/*!
 * Copyright (c) 2026-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
"use strict";var Mediabunny=(()=>{var bu=Object.create;var sn=Object.defineProperty;var ku=Object.getOwnPropertyDescriptor;var yu=Object.getOwnPropertyNames;var wu=Object.getPrototypeOf,Tu=Object.prototype.hasOwnProperty;var Su=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports),xu=(i,t)=>{for(var e in t)sn(i,e,{get:t[e],enumerable:!0})},uo=(i,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of yu(t))!Tu.call(i,n)&&n!==e&&sn(i,n,{get:()=>t[n],enumerable:!(r=ku(t,n))||r.enumerable});return i};var lo=(i,t,e)=>(e=i!=null?bu(wu(i)):{},uo(t||!i||!i.__esModule?sn(e,"default",{value:i,enumerable:!0}):e,i)),Cu=i=>uo(sn({},"__esModule",{value:!0}),i);var Ls=Su(()=>{});var Pl={};xu(Pl,{ADTS:()=>Vs,ALL_FORMATS:()=>Pc,ALL_TRACK_TYPES:()=>io,AUDIO_CODECS:()=>ue,AdtsInputFormat:()=>Wi,AdtsOutputFormat:()=>Aa,AttachedFile:()=>ft,AudioBufferSink:()=>xn,AudioBufferSource:()=>Va,AudioSample:()=>ye,AudioSampleSink:()=>Dt,AudioSampleSource:()=>pr,AudioSource:()=>ot,BaseMediaSampleSink:()=>Fr,BlobSource:()=>na,BufferSource:()=>ia,BufferTarget:()=>ai,CanvasSink:()=>Mr,CanvasSource:()=>Oa,Conversion:()=>La,ConversionCanceledError:()=>nn,CustomAudioDecoder:()=>wi,CustomAudioEncoder:()=>Si,CustomVideoDecoder:()=>yi,CustomVideoEncoder:()=>Ti,EncodedAudioPacketSource:()=>li,EncodedPacket:()=>L,EncodedPacketSink:()=>We,EncodedVideoPacketSource:()=>di,FLAC:()=>zs,FilePathSource:()=>sa,FilePathTarget:()=>ga,FlacInputFormat:()=>Li,FlacOutputFormat:()=>Ea,Input:()=>ti,InputAudioTrack:()=>te,InputDisposedError:()=>de,InputFormat:()=>_e,InputTrack:()=>Bt,InputVideoTrack:()=>Ie,IsobmffInputFormat:()=>Jr,IsobmffOutputFormat:()=>oi,MATROSKA:()=>Rs,MP3:()=>Bs,MP4:()=>Fs,MPEG_TS:()=>Ns,MatroskaInputFormat:()=>ei,MediaSource:()=>mr,MediaStreamAudioTrackSource:()=>za,MediaStreamVideoTrackSource:()=>Ua,MkvOutputFormat:()=>ci,MovOutputFormat:()=>cr,Mp3InputFormat:()=>Vi,Mp3OutputFormat:()=>Pa,Mp4InputFormat:()=>Bi,Mp4OutputFormat:()=>lr,MpegTsInputFormat:()=>Hi,MpegTsOutputFormat:()=>_a,NON_PCM_AUDIO_CODECS:()=>Je,NullTarget:()=>si,OGG:()=>Us,OggInputFormat:()=>Ni,OggOutputFormat:()=>Ia,Output:()=>gr,OutputFormat:()=>Me,PCM_AUDIO_CODECS:()=>Y,QTFF:()=>Ms,QUALITY_HIGH:()=>Yi,QUALITY_LOW:()=>ou,QUALITY_MEDIUM:()=>cu,QUALITY_VERY_HIGH:()=>uu,QUALITY_VERY_LOW:()=>su,Quality:()=>be,QuickTimeInputFormat:()=>Oi,ReadableStreamSource:()=>oa,RichImageData:()=>Re,SUBTITLE_CODECS:()=>Pe,Source:()=>Ve,StreamSource:()=>qi,StreamTarget:()=>Xi,SubtitleSource:()=>hr,Target:()=>at,TextSubtitleSource:()=>Na,UrlSource:()=>aa,VIDEO_CODECS:()=>se,VIDEO_SAMPLE_PIXEL_FORMATS:()=>Sn,VideoSample:()=>le,VideoSampleColorSpace:()=>rr,VideoSampleSink:()=>Rt,VideoSampleSource:()=>fr,VideoSource:()=>st,WAVE:()=>Os,WEBM:()=>Ds,WavOutputFormat:()=>va,WaveInputFormat:()=>zi,WebMInputFormat:()=>Ui,WebMOutputFormat:()=>ur,canEncode:()=>du,canEncodeAudio:()=>Ji,canEncodeSubtitles:()=>en,canEncodeVideo:()=>Zi,getEncodableAudioCodecs:()=>ui,getEncodableCodecs:()=>lu,getEncodableSubtitleCodecs:()=>Zs,getEncodableVideoCodecs:()=>Ys,getFirstEncodableAudioCodec:()=>mu,getFirstEncodableSubtitleCodec:()=>fu,getFirstEncodableVideoCodec:()=>Ba,registerDecoder:()=>jo,registerEncoder:()=>Ko});function p(i){if(!i)throw new Error("Assertion failed.")}var It=i=>{let t=(i%360+360)%360;if(t===0||t===90||t===180||t===270)return t;throw new Error(`Invalid rotation ${i}.`)},j=i=>i&&i[i.length-1],Wt=i=>i>=0&&i<2**32,V=class i{constructor(t){this.bytes=t;this.pos=0}seekToByte(t){this.pos=8*t}readBit(){let t=Math.floor(this.pos/8),e=this.bytes[t]??0,r=7-(this.pos&7),n=(e&1<<r)>>r;return this.pos++,n}readBits(t){if(t===1)return this.readBit();let e=0;for(let r=0;r<t;r++)e<<=1,e|=this.readBit();return e}writeBits(t,e){let r=this.pos+t;for(let n=this.pos;n<r;n++){let a=Math.floor(n/8),s=this.bytes[a],o=7-(n&7);s&=~(1<<o),s|=(e&1<<r-n-1)>>r-n-1<<o,this.bytes[a]=s}this.pos=r}readAlignedByte(){if(this.pos%8!==0)throw new Error("Bitstream is not byte-aligned.");let t=this.pos/8,e=this.bytes[t]??0;return this.pos+=8,e}skipBits(t){this.pos+=t}getBitsLeft(){return this.bytes.length*8-this.pos}clone(){let t=new i(this.bytes);return t.pos=this.pos,t}},v=i=>{let t=0;for(;i.readBits(1)===0&&t<32;)t++;if(t>=32)throw new Error("Invalid exponential-Golomb code.");return(1<<t)-1+i.readBits(t)},Xe=i=>{let t=v(i);return(t&1)===0?-(t>>1):t+1>>1},fo=(i,t,e,r)=>{for(let n=t;n<e;n++){let a=Math.floor(n/8),s=i[a],o=7-(n&7);s&=~(1<<o),s|=(r&1<<e-n-1)>>e-n-1<<o,i[a]=s}},W=i=>i.constructor===Uint8Array?i:ArrayBuffer.isView(i)?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i),D=i=>i.constructor===DataView?i:ArrayBuffer.isView(i)?new DataView(i.buffer,i.byteOffset,i.byteLength):new DataView(i),fe=new TextDecoder,G=new TextEncoder,At=i=>{for(let t=0;t<i.length;t++)if(i.charCodeAt(t)>255)return!1;return!0},Ka=i=>Object.fromEntries(Object.entries(i).map(([t,e])=>[e,t])),ct={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},Ht=Ka(ct),ut={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pq:16,hlg:18},qt=Ka(ut),dt={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},jt=Ka(dt),on=i=>!!i&&!!i.primaries&&!!i.transfer&&!!i.matrix&&i.fullRange!==void 0,kr=i=>i instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&i instanceof SharedArrayBuffer||ArrayBuffer.isView(i),Te=class{constructor(){this.currentPromise=Promise.resolve();this.pending=0}async acquire(){let t,e=new Promise(n=>{let a=!1;t=()=>{a||(n(),this.pending--,a=!0)}}),r=this.currentPromise;return this.currentPromise=e,this.pending++,await r,t}},Ga=i=>[...i].map(t=>t.toString(16).padStart(2,"0")).join(""),Qa=i=>(i=i>>1&1431655765|(i&1431655765)<<1,i=i>>2&858993459|(i&858993459)<<2,i=i>>4&252645135|(i&252645135)<<4,i=i>>8&16711935|(i&16711935)<<8,i=i>>16&65535|(i&65535)<<16,i>>>0),Kt=(i,t,e)=>{let r=0,n=i.length-1,a=-1;for(;r<=n;){let s=r+n>>1,o=e(i[s]);o===t?(a=s,n=s-1):o<t?r=s+1:n=s-1}return a},z=(i,t,e)=>{let r=0,n=i.length-1,a=-1;for(;r<=n;){let s=r+(n-r+1)/2|0;e(i[s])<=t?(a=s,r=s+1):n=s-1}return a},$a=(i,t,e)=>{let r=z(i,e(t),e);i.splice(r+1,0,t)},Q=()=>{let i,t;return{promise:new Promise((r,n)=>{i=r,t=n}),resolve:i,reject:t}};var Xa=(i,t)=>{for(let e=i.length-1;e>=0;e--)if(t(i[e]))return i[e]},yr=(i,t)=>{for(let e=i.length-1;e>=0;e--)if(t(i[e]))return e;return-1},po=async function*(i){Symbol.iterator in i?yield*i[Symbol.iterator]():yield*i[Symbol.asyncIterator]()},ho=i=>{if(!(Symbol.iterator in i)&&!(Symbol.asyncIterator in i))throw new TypeError("Argument must be an iterable or async iterable.")},J=i=>{throw new Error(`Unexpected value: ${i}`)},Gt=(i,t,e)=>{let r=i.getUint8(t),n=i.getUint8(t+1),a=i.getUint8(t+2);return e?r|n<<8|a<<16:r<<16|n<<8|a},go=(i,t,e)=>Gt(i,t,e)<<8>>8,Qt=(i,t,e,r)=>{e=e>>>0,e=e&16777215,r?(i.setUint8(t,e&255),i.setUint8(t+1,e>>>8&255),i.setUint8(t+2,e>>>16&255)):(i.setUint8(t,e>>>16&255),i.setUint8(t+1,e>>>8&255),i.setUint8(t+2,e&255))},bo=(i,t,e,r)=>{e=ae(e,-8388608,8388607),e<0&&(e=e+16777216&16777215),Qt(i,t,e,r)},ko=(i,t,e,r)=>{r?(i.setUint32(t+0,e,!0),i.setInt32(t+4,Math.floor(e/2**32),!0)):(i.setInt32(t+0,Math.floor(e/2**32),!0),i.setUint32(t+4,e,!0))},mi=(i,t)=>({async next(){let e=await i.next();return e.done?{value:void 0,done:!0}:{value:t(e.value),done:!1}},return(){return i.return()},throw(e){return i.throw(e)},[Symbol.asyncIterator](){return this}}),ae=(i,t,e)=>Math.max(t,Math.min(e,i)),ee="und",lt=i=>{let t=Math.round(i);return Math.abs(i/t-1)<10*Number.EPSILON?t:i},$t=(i,t)=>Math.round(i/t)*t,yo=i=>{let t=0;for(;i;)t++,i>>=1;return t},Pu=/^[a-z]{3}$/,mt=i=>Pu.test(i),Ye=1e6*(1+Number.EPSILON),Ya=(i,t)=>{let e={...i,...t};if(i.headers||t.headers){let r=i.headers?mo(i.headers):{},n=t.headers?mo(t.headers):{},a={...r};Object.entries(n).forEach(([s,o])=>{let c=Object.keys(a).find(u=>u.toLowerCase()===s.toLowerCase());c&&delete a[c],a[s]=o}),e.headers=a}return e},mo=i=>{if(i instanceof Headers){let t={};return i.forEach((e,r)=>{t[r]=e}),t}if(Array.isArray(i)){let t={};return i.forEach(([e,r])=>{t[e]=r}),t}return i},Za=async(i,t,e,r,n)=>{let a=0;for(;;)try{return await i(t,e)}catch(s){if(n())throw s;a++;let o=r(a,s,t);if(o===null)throw s;if(console.error("Retrying failed fetch. Error:",s),!Number.isFinite(o)||o<0)throw new TypeError("Retry delay must be a non-negative finite number.");if(o>0&&await new Promise(c=>setTimeout(c,1e3*o)),n())throw s}},wo=(i,t)=>{let e=i<0?-1:1;i=Math.abs(i);let r=0,n=1,a=1,s=0,o=i;for(;;){let c=Math.floor(o),u=c*a+r,d=c*s+n;if(d>t)return{numerator:e*a,denominator:s};if(r=a,n=s,a=u,s=d,o=1/(o-c),!isFinite(o))break}return{numerator:e*a,denominator:s}},vt=class{constructor(){this.currentPromise=Promise.resolve()}call(t){return this.currentPromise=this.currentPromise.then(t)}},Wa=null,Et=()=>Wa!==null?Wa:Wa=!!(typeof navigator<"u"&&(navigator.vendor?.match(/apple/i)||/AppleWebKit/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)||/\b(iPad|iPhone|iPod)\b/.test(navigator.userAgent))),Ha=null,Ze=()=>Ha!==null?Ha:Ha=typeof navigator<"u"&&navigator.userAgent?.includes("Firefox"),qa=null,fi=()=>qa!==null?qa:qa=!!(typeof navigator<"u"&&(navigator.vendor?.includes("Google Inc")||/Chrome/.test(navigator.userAgent))),ja=null,To=()=>{if(ja!==null)return ja;if(typeof navigator>"u")return null;let i=/\bChrome\/(\d+)/.exec(navigator.userAgent);return i?ja=Number(i[1]):null},Xt=(i,t)=>i!==-1?i:t,cn=(i,t,e,r)=>i<=r&&e<=t,Ne=function*(i){for(let t in i){let e=i[t];e!==void 0&&(yield{key:t,value:e})}},So=i=>{switch(i.toLowerCase()){case"image/jpeg":case"image/jpg":return".jpg";case"image/png":return".png";case"image/gif":return".gif";case"image/webp":return".webp";case"image/bmp":return".bmp";case"image/svg+xml":return".svg";case"image/tiff":return".tiff";case"image/avif":return".avif";case"image/x-icon":case"image/vnd.microsoft.icon":return".ico";default:return null}},xo=i=>{let t=atob(i),e=new Uint8Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e},Co=i=>{let t="";for(let e=0;e<i.length;e++)t+=String.fromCharCode(i[e]);return btoa(t)},Po=(i,t)=>{if(i.length!==t.length)return!1;for(let e=0;e<i.length;e++)if(i[e]!==t[e])return!1;return!0},un=()=>{Symbol.dispose??=Symbol("Symbol.dispose")},_t=i=>typeof i=="number"&&!Number.isNaN(i);var Re=class{constructor(t,e){this.data=t;this.mimeType=e;if(!(t instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(typeof e!="string")throw new TypeError("mimeType must be a string.")}},ft=class{constructor(t,e,r,n){this.data=t;this.mimeType=e;this.name=r;this.description=n;if(!(t instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(e!==void 0&&typeof e!="string")throw new TypeError("mimeType, when provided, must be a string.");if(r!==void 0&&typeof r!="string")throw new TypeError("name, when provided, must be a string.");if(n!==void 0&&typeof n!="string")throw new TypeError("description, when provided, must be a string.")}},pi=i=>{if(!i||typeof i!="object")throw new TypeError("tags must be an object.");if(i.title!==void 0&&typeof i.title!="string")throw new TypeError("tags.title, when provided, must be a string.");if(i.description!==void 0&&typeof i.description!="string")throw new TypeError("tags.description, when provided, must be a string.");if(i.artist!==void 0&&typeof i.artist!="string")throw new TypeError("tags.artist, when provided, must be a string.");if(i.album!==void 0&&typeof i.album!="string")throw new TypeError("tags.album, when provided, must be a string.");if(i.albumArtist!==void 0&&typeof i.albumArtist!="string")throw new TypeError("tags.albumArtist, when provided, must be a string.");if(i.trackNumber!==void 0&&(!Number.isInteger(i.trackNumber)||i.trackNumber<=0))throw new TypeError("tags.trackNumber, when provided, must be a positive integer.");if(i.tracksTotal!==void 0&&(!Number.isInteger(i.tracksTotal)||i.tracksTotal<=0))throw new TypeError("tags.tracksTotal, when provided, must be a positive integer.");if(i.discNumber!==void 0&&(!Number.isInteger(i.discNumber)||i.discNumber<=0))throw new TypeError("tags.discNumber, when provided, must be a positive integer.");if(i.discsTotal!==void 0&&(!Number.isInteger(i.discsTotal)||i.discsTotal<=0))throw new TypeError("tags.discsTotal, when provided, must be a positive integer.");if(i.genre!==void 0&&typeof i.genre!="string")throw new TypeError("tags.genre, when provided, must be a string.");if(i.date!==void 0&&(!(i.date instanceof Date)||Number.isNaN(i.date.getTime())))throw new TypeError("tags.date, when provided, must be a valid Date.");if(i.lyrics!==void 0&&typeof i.lyrics!="string")throw new TypeError("tags.lyrics, when provided, must be a string.");if(i.images!==void 0){if(!Array.isArray(i.images))throw new TypeError("tags.images, when provided, must be an array.");for(let t of i.images){if(!t||typeof t!="object")throw new TypeError("Each image in tags.images must be an object.");if(!(t.data instanceof Uint8Array))throw new TypeError("Each image.data must be a Uint8Array.");if(typeof t.mimeType!="string")throw new TypeError("Each image.mimeType must be a string.");if(!["coverFront","coverBack","unknown"].includes(t.kind))throw new TypeError("Each image.kind must be 'coverFront', 'coverBack', or 'unknown'.")}}if(i.comment!==void 0&&typeof i.comment!="string")throw new TypeError("tags.comment, when provided, must be a string.");if(i.raw!==void 0){if(!i.raw||typeof i.raw!="object")throw new TypeError("tags.raw, when provided, must be an object.");for(let t of Object.values(i.raw))if(t!==null&&typeof t!="string"&&!(t instanceof Uint8Array)&&!(t instanceof Re)&&!(t instanceof ft))throw new TypeError("Each value in tags.raw must be a string, Uint8Array, RichImageData, AttachedFile, or null.")}},Yt=i=>i.title===void 0&&i.description===void 0&&i.artist===void 0&&i.album===void 0&&i.albumArtist===void 0&&i.trackNumber===void 0&&i.tracksTotal===void 0&&i.discNumber===void 0&&i.discsTotal===void 0&&i.genre===void 0&&i.date===void 0&&i.lyrics===void 0&&(!i.images||i.images.length===0)&&i.comment===void 0&&(i.raw===void 0||Object.keys(i.raw).length===0),Se={default:!0,forced:!1,original:!1,commentary:!1,hearingImpaired:!1,visuallyImpaired:!1},vo=i=>{if(!i||typeof i!="object")throw new TypeError("disposition must be an object.");if(i.default!==void 0&&typeof i.default!="boolean")throw new TypeError("disposition.default must be a boolean.");if(i.forced!==void 0&&typeof i.forced!="boolean")throw new TypeError("disposition.forced must be a boolean.");if(i.original!==void 0&&typeof i.original!="boolean")throw new TypeError("disposition.original must be a boolean.");if(i.commentary!==void 0&&typeof i.commentary!="boolean")throw new TypeError("disposition.commentary must be a boolean.");if(i.hearingImpaired!==void 0&&typeof i.hearingImpaired!="boolean")throw new TypeError("disposition.hearingImpaired must be a boolean.");if(i.visuallyImpaired!==void 0&&typeof i.visuallyImpaired!="boolean")throw new TypeError("disposition.visuallyImpaired must be a boolean.")};var se=["avc","hevc","vp9","av1","vp8"],Y=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],Je=["aac","opus","mp3","vorbis","flac"],ue=[...Je,...Y],Pe=["webvtt"],hi=[{maxMacroblocks:99,maxBitrate:64e3,maxDpbMbs:396,level:10},{maxMacroblocks:396,maxBitrate:192e3,maxDpbMbs:900,level:11},{maxMacroblocks:396,maxBitrate:384e3,maxDpbMbs:2376,level:12},{maxMacroblocks:396,maxBitrate:768e3,maxDpbMbs:2376,level:13},{maxMacroblocks:396,maxBitrate:2e6,maxDpbMbs:2376,level:20},{maxMacroblocks:792,maxBitrate:4e6,maxDpbMbs:4752,level:21},{maxMacroblocks:1620,maxBitrate:4e6,maxDpbMbs:8100,level:22},{maxMacroblocks:1620,maxBitrate:1e7,maxDpbMbs:8100,level:30},{maxMacroblocks:3600,maxBitrate:14e6,maxDpbMbs:18e3,level:31},{maxMacroblocks:5120,maxBitrate:2e7,maxDpbMbs:20480,level:32},{maxMacroblocks:8192,maxBitrate:2e7,maxDpbMbs:32768,level:40},{maxMacroblocks:8192,maxBitrate:5e7,maxDpbMbs:32768,level:41},{maxMacroblocks:8704,maxBitrate:5e7,maxDpbMbs:34816,level:42},{maxMacroblocks:22080,maxBitrate:135e6,maxDpbMbs:110400,level:50},{maxMacroblocks:36864,maxBitrate:24e7,maxDpbMbs:184320,level:51},{maxMacroblocks:36864,maxBitrate:24e7,maxDpbMbs:184320,level:52},{maxMacroblocks:139264,maxBitrate:24e7,maxDpbMbs:696320,level:60},{maxMacroblocks:139264,maxBitrate:48e7,maxDpbMbs:696320,level:61},{maxMacroblocks:139264,maxBitrate:8e8,maxDpbMbs:696320,level:62}],Io=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],pt=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],Ao=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],Eo=".01.01.01.01.00",_o=".0.110.01.01.01.0",Fo=(i,t,e,r)=>{if(i==="avc"){let a=Math.ceil(t/16)*Math.ceil(e/16),s=hi.find(l=>a<=l.maxMacroblocks&&r<=l.maxBitrate)??j(hi),o=s?s.level:0,c="64".padStart(2,"0"),u="00",d=o.toString(16).padStart(2,"0");return`avc1.${c}${u}${d}`}else if(i==="hevc"){let n="",s="6",o=t*e,c=Io.find(d=>o<=d.maxPictureSize&&r<=d.maxBitrate)??j(Io);return`hev1.${n}1.${s}.${c.tier}${c.level}.B0`}else{if(i==="vp8")return"vp8";if(i==="vp9"){let n="00",a=t*e,s=pt.find(c=>a<=c.maxPictureSize&&r<=c.maxBitrate)??j(pt);return`vp09.${n}.${s.level.toString().padStart(2,"0")}.08`}else if(i==="av1"){let a=t*e,s=Ao.find(u=>a<=u.maxPictureSize&&r<=u.maxBitrate)??j(Ao);return`av01.0.${s.level.toString().padStart(2,"0")}${s.tier}.08`}}throw new TypeError(`Unhandled codec '${i}'.`)},Mo=i=>{let t=i.split("."),e=Number(t[1]),r=Number(t[2]),n=Number(t[3]),a=t[4]?Number(t[4]):1;return[1,1,e,2,1,r,3,1,n,4,1,a]},dn=i=>{let t=i.split("."),n=(1<<7)+1,a=Number(t[1]),s=t[2],o=Number(s.slice(0,-1)),c=(a<<5)+o,u=s.slice(-1)==="H"?1:0,l=Number(t[3])===8?0:1,m=0,f=t[4]?Number(t[4]):0,h=t[5]?Number(t[5][0]):1,g=t[5]?Number(t[5][1]):1,b=t[5]?Number(t[5][2]):0,y=(u<<7)+(l<<6)+(m<<5)+(f<<4)+(h<<3)+(g<<2)+b;return[n,c,y,0]},wr=i=>{let{codec:t,codecDescription:e,colorSpace:r,avcCodecInfo:n,hevcCodecInfo:a,vp9CodecInfo:s,av1CodecInfo:o}=i;if(t==="avc"){if(p(i.avcType!==null),n){let c=new Uint8Array([n.avcProfileIndication,n.profileCompatibility,n.avcLevelIndication]);return`avc${i.avcType}.${Ga(c)}`}if(!e||e.byteLength<4)throw new TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return`avc${i.avcType}.${Ga(e.subarray(1,4))}`}else if(t==="hevc"){let c,u,d,l,m,f;if(a)c=a.generalProfileSpace,u=a.generalProfileIdc,d=Qa(a.generalProfileCompatibilityFlags),l=a.generalTierFlag,m=a.generalLevelIdc,f=[...a.generalConstraintIndicatorFlags];else{if(!e||e.byteLength<23)throw new TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");let g=D(e),b=g.getUint8(1);c=b>>6&3,u=b&31,d=Qa(g.getUint32(2)),l=b>>5&1,m=g.getUint8(12),f=[];for(let y=0;y<6;y++)f.push(g.getUint8(6+y))}let h="hev1.";for(h+=["","A","B","C"][c]+u,h+=".",h+=d.toString(16).toUpperCase(),h+=".",h+=l===0?"L":"H",h+=m;f.length>0&&f[f.length-1]===0;)f.pop();return f.length>0&&(h+=".",h+=f.map(g=>g.toString(16).toUpperCase()).join(".")),h}else{if(t==="vp8")return"vp8";if(t==="vp9"){if(!s){let y=i.width*i.height,k=j(pt).level;for(let w of pt)if(y<=w.maxPictureSize){k=w.level;break}return`vp09.00.${k.toString().padStart(2,"0")}.08`}let c=s.profile.toString().padStart(2,"0"),u=s.level.toString().padStart(2,"0"),d=s.bitDepth.toString().padStart(2,"0"),l=s.chromaSubsampling.toString().padStart(2,"0"),m=s.colourPrimaries.toString().padStart(2,"0"),f=s.transferCharacteristics.toString().padStart(2,"0"),h=s.matrixCoefficients.toString().padStart(2,"0"),g=s.videoFullRangeFlag.toString().padStart(2,"0"),b=`vp09.${c}.${u}.${d}.${l}`;return b+=`.${m}.${f}.${h}.${g}`,b.endsWith(Eo)&&(b=b.slice(0,-Eo.length)),b}else if(t==="av1"){if(!o){let w=i.width*i.height,S=j(pt).level;for(let T of pt)if(w<=T.maxPictureSize){S=T.level;break}return`av01.0.${S.toString().padStart(2,"0")}M.08`}let c=o.profile,u=o.level.toString().padStart(2,"0"),d=o.tier?"H":"M",l=o.bitDepth.toString().padStart(2,"0"),m=o.monochrome?"1":"0",f=100*o.chromaSubsamplingX+10*o.chromaSubsamplingY+1*(o.chromaSubsamplingX&&o.chromaSubsamplingY?o.chromaSamplePosition:0),h=r?.primaries?ct[r.primaries]:1,g=r?.transfer?ut[r.transfer]:1,b=r?.matrix?dt[r.matrix]:1,y=r?.fullRange?1:0,k=`av01.${c}.${u}${d}.${l}`;return k+=`.${m}.${f.toString().padStart(3,"0")}`,k+=`.${h.toString().padStart(2,"0")}`,k+=`.${g.toString().padStart(2,"0")}`,k+=`.${b.toString().padStart(2,"0")}`,k+=`.${y}`,k.endsWith(_o)&&(k=k.slice(0,-_o.length)),k}}throw new TypeError(`Unhandled codec '${t}'.`)},Ro=(i,t,e)=>{if(i==="aac")return t>=2&&e<=24e3?"mp4a.40.29":e<=24e3?"mp4a.40.5":"mp4a.40.2";if(i==="mp3")return"mp3";if(i==="opus")return"opus";if(i==="vorbis")return"vorbis";if(i==="flac")return"flac";if(Y.includes(i))return i;throw new TypeError(`Unhandled codec '${i}'.`)},Tr=i=>{let{codec:t,codecDescription:e,aacCodecInfo:r}=i;if(t==="aac"){if(!r)throw new TypeError("AAC codec info must be provided.");if(r.isMpeg2)return"mp4a.67";{let n;return r.objectType!==null?n=r.objectType:n=ht(e).objectType,`mp4a.40.${n}`}}else{if(t==="mp3")return"mp3";if(t==="opus")return"opus";if(t==="vorbis")return"vorbis";if(t==="flac")return"flac";if(t&&Y.includes(t))return t}throw new TypeError(`Unhandled codec '${t}'.`)},Ue=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],et=[-1,1,2,3,4,5,6,8],ht=i=>{if(!i||i.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");let t=new V(i),e=t.readBits(5);e===31&&(e=32+t.readBits(6));let r=t.readBits(4),n=null;r===15?n=t.readBits(24):r<Ue.length&&(n=Ue[r]);let a=t.readBits(4),s=null;return a>=1&&a<=7&&(s=et[a]),{objectType:e,frequencyIndex:r,sampleRate:n,channelConfiguration:a,numberOfChannels:s}},Sr=i=>{let t=Ue.indexOf(i.sampleRate),e=null;t===-1&&(t=15,e=i.sampleRate);let r=et.indexOf(i.numberOfChannels);if(r===-1)throw new TypeError(`Unsupported number of channels: ${i.numberOfChannels}`);let n=13;i.objectType>=32&&(n+=6),t===15&&(n+=24);let a=Math.ceil(n/8),s=new Uint8Array(a),o=new V(s);return i.objectType<32?o.writeBits(5,i.objectType):(o.writeBits(5,31),o.writeBits(6,i.objectType-32)),o.writeBits(4,t),t===15&&o.writeBits(24,e),o.writeBits(4,r),s},Le=48e3,Do=/^pcm-([usf])(\d+)+(be)?$/,ke=i=>{if(p(Y.includes(i)),i==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(i==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};let t=Do.exec(i);p(t);let e;t[1]==="u"?e="unsigned":t[1]==="s"?e="signed":e="float";let r=Number(t[2])/8,n=t[3]!=="be",a=i==="pcm-u8"?2**7:0;return{dataType:e,sampleSize:r,littleEndian:n,silentValue:a}},Ja=i=>i.startsWith("avc1")||i.startsWith("avc3")?"avc":i.startsWith("hev1")||i.startsWith("hvc1")?"hevc":i==="vp8"?"vp8":i.startsWith("vp09")?"vp9":i.startsWith("av01")?"av1":i.startsWith("mp4a.40")||i==="mp4a.67"?"aac":i==="mp3"||i==="mp4a.69"||i==="mp4a.6B"||i==="mp4a.6b"?"mp3":i==="opus"?"opus":i==="vorbis"?"vorbis":i==="flac"?"flac":i==="ulaw"?"ulaw":i==="alaw"?"alaw":Do.test(i)?i:i==="webvtt"?"webvtt":null,Bo=i=>i==="avc"?{avc:{format:"avc"}}:i==="hevc"?{hevc:{format:"hevc"}}:{},Oo=i=>i==="aac"?{aac:{format:"aac"}}:i==="opus"?{opus:{format:"opus"}}:{},vu=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],Iu=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,Au=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,Eu=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,_u=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,xr=i=>{if(!i)throw new TypeError("Video chunk metadata must be provided.");if(typeof i!="object")throw new TypeError("Video chunk metadata must be an object.");if(!i.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if(typeof i.decoderConfig!="object")throw new TypeError("Video chunk metadata decoder configuration must be an object.");if(typeof i.decoderConfig.codec!="string")throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!vu.some(t=>i.decoderConfig.codec.startsWith(t)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(i.decoderConfig.codedWidth)||i.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(i.decoderConfig.codedHeight)||i.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(i.decoderConfig.description!==void 0&&!kr(i.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(i.decoderConfig.colorSpace!==void 0){let{colorSpace:t}=i.decoderConfig;if(typeof t!="object")throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");let e=Object.keys(ct);if(t.primaries!=null&&!e.includes(t.primaries))throw new TypeError(`Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ${e.join(", ")}.`);let r=Object.keys(ut);if(t.transfer!=null&&!r.includes(t.transfer))throw new TypeError(`Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ${r.join(", ")}.`);let n=Object.keys(dt);if(t.matrix!=null&&!n.includes(t.matrix))throw new TypeError(`Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ${n.join(", ")}.`);if(t.fullRange!=null&&typeof t.fullRange!="boolean")throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(i.decoderConfig.codec.startsWith("avc1")||i.decoderConfig.codec.startsWith("avc3")){if(!Iu.test(i.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(i.decoderConfig.codec.startsWith("hev1")||i.decoderConfig.codec.startsWith("hvc1")){if(!Au.test(i.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(i.decoderConfig.codec.startsWith("vp8")){if(i.decoderConfig.codec!=="vp8")throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(i.decoderConfig.codec.startsWith("vp09")){if(!Eu.test(i.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(i.decoderConfig.codec.startsWith("av01")&&!_u.test(i.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},Fu=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],ve=i=>{if(!i)throw new TypeError("Audio chunk metadata must be provided.");if(typeof i!="object")throw new TypeError("Audio chunk metadata must be an object.");if(!i.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if(typeof i.decoderConfig!="object")throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if(typeof i.decoderConfig.codec!="string")throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!Fu.some(t=>i.decoderConfig.codec.startsWith(t)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(i.decoderConfig.sampleRate)||i.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(i.decoderConfig.numberOfChannels)||i.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(i.decoderConfig.description!==void 0&&!kr(i.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(i.decoderConfig.codec.startsWith("mp4a")&&i.decoderConfig.codec!=="mp4a.69"&&i.decoderConfig.codec!=="mp4a.6B"&&i.decoderConfig.codec!=="mp4a.6b"){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(i.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.")}else if(i.decoderConfig.codec.startsWith("mp3")||i.decoderConfig.codec.startsWith("mp4a")){if(i.decoderConfig.codec!=="mp3"&&i.decoderConfig.codec!=="mp4a.69"&&i.decoderConfig.codec!=="mp4a.6B"&&i.decoderConfig.codec!=="mp4a.6b")throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(i.decoderConfig.codec.startsWith("opus")){if(i.decoderConfig.codec!=="opus")throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(i.decoderConfig.description&&i.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(i.decoderConfig.codec.startsWith("vorbis")){if(i.decoderConfig.codec!=="vorbis")throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!i.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(i.decoderConfig.codec.startsWith("flac")){if(i.decoderConfig.codec!=="flac")throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!i.decoderConfig.description||i.decoderConfig.description.byteLength<42)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((i.decoderConfig.codec.startsWith("pcm")||i.decoderConfig.codec.startsWith("ulaw")||i.decoderConfig.codec.startsWith("alaw"))&&!Y.includes(i.decoderConfig.codec))throw new TypeError(`Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (${Y.join(", ")}).`)},ln=i=>{if(!i)throw new TypeError("Subtitle metadata must be provided.");if(typeof i!="object")throw new TypeError("Subtitle metadata must be an object.");if(!i.config)throw new TypeError("Subtitle metadata must include a config object.");if(typeof i.config!="object")throw new TypeError("Subtitle metadata config must be an object.");if(typeof i.config.description!="string")throw new TypeError("Subtitle metadata config description must be a string.")};var pe=class{constructor(t){this.mutex=new Te;this.firstMediaStreamTimestamp=null;this.trackTimestampInfo=new WeakMap;this.output=t}onTrackClose(t){}validateAndNormalizeTimestamp(t,e,r){e+=t.source._timestampOffset;let n=this.trackTimestampInfo.get(t);if(!n){if(!r)throw new Error("First packet must be a key packet.");n={maxTimestamp:e,maxTimestampBeforeLastKeyPacket:e},this.trackTimestampInfo.set(t,n)}if(e<0)throw new Error(`Timestamps must be non-negative (got ${e}s).`);if(r&&(n.maxTimestampBeforeLastKeyPacket=n.maxTimestamp),e<n.maxTimestampBeforeLastKeyPacket)throw new Error(`Timestamps cannot be smaller than the largest timestamp of the previous GOP (a GOP begins with a key packet and ends right before the next key packet). Got ${e}s, but largest timestamp is ${n.maxTimestampBeforeLastKeyPacket}s.`);return n.maxTimestamp=Math.max(n.maxTimestamp,e),e}};var mn=i=>{let t=new Uint8Array(7),e=new V(t),{objectType:r,frequencyIndex:n,channelConfiguration:a}=i,s=r-1;return e.writeBits(12,4095),e.writeBits(1,0),e.writeBits(2,0),e.writeBits(1,1),e.writeBits(2,s),e.writeBits(4,n),e.writeBits(1,0),e.writeBits(3,a),e.writeBits(1,0),e.writeBits(1,0),e.writeBits(1,0),e.writeBits(1,0),e.skipBits(13),e.writeBits(11,2047),e.writeBits(2,0),{header:t,bitstream:e}},fn=(i,t)=>{i.pos=30,i.writeBits(13,t)};var pn=class extends pe{constructor(e,r){super(e);this.header=null;this.headerBitstream=null;this.inputIsAdts=null;this.format=r,this.writer=e._writer}async start(){}async getMimeType(){return"audio/aac"}async addEncodedVideoPacket(){throw new Error("ADTS does not support video.")}async addEncodedAudioPacket(e,r,n){let a=await this.mutex.acquire();try{if(this.validateAndNormalizeTimestamp(e,r.timestamp,r.type==="key"),this.inputIsAdts===null){ve(n);let s=n?.decoderConfig?.description;if(this.inputIsAdts=!s,!this.inputIsAdts){let o=ht(W(s)),c=mn(o);this.header=c.header,this.headerBitstream=c.bitstream}}if(this.inputIsAdts){let s=this.writer.getPos();this.writer.write(r.data),this.format._options.onFrame&&this.format._options.onFrame(r.data,s)}else{p(this.header);let s=r.data.byteLength+this.header.byteLength;fn(this.headerBitstream,s);let o=this.writer.getPos();if(this.writer.write(this.header),this.writer.write(r.data),this.format._options.onFrame){let c=new Uint8Array(s);c.set(this.header,0),c.set(r.data,this.header.byteLength),this.format._options.onFrame(c,o)}}await this.writer.flush()}finally{a()}}async addSubtitleCue(){throw new Error("ADTS does not support subtitles.")}async finalize(){}};var Ft=function*(i){let t=0,e=-1;for(;t<i.length-2;){let r=i.indexOf(0,t);if(r===-1||r>=i.length-2)break;t=r;let n=0;if(t+3<i.length&&i[t+1]===0&&i[t+2]===0&&i[t+3]===1?n=4:i[t+1]===0&&i[t+2]===1&&(n=3),n===0){t++;continue}e!==-1&&t>e&&(yield{offset:e,length:t-e}),e=t+n,t=e}e!==-1&&e<i.length&&(yield{offset:e,length:i.length-e})},hn=function*(i,t){let e=0,r=new DataView(i.buffer,i.byteOffset,i.byteLength);for(;e+t<=i.length;){let n;t===1?n=r.getUint8(e):t===2?n=r.getUint16(e,!1):t===3?n=Gt(r,e,!1):(p(t===4),n=r.getUint32(e,!1)),e+=t,yield{offset:e,length:n},e+=n}},ts=(i,t)=>{if(t.description){let n=(W(t.description)[4]&3)+1;return hn(i,n)}else return Ft(i)},Mu=function*(i){yield*Ft(i)},gt=i=>i&31,gn=i=>{let t=[],e=i.length;for(let r=0;r<e;r++)r+2<e&&i[r]===0&&i[r+1]===0&&i[r+2]===3?(t.push(0,0),r+=2):t.push(i[r]);return new Uint8Array(t)},es=new Uint8Array([0,0,0,1]),bn=i=>{let t=i.reduce((n,a)=>n+es.byteLength+a.byteLength,0),e=new Uint8Array(t),r=0;for(let n of i)e.set(es,r),r+=es.byteLength,e.set(n,r),r+=n.byteLength;return e},rs=(i,t)=>{let e=i.reduce((a,s)=>a+t+s.byteLength,0),r=new Uint8Array(e),n=0;for(let a of i){let s=new DataView(r.buffer,r.byteOffset,r.byteLength);switch(t){case 1:s.setUint8(n,a.byteLength);break;case 2:s.setUint16(n,a.byteLength,!1);break;case 3:Qt(s,n,a.byteLength,!1);break;case 4:s.setUint32(n,a.byteLength,!1);break}n+=t,r.set(a,n),n+=a.byteLength}return r},zo=(i,t)=>{if(t.description){let n=(W(t.description)[4]&3)+1;return rs(i,n)}else return bn(i)},Cr=i=>{try{let t=[],e=[],r=[];for(let o of Mu(i)){let c=i.subarray(o.offset,o.offset+o.length),u=gt(c[0]);u===7?t.push(c):u===8?e.push(c):u===13&&r.push(c)}if(t.length===0||e.length===0)return null;let n=t[0],a=gi(n);p(a!==null);let s=a.profileIdc===100||a.profileIdc===110||a.profileIdc===122||a.profileIdc===144;return{configurationVersion:1,avcProfileIndication:a.profileIdc,profileCompatibility:a.constraintFlags,avcLevelIndication:a.levelIdc,lengthSizeMinusOne:3,sequenceParameterSets:t,pictureParameterSets:e,chromaFormat:s?a.chromaFormatIdc:null,bitDepthLumaMinus8:s?a.bitDepthLumaMinus8:null,bitDepthChromaMinus8:s?a.bitDepthChromaMinus8:null,sequenceParameterSetExt:s?r:null}}catch(t){return console.error("Error building AVC Decoder Configuration Record:",t),null}},No=i=>{let t=[];t.push(i.configurationVersion),t.push(i.avcProfileIndication),t.push(i.profileCompatibility),t.push(i.avcLevelIndication),t.push(252|i.lengthSizeMinusOne&3),t.push(224|i.sequenceParameterSets.length&31);for(let e of i.sequenceParameterSets){let r=e.byteLength;t.push(r>>8),t.push(r&255);for(let n=0;n<r;n++)t.push(e[n])}t.push(i.pictureParameterSets.length);for(let e of i.pictureParameterSets){let r=e.byteLength;t.push(r>>8),t.push(r&255);for(let n=0;n<r;n++)t.push(e[n])}if(i.avcProfileIndication===100||i.avcProfileIndication===110||i.avcProfileIndication===122||i.avcProfileIndication===144){p(i.chromaFormat!==null),p(i.bitDepthLumaMinus8!==null),p(i.bitDepthChromaMinus8!==null),p(i.sequenceParameterSetExt!==null),t.push(252|i.chromaFormat&3),t.push(248|i.bitDepthLumaMinus8&7),t.push(248|i.bitDepthChromaMinus8&7),t.push(i.sequenceParameterSetExt.length);for(let e of i.sequenceParameterSetExt){let r=e.byteLength;t.push(r>>8),t.push(r&255);for(let n=0;n<r;n++)t.push(e[n])}}return new Uint8Array(t)},kn=i=>{try{let t=D(i),e=0,r=t.getUint8(e++),n=t.getUint8(e++),a=t.getUint8(e++),s=t.getUint8(e++),o=t.getUint8(e++)&3,c=t.getUint8(e++)&31,u=[];for(let f=0;f<c;f++){let h=t.getUint16(e,!1);e+=2,u.push(i.subarray(e,e+h)),e+=h}let d=t.getUint8(e++),l=[];for(let f=0;f<d;f++){let h=t.getUint16(e,!1);e+=2,l.push(i.subarray(e,e+h)),e+=h}let m={configurationVersion:r,avcProfileIndication:n,profileCompatibility:a,avcLevelIndication:s,lengthSizeMinusOne:o,sequenceParameterSets:u,pictureParameterSets:l,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if((n===100||n===110||n===122||n===144)&&e+4<=i.length){let f=t.getUint8(e++)&3,h=t.getUint8(e++)&7,g=t.getUint8(e++)&7,b=t.getUint8(e++);m.chromaFormat=f,m.bitDepthLumaMinus8=h,m.bitDepthChromaMinus8=g;let y=[];for(let k=0;k<b;k++){let w=t.getUint16(e,!1);e+=2,y.push(i.subarray(e,e+w)),e+=w}m.sequenceParameterSetExt=y}return m}catch(t){return console.error("Error deserializing AVC Decoder Configuration Record:",t),null}},gi=i=>{try{let t=new V(gn(i));if(t.skipBits(1),t.skipBits(2),t.readBits(5)!==7)return null;let r=t.readAlignedByte(),n=t.readAlignedByte(),a=t.readAlignedByte();v(t);let s=1,o=0,c=0,u=0;if((r===100||r===110||r===122||r===244||r===44||r===83||r===86||r===118||r===128)&&(s=v(t),s===3&&(u=t.readBits(1)),o=v(t),c=v(t),t.skipBits(1),t.readBits(1))){for(let F=0;F<(s!==3?8:12);F++)if(t.readBits(1)){let H=F<6?16:64,$=8,X=8;for(let Z=0;Z<H;Z++){if(X!==0){let ne=Xe(t);X=($+ne+256)%256}$=X===0?$:X}}}v(t);let d=v(t);if(d===0)v(t);else if(d===1){t.skipBits(1),Xe(t),Xe(t);let U=v(t);for(let F=0;F<U;F++)Xe(t)}v(t),t.skipBits(1);let l=v(t),m=v(t),f=16*(l+1),h=16*(m+1),g=f,b=h,y=t.readBits(1);if(y||t.skipBits(1),t.skipBits(1),t.readBits(1)){let U=v(t),F=v(t),R=v(t),H=v(t),$,X;if((u===0?s:0)===0)$=1,X=2-y;else{let ne=s===3?1:2,we=s===1?2:1;$=ne,X=we*(2-y)}g-=$*(U+F),b-=X*(R+H)}let w=2,S=2,T=2,x=0,A=null,C=null;if(t.readBits(1)){t.readBits(1)&&t.readBits(8)===255&&(t.skipBits(16),t.skipBits(16)),t.readBits(1)&&t.skipBits(1),t.readBits(1)&&(t.skipBits(3),x=t.readBits(1),t.readBits(1)&&(w=t.readBits(8),S=t.readBits(8),T=t.readBits(8))),t.readBits(1)&&(v(t),v(t)),t.readBits(1)&&(t.skipBits(32),t.skipBits(32),t.skipBits(1));let X=t.readBits(1);X&&Uo(t);let Z=t.readBits(1);Z&&Uo(t),(X||Z)&&t.skipBits(1),t.skipBits(1),t.readBits(1)&&(t.skipBits(1),v(t),v(t),v(t),v(t),A=v(t),C=v(t))}if(A===null){p(C===null);let U=n&16;if((r===44||r===86||r===100||r===110||r===122||r===244)&&U)A=0,C=0;else{let F=l+1,R=m+1,H=(2-y)*R,$=hi.find(Z=>Z.level>=a)??j(hi),X=Math.min(Math.floor($.maxDpbMbs/(F*H)),16);A=X,C=X}}return p(C!==null),{profileIdc:r,constraintFlags:n,levelIdc:a,frameMbsOnlyFlag:y,chromaFormatIdc:s,bitDepthLumaMinus8:o,bitDepthChromaMinus8:c,codedWidth:f,codedHeight:h,displayWidth:g,displayHeight:b,colourPrimaries:w,matrixCoefficients:T,transferCharacteristics:S,fullRangeFlag:x,numReorderFrames:A,maxDecFrameBuffering:C}}catch(t){return console.error("Error parsing AVC SPS:",t),null}},Uo=i=>{let t=v(i);i.skipBits(4),i.skipBits(4);for(let e=0;e<=t;e++)v(i),v(i),i.skipBits(1);i.skipBits(5),i.skipBits(5),i.skipBits(5),i.skipBits(5)},is=(i,t)=>{if(t.description){let n=(W(t.description)[21]&3)+1;return hn(i,n)}else return Ft(i)},Ru=function*(i){yield*Ft(i)},tt=i=>i>>1&63,ns=i=>{try{let t=new V(gn(i));t.skipBits(16),t.readBits(4);let e=t.readBits(3),r=t.readBits(1),{general_profile_space:n,general_tier_flag:a,general_profile_idc:s,general_profile_compatibility_flags:o,general_constraint_indicator_flags:c,general_level_idc:u}=Du(t,e);v(t);let d=v(t),l=0;d===3&&(l=t.readBits(1));let m=v(t),f=v(t),h=m,g=f;if(t.readBits(1)){let F=v(t),R=v(t),H=v(t),$=v(t),X=1,Z=1,ne=l===0?d:0;ne===1?(X=2,Z=2):ne===2&&(X=2,Z=1),h-=(F+R)*X,g-=(H+$)*Z}let b=v(t),y=v(t);v(t);let w=t.readBits(1)?0:e,S=0;for(let F=w;F<=e;F++)v(t),S=v(t),v(t);v(t),v(t),v(t),v(t),v(t),v(t),t.readBits(1)&&t.readBits(1)&&Bu(t),t.skipBits(1),t.skipBits(1),t.readBits(1)&&(t.skipBits(4),t.skipBits(4),v(t),v(t),t.skipBits(1));let T=v(t);if(Ou(t,T),t.readBits(1)){let F=v(t);for(let R=0;R<F;R++)v(t),t.skipBits(1)}t.skipBits(1),t.skipBits(1);let x=2,A=2,C=2,_=0,U=0;if(t.readBits(1)){let F=Vu(t,e);x=F.colourPrimaries,A=F.transferCharacteristics,C=F.matrixCoefficients,_=F.fullRangeFlag,U=F.minSpatialSegmentationIdc}return{displayWidth:h,displayHeight:g,colourPrimaries:x,transferCharacteristics:A,matrixCoefficients:C,fullRangeFlag:_,maxDecFrameBuffering:S+1,spsMaxSubLayersMinus1:e,spsTemporalIdNestingFlag:r,generalProfileSpace:n,generalTierFlag:a,generalProfileIdc:s,generalProfileCompatibilityFlags:o,generalConstraintIndicatorFlags:c,generalLevelIdc:u,chromaFormatIdc:d,bitDepthLumaMinus8:b,bitDepthChromaMinus8:y,minSpatialSegmentationIdc:U}}catch(t){return console.error("Error parsing HEVC SPS:",t),null}},Pr=i=>{try{let t=[],e=[],r=[],n=[];for(let u of Ru(i)){let d=i.subarray(u.offset,u.offset+u.length),l=tt(d[0]);l===32?t.push(d):l===33?e.push(d):l===34?r.push(d):(l===39||l===40)&&n.push(d)}if(e.length===0||r.length===0)return null;let a=ns(e[0]);if(!a)return null;let s=0;if(r.length>0){let u=r[0],d=new V(gn(u));d.skipBits(16),v(d),v(d),d.skipBits(1),d.skipBits(1),d.skipBits(3),d.skipBits(1),d.skipBits(1),v(d),v(d),Xe(d),d.skipBits(1),d.skipBits(1),d.readBits(1)&&v(d),Xe(d),Xe(d),d.skipBits(1),d.skipBits(1),d.skipBits(1),d.skipBits(1);let l=d.readBits(1),m=d.readBits(1);!l&&!m?s=0:l&&!m?s=2:!l&&m?s=3:s=0}let o=[...t.length?[{arrayCompleteness:1,nalUnitType:32,nalUnits:t}]:[],...e.length?[{arrayCompleteness:1,nalUnitType:33,nalUnits:e}]:[],...r.length?[{arrayCompleteness:1,nalUnitType:34,nalUnits:r}]:[],...n.length?[{arrayCompleteness:1,nalUnitType:tt(n[0][0]),nalUnits:n}]:[]];return{configurationVersion:1,generalProfileSpace:a.generalProfileSpace,generalTierFlag:a.generalTierFlag,generalProfileIdc:a.generalProfileIdc,generalProfileCompatibilityFlags:a.generalProfileCompatibilityFlags,generalConstraintIndicatorFlags:a.generalConstraintIndicatorFlags,generalLevelIdc:a.generalLevelIdc,minSpatialSegmentationIdc:a.minSpatialSegmentationIdc,parallelismType:s,chromaFormatIdc:a.chromaFormatIdc,bitDepthLumaMinus8:a.bitDepthLumaMinus8,bitDepthChromaMinus8:a.bitDepthChromaMinus8,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:a.spsMaxSubLayersMinus1+1,temporalIdNested:a.spsTemporalIdNestingFlag,lengthSizeMinusOne:3,arrays:o}}catch(t){return console.error("Error building HEVC Decoder Configuration Record:",t),null}},Du=(i,t)=>{let e=i.readBits(2),r=i.readBits(1),n=i.readBits(5),a=0;for(let d=0;d<32;d++)a=a<<1|i.readBits(1);let s=new Uint8Array(6);for(let d=0;d<6;d++)s[d]=i.readBits(8);let o=i.readBits(8),c=[],u=[];for(let d=0;d<t;d++)c.push(i.readBits(1)),u.push(i.readBits(1));if(t>0)for(let d=t;d<8;d++)i.skipBits(2);for(let d=0;d<t;d++)c[d]&&i.skipBits(88),u[d]&&i.skipBits(8);return{general_profile_space:e,general_tier_flag:r,general_profile_idc:n,general_profile_compatibility_flags:a,general_constraint_indicator_flags:s,general_level_idc:o}},Bu=i=>{for(let t=0;t<4;t++)for(let e=0;e<(t===3?2:6);e++)if(!i.readBits(1))v(i);else{let n=Math.min(64,1<<4+(t<<1));t>1&&Xe(i);for(let a=0;a<n;a++)Xe(i)}},Ou=(i,t)=>{let e=[];for(let r=0;r<t;r++)e[r]=Uu(i,r,t,e)},Uu=(i,t,e,r)=>{let n=0,a=0,s=0;if(t!==0&&(a=i.readBits(1)),a){if(t===e){let c=v(i);s=t-(c+1)}else s=t-1;i.readBits(1),v(i);let o=r[s]??0;for(let c=0;c<=o;c++)i.readBits(1)||i.readBits(1);n=r[s]}else{let o=v(i),c=v(i);for(let u=0;u<o;u++)v(i),i.readBits(1);for(let u=0;u<c;u++)v(i),i.readBits(1);n=o+c}return n},Vu=(i,t)=>{let e=2,r=2,n=2,a=0,s=0;return i.readBits(1)&&i.readBits(8)===255&&(i.readBits(16),i.readBits(16)),i.readBits(1)&&i.readBits(1),i.readBits(1)&&(i.readBits(3),a=i.readBits(1),i.readBits(1)&&(e=i.readBits(8),r=i.readBits(8),n=i.readBits(8))),i.readBits(1)&&(v(i),v(i)),i.readBits(1),i.readBits(1),i.readBits(1),i.readBits(1)&&(v(i),v(i),v(i),v(i)),i.readBits(1)&&(i.readBits(32),i.readBits(32),i.readBits(1)&&v(i),i.readBits(1)&&zu(i,!0,t)),i.readBits(1)&&(i.readBits(1),i.readBits(1),i.readBits(1),s=v(i),v(i),v(i),v(i),v(i)),{colourPrimaries:e,transferCharacteristics:r,matrixCoefficients:n,fullRangeFlag:a,minSpatialSegmentationIdc:s}},zu=(i,t,e)=>{let r=!1,n=!1,a=!1;t&&(r=i.readBits(1)===1,n=i.readBits(1)===1,(r||n)&&(a=i.readBits(1)===1,a&&(i.readBits(8),i.readBits(5),i.readBits(1),i.readBits(5)),i.readBits(4),i.readBits(4),a&&i.readBits(4),i.readBits(5),i.readBits(5),i.readBits(5)));for(let s=0;s<=e;s++){let o=i.readBits(1)===1,c=!0;o||(c=i.readBits(1)===1);let u=!1;c?v(i):u=i.readBits(1)===1;let d=1;u||(d=v(i)+1),r&&Vo(i,d,a),n&&Vo(i,d,a)}},Vo=(i,t,e)=>{for(let r=0;r<t;r++)v(i),v(i),e&&(v(i),v(i)),i.readBits(1)},Lo=i=>{let t=[];t.push(i.configurationVersion),t.push((i.generalProfileSpace&3)<<6|(i.generalTierFlag&1)<<5|i.generalProfileIdc&31),t.push(i.generalProfileCompatibilityFlags>>>24&255),t.push(i.generalProfileCompatibilityFlags>>>16&255),t.push(i.generalProfileCompatibilityFlags>>>8&255),t.push(i.generalProfileCompatibilityFlags&255),t.push(...i.generalConstraintIndicatorFlags),t.push(i.generalLevelIdc&255),t.push(240|i.minSpatialSegmentationIdc>>8&15),t.push(i.minSpatialSegmentationIdc&255),t.push(252|i.parallelismType&3),t.push(252|i.chromaFormatIdc&3),t.push(248|i.bitDepthLumaMinus8&7),t.push(248|i.bitDepthChromaMinus8&7),t.push(i.avgFrameRate>>8&255),t.push(i.avgFrameRate&255),t.push((i.constantFrameRate&3)<<6|(i.numTemporalLayers&7)<<3|(i.temporalIdNested&1)<<2|i.lengthSizeMinusOne&3),t.push(i.arrays.length&255);for(let e of i.arrays){t.push((e.arrayCompleteness&1)<<7|0|e.nalUnitType&63),t.push(e.nalUnits.length>>8&255),t.push(e.nalUnits.length&255);for(let r of e.nalUnits){t.push(r.length>>8&255),t.push(r.length&255);for(let n=0;n<r.length;n++)t.push(r[n])}}return new Uint8Array(t)},Wo=i=>{try{let t=D(i),e=0,r=t.getUint8(e++),n=t.getUint8(e++),a=n>>6&3,s=n>>5&1,o=n&31,c=t.getUint32(e,!1);e+=4;let u=i.subarray(e,e+6);e+=6;let d=t.getUint8(e++),l=(t.getUint8(e++)&15)<<8|t.getUint8(e++),m=t.getUint8(e++)&3,f=t.getUint8(e++)&3,h=t.getUint8(e++)&7,g=t.getUint8(e++)&7,b=t.getUint16(e,!1);e+=2;let y=t.getUint8(e++),k=y>>6&3,w=y>>3&7,S=y>>2&1,T=y&3,x=t.getUint8(e++),A=[];for(let C=0;C<x;C++){let _=t.getUint8(e++),U=_>>7&1,F=_&63,R=t.getUint16(e,!1);e+=2;let H=[];for(let $=0;$<R;$++){let X=t.getUint16(e,!1);e+=2,H.push(i.subarray(e,e+X)),e+=X}A.push({arrayCompleteness:U,nalUnitType:F,nalUnits:H})}return{configurationVersion:r,generalProfileSpace:a,generalTierFlag:s,generalProfileIdc:o,generalProfileCompatibilityFlags:c,generalConstraintIndicatorFlags:u,generalLevelIdc:d,minSpatialSegmentationIdc:l,parallelismType:m,chromaFormatIdc:f,bitDepthLumaMinus8:h,bitDepthChromaMinus8:g,avgFrameRate:b,constantFrameRate:k,numTemporalLayers:w,temporalIdNested:S,lengthSizeMinusOne:T,arrays:A}}catch(t){return console.error("Error deserializing HEVC Decoder Configuration Record:",t),null}},yn=i=>{let t=new V(i);if(t.readBits(2)!==2)return null;let r=t.readBits(1),a=(t.readBits(1)<<1)+r;if(a===3&&t.skipBits(1),t.readBits(1)===1||t.readBits(1)!==0||(t.skipBits(2),t.readBits(24)!==4817730))return null;let u=8;a>=2&&(u=t.readBits(1)?12:10);let d=t.readBits(3),l=0,m=0;if(d!==7)if(m=t.readBits(1),a===1||a===3){let A=t.readBits(1),C=t.readBits(1);l=!A&&!C?3:A&&!C?2:1,t.skipBits(1)}else l=1;else l=3,m=1;let f=t.readBits(16),h=t.readBits(16),g=f+1,b=h+1,y=g*b,k=j(pt).level;for(let x of pt)if(y<=x.maxPictureSize){k=x.level;break}return{profile:a,level:k,bitDepth:u,chromaSubsampling:l,videoFullRangeFlag:m,colourPrimaries:d===2?1:d===1?6:2,transferCharacteristics:d===2?1:d===1?6:2,matrixCoefficients:d===7?0:d===2?1:d===1?6:2}},Ho=function*(i){let t=new V(i),e=()=>{let r=0;for(let n=0;n<8;n++){let a=t.readAlignedByte();if(r|=(a&127)<<n*7,!(a&128))break;if(n===7&&a&128)return null}return r>=2**32-1?null:r};for(;t.getBitsLeft()>=8;){t.skipBits(1);let r=t.readBits(4),n=t.readBits(1),a=t.readBits(1);t.skipBits(1),n&&t.skipBits(8);let s;if(a){let o=e();if(o===null)return;s=o}else s=Math.floor(t.getBitsLeft()/8);p(t.pos%8===0),yield{type:r,data:i.subarray(t.pos/8,t.pos/8+s)},t.skipBits(s*8)}},wn=i=>{for(let{type:t,data:e}of Ho(i)){if(t!==1)continue;let r=new V(e),n=r.readBits(3),a=r.readBits(1),s=r.readBits(1),o=0,c=0,u=0;if(s)o=r.readBits(5);else{if(r.readBits(1)&&(r.skipBits(32),r.skipBits(32),r.readBits(1)))return null;let x=r.readBits(1);x&&(u=r.readBits(5),r.skipBits(32),r.skipBits(5),r.skipBits(5));let A=r.readBits(5);for(let C=0;C<=A;C++){r.skipBits(12);let _=r.readBits(5);if(C===0&&(o=_),_>7){let F=r.readBits(1);C===0&&(c=F)}if(x&&r.readBits(1)){let R=u+1;r.skipBits(R),r.skipBits(R),r.skipBits(1)}r.readBits(1)&&r.skipBits(4)}}let d=r.readBits(4),l=r.readBits(4),m=d+1;r.skipBits(m);let f=l+1;r.skipBits(f);let h=0;if(s?h=0:h=r.readBits(1),h&&(r.skipBits(4),r.skipBits(3)),r.skipBits(1),r.skipBits(1),r.skipBits(1),!s){r.skipBits(1),r.skipBits(1),r.skipBits(1),r.skipBits(1);let T=r.readBits(1);T&&(r.skipBits(1),r.skipBits(1));let x=r.readBits(1),A=0;x?A=2:A=r.readBits(1),A>0&&(r.readBits(1)||r.skipBits(1)),T&&r.skipBits(3)}r.skipBits(1),r.skipBits(1),r.skipBits(1);let g=r.readBits(1),b=8;n===2&&g?b=r.readBits(1)?12:10:n<=2&&(b=g?10:8);let y=0;n!==1&&(y=r.readBits(1));let k=1,w=1,S=0;return y||(n===0?(k=1,w=1):n===1?(k=0,w=0):b===12&&(k=r.readBits(1),k&&(w=r.readBits(1))),k&&w&&(S=r.readBits(2))),{profile:n,level:o,tier:c,bitDepth:b,monochrome:y,chromaSubsamplingX:k,chromaSubsamplingY:w,chromaSamplePosition:S}}return null},Mt=i=>{let t=D(i),e=t.getUint8(9),r=t.getUint16(10,!0),n=t.getUint32(12,!0),a=t.getInt16(16,!0),s=t.getUint8(18),o=null;return s&&(o=i.subarray(19,21+e)),{outputChannelCount:e,preSkip:r,inputSampleRate:n,outputGain:a,channelMappingFamily:s,channelMappingTable:o}},Nu=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],qo=i=>{let t=i[0]>>3;return{durationInSamples:Nu[t]}},Tn=i=>{if(i.length<7)throw new Error("Setup header is too short.");if(i[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...i.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");let e=i.length,r=new Uint8Array(e);for(let l=0;l<e;l++)r[l]=i[e-1-l];let n=new V(r),a=0;for(;n.getBitsLeft()>97;)if(n.readBits(1)===1){a=n.pos;break}if(a===0)throw new Error("Invalid Setup header: framing bit not found.");let s=0,o=!1,c=0;for(;n.getBitsLeft()>=97;){let l=n.pos,m=n.readBits(8),f=n.readBits(16),h=n.readBits(16);if(m>63||f!==0||h!==0){n.pos=l;break}if(n.skipBits(1),s++,s>64)break;n.clone().readBits(6)+1===s&&(o=!0,c=s)}if(!o)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error(`Unsupported mode count: ${c}.`);let u=c;n.pos=0,n.skipBits(a);let d=Array(u).fill(0);for(let l=u-1;l>=0;l--)n.skipBits(40),d[l]=n.readBits(1);return{modeBlockflags:d}},vr=(i,t,e)=>{switch(i){case"avc":{for(let r of ts(e,t)){let n=e[r.offset],a=gt(n);if(a>=1&&a<=4)return"delta";if(a===5)return"key";if(a===6&&(!fi()||To()>=144)){let s=e.subarray(r.offset,r.offset+r.length),o=gn(s),c=1;do{let u=0;for(;;){let m=o[c++];if(m===void 0||(u+=m,m<255))break}let d=0;for(;;){let m=o[c++];if(m===void 0||(d+=m,m<255))break}if(u===6){let m=new V(o);m.pos=8*c;let f=v(m),h=m.readBits(1);if(f===0&&h===1)return"key"}c+=d}while(c<o.length-1)}}return"delta"}case"hevc":{for(let r of is(e,t)){let n=tt(e[r.offset]);if(n<16)return"delta";if(n<=23)return"key"}return"delta"}case"vp8":return(e[0]&1)===0?"key":"delta";case"vp9":{let r=new V(e);if(r.readBits(2)!==2)return null;let n=r.readBits(1);return(r.readBits(1)<<1)+n===3&&r.skipBits(1),r.readBits(1)?null:r.readBits(1)===0?"key":"delta"}case"av1":{let r=!1;for(let{type:n,data:a}of Ho(e))if(n===1){let s=new V(a);s.skipBits(4),r=!!s.readBits(1)}else if(n===3||n===6||n===7){if(r)return"key";let s=new V(a);return s.readBits(1)?null:s.readBits(2)===0?"key":"delta"}return null}default:J(i),p(!1)}};var bi=(i,t)=>{let e=D(i),r=0,n=e.getUint32(r,!0);r+=4;let a=fe.decode(i.subarray(r,r+n));r+=n,n>0&&(t.raw??={},t.raw.vendor??=a);let s=e.getUint32(r,!0);r+=4;for(let o=0;o<s;o++){let c=e.getUint32(r,!0);r+=4;let u=fe.decode(i.subarray(r,r+c));r+=c;let d=u.indexOf("=");if(d===-1)continue;let l=u.slice(0,d).toUpperCase(),m=u.slice(d+1);switch(t.raw??={},t.raw[l]??=m,l){case"TITLE":t.title??=m;break;case"DESCRIPTION":t.description??=m;break;case"ARTIST":t.artist??=m;break;case"ALBUM":t.album??=m;break;case"ALBUMARTIST":t.albumArtist??=m;break;case"COMMENT":t.comment??=m;break;case"LYRICS":t.lyrics??=m;break;case"TRACKNUMBER":{let f=m.split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(t.trackNumber??=h),g&&Number.isInteger(g)&&g>0&&(t.tracksTotal??=g)}break;case"TRACKTOTAL":{let f=Number.parseInt(m,10);Number.isInteger(f)&&f>0&&(t.tracksTotal??=f)}break;case"DISCNUMBER":{let f=m.split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(t.discNumber??=h),g&&Number.isInteger(g)&&g>0&&(t.discsTotal??=g)}break;case"DISCTOTAL":{let f=Number.parseInt(m,10);Number.isInteger(f)&&f>0&&(t.discsTotal??=f)}break;case"DATE":{let f=new Date(m);Number.isNaN(f.getTime())||(t.date??=f)}break;case"GENRE":t.genre??=m;break;case"METADATA_BLOCK_PICTURE":{let f=xo(m),h=D(f),g=h.getUint32(0,!1),b=h.getUint32(4,!1),y=String.fromCharCode(...f.subarray(8,8+b)),k=h.getUint32(8+b,!1),w=fe.decode(f.subarray(12+b,12+b+k)),S=h.getUint32(b+k+28),T=f.subarray(b+k+32,b+k+32+S);t.images??=[],t.images.push({data:T,mimeType:y,kind:g===3?"coverFront":g===4?"coverBack":"unknown",name:void 0,description:w||void 0})}break}}},ki=(i,t,e)=>{let r=[i],a=G.encode("Mediabunny"),s=new Uint8Array(4+a.length),o=new DataView(s.buffer);o.setUint32(0,a.length,!0),s.set(a,4),r.push(s);let c=new Set,u=(h,g)=>{let b=`${h}=${g}`,y=G.encode(b);s=new Uint8Array(4+y.length),o=new DataView(s.buffer),o.setUint32(0,y.length,!0),s.set(y,4),r.push(s),c.add(h)};for(let{key:h,value:g}of Ne(t))switch(h){case"title":u("TITLE",g);break;case"description":u("DESCRIPTION",g);break;case"artist":u("ARTIST",g);break;case"album":u("ALBUM",g);break;case"albumArtist":u("ALBUMARTIST",g);break;case"genre":u("GENRE",g);break;case"date":{let b=t.raw?.DATE??t.raw?.date;b&&typeof b=="string"?u("DATE",b):u("DATE",g.toISOString().slice(0,10))}break;case"comment":u("COMMENT",g);break;case"lyrics":u("LYRICS",g);break;case"trackNumber":u("TRACKNUMBER",g.toString());break;case"tracksTotal":u("TRACKTOTAL",g.toString());break;case"discNumber":u("DISCNUMBER",g.toString());break;case"discsTotal":u("DISCTOTAL",g.toString());break;case"images":{if(!e)break;for(let b of g){let y=b.kind==="coverFront"?3:b.kind==="coverBack"?4:0,k=new Uint8Array(b.mimeType.length);for(let A=0;A<b.mimeType.length;A++)k[A]=b.mimeType.charCodeAt(A);let w=G.encode(b.description??""),S=new Uint8Array(8+k.length+4+w.length+16+4+b.data.length),T=D(S);T.setUint32(0,y,!1),T.setUint32(4,k.length,!1),S.set(k,8),T.setUint32(8+k.length,w.length,!1),S.set(w,12+k.length),T.setUint32(28+k.length+w.length,b.data.length,!1),S.set(b.data,32+k.length+w.length);let x=Co(S);u("METADATA_BLOCK_PICTURE",x)}}break;case"raw":break;default:J(h)}if(t.raw)for(let h in t.raw){let g=t.raw[h]??t.raw[h.toLowerCase()];h==="vendor"||g==null||c.has(h)||typeof g=="string"&&u(h,g)}let d=new Uint8Array(4);D(d).setUint32(0,c.size,!0),r.splice(2,0,d);let l=r.reduce((h,g)=>h+g.length,0),m=new Uint8Array(l),f=0;for(let h of r)m.set(h,f),f+=h.length;return m};var he=class{constructor(t){this.input=t}};var yi=class{static supports(t,e){return!1}},wi=class{static supports(t,e){return!1}},Ti=class{static supports(t,e){return!1}},Si=class{static supports(t,e){return!1}},Ir=[],Ar=[],Zt=[],Jt=[],jo=i=>{if(i.prototype instanceof yi){let t=i;if(Ir.includes(t)){console.warn("Video decoder already registered.");return}Ir.push(t)}else if(i.prototype instanceof wi){let t=i;if(Ar.includes(t)){console.warn("Audio decoder already registered.");return}Ar.push(t)}else throw new TypeError("Decoder must be a CustomVideoDecoder or CustomAudioDecoder.")},Ko=i=>{if(i.prototype instanceof Ti){let t=i;if(Zt.includes(t)){console.warn("Video encoder already registered.");return}Zt.push(t)}else if(i.prototype instanceof Si){let t=i;if(Jt.includes(t)){console.warn("Audio encoder already registered.");return}Jt.push(t)}else throw new TypeError("Encoder must be a CustomVideoEncoder or CustomAudioEncoder.")};var oe=new Uint8Array(0),L=class i{constructor(t,e,r,n,a=-1,s,o){this.data=t;this.type=e;this.timestamp=r;this.duration=n;this.sequenceNumber=a;if(t===oe&&s===void 0)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(s===void 0&&(s=t.byteLength),!(t instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(e!=="key"&&e!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(r))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(n)||n<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(a))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(s)||s<0)throw new TypeError("byteLength must be a non-negative integer.");if(o!==void 0&&(typeof o!="object"||!o))throw new TypeError("sideData, when provided, must be an object.");if(o?.alpha!==void 0&&!(o.alpha instanceof Uint8Array))throw new TypeError("sideData.alpha, when provided, must be a Uint8Array.");if(o?.alphaByteLength!==void 0&&(!Number.isInteger(o.alphaByteLength)||o.alphaByteLength<0))throw new TypeError("sideData.alphaByteLength, when provided, must be a non-negative integer.");this.byteLength=s,this.sideData=o??{},this.sideData.alpha&&this.sideData.alphaByteLength===void 0&&(this.sideData.alphaByteLength=this.sideData.alpha.byteLength)}get isMetadataOnly(){return this.data===oe}get microsecondTimestamp(){return Math.trunc(Ye*this.timestamp)}get microsecondDuration(){return Math.trunc(Ye*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}alphaToEncodedVideoChunk(t=this.type){if(!this.sideData.alpha)throw new TypeError("This packet does not contain alpha side data.");if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.sideData.alpha,type:t,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(t,e){if(!(t instanceof EncodedVideoChunk||t instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");let r=new Uint8Array(t.byteLength);return t.copyTo(r),new i(r,t.type,t.timestamp/1e6,(t.duration??0)/1e6,void 0,void 0,e)}clone(t){if(t!==void 0&&(typeof t!="object"||t===null))throw new TypeError("options, when provided, must be an object.");if(t?.data!==void 0&&!(t.data instanceof Uint8Array))throw new TypeError("options.data, when provided, must be a Uint8Array.");if(t?.type!==void 0&&t.type!=="key"&&t.type!=="delta")throw new TypeError('options.type, when provided, must be either "key" or "delta".');if(t?.timestamp!==void 0&&!Number.isFinite(t.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&!Number.isFinite(t.duration))throw new TypeError("options.duration, when provided, must be a number.");if(t?.sequenceNumber!==void 0&&!Number.isFinite(t.sequenceNumber))throw new TypeError("options.sequenceNumber, when provided, must be a number.");if(t?.sideData!==void 0&&(typeof t.sideData!="object"||t.sideData===null))throw new TypeError("options.sideData, when provided, must be an object.");return new i(t?.data??this.data,t?.type??this.type,t?.timestamp??this.timestamp,t?.duration??this.duration,t?.sequenceNumber??this.sequenceNumber,this.byteLength,t?.sideData??this.sideData)}};var Go=i=>{let r=i,n=4096,a=0,s=12,o=0;for(r<0&&(r=-r,a=128),r+=33,r>8191&&(r=8191);(r&n)!==n&&s>=5;)n>>=1,s--;return o=r>>s-4&15,~(a|s-5<<4|o)&255},Qo=i=>{let e=0,r=0,n=~i;n&128&&(n&=-129,e=-1),r=((n&240)>>4)+5;let a=(1<<r|(n&15)<<r-4|1<<r-5)-33;return e===0?a:-a},$o=i=>{let e=2048,r=0,n=11,a=0,s=i;for(s<0&&(s=-s,r=128),s>4095&&(s=4095);(s&e)!==e&&n>=5;)e>>=1,n--;return a=s>>(n===4?1:n-4)&15,(r|n-4<<4|a)^85},Xo=i=>{let t=0,e=0,r=i^85;r&128&&(r&=-129,t=-1),e=((r&240)>>4)+4;let n=0;return e!==4?n=1<<e|(r&15)<<e-4|1<<e-5:n=r<<1|1,t===0?n:-n};un();var Yo=-1/0,Zo=-1/0,Ci=null;typeof FinalizationRegistry<"u"&&(Ci=new FinalizationRegistry(i=>{let t=Date.now();i.type==="video"?(t-Yo>=1e3&&(console.error("A VideoSample was garbage collected without first being closed. For proper resource management, make sure to call close() on all your VideoSamples as soon as you're done using them."),Yo=t),typeof VideoFrame<"u"&&i.data instanceof VideoFrame&&i.data.close()):(t-Zo>=1e3&&(console.error("An AudioSample was garbage collected without first being closed. For proper resource management, make sure to call close() on all your AudioSamples as soon as you're done using them."),Zo=t),typeof AudioData<"u"&&i.data instanceof AudioData&&i.data.close())}));var Sn=["I420","I420P10","I420P12","I420A","I420AP10","I420AP12","I422","I422P10","I422P12","I422A","I422AP10","I422AP12","I444","I444P10","I444P12","I444A","I444AP10","I444AP12","NV12","RGBA","RGBX","BGRA","BGRX"],Lu=new Set(Sn),le=class i{constructor(t,e){this._closed=!1;if(t instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&t instanceof SharedArrayBuffer||ArrayBuffer.isView(t)){if(!e||typeof e!="object")throw new TypeError("init must be an object.");if(e.format===void 0||!Lu.has(e.format))throw new TypeError("init.format must be one of: "+Sn.join(", "));if(!Number.isInteger(e.codedWidth)||e.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(e.codedHeight)||e.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(e.timestamp))throw new TypeError("init.timestamp must be a number.");if(e.duration!==void 0&&(!Number.isFinite(e.duration)||e.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=W(t).slice(),this._layout=e.layout??Wu(e.format,e.codedWidth,e.codedHeight),this.format=e.format,this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight,this.rotation=e.rotation??0,this.timestamp=e.timestamp,this.duration=e.duration??0,this.colorSpace=new rr(e.colorSpace)}else if(typeof VideoFrame<"u"&&t instanceof VideoFrame){if(e?.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(e?.timestamp!==void 0&&!Number.isFinite(e?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(e?.duration!==void 0&&(!Number.isFinite(e.duration)||e.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=t,this._layout=null,this.format=t.format,this.codedWidth=t.displayWidth,this.codedHeight=t.displayHeight,this.rotation=e?.rotation??0,this.timestamp=e?.timestamp??t.timestamp/1e6,this.duration=e?.duration??(t.duration??0)/1e6,this.colorSpace=new rr(t.colorSpace)}else if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof SVGImageElement<"u"&&t instanceof SVGImageElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas){if(!e||typeof e!="object")throw new TypeError("init must be an object.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(e.timestamp))throw new TypeError("init.timestamp must be a number.");if(e.duration!==void 0&&(!Number.isFinite(e.duration)||e.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new i(new VideoFrame(t,{timestamp:Math.trunc(e.timestamp*Ye),duration:Math.trunc((e.duration??0)*Ye)||void 0}),e);let r=0,n=0;if("naturalWidth"in t?(r=t.naturalWidth,n=t.naturalHeight):"videoWidth"in t?(r=t.videoWidth,n=t.videoHeight):"width"in t&&(r=Number(t.width),n=Number(t.height)),!r||!n)throw new TypeError("Could not determine dimensions.");let a=new OffscreenCanvas(r,n),s=a.getContext("2d",{alpha:Ze(),willReadFrequently:!0});p(s),s.drawImage(t,0,0),this._data=a,this._layout=null,this.format="RGBX",this.codedWidth=r,this.codedHeight=n,this.rotation=e.rotation??0,this.timestamp=e.timestamp,this.duration=e.duration??0,this.colorSpace=new rr({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.");Ci?.register(this,{type:"video",data:this._data},this)}get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(Ye*this.timestamp)}get microsecondDuration(){return Math.trunc(Ye*this.duration)}get hasAlpha(){return this.format&&this.format.includes("A")}clone(){if(this._closed)throw new Error("VideoSample is closed.");return p(this._data!==null),er(this._data)?new i(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?(p(this._layout),new i(this._data,{format:this.format,layout:this._layout,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})):new i(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(Ci?.unregister(this),er(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(t={}){if(Jo(t),this._closed)throw new Error("VideoSample is closed.");if(this.format===null)throw new Error("Cannot get allocation size when format is null. Sorry!");if(p(this._data!==null),!er(this._data)&&(t.colorSpace||t.format&&t.format!==this.format||t.layout||t.rect)){let e=this.toVideoFrame(),r=e.allocationSize(t);return e.close(),r}return er(this._data)?this._data.allocationSize(t):this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(t,e={}){if(!kr(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(Jo(e),this._closed)throw new Error("VideoSample is closed.");if(this.format===null)throw new Error("Cannot copy video sample data when format is null. Sorry!");if(p(this._data!==null),!er(this._data)&&(e.colorSpace||e.format&&e.format!==this.format||e.layout||e.rect)){let r=this.toVideoFrame(),n=await r.copyTo(t,e);return r.close(),n}if(er(this._data))return this._data.copyTo(t,e);if(this._data instanceof Uint8Array)return p(this._layout),W(t).set(this._data),this._layout;{let n=this._data.getContext("2d");p(n);let a=n.getImageData(0,0,this.codedWidth,this.codedHeight);return W(t).set(a.data),[{offset:0,stride:4*this.codedWidth}]}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return p(this._data!==null),er(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0})}draw(t,e,r,n,a,s,o,c,u){let d=0,l=0,m=this.displayWidth,f=this.displayHeight,h=0,g=0,b=this.displayWidth,y=this.displayHeight;if(s!==void 0?(d=e,l=r,m=n,f=a,h=s,g=o,c!==void 0?(b=c,y=u):(b=m,y=f)):(h=e,g=r,n!==void 0&&(b=n,y=a)),!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(d))throw new TypeError("sx must be a number.");if(!Number.isFinite(l))throw new TypeError("sy must be a number.");if(!Number.isFinite(m)||m<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(f)||f<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(h))throw new TypeError("dx must be a number.");if(!Number.isFinite(g))throw new TypeError("dy must be a number.");if(!Number.isFinite(b)||b<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(y)||y<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");({sx:d,sy:l,sWidth:m,sHeight:f}=this._rotateSourceRegion(d,l,m,f,this.rotation));let k=this.toCanvasImageSource();t.save();let w=h+b/2,S=g+y/2;t.translate(w,S),t.rotate(this.rotation*Math.PI/180);let T=this.rotation%180===0?1:b/y;t.scale(1/T,T),t.drawImage(k,d,l,m,f,-b/2,-y/2,b,y),t.restore()}drawWithFit(t,e){if(!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!["fill","contain","cover"].includes(e.fit))throw new TypeError("options.fit must be 'fill', 'contain', or 'cover'.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180, or 270.");e.crop!==void 0&&vi(e.crop,"options.");let r=t.canvas.width,n=t.canvas.height,a=e.rotation??this.rotation,[s,o]=a%180===0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth];e.crop&&Pi(e.crop,s,o);let c,u,d,l,{sx:m,sy:f,sWidth:h,sHeight:g}=this._rotateSourceRegion(e.crop?.left??0,e.crop?.top??0,e.crop?.width??s,e.crop?.height??o,a);if(e.fit==="fill")c=0,u=0,d=r,l=n;else{let[y,k]=e.crop?[e.crop.width,e.crop.height]:[s,o],w=e.fit==="contain"?Math.min(r/y,n/k):Math.max(r/y,n/k);d=y*w,l=k*w,c=(r-d)/2,u=(n-l)/2}t.save();let b=a%180===0?1:d/l;t.translate(r/2,n/2),t.rotate(a*Math.PI/180),t.scale(1/b,b),t.translate(-r/2,-n/2),t.drawImage(this.toCanvasImageSource(),m,f,h,g,c,u,d,l),t.restore()}_rotateSourceRegion(t,e,r,n,a){return a===90?[t,e,r,n]=[e,this.codedHeight-t-r,n,r]:a===180?[t,e]=[this.codedWidth-t-r,this.codedHeight-e-n]:a===270&&([t,e,r,n]=[this.codedWidth-e-n,t,n,r]),{sx:t,sy:e,sWidth:r,sHeight:n}}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(p(this._data!==null),this._data instanceof Uint8Array){let t=this.toVideoFrame();return queueMicrotask(()=>t.close()),t}else return this._data}setRotation(t){if(![0,90,180,270].includes(t))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}setDuration(t){if(!Number.isFinite(t)||t<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=t}[Symbol.dispose](){this.close()}},rr=class{constructor(t){this.primaries=t?.primaries??null,this.transfer=t?.transfer??null,this.matrix=t?.matrix??null,this.fullRange=t?.fullRange??null}toJSON(){return{primaries:this.primaries,transfer:this.transfer,matrix:this.matrix,fullRange:this.fullRange}}},er=i=>typeof VideoFrame<"u"&&i instanceof VideoFrame,Pi=(i,t,e)=>{i.left=Math.min(i.left,t),i.top=Math.min(i.top,e),i.width=Math.min(i.width,t-i.left),i.height=Math.min(i.height,e-i.top),p(i.width>=0),p(i.height>=0)},vi=(i,t)=>{if(!i||typeof i!="object")throw new TypeError(t+"crop, when provided, must be an object.");if(!Number.isInteger(i.left)||i.left<0)throw new TypeError(t+"crop.left must be a non-negative integer.");if(!Number.isInteger(i.top)||i.top<0)throw new TypeError(t+"crop.top must be a non-negative integer.");if(!Number.isInteger(i.width)||i.width<0)throw new TypeError(t+"crop.width must be a non-negative integer.");if(!Number.isInteger(i.height)||i.height<0)throw new TypeError(t+"crop.height must be a non-negative integer.")},Jo=i=>{if(!i||typeof i!="object")throw new TypeError("options must be an object.");if(i.colorSpace!==void 0&&!["display-p3","srgb"].includes(i.colorSpace))throw new TypeError("options.colorSpace, when provided, must be 'display-p3' or 'srgb'.");if(i.format!==void 0&&typeof i.format!="string")throw new TypeError("options.format, when provided, must be a string.");if(i.layout!==void 0){if(!Array.isArray(i.layout))throw new TypeError("options.layout, when provided, must be an array.");for(let t of i.layout){if(!t||typeof t!="object")throw new TypeError("Each entry in options.layout must be an object.");if(!Number.isInteger(t.offset)||t.offset<0)throw new TypeError("plane.offset must be a non-negative integer.");if(!Number.isInteger(t.stride)||t.stride<0)throw new TypeError("plane.stride must be a non-negative integer.")}}if(i.rect!==void 0){if(!i.rect||typeof i.rect!="object")throw new TypeError("options.rect, when provided, must be an object.");if(i.rect.x!==void 0&&(!Number.isInteger(i.rect.x)||i.rect.x<0))throw new TypeError("options.rect.x, when provided, must be a non-negative integer.");if(i.rect.y!==void 0&&(!Number.isInteger(i.rect.y)||i.rect.y<0))throw new TypeError("options.rect.y, when provided, must be a non-negative integer.");if(i.rect.width!==void 0&&(!Number.isInteger(i.rect.width)||i.rect.width<0))throw new TypeError("options.rect.width, when provided, must be a non-negative integer.");if(i.rect.height!==void 0&&(!Number.isInteger(i.rect.height)||i.rect.height<0))throw new TypeError("options.rect.height, when provided, must be a non-negative integer.")}},Wu=(i,t,e)=>{let r=Hu(i),n=[],a=0;for(let s of r){let o=Math.ceil(t/s.widthDivisor),c=Math.ceil(e/s.heightDivisor),u=o*s.sampleBytes,d=u*c;n.push({offset:a,stride:u}),a+=d}return n},Hu=i=>{let t=(e,r,n,a,s)=>{let o=[{sampleBytes:e,widthDivisor:1,heightDivisor:1},{sampleBytes:r,widthDivisor:n,heightDivisor:a},{sampleBytes:r,widthDivisor:n,heightDivisor:a}];return s&&o.push({sampleBytes:e,widthDivisor:1,heightDivisor:1}),o};switch(i){case"I420":return t(1,1,2,2,!1);case"I420P10":case"I420P12":return t(2,2,2,2,!1);case"I420A":return t(1,1,2,2,!0);case"I420AP10":case"I420AP12":return t(2,2,2,2,!0);case"I422":return t(1,1,2,1,!1);case"I422P10":case"I422P12":return t(2,2,2,1,!1);case"I422A":return t(1,1,2,1,!0);case"I422AP10":case"I422AP12":return t(2,2,2,1,!0);case"I444":return t(1,1,1,1,!1);case"I444P10":case"I444P12":return t(2,2,1,1,!1);case"I444A":return t(1,1,1,1,!0);case"I444AP10":case"I444AP12":return t(2,2,1,1,!0);case"NV12":return[{sampleBytes:1,widthDivisor:1,heightDivisor:1},{sampleBytes:2,widthDivisor:2,heightDivisor:2}];case"RGBA":case"RGBX":case"BGRA":case"BGRX":return[{sampleBytes:4,widthDivisor:1,heightDivisor:1}];default:J(i),p(!1)}},as=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]),ye=class i{constructor(t){this._closed=!1;if(xi(t)){if(t.format===null)throw new TypeError("AudioData with null format is not supported.");this._data=t,this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=t.numberOfFrames,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp/1e6,this.duration=t.numberOfFrames/t.sampleRate}else{if(!t||typeof t!="object")throw new TypeError("Invalid AudioDataInit: must be an object.");if(!as.has(t.format))throw new TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(t.sampleRate)||t.sampleRate<=0)throw new TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(t.numberOfChannels)||t.numberOfChannels===0)throw new TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp must be a number.");let e=t.data.byteLength/(tr(t.format)*t.numberOfChannels);if(!Number.isInteger(e))throw new TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=e,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp,this.duration=e/t.sampleRate;let r;if(t.data instanceof ArrayBuffer)r=new Uint8Array(t.data);else if(ArrayBuffer.isView(t.data))r=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.byteLength);else throw new TypeError("Invalid AudioDataInit: data is not a BufferSource.");let n=this.numberOfFrames*this.numberOfChannels*tr(this.format);if(r.byteLength<n)throw new TypeError("Invalid AudioDataInit: insufficient data size.");this._data=r}Ci?.register(this,{type:"audio",data:this._data},this)}get microsecondTimestamp(){return Math.trunc(Ye*this.timestamp)}get microsecondDuration(){return Math.trunc(Ye*this.duration)}allocationSize(t){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(t.format!==void 0&&!as.has(t.format))throw new TypeError("Invalid format.");if(t.frameOffset!==void 0&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(t.frameCount!==void 0&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let e=t.format??this.format,r=t.frameOffset??0;if(r>=this.numberOfFrames)throw new RangeError("frameOffset out of range");let n=t.frameCount!==void 0?t.frameCount:this.numberOfFrames-r;if(n>this.numberOfFrames-r)throw new RangeError("frameCount out of range");let a=tr(e),s=Er(e);if(s&&t.planeIndex>=this.numberOfChannels)throw new RangeError("planeIndex out of range");if(!s&&t.planeIndex!==0)throw new RangeError("planeIndex out of range");return(s?n:n*this.numberOfChannels)*a}copyTo(t,e){if(!kr(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(e.planeIndex)||e.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(e.format!==void 0&&!as.has(e.format))throw new TypeError("Invalid format.");if(e.frameOffset!==void 0&&(!Number.isInteger(e.frameOffset)||e.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(e.frameCount!==void 0&&(!Number.isInteger(e.frameCount)||e.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let{planeIndex:r,format:n,frameCount:a,frameOffset:s}=e,o=this.format,c=n??this.format;if(!c)throw new Error("Destination format not determined");let u=this.numberOfFrames,d=this.numberOfChannels,l=s??0;if(l>=u)throw new RangeError("frameOffset out of range");let m=a!==void 0?a:u-l;if(m>u-l)throw new RangeError("frameCount out of range");let f=tr(c),h=Er(c);if(h&&r>=d)throw new RangeError("planeIndex out of range");if(!h&&r!==0)throw new RangeError("planeIndex out of range");let b=(h?m:m*d)*f;if(t.byteLength<b)throw new RangeError("Destination buffer is too small");let y=D(t),k=tc(c);if(xi(this._data))Et()&&d>2&&c!==o?qu(this._data,y,o,c,d,r,l,m):this._data.copyTo(t,{planeIndex:r,frameOffset:l,frameCount:m,format:c});else{let w=this._data,S=D(w),T=ec(o),x=tr(o),A=Er(o);for(let C=0;C<m;C++)if(h){let _=C*f,U;A?U=(r*u+(C+l))*x:U=((C+l)*d+r)*x;let F=T(S,U);k(y,_,F)}else for(let _=0;_<d;_++){let F=(C*d+_)*f,R;A?R=(_*u+(C+l))*x:R=((C+l)*d+_)*x;let H=T(S,R);k(y,F,H)}}}clone(){if(this._closed)throw new Error("AudioSample is closed.");if(xi(this._data)){let t=new i(this._data.clone());return t.setTimestamp(this.timestamp),t}else return new i({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data})}close(){this._closed||(Ci?.unregister(this),xi(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw new Error("AudioSample is closed.");if(xi(this._data)){if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(Er(this.format)){let t=this.allocationSize({planeIndex:0,format:this.format}),e=new ArrayBuffer(t*this.numberOfChannels);for(let r=0;r<this.numberOfChannels;r++)this.copyTo(new Uint8Array(e,r*t,t),{planeIndex:r,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:e})}else{let t=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(t,{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}}else return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data.buffer instanceof ArrayBuffer?this._data.buffer:this._data.slice()})}toAudioBuffer(){if(this._closed)throw new Error("AudioSample is closed.");let t=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),e=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let r=0;r<this.numberOfChannels;r++)this.copyTo(e,{planeIndex:r,format:"f32-planar"}),t.copyToChannel(e,r);return t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}[Symbol.dispose](){this.close()}static*_fromAudioBuffer(t,e){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=48e3*5,n=t.numberOfChannels,a=t.sampleRate,s=t.length,o=Math.floor(r/n),c=0,u=s;for(;u>0;){let d=Math.min(o,u),l=new Float32Array(n*d);for(let m=0;m<n;m++)t.copyFromChannel(l.subarray(m*d,(m+1)*d),m,c);yield new i({format:"f32-planar",sampleRate:a,numberOfFrames:d,numberOfChannels:n,timestamp:e+c/a,data:l}),c+=d,u-=d}}static fromAudioBuffer(t,e){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=48e3*5,n=t.numberOfChannels,a=t.sampleRate,s=t.length,o=Math.floor(r/n),c=0,u=s,d=[];for(;u>0;){let l=Math.min(o,u),m=new Float32Array(n*l);for(let h=0;h<n;h++)t.copyFromChannel(m.subarray(h*l,(h+1)*l),h,c);let f=new i({format:"f32-planar",sampleRate:a,numberOfFrames:l,numberOfChannels:n,timestamp:e+c/a,data:m});d.push(f),c+=l,u-=l}return d}},tr=i=>{switch(i){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":return 4;case"f32":case"f32-planar":return 4;default:throw new Error("Unknown AudioSampleFormat")}},Er=i=>{switch(i){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},ec=i=>{switch(i){case"u8":case"u8-planar":return(t,e)=>(t.getUint8(e)-128)/128;case"s16":case"s16-planar":return(t,e)=>t.getInt16(e,!0)/32768;case"s32":case"s32-planar":return(t,e)=>t.getInt32(e,!0)/2147483648;case"f32":case"f32-planar":return(t,e)=>t.getFloat32(e,!0)}},tc=i=>{switch(i){case"u8":case"u8-planar":return(t,e,r)=>t.setUint8(e,ae((r+1)*127.5,0,255));case"s16":case"s16-planar":return(t,e,r)=>t.setInt16(e,ae(Math.round(r*32767),-32768,32767),!0);case"s32":case"s32-planar":return(t,e,r)=>t.setInt32(e,ae(Math.round(r*2147483647),-2147483648,2147483647),!0);case"f32":case"f32-planar":return(t,e,r)=>t.setFloat32(e,r,!0)}},xi=i=>typeof AudioData<"u"&&i instanceof AudioData,qu=(i,t,e,r,n,a,s,o)=>{let c=ec(e),u=tc(r),d=tr(e),l=tr(r),m=Er(e);if(Er(r))if(m){let h=new ArrayBuffer(o*d),g=D(h);i.copyTo(h,{planeIndex:a,frameOffset:s,frameCount:o,format:e});for(let b=0;b<o;b++){let y=b*d,k=b*l,w=c(g,y);u(t,k,w)}}else{let h=new ArrayBuffer(o*n*d),g=D(h);i.copyTo(h,{planeIndex:0,frameOffset:s,frameCount:o,format:e});for(let b=0;b<o;b++){let y=(b*n+a)*d,k=b*l,w=c(g,y);u(t,k,w)}}else if(m){let h=o*d,g=new ArrayBuffer(h),b=D(g);for(let y=0;y<n;y++){i.copyTo(g,{planeIndex:y,frameOffset:s,frameCount:o,format:e});for(let k=0;k<o;k++){let w=k*d,S=(k*n+y)*l,T=c(b,w);u(t,S,T)}}}else{let h=new ArrayBuffer(o*n*d),g=D(h);i.copyTo(h,{planeIndex:0,frameOffset:s,frameCount:o,format:e});for(let b=0;b<o;b++)for(let y=0;y<n;y++){let k=b*n+y,w=k*d,S=k*l,T=c(g,w);u(t,S,T)}}};var _r=i=>{if(!i||typeof i!="object")throw new TypeError("options must be an object.");if(i.metadataOnly!==void 0&&typeof i.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.");if(i.verifyKeyPackets!==void 0&&typeof i.verifyKeyPackets!="boolean")throw new TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(i.verifyKeyPackets&&i.metadataOnly)throw new TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},bt=i=>{if(!_t(i))throw new TypeError("timestamp must be a number.")},ss=(i,t,e)=>e.verifyKeyPackets?t.then(async r=>{if(!r||r.type==="delta")return r;let n=await i.determinePacketType(r);return n&&(r.type=n),r}):t,We=class{constructor(t){if(!(t instanceof Bt))throw new TypeError("track must be an InputTrack.");this._track=t}getFirstPacket(t={}){if(_r(t),this._track.input._disposed)throw new de;return ss(this._track,this._track._backing.getFirstPacket(t),t)}getPacket(t,e={}){if(bt(t),_r(e),this._track.input._disposed)throw new de;return ss(this._track,this._track._backing.getPacket(t,e),e)}getNextPacket(t,e={}){if(!(t instanceof L))throw new TypeError("packet must be an EncodedPacket.");if(_r(e),this._track.input._disposed)throw new de;return ss(this._track,this._track._backing.getNextPacket(t,e),e)}async getKeyPacket(t,e={}){if(bt(t),_r(e),this._track.input._disposed)throw new de;if(!e.verifyKeyPackets)return this._track._backing.getKeyPacket(t,e);let r=await this._track._backing.getKeyPacket(t,e);return r&&(p(r.type==="key"),await this._track.determinePacketType(r)==="delta"?this.getKeyPacket(r.timestamp-1/this._track.timeResolution,e):r)}async getNextKeyPacket(t,e={}){if(!(t instanceof L))throw new TypeError("packet must be an EncodedPacket.");if(_r(e),this._track.input._disposed)throw new de;if(!e.verifyKeyPackets)return this._track._backing.getNextKeyPacket(t,e);let r=await this._track._backing.getNextKeyPacket(t,e);return r&&(p(r.type==="key"),await this._track.determinePacketType(r)==="delta"?this.getNextKeyPacket(r,e):r)}packets(t,e,r={}){if(t!==void 0&&!(t instanceof L))throw new TypeError("startPacket must be an EncodedPacket.");if(t!==void 0&&t.isMetadataOnly&&!r?.metadataOnly)throw new TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(e!==void 0&&!(e instanceof L))throw new TypeError("endPacket must be an EncodedPacket.");if(_r(r),this._track.input._disposed)throw new de;let n=[],{promise:a,resolve:s}=Q(),{promise:o,resolve:c}=Q(),u=!1,d=!1,l=null,m=[],f=()=>Math.max(2,m.length);(async()=>{let g=t??await this.getFirstPacket(r);for(;g&&!d&&!this._track.input._disposed&&!(e&&g.sequenceNumber>=e?.sequenceNumber);){if(n.length>f()){({promise:o,resolve:c}=Q()),await o;continue}n.push(g),s(),{promise:a,resolve:s}=Q(),g=await this.getNextPacket(g,r)}u=!0,s()})().catch(g=>{l||(l=g,s())});let h=this._track;return{async next(){for(;;){if(h.input._disposed)throw new de;if(d)return{value:void 0,done:!0};if(l)throw l;if(n.length>0){let g=n.shift(),b=performance.now();for(m.push(b);m.length>0&&b-m[0]>=1e3;)m.shift();return c(),{value:g,done:!1}}else{if(u)return{value:void 0,done:!0};await a}}},async return(){return d=!0,c(),s(),{value:void 0,done:!0}},async throw(g){throw g},[Symbol.asyncIterator](){return this}}}},Ii=class{constructor(t,e){this.onSample=t;this.onError=e}},Fr=class{mediaSamplesInRange(t=0,e=1/0){bt(t),bt(e);let r=[],n=!1,a=null,{promise:s,resolve:o}=Q(),{promise:c,resolve:u}=Q(),d=!1,l=!1,m=!1,f=null;(async()=>{let b=await this._createDecoder(x=>{if(u(),x.timestamp>=e&&(l=!0),l){x.close();return}a&&(x.timestamp>t?(r.push(a),n=!0):a.close()),x.timestamp>=t&&(r.push(x),n=!0),a=n?null:x,r.length>0&&(o(),{promise:s,resolve:o}=Q())},x=>{f||(f=x,o())}),y=this._createPacketSink(),k=await y.getKeyPacket(t,{verifyKeyPackets:!0})??await y.getFirstPacket(),w=k,T=y.packets(k??void 0,void 0);for(await T.next();w&&!l&&!this._track.input._disposed;){let x=rc(r.length);if(r.length+b.getDecodeQueueSize()>x){({promise:c,resolve:u}=Q()),await c;continue}b.decode(w);let A=await T.next();if(A.done)break;w=A.value}await T.return(),!m&&!this._track.input._disposed&&await b.flush(),b.close(),!n&&a&&r.push(a),d=!0,o()})().catch(b=>{f||(f=b,o())});let h=this._track,g=()=>{a?.close();for(let b of r)b.close()};return{async next(){for(;;){if(h.input._disposed)throw g(),new de;if(m)return{value:void 0,done:!0};if(f)throw g(),f;if(r.length>0){let b=r.shift();return u(),{value:b,done:!1}}else if(!d)await s;else return{value:void 0,done:!0}}},async return(){return m=!0,l=!0,u(),o(),g(),{value:void 0,done:!0}},async throw(b){throw b},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(t){ho(t);let e=po(t),r=[],n=[],{promise:a,resolve:s}=Q(),{promise:o,resolve:c}=Q(),u=!1,d=!1,l=null,m=g=>{n.push(g),s(),{promise:a,resolve:s}=Q()};(async()=>{let g=await this._createDecoder(x=>{if(c(),d){x.close();return}let A=0;for(;r.length>0&&x.timestamp-r[0]>-1e-10;)A++,r.shift();if(A>0)for(let C=0;C<A;C++)m(C<A-1?x.clone():x);else x.close()},x=>{l||(l=x,s())}),b=this._createPacketSink(),y=null,k=null,w=-1,S=async()=>{p(k);let x=k;for(g.decode(x);x.sequenceNumber<w;){let A=rc(n.length);for(;n.length+g.getDecodeQueueSize()>A&&!d;)({promise:o,resolve:c}=Q()),await o;if(d)break;let C=await b.getNextPacket(x);p(C),g.decode(C),x=C}w=-1},T=async()=>{await g.flush();for(let x=0;x<r.length;x++)m(null);r.length=0};for await(let x of e){if(bt(x),d||this._track.input._disposed)break;let A=await b.getPacket(x),C=A&&await b.getKeyPacket(x,{verifyKeyPackets:!0});if(!C){w!==-1&&(await S(),await T()),m(null),y=null;continue}y&&(C.sequenceNumber!==k.sequenceNumber||A.timestamp<y.timestamp)&&(await S(),await T()),r.push(A.timestamp),w=Math.max(A.sequenceNumber,w),y=A,k=C}!d&&!this._track.input._disposed&&(w!==-1&&await S(),await T()),g.close(),u=!0,s()})().catch(g=>{l||(l=g,s())});let f=this._track,h=()=>{for(let g of n)g?.close()};return{async next(){for(;;){if(f.input._disposed)throw h(),new de;if(d)return{value:void 0,done:!0};if(l)throw h(),l;if(n.length>0){let g=n.shift();return p(g!==void 0),c(),{value:g,done:!1}}else if(!u)await a;else return{value:void 0,done:!0}}},async return(){return d=!0,c(),s(),h(),{value:void 0,done:!0}},async throw(g){throw g},[Symbol.asyncIterator](){return this}}}},rc=i=>i===0?40:8,os=class extends Ii{constructor(e,r,n,a,s,o){super(e,r);this.codec=n;this.decoderConfig=a;this.rotation=s;this.timeResolution=o;this.decoder=null;this.customDecoder=null;this.customDecoderCallSerializer=new vt;this.customDecoderQueueSize=0;this.inputTimestamps=[];this.sampleQueue=[];this.currentPacketIndex=0;this.raslSkipped=!1;this.alphaDecoder=null;this.alphaHadKeyframe=!1;this.colorQueue=[];this.alphaQueue=[];this.merger=null;this.mergerCreationFailed=!1;this.decodedAlphaChunkCount=0;this.alphaDecoderQueueSize=0;this.nullAlphaFrameQueue=[];this.currentAlphaPacketIndex=0;this.alphaRaslSkipped=!1;let c=Ir.find(u=>u.supports(n,a));if(c)this.customDecoder=new c,this.customDecoder.codec=n,this.customDecoder.config=a,this.customDecoder.onSample=u=>{if(!(u instanceof le))throw new TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(u)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{let u=l=>{if(this.alphaQueue.length>0){let m=this.alphaQueue.shift();p(m!==void 0),this.mergeAlpha(l,m)}else this.colorQueue.push(l)};if(n==="avc"&&this.decoderConfig.description&&fi()){let l=kn(W(this.decoderConfig.description));if(l&&l.sequenceParameterSets.length>0){let m=gi(l.sequenceParameterSets[0]);m&&m.frameMbsOnlyFlag===0&&(this.decoderConfig={...this.decoderConfig,hardwareAcceleration:"prefer-software"})}}let d=new Error("Decoding error").stack;this.decoder=new VideoDecoder({output:l=>{try{u(l)}catch(m){this.onError(m)}},error:l=>{l.stack=d,this.onError(l)}}),this.decoder.configure(this.decoderConfig)}}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(p(this.decoder),Math.max(this.decoder.decodeQueueSize,this.alphaDecoder?.decodeQueueSize??0))}decode(e){if(this.codec==="hevc"&&this.currentPacketIndex>0&&!this.raslSkipped){if(this.hasHevcRaslPicture(e.data))return;this.raslSkipped=!0}if(this.customDecoder)this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--);else{if(p(this.decoder),Et()||$a(this.inputTimestamps,e.timestamp,r=>r),fi()&&this.currentPacketIndex===0&&this.codec==="avc"){let r=[];for(let a of ts(e.data,this.decoderConfig)){let s=gt(e.data[a.offset]);s>=20&&s<=31||r.push(e.data.subarray(a.offset,a.offset+a.length))}let n=zo(r,this.decoderConfig);e=new L(n,e.type,e.timestamp,e.duration)}this.decoder.decode(e.toEncodedVideoChunk()),this.decodeAlphaData(e)}this.currentPacketIndex++}decodeAlphaData(e){if(!e.sideData.alpha||this.mergerCreationFailed){this.pushNullAlphaFrame();return}if(!this.merger)try{this.merger=new cs}catch(n){console.error("Due to an error, only color data will be decoded.",n),this.mergerCreationFailed=!0,this.decodeAlphaData(e);return}if(!this.alphaDecoder){let n=s=>{if(this.alphaDecoderQueueSize--,this.colorQueue.length>0){let o=this.colorQueue.shift();p(o!==void 0),this.mergeAlpha(o,s)}else this.alphaQueue.push(s);for(this.decodedAlphaChunkCount++;this.nullAlphaFrameQueue.length>0&&this.nullAlphaFrameQueue[0]===this.decodedAlphaChunkCount;)if(this.nullAlphaFrameQueue.shift(),this.colorQueue.length>0){let o=this.colorQueue.shift();p(o!==void 0),this.mergeAlpha(o,null)}else this.alphaQueue.push(null)},a=new Error("Decoding error").stack;this.alphaDecoder=new VideoDecoder({output:s=>{try{n(s)}catch(o){this.onError(o)}},error:s=>{s.stack=a,this.onError(s)}}),this.alphaDecoder.configure(this.decoderConfig)}let r=vr(this.codec,this.decoderConfig,e.sideData.alpha);if(this.alphaHadKeyframe||(this.alphaHadKeyframe=r==="key"),this.alphaHadKeyframe){if(this.codec==="hevc"&&this.currentAlphaPacketIndex>0&&!this.alphaRaslSkipped){if(this.hasHevcRaslPicture(e.sideData.alpha)){this.pushNullAlphaFrame();return}this.alphaRaslSkipped=!0}this.currentAlphaPacketIndex++,this.alphaDecoder.decode(e.alphaToEncodedVideoChunk(r??e.type)),this.alphaDecoderQueueSize++}else this.pushNullAlphaFrame()}pushNullAlphaFrame(){this.alphaDecoderQueueSize===0?this.alphaQueue.push(null):this.nullAlphaFrameQueue.push(this.decodedAlphaChunkCount+this.alphaDecoderQueueSize)}hasHevcRaslPicture(e){for(let r of is(e,this.decoderConfig)){let n=tt(e[r.offset]);if(n===8||n===9)return!0}return!1}sampleHandler(e){if(Et()){if(this.sampleQueue.length>0&&e.timestamp>=j(this.sampleQueue).timestamp){for(let r of this.sampleQueue)this.finalizeAndEmitSample(r);this.sampleQueue.length=0}$a(this.sampleQueue,e,r=>r.timestamp)}else{let r=this.inputTimestamps.shift();p(r!==void 0),e.setTimestamp(r),this.finalizeAndEmitSample(e)}}finalizeAndEmitSample(e){e.setTimestamp(Math.round(e.timestamp*this.timeResolution)/this.timeResolution),e.setDuration(Math.round(e.duration*this.timeResolution)/this.timeResolution),e.setRotation(this.rotation),this.onSample(e)}mergeAlpha(e,r){if(!r){let s=new le(e);this.sampleHandler(s);return}p(this.merger),this.merger.update(e,r),e.close(),r.close();let n=new VideoFrame(this.merger.canvas,{timestamp:e.timestamp,duration:e.duration??void 0}),a=new le(n);this.sampleHandler(a)}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(p(this.decoder),await Promise.all([this.decoder.flush(),this.alphaDecoder?.flush()]),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.alphaHadKeyframe=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue.length=0,this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1),Et()){for(let e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}this.currentPacketIndex=0,this.raslSkipped=!1}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(p(this.decoder),this.decoder.close(),this.alphaDecoder?.close(),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.merger?.close());for(let e of this.sampleQueue)e.close();this.sampleQueue.length=0}},cs=class{constructor(){typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(300,150):this.canvas=document.createElement("canvas");let t=this.canvas.getContext("webgl2",{premultipliedAlpha:!1});if(!t)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=t,this.program=this.createProgram(),this.vao=this.createVAO(),this.colorTexture=this.createTexture(),this.alphaTexture=this.createTexture(),this.gl.useProgram(this.program),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_colorTexture"),0),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_alphaTexture"),1)}createProgram(){let t=this.createShader(this.gl.VERTEX_SHADER,`#version 300 es
			in vec2 a_position;
			in vec2 a_texCoord;
			out vec2 v_texCoord;
			
			void main() {
				gl_Position = vec4(a_position, 0.0, 1.0);
				v_texCoord = a_texCoord;
			}
		`),e=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_colorTexture;
			uniform sampler2D u_alphaTexture;
			in vec2 v_texCoord;
			out vec4 fragColor;
			
			void main() {
				vec3 color = texture(u_colorTexture, v_texCoord).rgb;
				float alpha = texture(u_alphaTexture, v_texCoord).r;
				fragColor = vec4(color, alpha);
			}
		`),r=this.gl.createProgram();return this.gl.attachShader(r,t),this.gl.attachShader(r,e),this.gl.linkProgram(r),r}createShader(t,e){let r=this.gl.createShader(t);return this.gl.shaderSource(r,e),this.gl.compileShader(r),r}createVAO(){let t=this.gl.createVertexArray();this.gl.bindVertexArray(t);let e=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW);let n=this.gl.getAttribLocation(this.program,"a_position"),a=this.gl.getAttribLocation(this.program,"a_texCoord");return this.gl.enableVertexAttribArray(n),this.gl.vertexAttribPointer(n,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(a),this.gl.vertexAttribPointer(a,2,this.gl.FLOAT,!1,16,8),t}createTexture(){let t=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),t}update(t,e){(t.displayWidth!==this.canvas.width||t.displayHeight!==this.canvas.height)&&(this.canvas.width=t.displayWidth,this.canvas.height=t.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colorTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.alphaTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}},Rt=class extends Fr{constructor(t){if(!(t instanceof Ie))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._track=t}async _createDecoder(t,e){if(!await this._track.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._track.codec,n=this._track.rotation,a=await this._track.getDecoderConfig(),s=this._track.timeResolution;return p(r&&a),new os(t,e,r,a,n,s)}_createPacketSink(){return new We(this._track)}async getSample(t){bt(t);for await(let e of this.mediaSamplesAtTimestamps([t]))return e;throw new Error("Internal error: Iterator returned nothing.")}samples(t=0,e=1/0){return this.mediaSamplesInRange(t,e)}samplesAtTimestamps(t){return this.mediaSamplesAtTimestamps(t)}},Mr=class{constructor(t,e={}){this._nextCanvasIndex=0;if(!(t instanceof Ie))throw new TypeError("videoTrack must be an InputVideoTrack.");if(e&&typeof e!="object")throw new TypeError("options must be an object.");if(e.alpha!==void 0&&typeof e.alpha!="boolean")throw new TypeError("options.alpha, when provided, must be a boolean.");if(e.width!==void 0&&(!Number.isInteger(e.width)||e.width<=0))throw new TypeError("options.width, when defined, must be a positive integer.");if(e.height!==void 0&&(!Number.isInteger(e.height)||e.height<=0))throw new TypeError("options.height, when defined, must be a positive integer.");if(e.fit!==void 0&&!["fill","contain","cover"].includes(e.fit))throw new TypeError('options.fit, when provided, must be one of "fill", "contain", or "cover".');if(e.width!==void 0&&e.height!==void 0&&e.fit===void 0)throw new TypeError("When both options.width and options.height are provided, options.fit must also be provided.");if(e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180 or 270.");if(e.crop!==void 0&&vi(e.crop,"options."),e.poolSize!==void 0&&(typeof e.poolSize!="number"||!Number.isInteger(e.poolSize)||e.poolSize<0))throw new TypeError("poolSize must be a non-negative integer.");let r=e.rotation??t.rotation,[n,a]=r%180===0?[t.codedWidth,t.codedHeight]:[t.codedHeight,t.codedWidth],s=e.crop;s&&Pi(s,n,a);let[o,c]=s?[s.width,s.height]:[n,a],u=o/c;e.width!==void 0&&e.height===void 0?(o=e.width,c=Math.round(o/u)):e.width===void 0&&e.height!==void 0?(c=e.height,o=Math.round(c*u)):e.width!==void 0&&e.height!==void 0&&(o=e.width,c=e.height),this._videoTrack=t,this._alpha=e.alpha??!1,this._width=o,this._height=c,this._rotation=r,this._crop=s,this._fit=e.fit??"fill",this._videoSampleSink=new Rt(t),this._canvasPool=Array.from({length:e.poolSize??0},()=>null)}_videoSampleToWrappedCanvas(t){let e=this._canvasPool[this._nextCanvasIndex],r=!1;e||(typeof document<"u"?(e=document.createElement("canvas"),e.width=this._width,e.height=this._height):e=new OffscreenCanvas(this._width,this._height),this._canvasPool.length>0&&(this._canvasPool[this._nextCanvasIndex]=e),r=!0),this._canvasPool.length>0&&(this._nextCanvasIndex=(this._nextCanvasIndex+1)%this._canvasPool.length);let n=e.getContext("2d",{alpha:this._alpha||Ze()});p(n),n.resetTransform(),r||(!this._alpha&&Ze()?(n.fillStyle="black",n.fillRect(0,0,this._width,this._height)):n.clearRect(0,0,this._width,this._height)),t.drawWithFit(n,{fit:this._fit,rotation:this._rotation,crop:this._crop});let a={canvas:e,timestamp:t.timestamp,duration:t.duration};return t.close(),a}async getCanvas(t){bt(t);let e=await this._videoSampleSink.getSample(t);return e&&this._videoSampleToWrappedCanvas(e)}canvases(t=0,e=1/0){return mi(this._videoSampleSink.samples(t,e),r=>this._videoSampleToWrappedCanvas(r))}canvasesAtTimestamps(t){return mi(this._videoSampleSink.samplesAtTimestamps(t),e=>e&&this._videoSampleToWrappedCanvas(e))}},us=class extends Ii{constructor(e,r,n,a){super(e,r);this.decoder=null;this.customDecoder=null;this.customDecoderCallSerializer=new vt;this.customDecoderQueueSize=0;this.currentTimestamp=null;let s=c=>{(this.currentTimestamp===null||Math.abs(c.timestamp-this.currentTimestamp)>=c.duration)&&(this.currentTimestamp=c.timestamp);let u=this.currentTimestamp;if(this.currentTimestamp+=c.duration,c.numberOfFrames===0){c.close();return}let d=a.sampleRate;c.setTimestamp(Math.round(u*d)/d),e(c)},o=Ar.find(c=>c.supports(n,a));if(o)this.customDecoder=new o,this.customDecoder.codec=n,this.customDecoder.config=a,this.customDecoder.onSample=c=>{if(!(c instanceof ye))throw new TypeError("The argument passed to onSample must be an AudioSample.");s(c)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{let c=new Error("Decoding error").stack;this.decoder=new AudioDecoder({output:u=>{try{s(new ye(u))}catch(d){this.onError(d)}},error:u=>{u.stack=c,this.onError(u)}}),this.decoder.configure(a)}}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(p(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(p(this.decoder),this.decoder.decode(e.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(p(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(p(this.decoder),this.decoder.close())}},ds=class extends Ii{constructor(e,r,n){super(e,r);this.decoderConfig=n;this.currentTimestamp=null;p(Y.includes(n.codec)),this.codec=n.codec;let{dataType:a,sampleSize:s,littleEndian:o}=ke(this.codec);switch(this.inputSampleSize=s,s){case 1:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint8(u)-2**7:a==="signed"?this.readInputValue=(c,u)=>c.getInt8(u):a==="ulaw"?this.readInputValue=(c,u)=>Qo(c.getUint8(u)):a==="alaw"?this.readInputValue=(c,u)=>Xo(c.getUint8(u)):p(!1);break;case 2:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint16(u,o)-2**15:a==="signed"?this.readInputValue=(c,u)=>c.getInt16(u,o):p(!1);break;case 3:a==="unsigned"?this.readInputValue=(c,u)=>Gt(c,u,o)-2**23:a==="signed"?this.readInputValue=(c,u)=>go(c,u,o):p(!1);break;case 4:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint32(u,o)-2**31:a==="signed"?this.readInputValue=(c,u)=>c.getInt32(u,o):a==="float"?this.readInputValue=(c,u)=>c.getFloat32(u,o):p(!1);break;case 8:a==="float"?this.readInputValue=(c,u)=>c.getFloat64(u,o):p(!1);break;default:J(s),p(!1)}switch(s){case 1:a==="ulaw"||a==="alaw"?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(c,u,d)=>c.setInt16(u,d,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(c,u,d)=>c.setUint8(u,d+2**7));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(c,u,d)=>c.setInt16(u,d,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(c,u,d)=>c.setInt32(u,d<<8,!0);break;case 4:this.outputSampleSize=4,a==="float"?(this.outputFormat="f32",this.writeOutputValue=(c,u,d)=>c.setFloat32(u,d,!0)):(this.outputFormat="s32",this.writeOutputValue=(c,u,d)=>c.setInt32(u,d,!0));break;case 8:this.outputSampleSize=4,this.outputFormat="f32",this.writeOutputValue=(c,u,d)=>c.setFloat32(u,d,!0);break;default:J(s),p(!1)}}getDecodeQueueSize(){return 0}decode(e){let r=D(e.data),n=e.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,a=n*this.decoderConfig.numberOfChannels*this.outputSampleSize,s=new ArrayBuffer(a),o=new DataView(s);for(let l=0;l<n*this.decoderConfig.numberOfChannels;l++){let m=l*this.inputSampleSize,f=l*this.outputSampleSize,h=this.readInputValue(r,m);this.writeOutputValue(o,f,h)}let c=n/this.decoderConfig.sampleRate;(this.currentTimestamp===null||Math.abs(e.timestamp-this.currentTimestamp)>=c)&&(this.currentTimestamp=e.timestamp);let u=this.currentTimestamp;this.currentTimestamp+=c;let d=new ye({format:this.outputFormat,data:s,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:n,timestamp:u});this.onSample(d)}async flush(){}close(){}},Dt=class extends Fr{constructor(t){if(!(t instanceof te))throw new TypeError("audioTrack must be an InputAudioTrack.");super(),this._track=t}async _createDecoder(t,e){if(!await this._track.canDecode())throw new Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._track.codec,n=await this._track.getDecoderConfig();return p(r&&n),Y.includes(n.codec)?new ds(t,e,n):new us(t,e,r,n)}_createPacketSink(){return new We(this._track)}async getSample(t){bt(t);for await(let e of this.mediaSamplesAtTimestamps([t]))return e;throw new Error("Internal error: Iterator returned nothing.")}samples(t=0,e=1/0){return this.mediaSamplesInRange(t,e)}samplesAtTimestamps(t){return this.mediaSamplesAtTimestamps(t)}},xn=class{constructor(t){if(!(t instanceof te))throw new TypeError("audioTrack must be an InputAudioTrack.");this._audioSampleSink=new Dt(t)}_audioSampleToWrappedArrayBuffer(t){let e={buffer:t.toAudioBuffer(),timestamp:t.timestamp,duration:t.duration};return t.close(),e}async getBuffer(t){bt(t);let e=await this._audioSampleSink.getSample(t);return e&&this._audioSampleToWrappedArrayBuffer(e)}buffers(t=0,e=1/0){return mi(this._audioSampleSink.samples(t,e),r=>this._audioSampleToWrappedArrayBuffer(r))}buffersAtTimestamps(t){return mi(this._audioSampleSink.samplesAtTimestamps(t),e=>e&&this._audioSampleToWrappedArrayBuffer(e))}};var Bt=class{constructor(t,e){this.input=t,this._backing=e}isVideoTrack(){return this instanceof Ie}isAudioTrack(){return this instanceof te}get id(){return this._backing.getId()}get internalCodecId(){return this._backing.getInternalCodecId()}get languageCode(){return this._backing.getLanguageCode()}get name(){return this._backing.getName()}get timeResolution(){return this._backing.getTimeResolution()}get disposition(){return this._backing.getDisposition()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(t=1/0){let e=new We(this),r=1/0,n=-1/0,a=0,s=0;for await(let o of e.packets(void 0,void 0,{metadataOnly:!0})){if(a>=t&&o.timestamp>=n)break;r=Math.min(r,o.timestamp),n=Math.max(n,o.timestamp+o.duration),a++,s+=o.byteLength}return{packetCount:a,averagePacketRate:a?Number((a/(n-r)).toPrecision(16)):0,averageBitrate:a?Number((8*s/(n-r)).toPrecision(16)):0}}},Ie=class extends Bt{constructor(t,e){super(t,e),this._backing=e}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){let t=await this._backing.getColorSpace();return t.primaries==="bt2020"||t.primaries==="smpte432"||t.transfer==="pg"||t.transfer==="hlg"||t.matrix==="bt2020-ncl"}canBeTransparent(){return this._backing.canBeTransparent()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let t=await this._backing.getDecoderConfig();if(!t)return!1;let e=this._backing.getCodec();return p(e!==null),Ir.some(n=>n.supports(e,t))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(t)).supported===!0}catch(t){return console.error("Error during decodability check:",t),!1}}async determinePacketType(t){if(!(t instanceof L))throw new TypeError("packet must be an EncodedPacket.");if(t.isMetadataOnly)throw new TypeError("packet must not be metadata-only to determine its type.");if(this.codec===null)return null;let e=await this.getDecoderConfig();return p(e),vr(this.codec,e,t.data)}},te=class extends Bt{constructor(t,e){super(t,e),this._backing=e}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let t=await this._backing.getDecoderConfig();if(!t)return!1;let e=this._backing.getCodec();return p(e!==null),Ar.some(r=>r.supports(e,t))||t.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(t)).supported===!0}catch(t){return console.error("Error during decodability check:",t),!1}}async determinePacketType(t){if(!(t instanceof L))throw new TypeError("packet must be an EncodedPacket.");return this.codec===null?null:"key"}};var Cn=i=>{let e=(i.hasVideo?"video/":i.hasAudio?"audio/":"application/")+(i.isQuickTime?"quicktime":"mp4");if(i.codecStrings.length>0){let r=[...new Set(i.codecStrings)];e+=`; codecs="${r.join(", ")}"`}return e};var He=8,kt=16,yt=i=>{let t=P(i),e=re(i,4),r=8;t===1&&(t=De(i),r=16);let a=t-r;return a<0?null:{name:e,totalSize:t,headerSize:r,contentSize:a}},Ot=i=>wt(i)/65536,Pn=i=>wt(i)/1073741824,vn=i=>{let t=0;for(let e=0;e<4;e++){t<<=7;let r=E(i);if(t|=r&127,(r&128)===0)break}return t},qe=i=>{let t=ce(i);return i.skip(2),t=Math.min(t,i.remainingLength),fe.decode(M(i,t))},nc=i=>{let t=yt(i);if(!t||t.name!=="data"||i.remainingLength<8)return null;let e=P(i);i.skip(4);let r=M(i,t.contentSize-8);switch(e){case 1:return fe.decode(r);case 2:return new TextDecoder("utf-16be").decode(r);case 13:return new Re(r,"image/jpeg");case 14:return new Re(r,"image/png");case 27:return new Re(r,"image/bmp");default:return r}};var In=class extends he{constructor(e){super(e);this.moovSlice=null;this.currentTrack=null;this.tracks=[];this.metadataPromise=null;this.movieTimescale=-1;this.movieDurationInTimescale=-1;this.isQuickTime=!1;this.metadataTags={};this.currentMetadataKeys=null;this.isFragmented=!1;this.fragmentTrackDefaults=[];this.currentFragment=null;this.lastReadFragment=null;this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),r=await Promise.all(e.map(n=>n.computeDuration()));return Math.max(0,...r)}async getTracks(){return await this.readMetadata(),this.tracks.map(e=>e.inputTrack)}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(r=>r.inputTrack.getCodecParameterString()));return Cn({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(r=>r.info?.type==="video"),hasAudio:this.tracks.some(r=>r.info?.type==="audio"),codecStrings:e.filter(Boolean)})}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let r=this.reader.requestSliceRange(e,He,kt);if(r instanceof Promise&&(r=await r),!r)break;let n=e,a=yt(r);if(!a)break;if(a.name==="ftyp"){let s=re(r,4);this.isQuickTime=s==="qt  "}else if(a.name==="moov"){let s=this.reader.requestSlice(r.filePos,a.contentSize);if(s instanceof Promise&&(s=await s),!s)break;this.moovSlice=s,this.readContiguousBoxes(this.moovSlice),this.tracks.sort((o,c)=>Number(c.disposition.default)-Number(o.disposition.default));for(let o of this.tracks){let c=o.editListPreviousSegmentDurations/this.movieTimescale;o.editListOffset-=Math.round(c*o.timescale)}break}e=n+a.totalSize}if(this.isFragmented&&this.reader.fileSize!==null){let r=this.reader.requestSlice(this.reader.fileSize-4,4);r instanceof Promise&&(r=await r),p(r);let n=P(r),a=this.reader.fileSize-n;if(a>=0&&a<=this.reader.fileSize-kt){let s=this.reader.requestSliceRange(a,He,kt);if(s instanceof Promise&&(s=await s),s){let o=yt(s);if(o&&o.name==="mfra"){let c=this.reader.requestSlice(s.filePos,o.contentSize);c instanceof Promise&&(c=await c),c&&this.readContiguousBoxes(c)}}}}})()}getSampleTableForTrack(e){if(e.sampleTable)return e.sampleTable;let r={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};e.sampleTable=r,p(this.moovSlice);let n=this.moovSlice.slice(e.sampleTableByteOffset);if(this.currentTrack=e,this.traverseBox(n),this.currentTrack=null,e.info?.type==="audio"&&e.info.codec&&Y.includes(e.info.codec)&&r.sampleCompositionTimeOffsets.length===0){p(e.info?.type==="audio");let s=ke(e.info.codec),o=[],c=[];for(let u=0;u<r.sampleToChunk.length;u++){let d=r.sampleToChunk[u],l=r.sampleToChunk[u+1],m=(l?l.startChunkIndex:r.chunkOffsets.length)-d.startChunkIndex;for(let f=0;f<m;f++){let h=d.startSampleIndex+f*d.samplesPerChunk,g=h+d.samplesPerChunk,b=z(r.sampleTimingEntries,h,_=>_.startIndex),y=r.sampleTimingEntries[b],k=z(r.sampleTimingEntries,g,_=>_.startIndex),w=r.sampleTimingEntries[k],S=y.startDecodeTimestamp+(h-y.startIndex)*y.delta,x=w.startDecodeTimestamp+(g-w.startIndex)*w.delta-S,A=j(o);A&&A.delta===x?A.count++:o.push({startIndex:d.startChunkIndex+f,startDecodeTimestamp:S,count:1,delta:x});let C=d.samplesPerChunk*s.sampleSize*e.info.numberOfChannels;c.push(C)}d.startSampleIndex=d.startChunkIndex,d.samplesPerChunk=1}r.sampleTimingEntries=o,r.sampleSizes=c}if(r.sampleCompositionTimeOffsets.length>0){r.presentationTimestamps=[];for(let s of r.sampleTimingEntries)for(let o=0;o<s.count;o++)r.presentationTimestamps.push({presentationTimestamp:s.startDecodeTimestamp+o*s.delta,sampleIndex:s.startIndex+o});for(let s of r.sampleCompositionTimeOffsets)for(let o=0;o<s.count;o++){let c=s.startIndex+o,u=r.presentationTimestamps[c];u&&(u.presentationTimestamp+=s.offset)}r.presentationTimestamps.sort((s,o)=>s.presentationTimestamp-o.presentationTimestamp),r.presentationTimestampIndexMap=Array(r.presentationTimestamps.length).fill(-1);for(let s=0;s<r.presentationTimestamps.length;s++)r.presentationTimestampIndexMap[r.presentationTimestamps[s].sampleIndex]=s}return r}async readFragment(e){if(this.lastReadFragment?.moofOffset===e)return this.lastReadFragment;let r=this.reader.requestSliceRange(e,He,kt);r instanceof Promise&&(r=await r),p(r);let n=yt(r);p(n?.name==="moof");let a=this.reader.requestSlice(e,n.totalSize);a instanceof Promise&&(a=await a),p(a),this.traverseBox(a);let s=this.lastReadFragment;p(s&&s.moofOffset===e);for(let[,o]of s.trackData){let c=o.track,{fragmentPositionCache:u}=c;if(!o.startTimestampIsFinal){let l=c.fragmentLookupTable.find(m=>m.moofOffset===s.moofOffset);if(l)ls(o,l.timestamp);else{let m=z(u,s.moofOffset-1,f=>f.moofOffset);if(m!==-1){let f=u[m];ls(o,f.endTimestamp)}}o.startTimestampIsFinal=!0}let d=z(u,o.startTimestamp,l=>l.startTimestamp);(d===-1||u[d].moofOffset!==s.moofOffset)&&u.splice(d+1,0,{moofOffset:s.moofOffset,startTimestamp:o.startTimestamp,endTimestamp:o.endTimestamp})}return s}readContiguousBoxes(e){let r=e.filePos;for(;e.filePos-r<=e.length-He&&this.traverseBox(e););}*iterateContiguousBoxes(e){let r=e.filePos;for(;e.filePos-r<=e.length-He;){let n=e.filePos,a=yt(e);if(!a)break;yield{boxInfo:a,slice:e},e.filePos=n+a.totalSize}}traverseBox(e){let r=e.filePos,n=yt(e);if(!n)return!1;let a=e.filePos,s=r+n.totalSize;switch(n.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":this.readContiguousBoxes(e.slice(a,n.contentSize));break;case"mvhd":{let o=E(e);e.skip(3),o===1?(e.skip(16),this.movieTimescale=P(e),this.movieDurationInTimescale=De(e)):(e.skip(8),this.movieTimescale=P(e),this.movieDurationInTimescale=P(e))}break;case"trak":{let o={id:-1,demuxer:this,inputTrack:null,disposition:{...Se},info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,internalCodecId:null,name:null,languageCode:ee,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:[],currentFragmentState:null,fragmentPositionCache:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=o,this.readContiguousBoxes(e.slice(a,n.contentSize)),o.id!==-1&&o.timescale!==-1&&o.info!==null){if(o.info.type==="video"&&o.info.width!==-1){let c=o;o.inputTrack=new Ie(this.input,new ms(c)),this.tracks.push(o)}else if(o.info.type==="audio"&&o.info.numberOfChannels!==-1){let c=o;o.inputTrack=new te(this.input,new fs(c)),this.tracks.push(o)}}this.currentTrack=null}break;case"tkhd":{let o=this.currentTrack;if(!o)break;let c=E(e),d=!!(Ut(e)&1);if(o.disposition.default=d,c===0)e.skip(8),o.id=P(e),e.skip(4),o.durationInMovieTimescale=P(e);else if(c===1)e.skip(16),o.id=P(e),e.skip(4),o.durationInMovieTimescale=De(e);else throw new Error(`Incorrect track header version ${c}.`);e.skip(2*4+2+2+2+2);let l=[Ot(e),Ot(e),Pn(e),Ot(e),Ot(e),Pn(e),Ot(e),Ot(e),Pn(e)],m=It($t(Qu(l),90));p(m===0||m===90||m===180||m===270),o.rotation=m}break;case"elst":{let o=this.currentTrack;if(!o)break;let c=E(e);e.skip(3);let u=!1,d=0,l=P(e);for(let m=0;m<l;m++){let f=c===1?De(e):P(e),h=c===1?oc(e):wt(e),g=Ot(e);if(f!==0){if(u){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(h===-1){d+=f;continue}if(g!==1){console.warn("Unsupported edit list entry: media rate must be 1.");break}o.editListPreviousSegmentDurations=d,o.editListOffset=h,u=!0}}}break;case"mdhd":{let o=this.currentTrack;if(!o)break;let c=E(e);e.skip(3),c===0?(e.skip(8),o.timescale=P(e),o.durationInMediaTimescale=P(e)):c===1&&(e.skip(16),o.timescale=P(e),o.durationInMediaTimescale=De(e));let u=ce(e);if(u>0){o.languageCode="";for(let d=0;d<3;d++)o.languageCode=String.fromCharCode(96+(u&31))+o.languageCode,u>>=5;mt(o.languageCode)||(o.languageCode=ee)}}break;case"hdlr":{let o=this.currentTrack;if(!o)break;e.skip(8);let c=re(e,4);c==="vide"?o.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcType:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:c==="soun"&&(o.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{let o=this.currentTrack;if(!o)break;o.sampleTableByteOffset=r,this.readContiguousBoxes(e.slice(a,n.contentSize))}break;case"stsd":{let o=this.currentTrack;if(!o||o.info===null||o.sampleTable)break;let c=E(e);e.skip(3);let u=P(e);for(let d=0;d<u;d++){let l=e.filePos,m=yt(e);if(!m)break;o.internalCodecId=m.name;let f=m.name.toLowerCase();if(o.info.type==="video")f==="avc1"||f==="avc3"?(o.info.codec="avc",o.info.avcType=f==="avc1"?1:3):f==="hvc1"||f==="hev1"?o.info.codec="hevc":f==="vp08"?o.info.codec="vp8":f==="vp09"?o.info.codec="vp9":f==="av01"?o.info.codec="av1":console.warn(`Unsupported video codec (sample entry type '${m.name}').`),e.skip(6*1+2+2+2+3*4),o.info.width=ce(e),o.info.height=ce(e),e.skip(50),this.readContiguousBoxes(e.slice(e.filePos,l+m.totalSize-e.filePos));else{f==="mp4a"||(f==="opus"?o.info.codec="opus":f==="flac"?o.info.codec="flac":f==="twos"||f==="sowt"||f==="raw "||f==="in24"||f==="in32"||f==="fl32"||f==="fl64"||f==="lpcm"||f==="ipcm"||f==="fpcm"||(f==="ulaw"?o.info.codec="ulaw":f==="alaw"?o.info.codec="alaw":console.warn(`Unsupported audio codec (sample entry type '${m.name}').`))),e.skip(6*1+2);let h=ce(e);e.skip(3*2);let g=ce(e),b=ce(e);e.skip(2*2);let y=P(e)/65536;if(c===0&&h>0){if(h===1)e.skip(4),b=8*P(e),e.skip(2*4);else if(h===2){e.skip(4),y=En(e),g=P(e),e.skip(4),b=P(e);let k=P(e);if(e.skip(2*4),f==="lpcm"){let w=b+7>>3,S=!!(k&1),T=!!(k&2),x=k&4?-1:0;b>0&&b<=64&&(S?b===32&&(o.info.codec=T?"pcm-f32be":"pcm-f32"):x&1<<w-1?w===1?o.info.codec="pcm-s8":w===2?o.info.codec=T?"pcm-s16be":"pcm-s16":w===3?o.info.codec=T?"pcm-s24be":"pcm-s24":w===4&&(o.info.codec=T?"pcm-s32be":"pcm-s32"):w===1&&(o.info.codec="pcm-u8")),o.info.codec===null&&console.warn("Unsupported PCM format.")}}}o.info.codec==="opus"&&(y=Le),o.info.numberOfChannels=g,o.info.sampleRate=y,f==="twos"?b===8?o.info.codec="pcm-s8":b===16?o.info.codec="pcm-s16be":(console.warn(`Unsupported sample size ${b} for codec 'twos'.`),o.info.codec=null):f==="sowt"?b===8?o.info.codec="pcm-s8":b===16?o.info.codec="pcm-s16":(console.warn(`Unsupported sample size ${b} for codec 'sowt'.`),o.info.codec=null):f==="raw "?o.info.codec="pcm-u8":f==="in24"?o.info.codec="pcm-s24be":f==="in32"?o.info.codec="pcm-s32be":f==="fl32"?o.info.codec="pcm-f32be":f==="fl64"?o.info.codec="pcm-f64be":f==="ipcm"?o.info.codec="pcm-s16be":f==="fpcm"&&(o.info.codec="pcm-f32be"),this.readContiguousBoxes(e.slice(e.filePos,l+m.totalSize-e.filePos))}}}break;case"avcC":{let o=this.currentTrack;if(!o)break;p(o.info),o.info.codecDescription=M(e,n.contentSize)}break;case"hvcC":{let o=this.currentTrack;if(!o)break;p(o.info),o.info.codecDescription=M(e,n.contentSize)}break;case"vpcC":{let o=this.currentTrack;if(!o)break;p(o.info?.type==="video"),e.skip(4);let c=E(e),u=E(e),d=E(e),l=d>>4,m=d>>1&7,f=d&1,h=E(e),g=E(e),b=E(e);o.info.vp9CodecInfo={profile:c,level:u,bitDepth:l,chromaSubsampling:m,videoFullRangeFlag:f,colourPrimaries:h,transferCharacteristics:g,matrixCoefficients:b}}break;case"av1C":{let o=this.currentTrack;if(!o)break;p(o.info?.type==="video"),e.skip(1);let c=E(e),u=c>>5,d=c&31,l=E(e),m=l>>7,f=l>>6&1,h=l>>5&1,g=l>>4&1,b=l>>3&1,y=l>>2&1,k=l&3,w=u===2&&f?h?12:10:f?10:8;o.info.av1CodecInfo={profile:u,level:d,tier:m,bitDepth:w,monochrome:g,chromaSubsamplingX:b,chromaSubsamplingY:y,chromaSamplePosition:k}}break;case"colr":{let o=this.currentTrack;if(!o||(p(o.info?.type==="video"),re(e,4)!=="nclx"))break;let u=ce(e),d=ce(e),l=ce(e),m=!!(E(e)&128);o.info.colorSpace={primaries:Ht[u],transfer:qt[d],matrix:jt[l],fullRange:m}}break;case"wave":this.readContiguousBoxes(e.slice(a,n.contentSize));break;case"esds":{let o=this.currentTrack;if(!o)break;p(o.info?.type==="audio"),e.skip(4);let c=E(e);p(c===3),vn(e),e.skip(2);let u=E(e),d=(u&128)!==0,l=(u&64)!==0,m=(u&32)!==0;if(d&&e.skip(2),l){let y=E(e);e.skip(y)}m&&e.skip(2);let f=E(e);p(f===4);let h=vn(e),g=e.filePos,b=E(e);if(b===64||b===103?(o.info.codec="aac",o.info.aacCodecInfo={isMpeg2:b===103,objectType:null}):b===105||b===107?o.info.codec="mp3":b===221?o.info.codec="vorbis":console.warn(`Unsupported audio codec (objectTypeIndication ${b}) - discarding track.`),e.skip(12),h>e.filePos-g){let y=E(e);p(y===5);let k=vn(e);if(o.info.codecDescription=M(e,k),o.info.codec==="aac"){let w=ht(o.info.codecDescription);w.numberOfChannels!==null&&(o.info.numberOfChannels=w.numberOfChannels),w.sampleRate!==null&&(o.info.sampleRate=w.sampleRate)}}}break;case"enda":{let o=this.currentTrack;if(!o)break;p(o.info?.type==="audio"),ce(e)&255&&(o.info.codec==="pcm-s16be"?o.info.codec="pcm-s16":o.info.codec==="pcm-s24be"?o.info.codec="pcm-s24":o.info.codec==="pcm-s32be"?o.info.codec="pcm-s32":o.info.codec==="pcm-f32be"?o.info.codec="pcm-f32":o.info.codec==="pcm-f64be"&&(o.info.codec="pcm-f64"))}break;case"pcmC":{let o=this.currentTrack;if(!o)break;p(o.info?.type==="audio"),e.skip(4);let u=!!(E(e)&1),d=E(e);o.info.codec==="pcm-s16be"?u?d===16?o.info.codec="pcm-s16":d===24?o.info.codec="pcm-s24":d===32?o.info.codec="pcm-s32":(console.warn(`Invalid ipcm sample size ${d}.`),o.info.codec=null):d===16?o.info.codec="pcm-s16be":d===24?o.info.codec="pcm-s24be":d===32?o.info.codec="pcm-s32be":(console.warn(`Invalid ipcm sample size ${d}.`),o.info.codec=null):o.info.codec==="pcm-f32be"&&(u?d===32?o.info.codec="pcm-f32":d===64?o.info.codec="pcm-f64":(console.warn(`Invalid fpcm sample size ${d}.`),o.info.codec=null):d===32?o.info.codec="pcm-f32be":d===64?o.info.codec="pcm-f64be":(console.warn(`Invalid fpcm sample size ${d}.`),o.info.codec=null));break}case"dOps":{let o=this.currentTrack;if(!o)break;p(o.info?.type==="audio"),e.skip(1);let c=E(e),u=ce(e),d=P(e),l=Ai(e),m=E(e),f;m!==0?f=M(e,2+c):f=new Uint8Array(0);let h=new Uint8Array(19+f.byteLength),g=new DataView(h.buffer);g.setUint32(0,1332770163,!1),g.setUint32(4,1214603620,!1),g.setUint8(8,1),g.setUint8(9,c),g.setUint16(10,u,!0),g.setUint32(12,d,!0),g.setInt16(16,l,!0),g.setUint8(18,m),h.set(f,19),o.info.codecDescription=h,o.info.numberOfChannels=c}break;case"dfLa":{let o=this.currentTrack;if(!o)break;p(o.info?.type==="audio"),e.skip(4);let c=127,u=128,d=e.filePos;for(;e.filePos<s;){let g=E(e),b=Ut(e);if((g&c)===0){e.skip(10);let k=P(e),w=k>>>12,S=(k>>9&7)+1;o.info.sampleRate=w,o.info.numberOfChannels=S,e.skip(20)}else e.skip(b);if(g&u)break}let l=e.filePos;e.filePos=d;let m=M(e,l-d),f=new Uint8Array(4+m.byteLength);new DataView(f.buffer).setUint32(0,1716281667,!1),f.set(m,4),o.info.codecDescription=f}break;case"stts":{let o=this.currentTrack;if(!o||!o.sampleTable)break;e.skip(4);let c=P(e),u=0,d=0;for(let l=0;l<c;l++){let m=P(e),f=P(e);o.sampleTable.sampleTimingEntries.push({startIndex:u,startDecodeTimestamp:d,count:m,delta:f}),u+=m,d+=m*f}}break;case"ctts":{let o=this.currentTrack;if(!o||!o.sampleTable)break;e.skip(4);let c=P(e),u=0;for(let d=0;d<c;d++){let l=P(e),m=wt(e);o.sampleTable.sampleCompositionTimeOffsets.push({startIndex:u,count:l,offset:m}),u+=l}}break;case"stsz":{let o=this.currentTrack;if(!o||!o.sampleTable)break;e.skip(4);let c=P(e),u=P(e);if(c===0)for(let d=0;d<u;d++){let l=P(e);o.sampleTable.sampleSizes.push(l)}else o.sampleTable.sampleSizes.push(c)}break;case"stz2":{let o=this.currentTrack;if(!o||!o.sampleTable)break;e.skip(4),e.skip(3);let c=E(e),u=P(e),d=M(e,Math.ceil(u*c/8)),l=new V(d);for(let m=0;m<u;m++){let f=l.readBits(c);o.sampleTable.sampleSizes.push(f)}}break;case"stss":{let o=this.currentTrack;if(!o||!o.sampleTable)break;e.skip(4),o.sampleTable.keySampleIndices=[];let c=P(e);for(let u=0;u<c;u++){let d=P(e)-1;o.sampleTable.keySampleIndices.push(d)}o.sampleTable.keySampleIndices[0]!==0&&o.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{let o=this.currentTrack;if(!o||!o.sampleTable)break;e.skip(4);let c=P(e);for(let d=0;d<c;d++){let l=P(e)-1,m=P(e),f=P(e);o.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:l,samplesPerChunk:m,sampleDescriptionIndex:f})}let u=0;for(let d=0;d<o.sampleTable.sampleToChunk.length;d++)if(o.sampleTable.sampleToChunk[d].startSampleIndex=u,d<o.sampleTable.sampleToChunk.length-1){let m=o.sampleTable.sampleToChunk[d+1].startChunkIndex-o.sampleTable.sampleToChunk[d].startChunkIndex;u+=m*o.sampleTable.sampleToChunk[d].samplesPerChunk}}break;case"stco":{let o=this.currentTrack;if(!o||!o.sampleTable)break;e.skip(4);let c=P(e);for(let u=0;u<c;u++){let d=P(e);o.sampleTable.chunkOffsets.push(d)}}break;case"co64":{let o=this.currentTrack;if(!o||!o.sampleTable)break;e.skip(4);let c=P(e);for(let u=0;u<c;u++){let d=De(e);o.sampleTable.chunkOffsets.push(d)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(e.slice(a,n.contentSize));break;case"mehd":{let o=E(e);e.skip(3);let c=o===1?De(e):P(e);this.movieDurationInTimescale=c}break;case"trex":{e.skip(4);let o=P(e),c=P(e),u=P(e),d=P(e),l=P(e);this.fragmentTrackDefaults.push({trackId:o,defaultSampleDescriptionIndex:c,defaultSampleDuration:u,defaultSampleSize:d,defaultSampleFlags:l})}break;case"tfra":{let o=E(e);e.skip(3);let c=P(e),u=this.tracks.find(w=>w.id===c);if(!u)break;let d=P(e),l=(d&48)>>4,m=(d&12)>>2,f=d&3,h=[E,ce,Ut,P],g=h[l],b=h[m],y=h[f],k=P(e);for(let w=0;w<k;w++){let S=o===1?De(e):P(e),T=o===1?De(e):P(e);g(e),b(e),y(e),u.fragmentLookupTable.push({timestamp:S,moofOffset:T})}u.fragmentLookupTable.sort((w,S)=>w.timestamp-S.timestamp);for(let w=0;w<u.fragmentLookupTable.length-1;w++){let S=u.fragmentLookupTable[w],T=u.fragmentLookupTable[w+1];S.timestamp===T.timestamp&&(u.fragmentLookupTable.splice(w+1,1),w--)}}break;case"moof":this.currentFragment={moofOffset:r,moofSize:n.totalSize,implicitBaseDataOffset:r,trackData:new Map},this.readContiguousBoxes(e.slice(a,n.contentSize)),this.lastReadFragment=this.currentFragment,this.currentFragment=null;break;case"traf":if(p(this.currentFragment),this.readContiguousBoxes(e.slice(a,n.contentSize)),this.currentTrack){let o=this.currentFragment.trackData.get(this.currentTrack.id);if(o){let{currentFragmentState:c}=this.currentTrack;p(c),c.startTimestamp!==null&&(ls(o,c.startTimestamp),o.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{p(this.currentFragment),e.skip(1);let o=Ut(e),c=!!(o&1),u=!!(o&2),d=!!(o&8),l=!!(o&16),m=!!(o&32),f=!!(o&65536),h=!!(o&131072),g=P(e),b=this.tracks.find(k=>k.id===g);if(!b)break;let y=this.fragmentTrackDefaults.find(k=>k.trackId===g);this.currentTrack=b,b.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:y?.defaultSampleDescriptionIndex??null,defaultSampleDuration:y?.defaultSampleDuration??null,defaultSampleSize:y?.defaultSampleSize??null,defaultSampleFlags:y?.defaultSampleFlags??null,startTimestamp:null},c?b.currentFragmentState.baseDataOffset=De(e):h&&(b.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),u&&(b.currentFragmentState.sampleDescriptionIndex=P(e)),d&&(b.currentFragmentState.defaultSampleDuration=P(e)),l&&(b.currentFragmentState.defaultSampleSize=P(e)),m&&(b.currentFragmentState.defaultSampleFlags=P(e)),f&&(b.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{let o=this.currentTrack;if(!o)break;p(o.currentFragmentState);let c=E(e);e.skip(3);let u=c===0?P(e):De(e);o.currentFragmentState.startTimestamp=u}break;case"trun":{let o=this.currentTrack;if(!o)break;if(p(this.currentFragment),p(o.currentFragmentState),this.currentFragment.trackData.has(o.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}let c=E(e),u=Ut(e),d=!!(u&1),l=!!(u&4),m=!!(u&256),f=!!(u&512),h=!!(u&1024),g=!!(u&2048),b=P(e),y=o.currentFragmentState.baseDataOffset;d&&(y+=wt(e));let k=null;l&&(k=P(e));let w=y;if(b===0){this.currentFragment.implicitBaseDataOffset=w;break}let S=0,T={track:o,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(o.id,T);for(let C=0;C<b;C++){let _;m?_=P(e):(p(o.currentFragmentState.defaultSampleDuration!==null),_=o.currentFragmentState.defaultSampleDuration);let U;f?U=P(e):(p(o.currentFragmentState.defaultSampleSize!==null),U=o.currentFragmentState.defaultSampleSize);let F;h?F=P(e):(p(o.currentFragmentState.defaultSampleFlags!==null),F=o.currentFragmentState.defaultSampleFlags),C===0&&k!==null&&(F=k);let R=0;g&&(c===0?R=P(e):R=wt(e));let H=!(F&65536);T.samples.push({presentationTimestamp:S+R,duration:_,byteOffset:w,byteSize:U,isKeyFrame:H}),w+=U,S+=_}T.presentationTimestamps=T.samples.map((C,_)=>({presentationTimestamp:C.presentationTimestamp,sampleIndex:_})).sort((C,_)=>C.presentationTimestamp-_.presentationTimestamp);for(let C=0;C<T.presentationTimestamps.length;C++){let _=T.presentationTimestamps[C],U=T.samples[_.sampleIndex];if(T.firstKeyFrameTimestamp===null&&U.isKeyFrame&&(T.firstKeyFrameTimestamp=U.presentationTimestamp),C<T.presentationTimestamps.length-1){let F=T.presentationTimestamps[C+1];U.duration=F.presentationTimestamp-_.presentationTimestamp}}let x=T.samples[T.presentationTimestamps[0].sampleIndex],A=T.samples[j(T.presentationTimestamps).sampleIndex];T.startTimestamp=x.presentationTimestamp,T.endTimestamp=A.presentationTimestamp+A.duration,this.currentFragment.implicitBaseDataOffset=w}break;case"udta":{let o=this.iterateContiguousBoxes(e.slice(a,n.contentSize));for(let{boxInfo:c,slice:u}of o){if(c.name!=="meta"&&!this.currentTrack){let d=u.filePos;this.metadataTags.raw??={},c.name[0]==="\xA9"?this.metadataTags.raw[c.name]??=qe(u):this.metadataTags.raw[c.name]??=M(u,c.contentSize),u.filePos=d}switch(c.name){case"meta":u.skip(-c.headerSize),this.traverseBox(u);break;case"\xA9nam":case"name":this.currentTrack?this.currentTrack.name=fe.decode(M(u,c.contentSize)):this.metadataTags.title??=qe(u);break;case"\xA9des":this.currentTrack||(this.metadataTags.description??=qe(u));break;case"\xA9ART":this.currentTrack||(this.metadataTags.artist??=qe(u));break;case"\xA9alb":this.currentTrack||(this.metadataTags.album??=qe(u));break;case"albr":this.currentTrack||(this.metadataTags.albumArtist??=qe(u));break;case"\xA9gen":this.currentTrack||(this.metadataTags.genre??=qe(u));break;case"\xA9day":if(!this.currentTrack){let d=new Date(qe(u));Number.isNaN(d.getTime())||(this.metadataTags.date??=d)}break;case"\xA9cmt":this.currentTrack||(this.metadataTags.comment??=qe(u));break;case"\xA9lyr":this.currentTrack||(this.metadataTags.lyrics??=qe(u));break}}}break;case"meta":{if(this.currentTrack)break;let c=P(e)!==0;this.currentMetadataKeys=new Map,c?this.readContiguousBoxes(e.slice(a,n.contentSize)):this.readContiguousBoxes(e.slice(a+4,n.contentSize-4)),this.currentMetadataKeys=null}break;case"keys":{if(!this.currentMetadataKeys)break;e.skip(4);let o=P(e);for(let c=0;c<o;c++){let u=P(e);e.skip(4);let d=fe.decode(M(e,u-8));this.currentMetadataKeys.set(c+1,d)}}break;case"ilst":{if(!this.currentMetadataKeys)break;let o=this.iterateContiguousBoxes(e.slice(a,n.contentSize));for(let{boxInfo:c,slice:u}of o){let d=c.name,l=(d.charCodeAt(0)<<24)+(d.charCodeAt(1)<<16)+(d.charCodeAt(2)<<8)+d.charCodeAt(3);this.currentMetadataKeys.has(l)&&(d=this.currentMetadataKeys.get(l));let m=nc(u);switch(this.metadataTags.raw??={},this.metadataTags.raw[d]??=m,d){case"\xA9nam":case"titl":case"com.apple.quicktime.title":case"title":typeof m=="string"&&(this.metadataTags.title??=m);break;case"\xA9des":case"desc":case"dscp":case"com.apple.quicktime.description":case"description":typeof m=="string"&&(this.metadataTags.description??=m);break;case"\xA9ART":case"com.apple.quicktime.artist":case"artist":typeof m=="string"&&(this.metadataTags.artist??=m);break;case"\xA9alb":case"albm":case"com.apple.quicktime.album":case"album":typeof m=="string"&&(this.metadataTags.album??=m);break;case"aART":case"album_artist":typeof m=="string"&&(this.metadataTags.albumArtist??=m);break;case"\xA9cmt":case"com.apple.quicktime.comment":case"comment":typeof m=="string"&&(this.metadataTags.comment??=m);break;case"\xA9gen":case"gnre":case"com.apple.quicktime.genre":case"genre":typeof m=="string"&&(this.metadataTags.genre??=m);break;case"\xA9lyr":case"lyrics":typeof m=="string"&&(this.metadataTags.lyrics??=m);break;case"\xA9day":case"rldt":case"com.apple.quicktime.creationdate":case"date":if(typeof m=="string"){let f=new Date(m);Number.isNaN(f.getTime())||(this.metadataTags.date??=f)}break;case"covr":case"com.apple.quicktime.artwork":m instanceof Re?(this.metadataTags.images??=[],this.metadataTags.images.push({data:m.data,kind:"coverFront",mimeType:m.mimeType})):m instanceof Uint8Array&&(this.metadataTags.images??=[],this.metadataTags.images.push({data:m,kind:"coverFront",mimeType:"image/*"}));break;case"track":if(typeof m=="string"){let f=m.split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(this.metadataTags.trackNumber??=h),g&&Number.isInteger(g)&&g>0&&(this.metadataTags.tracksTotal??=g)}break;case"trkn":if(m instanceof Uint8Array&&m.length>=6){let f=D(m),h=f.getUint16(2,!1),g=f.getUint16(4,!1);h>0&&(this.metadataTags.trackNumber??=h),g>0&&(this.metadataTags.tracksTotal??=g)}break;case"disc":case"disk":if(m instanceof Uint8Array&&m.length>=6){let f=D(m),h=f.getUint16(2,!1),g=f.getUint16(4,!1);h>0&&(this.metadataTags.discNumber??=h),g>0&&(this.metadataTags.discsTotal??=g)}break}}}break}return e.filePos=s,!0}},An=class{constructor(t){this.internalTrack=t;this.packetToSampleIndex=new WeakMap;this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.internalCodecId}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}getDisposition(){return this.internalTrack.disposition}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(t){let e=await this.fetchPacketForSampleIndex(0,t);return e||!this.internalTrack.demuxer.isFragmented?e:this.performFragmentedLookup(null,r=>r.trackData.get(this.internalTrack.id)?{sampleIndex:0,correctSampleFound:!0}:{sampleIndex:-1,correctSampleFound:!1},-1/0,1/0,t)}mapTimestampIntoTimescale(t){return lt(t*this.internalTrack.timescale)+this.internalTrack.editListOffset}async getPacket(t,e){let r=this.mapTimestampIntoTimescale(t),n=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=ps(n,r),s=await this.fetchPacketForSampleIndex(a,e);return!ac(n)||!this.internalTrack.demuxer.isFragmented?s:this.performFragmentedLookup(null,o=>{let c=o.trackData.get(this.internalTrack.id);if(!c)return{sampleIndex:-1,correctSampleFound:!1};let u=z(c.presentationTimestamps,r,m=>m.presentationTimestamp),d=u!==-1?c.presentationTimestamps[u].sampleIndex:-1,l=u!==-1&&r<c.endTimestamp;return{sampleIndex:d,correctSampleFound:l}},r,r,e)}async getNextPacket(t,e){let r=this.packetToSampleIndex.get(t);if(r!==void 0)return this.fetchPacketForSampleIndex(r+1,e);let n=this.packetToFragmentLocation.get(t);if(n===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(n.fragment,a=>{if(a===n.fragment){let s=a.trackData.get(this.internalTrack.id);if(n.sampleIndex+1<s.samples.length)return{sampleIndex:n.sampleIndex+1,correctSampleFound:!0}}else if(a.trackData.get(this.internalTrack.id))return{sampleIndex:0,correctSampleFound:!0};return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,e)}async getKeyPacket(t,e){let r=this.mapTimestampIntoTimescale(t),n=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=ju(n,r),s=await this.fetchPacketForSampleIndex(a,e);return!ac(n)||!this.internalTrack.demuxer.isFragmented?s:this.performFragmentedLookup(null,o=>{let c=o.trackData.get(this.internalTrack.id);if(!c)return{sampleIndex:-1,correctSampleFound:!1};let u=yr(c.presentationTimestamps,m=>c.samples[m.sampleIndex].isKeyFrame&&m.presentationTimestamp<=r),d=u!==-1?c.presentationTimestamps[u].sampleIndex:-1,l=u!==-1&&r<c.endTimestamp;return{sampleIndex:d,correctSampleFound:l}},r,r,e)}async getNextKeyPacket(t,e){let r=this.packetToSampleIndex.get(t);if(r!==void 0){let a=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=Gu(a,r);return this.fetchPacketForSampleIndex(s,e)}let n=this.packetToFragmentLocation.get(t);if(n===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(n.fragment,a=>{if(a===n.fragment){let o=a.trackData.get(this.internalTrack.id).samples.findIndex((c,u)=>c.isKeyFrame&&u>n.sampleIndex);if(o!==-1)return{sampleIndex:o,correctSampleFound:!0}}else{let s=a.trackData.get(this.internalTrack.id);if(s&&s.firstKeyFrameTimestamp!==null){let o=s.samples.findIndex(c=>c.isKeyFrame);return p(o!==-1),{sampleIndex:o,correctSampleFound:!0}}}return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,e)}async fetchPacketForSampleIndex(t,e){if(t===-1)return null;let r=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),n=Ku(r,t);if(!n)return null;let a;if(e.metadataOnly)a=oe;else{let u=this.internalTrack.demuxer.reader.requestSlice(n.sampleOffset,n.sampleSize);u instanceof Promise&&(u=await u),p(u),a=M(u,n.sampleSize)}let s=(n.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,o=n.duration/this.internalTrack.timescale,c=new L(a,n.isKeyFrame?"key":"delta",s,o,t,n.sampleSize);return this.packetToSampleIndex.set(c,t),c}async fetchPacketInFragment(t,e,r){if(e===-1)return null;let a=t.trackData.get(this.internalTrack.id).samples[e];p(a);let s;if(r.metadataOnly)s=oe;else{let d=this.internalTrack.demuxer.reader.requestSlice(a.byteOffset,a.byteSize);d instanceof Promise&&(d=await d),p(d),s=M(d,a.byteSize)}let o=(a.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,c=a.duration/this.internalTrack.timescale,u=new L(s,a.isKeyFrame?"key":"delta",o,c,t.moofOffset+e,a.byteSize);return this.packetToFragmentLocation.set(u,{fragment:t,sampleIndex:e}),u}async performFragmentedLookup(t,e,r,n,a){let s=this.internalTrack.demuxer,o=null,c=null,u=-1;if(t){let{sampleIndex:b,correctSampleFound:y}=e(t);if(y)return this.fetchPacketInFragment(t,b,a);b!==-1&&(c=t,u=b)}let d=z(this.internalTrack.fragmentLookupTable,r,b=>b.timestamp),l=d!==-1?this.internalTrack.fragmentLookupTable[d]:null,m=z(this.internalTrack.fragmentPositionCache,r,b=>b.startTimestamp),f=m!==-1?this.internalTrack.fragmentPositionCache[m]:null,h=Math.max(l?.moofOffset??0,f?.moofOffset??0)||null,g;for(t?h===null||t.moofOffset>=h?(g=t.moofOffset+t.moofSize,o=t):g=h:g=h??0;;){if(o){let w=o.trackData.get(this.internalTrack.id);if(w&&w.startTimestamp>n)break}let b=s.reader.requestSliceRange(g,He,kt);if(b instanceof Promise&&(b=await b),!b)break;let y=g,k=yt(b);if(!k)break;if(k.name==="moof"){o=await s.readFragment(y);let{sampleIndex:w,correctSampleFound:S}=e(o);if(S)return this.fetchPacketInFragment(o,w,a);w!==-1&&(c=o,u=w)}g=y+k.totalSize}if(l&&(!c||c.moofOffset<l.moofOffset)){let b=this.internalTrack.fragmentLookupTable[d-1];p(!b||b.timestamp<l.timestamp);let y=b?.timestamp??-1/0;return this.performFragmentedLookup(null,e,y,n,a)}return c?this.fetchPacketInFragment(c,u,a):null}},ms=class extends An{constructor(e){super(e);this.decoderConfigPromise=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return!1}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=e&&yn(e.data)}else if(this.internalTrack.info.codec==="av1"&&!this.internalTrack.info.av1CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=e&&wn(e.data)}return{codec:wr(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}},fs=class extends An{constructor(e){super(e);this.decoderConfig=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:Tr(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}},ps=(i,t)=>{if(i.presentationTimestamps){let e=z(i.presentationTimestamps,t,r=>r.presentationTimestamp);return e===-1?-1:i.presentationTimestamps[e].sampleIndex}else{let e=z(i.sampleTimingEntries,t,n=>n.startDecodeTimestamp);if(e===-1)return-1;let r=i.sampleTimingEntries[e];return r.startIndex+Math.min(Math.floor((t-r.startDecodeTimestamp)/r.delta),r.count-1)}},ju=(i,t)=>{if(!i.keySampleIndices)return ps(i,t);if(i.presentationTimestamps){let e=z(i.presentationTimestamps,t,r=>r.presentationTimestamp);if(e===-1)return-1;for(let r=e;r>=0;r--){let n=i.presentationTimestamps[r].sampleIndex;if(Kt(i.keySampleIndices,n,s=>s)!==-1)return n}return-1}else{let e=ps(i,t),r=z(i.keySampleIndices,e,n=>n);return i.keySampleIndices[r]??-1}},Ku=(i,t)=>{let e=z(i.sampleTimingEntries,t,y=>y.startIndex),r=i.sampleTimingEntries[e];if(!r||r.startIndex+r.count<=t)return null;let a=r.startDecodeTimestamp+(t-r.startIndex)*r.delta,s=z(i.sampleCompositionTimeOffsets,t,y=>y.startIndex),o=i.sampleCompositionTimeOffsets[s];o&&t-o.startIndex<o.count&&(a+=o.offset);let c=i.sampleSizes[Math.min(t,i.sampleSizes.length-1)],u=z(i.sampleToChunk,t,y=>y.startSampleIndex),d=i.sampleToChunk[u];p(d);let l=d.startChunkIndex+Math.floor((t-d.startSampleIndex)/d.samplesPerChunk),m=i.chunkOffsets[l],f=d.startSampleIndex+(l-d.startChunkIndex)*d.samplesPerChunk,h=0,g=m;if(i.sampleSizes.length===1)g+=c*(t-f),h+=c*d.samplesPerChunk;else for(let y=f;y<f+d.samplesPerChunk;y++){let k=i.sampleSizes[y];y<t&&(g+=k),h+=k}let b=r.delta;if(i.presentationTimestamps){let y=i.presentationTimestampIndexMap[t];p(y!==void 0),y<i.presentationTimestamps.length-1&&(b=i.presentationTimestamps[y+1].presentationTimestamp-a)}return{presentationTimestamp:a,duration:b,sampleOffset:g,sampleSize:c,chunkOffset:m,chunkSize:h,isKeyFrame:i.keySampleIndices?Kt(i.keySampleIndices,t,y=>y)!==-1:!0}},Gu=(i,t)=>{if(!i.keySampleIndices)return t+1;let e=z(i.keySampleIndices,t,r=>r);return i.keySampleIndices[e+1]??-1},ls=(i,t)=>{i.startTimestamp+=t,i.endTimestamp+=t;for(let e of i.samples)e.presentationTimestamp+=t;for(let e of i.presentationTimestamps)e.presentationTimestamp+=t},Qu=i=>{let[t,,,e]=i,r=Math.hypot(t,e),n=t/r,a=e/r,s=-Math.atan2(a,n)*(180/Math.PI);return Number.isFinite(s)?s:0},ac=i=>i.sampleSizes.length===0;var Rr=class{constructor(t){this.value=t}},Dr=class{constructor(t){this.value=t}},Ei=class{constructor(t){this.value=t}},je=class{constructor(t){this.value=t}};var $u=[440786851,408125543],Br=[290298740,357149030,524531317,374648427,475249515,423732329,272869232,307544935],_i=[...$u,...Br],cc=i=>i<256?1:i<65536?2:i<1<<24?3:i<2**32?4:i<2**40?5:6,uc=i=>i<1n<<8n?1:i<1n<<16n?2:i<1n<<24n?3:i<1n<<32n?4:i<1n<<40n?5:i<1n<<48n?6:i<1n<<56n?7:8,dc=i=>i>=-64&&i<64?1:i>=-8192&&i<8192?2:i>=-(1<<20)&&i<1<<20?3:i>=-(1<<27)&&i<1<<27?4:i>=-(2**34)&&i<2**34?5:6,Xu=i=>{if(i<127)return 1;if(i<16383)return 2;if(i<(1<<21)-1)return 3;if(i<(1<<28)-1)return 4;if(i<2**35-1)return 5;if(i<2**42-1)return 6;throw new Error("EBML varint size not supported "+i)},_n=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeByte(t){this.helperView.setUint8(0,t),this.writer.write(this.helper.subarray(0,1))}writeFloat32(t){this.helperView.setFloat32(0,t,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(t){this.helperView.setFloat64(0,t,!1),this.writer.write(this.helper)}writeUnsignedInt(t,e=cc(t)){let r=0;switch(e){case 6:this.helperView.setUint8(r++,t/2**40|0);case 5:this.helperView.setUint8(r++,t/2**32|0);case 4:this.helperView.setUint8(r++,t>>24);case 3:this.helperView.setUint8(r++,t>>16);case 2:this.helperView.setUint8(r++,t>>8);case 1:this.helperView.setUint8(r++,t);break;default:throw new Error("Bad unsigned int size "+e)}this.writer.write(this.helper.subarray(0,r))}writeUnsignedBigInt(t,e=uc(t)){let r=0;for(let n=e-1;n>=0;n--)this.helperView.setUint8(r++,Number(t>>BigInt(n*8)&0xffn));this.writer.write(this.helper.subarray(0,r))}writeSignedInt(t,e=dc(t)){t<0&&(t+=2**(e*8)),this.writeUnsignedInt(t,e)}writeVarInt(t,e=Xu(t)){let r=0;switch(e){case 1:this.helperView.setUint8(r++,128|t);break;case 2:this.helperView.setUint8(r++,64|t>>8),this.helperView.setUint8(r++,t);break;case 3:this.helperView.setUint8(r++,32|t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;case 4:this.helperView.setUint8(r++,16|t>>24),this.helperView.setUint8(r++,t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;case 5:this.helperView.setUint8(r++,8|t/2**32&7),this.helperView.setUint8(r++,t>>24),this.helperView.setUint8(r++,t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;case 6:this.helperView.setUint8(r++,4|t/2**40&3),this.helperView.setUint8(r++,t/2**32|0),this.helperView.setUint8(r++,t>>24),this.helperView.setUint8(r++,t>>16),this.helperView.setUint8(r++,t>>8),this.helperView.setUint8(r++,t);break;default:throw new Error("Bad EBML varint size "+e)}this.writer.write(this.helper.subarray(0,r))}writeAsciiString(t){this.writer.write(new Uint8Array(t.split("").map(e=>e.charCodeAt(0))))}writeEBML(t){if(t!==null)if(t instanceof Uint8Array)this.writer.write(t);else if(Array.isArray(t))for(let e of t)this.writeEBML(e);else if(this.offsets.set(t,this.writer.getPos()),this.writeUnsignedInt(t.id),Array.isArray(t.data)){let e=this.writer.getPos(),r=t.size===-1?1:t.size??4;t.size===-1?this.writeByte(255):this.writer.seek(this.writer.getPos()+r);let n=this.writer.getPos();if(this.dataOffsets.set(t,n),this.writeEBML(t.data),t.size!==-1){let a=this.writer.getPos()-n,s=this.writer.getPos();this.writer.seek(e),this.writeVarInt(a,r),this.writer.seek(s)}}else if(typeof t.data=="number"){let e=t.size??cc(t.data);this.writeVarInt(e),this.writeUnsignedInt(t.data,e)}else if(typeof t.data=="bigint"){let e=t.size??uc(t.data);this.writeVarInt(e),this.writeUnsignedBigInt(t.data,e)}else if(typeof t.data=="string")this.writeVarInt(t.data.length),this.writeAsciiString(t.data);else if(t.data instanceof Uint8Array)this.writeVarInt(t.data.byteLength,t.size),this.writer.write(t.data);else if(t.data instanceof Rr)this.writeVarInt(4),this.writeFloat32(t.data.value);else if(t.data instanceof Dr)this.writeVarInt(8),this.writeFloat64(t.data.value);else if(t.data instanceof Ei){let e=t.size??dc(t.data.value);this.writeVarInt(e),this.writeSignedInt(t.data.value,e)}else if(t.data instanceof je){let e=G.encode(t.data.value);this.writeVarInt(e.length),this.writer.write(e)}else J(t.data)}},hs=8,Ae=2,Ke=2*hs,gs=i=>{if(i.remainingLength<1)return null;let t=E(i);if(i.skip(-1),t===0)return null;let e=1,r=128;for(;(t&r)===0;)e++,r>>=1;return i.remainingLength<e?null:e},Or=i=>{if(i.remainingLength<1)return null;let t=E(i);if(t===0)return null;let e=1,r=128;for(;(t&r)===0;)e++,r>>=1;if(i.remainingLength<e-1)return null;let n=t&r-1;for(let a=1;a<e;a++)n*=256,n+=E(i);return n},N=(i,t)=>{if(t<1||t>8)throw new Error("Bad unsigned int size "+t);let e=0;for(let r=0;r<t;r++)e*=256,e+=E(i);return e},lc=(i,t)=>{if(t<1)throw new Error("Bad unsigned int size "+t);let e=0n;for(let r=0;r<t;r++)e<<=8n,e+=BigInt(E(i));return e};var Fn=i=>{let t=gs(i);return t===null||i.remainingLength<t?null:N(i,t)},bs=i=>{if(i.remainingLength<1)return null;if(E(i)===255)return;i.skip(-1);let e=Or(i);if(e===null)return null;if(e!==72057594037927940)return e},Ge=i=>{p(i.remainingLength>=Ae);let t=Fn(i);if(t===null)return null;let e=bs(i);return e===null?null:{id:t,size:e}},Vt=(i,t)=>{let e=M(i,t),r=0;for(;r<t&&e[r]!==0;)r+=1;return String.fromCharCode(...e.subarray(0,r))},Ur=(i,t)=>{let e=M(i,t),r=0;for(;r<t&&e[r]!==0;)r+=1;return fe.decode(e.subarray(0,r))},Mn=(i,t)=>{if(t===0)return 0;if(t!==4&&t!==8)throw new Error("Bad float size "+t);return t===4?mc(i):En(i)},Rn=async(i,t,e,r)=>{let n=new Set(e),a=t;for(;r===null||a<r;){let s=i.requestSliceRange(a,Ae,Ke);if(s instanceof Promise&&(s=await s),!s)break;let o=Ge(s);if(!o)break;if(n.has(o.id))return{pos:a,found:!0};Tt(o.size),a=s.filePos+o.size}return{pos:r!==null&&r>a?r:a,found:!1}},ks=async(i,t,e,r)=>{let a=new Set(e),s=t;for(;s<r;){let o=i.requestSliceRange(s,0,Math.min(65536,r-s));if(o instanceof Promise&&(o=await o),!o||o.length<hs)break;for(let c=0;c<o.length-hs;c++){o.filePos=s;let u=Fn(o);if(u!==null&&a.has(u))return s;s++}}return null},Be={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"};function Tt(i){if(i===void 0)throw new Error("Undefined element size is used in a place where it is not supported.")}var Dn=i=>{let e=(i.hasVideo?"video/":i.hasAudio?"audio/":"application/")+(i.isWebM?"webm":"x-matroska");if(i.codecStrings.length>0){let r=[...new Set(i.codecStrings.filter(Boolean))];e+=`; codecs="${r.join(", ")}"`}return e};var ys=[{id:290298740,flag:"seekHeadSeen"},{id:357149030,flag:"infoSeen"},{id:374648427,flag:"tracksSeen"},{id:475249515,flag:"cuesSeen"}],pc=10*2**20,Bn=class extends he{constructor(e){super(e);this.readMetadataPromise=null;this.segments=[];this.currentSegment=null;this.currentTrack=null;this.currentCluster=null;this.currentBlock=null;this.currentBlockAdditional=null;this.currentCueTime=null;this.currentDecodingInstruction=null;this.currentTagTargetIsMovie=!0;this.currentSimpleTagName=null;this.currentAttachedFile=null;this.isWebM=!1;this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),r=await Promise.all(e.map(n=>n.computeDuration()));return Math.max(0,...r)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(e=>e.tracks.map(r=>r.inputTrack))}async getMimeType(){await this.readMetadata();let e=await this.getTracks(),r=await Promise.all(e.map(n=>n.getCodecParameterString()));return Dn({isWebM:this.isWebM,hasVideo:this.segments.some(n=>n.tracks.some(a=>a.info?.type==="video")),hasAudio:this.segments.some(n=>n.tracks.some(a=>a.info?.type==="audio")),codecStrings:r.filter(Boolean)})}async getMetadataTags(){await this.readMetadata();for(let r of this.segments)r.metadataTagsCollected||(this.reader.fileSize!==null&&await this.loadSegmentMetadata(r),r.metadataTagsCollected=!0);let e={};for(let r of this.segments)e={...e,...r.metadataTags};return e}readMetadata(){return this.readMetadataPromise??=(async()=>{let e=0;for(;;){let r=this.reader.requestSliceRange(e,Ae,Ke);if(r instanceof Promise&&(r=await r),!r)break;let n=Ge(r);if(!n)break;let a=n.id,s=n.size,o=r.filePos;if(a===440786851){Tt(s);let c=this.reader.requestSlice(o,s);if(c instanceof Promise&&(c=await c),!c)break;this.readContiguousElements(c)}else if(a===408125543){if(await this.readSegment(o,s),s===void 0||this.reader.fileSize===null)break}else if(a===524531317){if(this.reader.fileSize===null)break;s===void 0&&(s=(await Rn(this.reader,o,_i,this.reader.fileSize)).pos-o);let c=j(this.segments);c&&(c.elementEndPos=o+s)}Tt(s),e=o+s}})()}async readSegment(e,r){this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,tagsSeen:!1,attachmentsSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:e,elementEndPos:r===void 0?null:e+r,clusterSeekStartPos:e,lastReadCluster:null,metadataTags:{},metadataTagsCollected:!1},this.segments.push(this.currentSegment);let n=e;for(;this.currentSegment.elementEndPos===null||n<this.currentSegment.elementEndPos;){let c=this.reader.requestSliceRange(n,Ae,Ke);if(c instanceof Promise&&(c=await c),!c)break;let u=n,d=Ge(c);if(!d||!Br.includes(d.id)&&d.id!==236){let g=await ks(this.reader,u,Br,Math.min(this.currentSegment.elementEndPos??1/0,u+pc));if(g){n=g;continue}else break}let{id:l,size:m}=d,f=c.filePos,h=ys.findIndex(g=>g.id===l);if(h!==-1){let g=ys[h].flag;this.currentSegment[g]=!0,Tt(m);let b=this.reader.requestSlice(f,m);b instanceof Promise&&(b=await b),b&&this.readContiguousElements(b)}else if(l===307544935||l===423732329){l===307544935?this.currentSegment.tagsSeen=!0:this.currentSegment.attachmentsSeen=!0,Tt(m);let g=this.reader.requestSlice(f,m);g instanceof Promise&&(g=await g),g&&this.readContiguousElements(g)}else if(l===524531317){this.currentSegment.clusterSeekStartPos=u;break}if(m===void 0)break;n=f+m}if(this.currentSegment.seekEntries.sort((c,u)=>c.segmentPosition-u.segmentPosition),this.reader.fileSize!==null)for(let c of this.currentSegment.seekEntries){let u=ys.find(g=>g.id===c.id);if(!u||this.currentSegment[u.flag])continue;let d=this.reader.requestSliceRange(e+c.segmentPosition,Ae,Ke);if(d instanceof Promise&&(d=await d),!d)continue;let l=Ge(d);if(!l)continue;let{id:m,size:f}=l;if(m!==u.id)continue;Tt(f),this.currentSegment[u.flag]=!0;let h=this.reader.requestSlice(d.filePos,f);h instanceof Promise&&(h=await h),h&&this.readContiguousElements(h)}this.currentSegment.timestampScale===-1&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e9/1e6);for(let c of this.currentSegment.tracks)c.defaultDurationNs!==null&&(c.defaultDuration=this.currentSegment.timestampFactor*c.defaultDurationNs/1e9);this.currentSegment.tracks.sort((c,u)=>Number(u.disposition.default)-Number(c.disposition.default));let a=new Map(this.currentSegment.tracks.map(c=>[c.id,c]));for(let c of this.currentSegment.cuePoints){let u=a.get(c.trackId);u&&u.cuePoints.push(c)}for(let c of this.currentSegment.tracks){c.cuePoints.sort((u,d)=>u.time-d.time);for(let u=0;u<c.cuePoints.length-1;u++){let d=c.cuePoints[u],l=c.cuePoints[u+1];d.time===l.time&&(c.cuePoints.splice(u+1,1),u--)}}let s=null,o=-1/0;for(let c of this.currentSegment.tracks)c.cuePoints.length>o&&(o=c.cuePoints.length,s=c);for(let c of this.currentSegment.tracks)c.cuePoints.length===0&&(c.cuePoints=s.cuePoints);this.currentSegment=null}async readCluster(e,r){if(r.lastReadCluster?.elementStartPos===e)return r.lastReadCluster;let n=this.reader.requestSliceRange(e,Ae,Ke);n instanceof Promise&&(n=await n),p(n);let a=e,s=Ge(n);p(s);let o=s.id;p(o===524531317);let c=s.size,u=n.filePos;c===void 0&&(c=(await Rn(this.reader,u,_i,r.elementEndPos)).pos-u);let d=this.reader.requestSlice(u,c);d instanceof Promise&&(d=await d);let l={segment:r,elementStartPos:a,elementEndPos:u+c,dataStartPos:u,timestamp:-1,trackData:new Map};if(this.currentCluster=l,d){let m=this.readContiguousElements(d,_i);l.elementEndPos=m}for(let[,m]of l.trackData){let f=m.track;p(m.blocks.length>0);let h=!1;for(let k=0;k<m.blocks.length;k++){let w=m.blocks[k];w.timestamp+=l.timestamp,h||=w.lacing!==0}m.presentationTimestamps=m.blocks.map((k,w)=>({timestamp:k.timestamp,blockIndex:w})).sort((k,w)=>k.timestamp-w.timestamp);for(let k=0;k<m.presentationTimestamps.length;k++){let w=m.presentationTimestamps[k],S=m.blocks[w.blockIndex];if(m.firstKeyFrameTimestamp===null&&S.isKeyFrame&&(m.firstKeyFrameTimestamp=S.timestamp),k<m.presentationTimestamps.length-1){let T=m.presentationTimestamps[k+1];S.duration=T.timestamp-S.timestamp}else S.duration===0&&f.defaultDuration!=null&&S.lacing===0&&(S.duration=f.defaultDuration)}h&&(this.expandLacedBlocks(m.blocks,f),m.presentationTimestamps=m.blocks.map((k,w)=>({timestamp:k.timestamp,blockIndex:w})).sort((k,w)=>k.timestamp-w.timestamp));let g=m.blocks[m.presentationTimestamps[0].blockIndex],b=m.blocks[j(m.presentationTimestamps).blockIndex];m.startTimestamp=g.timestamp,m.endTimestamp=b.timestamp+b.duration;let y=z(f.clusterPositionCache,m.startTimestamp,k=>k.startTimestamp);(y===-1||f.clusterPositionCache[y].elementStartPos!==a)&&f.clusterPositionCache.splice(y+1,0,{elementStartPos:l.elementStartPos,startTimestamp:m.startTimestamp})}return r.lastReadCluster=l,l}getTrackDataInCluster(e,r){let n=e.trackData.get(r);if(!n){let a=e.segment.tracks.find(s=>s.id===r);if(!a)return null;n={track:a,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},e.trackData.set(r,n)}return n}expandLacedBlocks(e,r){for(let n=0;n<e.length;n++){let a=e[n];if(a.lacing===0)continue;a.decoded||(a.data=this.decodeBlockData(r,a.data),a.decoded=!0);let s=ge.tempFromBytes(a.data),o=[],c=E(s)+1;switch(a.lacing){case 1:{let d=0;for(let l=0;l<c-1;l++){let m=0;for(;s.bufferPos<s.length;){let f=E(s);if(m+=f,f<255){o.push(m),d+=m;break}}}o.push(s.length-(s.bufferPos+d))}break;case 2:{let d=s.length-1,l=Math.floor(d/c);for(let m=0;m<c;m++)o.push(l)}break;case 3:{let d=Or(s);p(d!==null);let l=d;o.push(l);let m=l;for(let f=1;f<c-1;f++){let h=s.bufferPos,g=Or(s);p(g!==null);let b=g,k=(1<<(s.bufferPos-h)*7-1)-1,w=b-k;l+=w,o.push(l),m+=l}o.push(s.length-(s.bufferPos+m))}break;default:p(!1)}p(o.length===c),e.splice(n,1);let u=a.duration||c*(r.defaultDuration??0);for(let d=0;d<c;d++){let l=o[d],m=M(s,l),f=a.timestamp+u*d/c,h=u/c;e.splice(n+d,0,{timestamp:f,duration:h,isKeyFrame:a.isKeyFrame,data:m,lacing:0,decoded:!0,mainAdditional:a.mainAdditional})}n+=c,n--}}async loadSegmentMetadata(e){for(let r of e.seekEntries){if(!(r.id===307544935&&!e.tagsSeen)){if(!(r.id===423732329&&!e.attachmentsSeen))continue}let n=this.reader.requestSliceRange(e.dataStartPos+r.segmentPosition,Ae,Ke);if(n instanceof Promise&&(n=await n),!n)continue;let a=Ge(n);if(!a||a.id!==r.id)continue;let{size:s}=a;Tt(s),p(!this.currentSegment),this.currentSegment=e;let o=this.reader.requestSlice(n.filePos,s);o instanceof Promise&&(o=await o),o&&this.readContiguousElements(o),this.currentSegment=null,r.id===307544935?e.tagsSeen=!0:r.id===423732329&&(e.attachmentsSeen=!0)}}readContiguousElements(e,r){for(;e.remainingLength>=Ae;){let n=e.filePos;if(!this.traverseElement(e,r))return n}return e.filePos}traverseElement(e,r){let n=Ge(e);if(!n||r&&r.includes(n.id))return!1;let{id:a,size:s}=n,o=e.filePos;switch(Tt(s),a){case 17026:this.isWebM=Vt(e,s)==="webm";break;case 19899:{if(!this.currentSegment)break;let c={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(c),this.readContiguousElements(e.slice(o,s)),(c.id===-1||c.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case 21419:{let c=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!c)break;c.id=N(e,s)}break;case 21420:{let c=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!c)break;c.segmentPosition=N(e,s)}break;case 2807729:{if(!this.currentSegment)break;this.currentSegment.timestampScale=N(e,s),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case 17545:{if(!this.currentSegment)break;this.currentSegment.duration=Mn(e,s)}break;case 174:{if(!this.currentSegment||(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusterPositionCache:[],cuePoints:[],disposition:{...Se},inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,defaultDurationNs:null,name:null,languageCode:ee,decodingInstructions:[],info:null},this.readContiguousElements(e.slice(o,s)),!this.currentTrack))break;if(this.currentTrack.decodingInstructions.some(c=>c.data?.type!=="decompress"||c.scope!==1||c.data.algorithm!==3)&&(console.warn(`Track #${this.currentTrack.id} has an unsupported content encoding; dropping.`),this.currentTrack=null),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){let c=this.currentTrack.codecId.indexOf("/"),u=c===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,c);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===Be.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===Be.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):u===Be.vp8?this.currentTrack.info.codec="vp8":u===Be.vp9?this.currentTrack.info.codec="vp9":u===Be.av1&&(this.currentTrack.info.codec="av1");let d=this.currentTrack,l=new Ie(this.input,new ws(d));this.currentTrack.inputTrack=l,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){u===Be.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2"),objectType:null},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===Be.mp3?this.currentTrack.info.codec="mp3":u===Be.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate,this.currentTrack.info.sampleRate=Le):u===Be.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):u===Be.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&(this.currentTrack.info.bitDepth===32?this.currentTrack.info.codec="pcm-f32":this.currentTrack.info.bitDepth===64&&(this.currentTrack.info.codec="pcm-f64"));let d=this.currentTrack,l=new te(this.input,new Ts(d));this.currentTrack.inputTrack=l,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case 215:{if(!this.currentTrack)break;this.currentTrack.id=N(e,s)}break;case 131:{if(!this.currentTrack)break;let c=N(e,s);c===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null,alphaMode:!1}:c===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case 185:{if(!this.currentTrack)break;N(e,s)||(this.currentTrack=null)}break;case 136:{if(!this.currentTrack)break;this.currentTrack.disposition.default=!!N(e,s)}break;case 21930:{if(!this.currentTrack)break;this.currentTrack.disposition.forced=!!N(e,s)}break;case 21934:{if(!this.currentTrack)break;this.currentTrack.disposition.original=!!N(e,s)}break;case 21931:{if(!this.currentTrack)break;this.currentTrack.disposition.hearingImpaired=!!N(e,s)}break;case 21932:{if(!this.currentTrack)break;this.currentTrack.disposition.visuallyImpaired=!!N(e,s)}break;case 21935:{if(!this.currentTrack)break;this.currentTrack.disposition.commentary=!!N(e,s)}break;case 134:{if(!this.currentTrack)break;this.currentTrack.codecId=Vt(e,s)}break;case 25506:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=M(e,s)}break;case 2352003:{if(!this.currentTrack)break;this.currentTrack.defaultDurationNs=N(e,s)}break;case 21358:{if(!this.currentTrack)break;this.currentTrack.name=Ur(e,s)}break;case 2274716:{if(!this.currentTrack||this.currentTrack.languageCode!==ee)break;this.currentTrack.languageCode=Vt(e,s),mt(this.currentTrack.languageCode)||(this.currentTrack.languageCode=ee)}break;case 2274717:{if(!this.currentTrack)break;let u=Vt(e,s).split("-")[0];u?this.currentTrack.languageCode=u:this.currentTrack.languageCode=ee}break;case 224:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(o,s))}break;case 176:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=N(e,s)}break;case 186:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=N(e,s)}break;case 21440:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.alphaMode=N(e,s)===1}break;case 21936:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(e.slice(o,s))}break;case 21937:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let c=N(e,s),u=jt[c]??null;this.currentTrack.info.colorSpace.matrix=u}break;case 21945:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=N(e,s)===2}break;case 21946:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let c=N(e,s),u=qt[c]??null;this.currentTrack.info.colorSpace.transfer=u}break;case 21947:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let c=N(e,s),u=Ht[c]??null;this.currentTrack.info.colorSpace.primaries=u}break;case 30320:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(o,s))}break;case 30325:{if(this.currentTrack?.info?.type!=="video")break;let u=-Mn(e,s);try{this.currentTrack.info.rotation=It(u)}catch{}}break;case 225:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(e.slice(o,s))}break;case 181:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=Mn(e,s)}break;case 159:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=N(e,s)}break;case 25188:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=N(e,s)}break;case 187:{if(!this.currentSegment)break;this.readContiguousElements(e.slice(o,s)),this.currentCueTime=null}break;case 179:this.currentCueTime=N(e,s);break;case 183:{if(this.currentCueTime===null)break;p(this.currentSegment);let c={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(c),this.readContiguousElements(e.slice(o,s)),(c.trackId===-1||c.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case 247:{let c=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!c)break;c.trackId=N(e,s)}break;case 241:{let c=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!c)break;p(this.currentSegment),c.clusterPosition=this.currentSegment.dataStartPos+N(e,s)}break;case 231:{if(!this.currentCluster)break;this.currentCluster.timestamp=N(e,s)}break;case 163:{if(!this.currentCluster)break;let c=Or(e);if(c===null)break;let u=this.getTrackDataInCluster(this.currentCluster,c);if(!u)break;let d=Ai(e),l=E(e),m=l>>1&3,f=!!(l&128);u.track.info?.type==="audio"&&u.track.info.codec&&(f=!0);let h=M(e,s-(e.filePos-o)),g=u.track.decodingInstructions.length>0;u.blocks.push({timestamp:d,duration:0,isKeyFrame:f,data:h,lacing:m,decoded:!g,mainAdditional:null})}break;case 160:{if(!this.currentCluster)break;this.readContiguousElements(e.slice(o,s)),this.currentBlock=null}break;case 161:{if(!this.currentCluster)break;let c=Or(e);if(c===null)break;let u=this.getTrackDataInCluster(this.currentCluster,c);if(!u)break;let d=Ai(e),m=E(e)>>1&3,f=M(e,s-(e.filePos-o)),h=u.track.decodingInstructions.length>0;this.currentBlock={timestamp:d,duration:0,isKeyFrame:!0,data:f,lacing:m,decoded:!h,mainAdditional:null},u.blocks.push(this.currentBlock)}break;case 30113:this.readContiguousElements(e.slice(o,s));break;case 166:{if(!this.currentBlock)break;this.currentBlockAdditional={addId:1,data:null},this.readContiguousElements(e.slice(o,s)),this.currentBlockAdditional.data&&this.currentBlockAdditional.addId===1&&(this.currentBlock.mainAdditional=this.currentBlockAdditional.data),this.currentBlockAdditional=null}break;case 165:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.data=M(e,s)}break;case 238:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.addId=N(e,s)}break;case 155:{if(!this.currentBlock)break;this.currentBlock.duration=N(e,s)}break;case 251:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1}break;case 29555:this.currentTagTargetIsMovie=!0,this.readContiguousElements(e.slice(o,s));break;case 25536:this.readContiguousElements(e.slice(o,s));break;case 26826:N(e,s)!==50&&(this.currentTagTargetIsMovie=!1);break;case 25541:case 25545:case 25540:case 25542:this.currentTagTargetIsMovie=!1;break;case 26568:{if(!this.currentTagTargetIsMovie)break;this.currentSimpleTagName=null,this.readContiguousElements(e.slice(o,s))}break;case 17827:this.currentSimpleTagName=Ur(e,s);break;case 17543:{if(!this.currentSimpleTagName)break;let c=Ur(e,s);this.processTagValue(this.currentSimpleTagName,c)}break;case 17541:{if(!this.currentSimpleTagName)break;let c=M(e,s);this.processTagValue(this.currentSimpleTagName,c)}break;case 24999:{if(!this.currentSegment)break;this.currentAttachedFile={fileUid:null,fileName:null,fileMediaType:null,fileData:null,fileDescription:null},this.readContiguousElements(e.slice(o,s));let c=this.currentSegment.metadataTags;if(this.currentAttachedFile.fileUid&&this.currentAttachedFile.fileData&&(c.raw??={},c.raw[this.currentAttachedFile.fileUid.toString()]=new ft(this.currentAttachedFile.fileData,this.currentAttachedFile.fileMediaType??void 0,this.currentAttachedFile.fileName??void 0,this.currentAttachedFile.fileDescription??void 0)),this.currentAttachedFile.fileMediaType?.startsWith("image/")&&this.currentAttachedFile.fileData){let u=this.currentAttachedFile.fileName,d="unknown";if(u){let l=u.toLowerCase();l.startsWith("cover.")?d="coverFront":l.startsWith("back.")&&(d="coverBack")}c.images??=[],c.images.push({data:this.currentAttachedFile.fileData,mimeType:this.currentAttachedFile.fileMediaType,kind:d,name:this.currentAttachedFile.fileName??void 0,description:this.currentAttachedFile.fileDescription??void 0})}this.currentAttachedFile=null}break;case 18094:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileUid=lc(e,s)}break;case 18030:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileName=Ur(e,s)}break;case 18016:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileMediaType=Vt(e,s)}break;case 18012:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileData=M(e,s)}break;case 18046:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileDescription=Ur(e,s)}break;case 28032:{if(!this.currentTrack)break;this.readContiguousElements(e.slice(o,s)),this.currentTrack.decodingInstructions.sort((c,u)=>u.order-c.order)}break;case 25152:this.currentDecodingInstruction={order:0,scope:1,data:null},this.readContiguousElements(e.slice(o,s)),this.currentDecodingInstruction.data&&this.currentTrack.decodingInstructions.push(this.currentDecodingInstruction),this.currentDecodingInstruction=null;break;case 20529:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.order=N(e,s)}break;case 20530:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.scope=N(e,s)}break;case 20532:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decompress",algorithm:0,settings:null},this.readContiguousElements(e.slice(o,s))}break;case 16980:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.algorithm=N(e,s)}break;case 16981:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.settings=M(e,s)}break;case 20533:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decrypt"}}break}return e.filePos=o+s,!0}decodeBlockData(e,r){p(e.decodingInstructions.length>0);let n=r;for(let a of e.decodingInstructions)switch(p(a.data),a.data.type){case"decompress":switch(a.data.algorithm){case 3:if(a.data.settings&&a.data.settings.length>0){let s=a.data.settings,o=new Uint8Array(s.length+n.length);o.set(s,0),o.set(n,s.length),n=o}break;default:}break;default:}return n}processTagValue(e,r){if(!this.currentSegment?.metadataTags)return;let n=this.currentSegment.metadataTags;if(n.raw??={},n.raw[e]??=r,typeof r=="string")switch(e.toLowerCase()){case"title":n.title??=r;break;case"description":n.description??=r;break;case"artist":n.artist??=r;break;case"album":n.album??=r;break;case"album_artist":n.albumArtist??=r;break;case"genre":n.genre??=r;break;case"comment":n.comment??=r;break;case"lyrics":n.lyrics??=r;break;case"date":{let a=new Date(r);Number.isNaN(a.getTime())||(n.date??=a)}break;case"track_number":case"part_number":{let a=r.split("/"),s=Number.parseInt(a[0],10),o=a[1]&&Number.parseInt(a[1],10);Number.isInteger(s)&&s>0&&(n.trackNumber??=s),o&&Number.isInteger(o)&&o>0&&(n.tracksTotal??=o)}break;case"disc_number":case"disc":{let a=r.split("/"),s=Number.parseInt(a[0],10),o=a[1]&&Number.parseInt(a[1],10);Number.isInteger(s)&&s>0&&(n.discNumber??=s),o&&Number.isInteger(o)&&o>0&&(n.discsTotal??=o)}break}}},On=class{constructor(t){this.internalTrack=t;this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.codecId}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}getDisposition(){return this.internalTrack.disposition}async getFirstPacket(t){return this.performClusterLookup(null,e=>e.trackData.get(this.internalTrack.id)?{blockIndex:0,correctBlockFound:!0}:{blockIndex:-1,correctBlockFound:!1},-1/0,1/0,t)}intoTimescale(t){return lt(t*this.internalTrack.segment.timestampFactor)}async getPacket(t,e){let r=this.intoTimescale(t);return this.performClusterLookup(null,n=>{let a=n.trackData.get(this.internalTrack.id);if(!a)return{blockIndex:-1,correctBlockFound:!1};let s=z(a.presentationTimestamps,r,u=>u.timestamp),o=s!==-1?a.presentationTimestamps[s].blockIndex:-1,c=s!==-1&&r<a.endTimestamp;return{blockIndex:o,correctBlockFound:c}},r,r,e)}async getNextPacket(t,e){let r=this.packetToClusterLocation.get(t);if(r===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(r.cluster,n=>{if(n===r.cluster){let a=n.trackData.get(this.internalTrack.id);if(r.blockIndex+1<a.blocks.length)return{blockIndex:r.blockIndex+1,correctBlockFound:!0}}else if(n.trackData.get(this.internalTrack.id))return{blockIndex:0,correctBlockFound:!0};return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,e)}async getKeyPacket(t,e){let r=this.intoTimescale(t);return this.performClusterLookup(null,n=>{let a=n.trackData.get(this.internalTrack.id);if(!a)return{blockIndex:-1,correctBlockFound:!1};let s=yr(a.presentationTimestamps,u=>a.blocks[u.blockIndex].isKeyFrame&&u.timestamp<=r),o=s!==-1?a.presentationTimestamps[s].blockIndex:-1,c=s!==-1&&r<a.endTimestamp;return{blockIndex:o,correctBlockFound:c}},r,r,e)}async getNextKeyPacket(t,e){let r=this.packetToClusterLocation.get(t);if(r===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(r.cluster,n=>{if(n===r.cluster){let s=n.trackData.get(this.internalTrack.id).blocks.findIndex((o,c)=>o.isKeyFrame&&c>r.blockIndex);if(s!==-1)return{blockIndex:s,correctBlockFound:!0}}else{let a=n.trackData.get(this.internalTrack.id);if(a&&a.firstKeyFrameTimestamp!==null){let s=a.blocks.findIndex(o=>o.isKeyFrame);return p(s!==-1),{blockIndex:s,correctBlockFound:!0}}}return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,e)}async fetchPacketInCluster(t,e,r){if(e===-1)return null;let a=t.trackData.get(this.internalTrack.id).blocks[e];p(a),a.decoded||(a.data=this.internalTrack.demuxer.decodeBlockData(this.internalTrack,a.data),a.decoded=!0);let s=r.metadataOnly?oe:a.data,o=a.timestamp/this.internalTrack.segment.timestampFactor,c=a.duration/this.internalTrack.segment.timestampFactor,u={};a.mainAdditional&&this.internalTrack.info?.type==="video"&&this.internalTrack.info.alphaMode&&(u.alpha=r.metadataOnly?oe:a.mainAdditional,u.alphaByteLength=a.mainAdditional.byteLength);let d=new L(s,a.isKeyFrame?"key":"delta",o,c,t.dataStartPos+e,a.data.byteLength,u);return this.packetToClusterLocation.set(d,{cluster:t,blockIndex:e}),d}async performClusterLookup(t,e,r,n,a){let{demuxer:s,segment:o}=this.internalTrack,c=null,u=null,d=-1;if(t){let{blockIndex:y,correctBlockFound:k}=e(t);if(k)return this.fetchPacketInCluster(t,y,a);y!==-1&&(u=t,d=y)}let l=z(this.internalTrack.cuePoints,r,y=>y.time),m=l!==-1?this.internalTrack.cuePoints[l]:null,f=z(this.internalTrack.clusterPositionCache,r,y=>y.startTimestamp),h=f!==-1?this.internalTrack.clusterPositionCache[f]:null,g=Math.max(m?.clusterPosition??0,h?.elementStartPos??0)||null,b;for(t?g===null||t.elementStartPos>=g?(b=t.elementEndPos,c=t):b=g:b=g??o.clusterSeekStartPos;o.elementEndPos===null||b<=o.elementEndPos-Ae;){if(c){let C=c.trackData.get(this.internalTrack.id);if(C&&C.startTimestamp>n)break}let y=s.reader.requestSliceRange(b,Ae,Ke);if(y instanceof Promise&&(y=await y),!y)break;let k=b,w=Ge(y);if(!w||!Br.includes(w.id)&&w.id!==236){let C=await ks(s.reader,k,Br,Math.min(o.elementEndPos??1/0,k+pc));if(C){b=C;continue}else break}let S=w.id,T=w.size,x=y.filePos;if(S===524531317){c=await s.readCluster(k,o),T=c.elementEndPos-x;let{blockIndex:C,correctBlockFound:_}=e(c);if(_)return this.fetchPacketInCluster(c,C,a);C!==-1&&(u=c,d=C)}T===void 0&&(p(S!==524531317),T=(await Rn(s.reader,x,_i,o.elementEndPos)).pos-x);let A=x+T;if(o.elementEndPos===null){let C=s.reader.requestSliceRange(A,Ae,Ke);if(C instanceof Promise&&(C=await C),!C)break;if(Fn(C)===408125543){o.elementEndPos=A;break}}b=A}if(m&&(!u||u.elementStartPos<m.clusterPosition)){let y=this.internalTrack.cuePoints[l-1];p(!y||y.time<m.time);let k=y?.time??-1/0;return this.performClusterLookup(null,e,k,n,a)}return u?this.fetchPacketInCluster(u,d,a):null}},ws=class extends On{constructor(e){super(e);this.decoderConfigPromise=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return this.internalTrack.info.alphaMode}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{let e=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1"||this.internalTrack.info.codec==="avc"&&!this.internalTrack.info.codecDescription||this.internalTrack.info.codec==="hevc"&&!this.internalTrack.info.codecDescription)&&(e=await this.getFirstPacket({})),{codec:wr({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcType:1,avcCodecInfo:this.internalTrack.info.codec==="avc"&&e?Cr(e.data):null,hevcCodecInfo:this.internalTrack.info.codec==="hevc"&&e?Pr(e.data):null,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&e?yn(e.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&e?wn(e.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}},Ts=class extends On{constructor(e){super(e);this.decoderConfig=null;this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:Tr({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}};var Yu=[44100,48e3,32e3],Un=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1,-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1,-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],Vr=1483304551,Vn=1231971951,zn=(i,t,e,r,n)=>t===0?0:t===1?Math.floor(144*e/(r<<i))+n:t===2?Math.floor(144*e/r)+n:(Math.floor(12*e/r)+n)*4,zr=(i,t)=>i===3?t===3?21:36:t===3?13:21,ir=(i,t)=>{let e=i>>>24,r=i>>>16&255,n=i>>>8&255,a=i&255;if(e!==255&&r!==255&&n!==255&&a!==255)return{header:null,bytesAdvanced:4};if(e!==255)return{header:null,bytesAdvanced:1};if((r&224)!==224)return{header:null,bytesAdvanced:1};let s=0,o=0;r&16?s=r&8?0:1:(s=1,o=1);let c=r>>3&3,u=r>>1&3,d=n>>4&15,l=(n>>2&3)%3,m=n>>1&1,f=a>>6&3,h=a>>4&3,g=a>>3&1,b=a>>2&1,y=a&3,k=Un[s*16*4+u*16+d];if(k===-1)return{header:null,bytesAdvanced:1};let w=k*1e3,S=Yu[l]>>s+o,T=zn(s,u,w,S,m);if(t!==null&&t<T)return{header:null,bytesAdvanced:1};let x;return c===3?x=u===3?384:1152:u===3?x=384:u===2?x=1152:x=576,{header:{totalSize:T,mpegVersionId:c,layer:u,bitrate:w,frequencyIndex:l,sampleRate:S,channel:f,modeExtension:h,copyright:g,original:b,emphasis:y,audioSamplesInFrame:x},bytesAdvanced:1}},hc=i=>{let t=127,e=0,r=i;for(;(t^2147483647)!==0;)e=r&~t,e<<=1,e|=r&t,t=(t+1<<8)-1,r=e;return e},Nn=i=>{let t=2130706432,e=0;for(;t!==0;)e>>=1,e|=i&t,t>>=8;return e};var Fi=128,Hr=10,Lr=["Blues","Classic rock","Country","Dance","Disco","Funk","Grunge","Hip-hop","Jazz","Metal","New age","Oldies","Other","Pop","Rhythm and blues","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death metal","Pranks","Soundtrack","Euro-techno","Ambient","Trip-hop","Vocal","Jazz & funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound clip","Gospel","Noise","Alternative rock","Bass","Soul","Punk","Space","Meditative","Instrumental pop","Instrumental rock","Ethnic","Gothic","Darkwave","Techno-industrial","Electronic","Pop-folk","Eurodance","Dream","Southern rock","Comedy","Cult","Gangsta","Top 40","Christian rap","Pop/funk","Jungle music","Native US","Cabaret","New wave","Psychedelic","Rave","Showtunes","Trailer","Lo-fi","Tribal","Acid punk","Acid jazz","Polka","Retro","Musical","Rock 'n' roll","Hard rock","Folk","Folk rock","National folk","Swing","Fast fusion","Bebop","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic rock","Progressive rock","Psychedelic rock","Symphonic rock","Slow rock","Big band","Chorus","Easy listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber music","Sonata","Symphony","Booty bass","Primus","Porn groove","Satire","Slow jam","Club","Tango","Samba","Folklore","Ballad","Power ballad","Rhythmic Soul","Freestyle","Duet","Punk rock","Drum solo","A cappella","Euro-house","Dance hall","Goa music","Drum & bass","Club-house","Hardcore techno","Terror","Indie","Britpop","Negerpunk","Polsk punk","Beat","Christian gangsta rap","Heavy metal","Black metal","Crossover","Contemporary Christian","Christian rock","Merengue","Salsa","Thrash metal","Anime","Jpop","Synthpop","Christmas","Art rock","Baroque","Bhangra","Big beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math rock","New romantic","Nu-breakz","Post-punk","Post-rock","Psytrance","Shoegaze","Space rock","Trop rock","World music","Neoclassical","Audiobook","Audio theatre","Neue Deutsche Welle","Podcast","Indie rock","G-Funk","Dubstep","Garage rock","Psybient"],gc=(i,t)=>{let e=i.filePos;t.raw??={},t.raw.TAG??=M(i,Fi-3),i.filePos=e;let r=Nr(i,30);r&&(t.title??=r);let n=Nr(i,30);n&&(t.artist??=n);let a=Nr(i,30);a&&(t.album??=a);let s=Nr(i,4),o=Number.parseInt(s,10);Number.isInteger(o)&&o>0&&(t.date??=new Date(o,0,1));let c=M(i,30),u;if(c[28]===0&&c[29]!==0){let l=c[29];l>0&&(t.trackNumber??=l),i.skip(-30),u=Nr(i,28),i.skip(2)}else i.skip(-30),u=Nr(i,30);u&&(t.comment??=u);let d=E(i);d<Lr.length&&(t.genre??=Lr[d])},Nr=(i,t)=>{let e=M(i,t),r=Xt(e.indexOf(0),e.length),n=e.subarray(0,r),a="";for(let s=0;s<n.length;s++)a+=String.fromCharCode(n[s]);return a.trimEnd()},nr=i=>{let t=i.filePos,e=re(i,3),r=E(i),n=E(i),a=E(i),s=P(i);if(e!=="ID3"||r===255||n===255||(s&2155905152)!==0)return i.filePos=t,null;let o=Nn(s);return{majorVersion:r,revision:n,flags:a,size:o}},Ln=(i,t,e)=>{if(![2,3,4].includes(t.majorVersion)){console.warn(`Unsupported ID3v2 major version: ${t.majorVersion}`);return}let r=M(i,t.size),n=new Ss(t,r);if(t.flags&16&&n.removeFooter(),t.flags&128&&t.majorVersion===3&&n.ununsynchronizeAll(),t.flags&64){let a=n.readU32();t.majorVersion===3?n.pos+=a:n.pos+=a-4}for(;n.pos<=n.bytes.length-n.frameHeaderSize();){let a=n.readId3V2Frame();if(!a)break;let s=n.pos,o=n.pos+a.size,c=!1,u=!1,d=!1;if(t.majorVersion===3?(c=!!(a.flags&64),u=!!(a.flags&128)):t.majorVersion===4&&(c=!!(a.flags&4),u=!!(a.flags&8),d=!!(a.flags&2)||!!(t.flags&128)),c){console.warn(`Skipping encrypted ID3v2 frame ${a.id}`),n.pos=o;continue}if(u){console.warn(`Skipping compressed ID3v2 frame ${a.id}`),n.pos=o;continue}switch(d&&n.ununsynchronizeRegion(n.pos,o),e.raw??={},a.id[0]==="T"?e.raw[a.id]??=n.readId3V2EncodingAndText(o):e.raw[a.id]??=n.readBytes(a.size),n.pos=s,a.id){case"TIT2":case"TT2":e.title??=n.readId3V2EncodingAndText(o);break;case"TIT3":case"TT3":e.description??=n.readId3V2EncodingAndText(o);break;case"TPE1":case"TP1":e.artist??=n.readId3V2EncodingAndText(o);break;case"TALB":case"TAL":e.album??=n.readId3V2EncodingAndText(o);break;case"TPE2":case"TP2":e.albumArtist??=n.readId3V2EncodingAndText(o);break;case"TRCK":case"TRK":{let m=n.readId3V2EncodingAndText(o).split("/"),f=Number.parseInt(m[0],10),h=m[1]&&Number.parseInt(m[1],10);Number.isInteger(f)&&f>0&&(e.trackNumber??=f),h&&Number.isInteger(h)&&h>0&&(e.tracksTotal??=h)}break;case"TPOS":case"TPA":{let m=n.readId3V2EncodingAndText(o).split("/"),f=Number.parseInt(m[0],10),h=m[1]&&Number.parseInt(m[1],10);Number.isInteger(f)&&f>0&&(e.discNumber??=f),h&&Number.isInteger(h)&&h>0&&(e.discsTotal??=h)}break;case"TCON":case"TCO":{let l=n.readId3V2EncodingAndText(o),m=/^\((\d+)\)/.exec(l);if(m){let f=Number.parseInt(m[1]);if(Lr[f]!==void 0){e.genre??=Lr[f];break}}if(m=/^\d+$/.exec(l),m){let f=Number.parseInt(m[0]);if(Lr[f]!==void 0){e.genre??=Lr[f];break}}e.genre??=l}break;case"TDRC":case"TDAT":{let l=n.readId3V2EncodingAndText(o),m=new Date(l);Number.isNaN(m.getTime())||(e.date??=m)}break;case"TYER":case"TYE":{let l=n.readId3V2EncodingAndText(o),m=Number.parseInt(l,10);Number.isInteger(m)&&(e.date??=new Date(m,0,1))}break;case"USLT":case"ULT":{let l=n.readU8();n.pos+=3,n.readId3V2Text(l,o),e.lyrics??=n.readId3V2Text(l,o)}break;case"COMM":case"COM":{let l=n.readU8();n.pos+=3,n.readId3V2Text(l,o),e.comment??=n.readId3V2Text(l,o)}break;case"APIC":case"PIC":{let l=n.readId3V2TextEncoding(),m;if(t.majorVersion===2){let b=n.readAscii(3);m=b==="PNG"?"image/png":b==="JPG"?"image/jpeg":"image/*"}else m=n.readId3V2Text(l,o);let f=n.readU8(),h=n.readId3V2Text(l,o).trimEnd(),g=o-n.pos;if(g>=0){let b=n.readBytes(g);e.images||(e.images=[]),e.images.push({data:b,mimeType:m,kind:f===3?"coverFront":f===4?"coverBack":"unknown",description:h})}}break;default:n.pos+=a.size;break}n.pos=o}},Ss=class{constructor(t,e){this.header=t;this.bytes=e;this.pos=0;this.view=new DataView(e.buffer,e.byteOffset,e.byteLength)}frameHeaderSize(){return this.header.majorVersion===2?6:10}ununsynchronizeAll(){let t=[];for(let e=0;e<this.bytes.length;e++){let r=this.bytes[e];t.push(r),r===255&&e!==this.bytes.length-1&&this.bytes[e]===0&&e++}this.bytes=new Uint8Array(t),this.view=new DataView(this.bytes.buffer)}ununsynchronizeRegion(t,e){let r=[];for(let s=t;s<e;s++){let o=this.bytes[s];r.push(o),o===255&&s!==e-1&&this.bytes[s+1]===0&&s++}let n=this.bytes.subarray(0,t),a=this.bytes.subarray(e);this.bytes=new Uint8Array(n.length+r.length+a.length),this.bytes.set(n,0),this.bytes.set(r,n.length),this.bytes.set(a,n.length+r.length),this.view=new DataView(this.bytes.buffer)}removeFooter(){this.bytes=this.bytes.subarray(0,this.bytes.length-Hr),this.view=new DataView(this.bytes.buffer)}readBytes(t){let e=this.bytes.subarray(this.pos,this.pos+t);return this.pos+=t,e}readU8(){let t=this.view.getUint8(this.pos);return this.pos+=1,t}readU16(){let t=this.view.getUint16(this.pos,!1);return this.pos+=2,t}readU24(){let t=this.view.getUint16(this.pos,!1),e=this.view.getUint8(this.pos+1);return this.pos+=3,t*256+e}readU32(){let t=this.view.getUint32(this.pos,!1);return this.pos+=4,t}readAscii(t){let e="";for(let r=0;r<t;r++)e+=String.fromCharCode(this.view.getUint8(this.pos+r));return this.pos+=t,e}readId3V2Frame(){if(this.header.majorVersion===2){let t=this.readAscii(3);if(t==="\0\0\0")return null;let e=this.readU24();return{id:t,size:e,flags:0}}else{let t=this.readAscii(4);if(t==="\0\0\0\0")return null;let e=this.readU32(),r=this.header.majorVersion===4?Nn(e):e,n=this.readU16(),a=this.pos,s=o=>{let c=this.pos+o;if(c>this.bytes.length)return!1;if(c<=this.bytes.length-this.frameHeaderSize()){this.pos+=o;let u=this.readAscii(4);if(u!=="\0\0\0\0"&&!/[0-9A-Z]{4}/.test(u))return!1}return!0};if(!s(r)){let o=this.header.majorVersion===4?e:Nn(e);s(o)&&(r=o)}return this.pos=a,{id:t,size:r,flags:n}}}readId3V2TextEncoding(){let t=this.readU8();if(t>3)throw new Error(`Unsupported text encoding: ${t}`);return t}readId3V2Text(t,e){let r=this.pos,n=this.readBytes(e-this.pos);switch(t){case 0:{let a="";for(let s=0;s<n.length;s++){let o=n[s];if(o===0){this.pos=r+s+1;break}a+=String.fromCharCode(o)}return a}case 1:if(n[0]===255&&n[1]===254){let a=new TextDecoder("utf-16le"),s=Xt(n.findIndex((o,c)=>o===0&&n[c+1]===0&&c%2===0),n.length);return this.pos=r+Math.min(s+2,n.length),a.decode(n.subarray(2,s))}else if(n[0]===254&&n[1]===255){let a=new TextDecoder("utf-16be"),s=Xt(n.findIndex((o,c)=>o===0&&n[c+1]===0&&c%2===0),n.length);return this.pos=r+Math.min(s+2,n.length),a.decode(n.subarray(2,s))}else{let a=Xt(n.findIndex(s=>s===0),n.length);return this.pos=r+Math.min(a+1,n.length),fe.decode(n.subarray(0,a))}case 2:{let a=new TextDecoder("utf-16be"),s=Xt(n.findIndex((o,c)=>o===0&&n[c+1]===0&&c%2===0),n.length);return this.pos=r+Math.min(s+2,n.length),a.decode(n.subarray(0,s))}case 3:{let a=Xt(n.findIndex(s=>s===0),n.length);return this.pos=r+Math.min(a+1,n.length),fe.decode(n.subarray(0,a))}}}readId3V2EncodingAndText(t){if(this.pos>=t)return"";let e=this.readId3V2TextEncoding();return this.readId3V2Text(e,t)}},Wr=class{constructor(t){this.helper=new Uint8Array(8);this.helperView=D(this.helper);this.writer=t}writeId3V2Tag(t){let e=this.writer.getPos();this.writeAscii("ID3"),this.writeU8(4),this.writeU8(0),this.writeU8(0),this.writeSynchsafeU32(0);let r=this.writer.getPos(),n=new Set;for(let{key:o,value:c}of Ne(t))switch(o){case"title":this.writeId3V2TextFrame("TIT2",c),n.add("TIT2");break;case"description":this.writeId3V2TextFrame("TIT3",c),n.add("TIT3");break;case"artist":this.writeId3V2TextFrame("TPE1",c),n.add("TPE1");break;case"album":this.writeId3V2TextFrame("TALB",c),n.add("TALB");break;case"albumArtist":this.writeId3V2TextFrame("TPE2",c),n.add("TPE2");break;case"trackNumber":{let u=t.tracksTotal!==void 0?`${c}/${t.tracksTotal}`:c.toString();this.writeId3V2TextFrame("TRCK",u),n.add("TRCK")}break;case"discNumber":{let u=t.discsTotal!==void 0?`${c}/${t.discsTotal}`:c.toString();this.writeId3V2TextFrame("TPOS",u),n.add("TPOS")}break;case"genre":this.writeId3V2TextFrame("TCON",c),n.add("TCON");break;case"date":this.writeId3V2TextFrame("TDRC",c.toISOString().slice(0,10)),n.add("TDRC");break;case"lyrics":this.writeId3V2LyricsFrame(c),n.add("USLT");break;case"comment":this.writeId3V2CommentFrame(c),n.add("COMM");break;case"images":{let u={coverFront:3,coverBack:4,unknown:0};for(let d of c){let l=u[d.kind]??0,m=d.description??"";this.writeId3V2ApicFrame(d.mimeType,l,m,d.data)}}break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:J(o)}if(t.raw)for(let o in t.raw){let c=t.raw[o];if(c==null||o.length!==4||n.has(o))continue;let u;if(typeof c=="string"){let d=G.encode(c);u=new Uint8Array(d.byteLength+2),u[0]=3,u.set(d,1)}else if(c instanceof Uint8Array)u=c;else continue;this.writeAscii(o),this.writeSynchsafeU32(u.byteLength),this.writeU16(0),this.writer.write(u)}let a=this.writer.getPos(),s=a-r;return this.writer.seek(e+6),this.writeSynchsafeU32(s),this.writer.seek(a),s+10}writeU8(t){this.helper[0]=t,this.writer.write(this.helper.subarray(0,1))}writeU16(t){this.helperView.setUint16(0,t,!1),this.writer.write(this.helper.subarray(0,2))}writeU32(t){this.helperView.setUint32(0,t,!1),this.writer.write(this.helper.subarray(0,4))}writeAscii(t){for(let e=0;e<t.length;e++)this.helper[e]=t.charCodeAt(e);this.writer.write(this.helper.subarray(0,t.length))}writeSynchsafeU32(t){this.writeU32(hc(t))}writeIsoString(t){let e=new Uint8Array(t.length+1);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);e[t.length]=0,this.writer.write(e)}writeUtf8String(t){let e=G.encode(t);this.writer.write(e),this.writeU8(0)}writeId3V2TextFrame(t,e){let r=At(e),a=1+(r?e.length:G.encode(e).byteLength)+1;this.writeAscii(t),this.writeSynchsafeU32(a),this.writeU16(0),this.writeU8(r?0:3),r?this.writeIsoString(e):this.writeUtf8String(e)}writeId3V2LyricsFrame(t){let e=At(t),r="",n=4+r.length+1+t.length+1;this.writeAscii("USLT"),this.writeSynchsafeU32(n),this.writeU16(0),this.writeU8(e?0:3),this.writeAscii("und"),e?(this.writeIsoString(r),this.writeIsoString(t)):(this.writeUtf8String(r),this.writeUtf8String(t))}writeId3V2CommentFrame(t){let e=At(t),r=e?t.length:G.encode(t).byteLength,n="",a=4+n.length+1+r+1;this.writeAscii("COMM"),this.writeSynchsafeU32(a),this.writeU16(0),this.writeU8(e?0:3),this.writeU8(117),this.writeU8(110),this.writeU8(100),e?(this.writeIsoString(n),this.writeIsoString(t)):(this.writeUtf8String(n),this.writeUtf8String(t))}writeId3V2ApicFrame(t,e,r,n){let a=At(t)&&At(r),s=a?r.length:G.encode(r).byteLength,o=1+t.length+1+1+s+1+n.byteLength;this.writeAscii("APIC"),this.writeSynchsafeU32(o),this.writeU16(0),this.writeU8(a?0:3),a?this.writeIsoString(t):this.writeUtf8String(t),this.writeU8(e),a?this.writeIsoString(r):this.writeUtf8String(r),this.writer.write(n)}};var Mi=async(i,t,e)=>{let r=t;for(;e===null||r<e;){let n=i.requestSlice(r,4);if(n instanceof Promise&&(n=await n),!n)break;let a=P(n),s=ir(a,i.fileSize!==null?i.fileSize-r:null);if(s.header)return{header:s.header,startPos:r};r+=s.bytesAdvanced}return null};var Wn=class extends he{constructor(e){super(e);this.metadataPromise=null;this.firstFrameHeader=null;this.loadedSamples=[];this.metadataTags=null;this.tracks=[];this.readingMutex=new Te;this.lastSampleLoaded=!1;this.lastLoadedPos=0;this.nextTimestampInSamples=0;this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();if(!this.firstFrameHeader)throw new Error("No valid MP3 frame found.");this.tracks=[new te(this.input,new xs(this))]})()}async advanceReader(){if(this.lastLoadedPos===0)for(;;){let c=this.reader.requestSlice(this.lastLoadedPos,Hr);if(c instanceof Promise&&(c=await c),!c){this.lastSampleLoaded=!0;return}let u=nr(c);if(!u)break;this.lastLoadedPos=c.filePos+u.size}let e=await Mi(this.reader,this.lastLoadedPos,this.reader.fileSize);if(!e){this.lastSampleLoaded=!0;return}let r=e.header;this.lastLoadedPos=e.startPos+r.totalSize-1;let n=zr(r.mpegVersionId,r.channel),a=this.reader.requestSlice(e.startPos+n,4);if(a instanceof Promise&&(a=await a),a){let c=P(a);if(c===Vr||c===Vn)return}this.firstFrameHeader||(this.firstFrameHeader=r),r.sampleRate!==this.firstFrameHeader.sampleRate&&console.warn(`MP3 changed sample rate mid-file: ${this.firstFrameHeader.sampleRate} Hz to ${r.sampleRate} Hz. Might be a bug, so please report this file.`);let s=r.audioSamplesInFrame/this.firstFrameHeader.sampleRate,o={timestamp:this.nextTimestampInSamples/this.firstFrameHeader.sampleRate,duration:s,dataStart:e.startPos,dataSize:r.totalSize};this.loadedSamples.push(o),this.nextTimestampInSamples+=r.audioSamplesInFrame}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return p(e),e.computeDuration()}async getMetadataTags(){let e=await this.readingMutex.acquire();try{if(await this.readMetadata(),this.metadataTags)return this.metadataTags;this.metadataTags={};let r=0,n=!1;for(;;){let a=this.reader.requestSlice(r,Hr);if(a instanceof Promise&&(a=await a),!a)break;let s=nr(a);if(!s)break;n=!0;let o=this.reader.requestSlice(a.filePos,s.size);if(o instanceof Promise&&(o=await o),!o)break;Ln(o,s,this.metadataTags),r=a.filePos+s.size}if(!n&&this.reader.fileSize!==null&&this.reader.fileSize>=Fi){let a=this.reader.requestSlice(this.reader.fileSize-Fi,Fi);a instanceof Promise&&(a=await a),p(a),re(a,3)==="TAG"&&gc(a,this.metadataTags)}return this.metadataTags}finally{e()}}},xs=class{constructor(t){this.demuxer=t}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getName(){return null}getLanguageCode(){return ee}getCodec(){return"mp3"}getInternalCodecId(){return null}getNumberOfChannels(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}getDisposition(){return{...Se}}async getDecoderConfig(){return p(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}async getPacketAtIndex(t,e){if(t===-1)return null;let r=this.demuxer.loadedSamples[t];if(!r)return null;let n;if(e.metadataOnly)n=oe;else{let a=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(a instanceof Promise&&(a=await a),!a)return null;n=M(a,r.dataSize)}return new L(n,"key",r.timestamp,r.duration,t,r.dataSize)}getFirstPacket(t){return this.getPacketAtIndex(0,t)}async getNextPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{let n=Kt(this.demuxer.loadedSamples,t.timestamp,s=>s.timestamp);if(n===-1)throw new Error("Packet was not created from this track.");let a=n+1;for(;a>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(a,e)}finally{r()}}async getPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let n=z(this.demuxer.loadedSamples,t,a=>a.timestamp);if(n===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(n,e);if(n>=0&&n+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(n,e);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}};var Ri=1399285583,Zu=79764919,bc=new Uint32Array(256);for(let i=0;i<256;i++){let t=i<<24;for(let e=0;e<8;e++)t=t&2147483648?t<<1^Zu:t<<1;bc[i]=t>>>0&4294967295}var Hn=i=>{let t=D(i),e=t.getUint32(22,!0);t.setUint32(22,0,!0);let r=0;for(let n=0;n<i.length;n++){let a=i[n];r=(r<<8^bc[r>>>24^a])>>>0}return t.setUint32(22,e,!0),r},qn=(i,t,e)=>{let r=0,n=null;if(i.length>0)if(t.codec==="vorbis"){p(t.vorbisInfo);let a=t.vorbisInfo.modeBlockflags.length,o=(1<<yo(a-1))-1<<1,c=(i[0]&o)>>1;if(c>=t.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let u=e,d=t.vorbisInfo.modeBlockflags[c];if(n=t.vorbisInfo.blocksizes[d],d===1){let l=(o|1)+1,m=i[0]&l?1:0;u=t.vorbisInfo.blocksizes[m]}r=u!==null?u+n>>2:0}else t.codec==="opus"&&(r=qo(i).durationInSamples);return{durationInSamples:r,vorbisBlockSize:n}},jn=i=>{let t="audio/ogg";if(i.codecStrings){let e=[...new Set(i.codecStrings)];t+=`; codecs="${e.join(", ")}"`}return t};var zt=27,sr=282,Kn=sr+255*255,jr=i=>{let t=i.filePos;if(ar(i)!==Ri)return null;i.skip(1);let r=E(i),n=yc(i),a=ar(i),s=ar(i),o=ar(i),c=E(i),u=new Uint8Array(c);for(let f=0;f<c;f++)u[f]=E(i);let d=27+c,l=u.reduce((f,h)=>f+h,0),m=d+l;return{headerStartPos:t,totalSize:m,dataStartPos:t+d,dataSize:l,headerType:r,granulePosition:n,serialNumber:a,sequenceNumber:s,checksum:o,lacingValues:u}},kc=(i,t)=>{for(;i.filePos<t-3;){let e=ar(i),r=e&255,n=e>>>8&255,a=e>>>16&255,s=e>>>24&255,o=79;if(!(r!==o&&n!==o&&a!==o&&s!==o)){if(i.skip(-4),e===Ri)return!0;i.skip(1)}}return!1};var Gn=class extends he{constructor(e){super(e);this.metadataPromise=null;this.bitstreams=[];this.tracks=[];this.metadataTags={};this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let r=this.reader.requestSliceRange(e,zt,sr);if(r instanceof Promise&&(r=await r),!r)break;let n=jr(r);if(!n||!!!(n.headerType&2))break;this.bitstreams.push({serialNumber:n.serialNumber,bosPage:n,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),e=n.headerStartPos+n.totalSize}for(let r of this.bitstreams){let n=await this.readPacket(r.bosPage,0);n&&(n.data.byteLength>=7&&n.data[0]===1&&n.data[1]===118&&n.data[2]===111&&n.data[3]===114&&n.data[4]===98&&n.data[5]===105&&n.data[6]===115?await this.readVorbisMetadata(n,r):n.data.byteLength>=8&&n.data[0]===79&&n.data[1]===112&&n.data[2]===117&&n.data[3]===115&&n.data[4]===72&&n.data[5]===101&&n.data[6]===97&&n.data[7]===100&&await this.readOpusMetadata(n,r),r.codecInfo.codec!==null&&this.tracks.push(new te(this.input,new Cs(r,this))))}})()}async readVorbisMetadata(e,r){let n=await this.findNextPacketStart(e);if(!n)return;let a=await this.readPacket(n.startPage,n.startSegmentIndex);if(!a||(n=await this.findNextPacketStart(a),!n))return;let s=await this.readPacket(n.startPage,n.startSegmentIndex);if(!s||a.data[0]!==3||s.data[0]!==5)return;let o=[],c=m=>{for(;o.push(Math.min(255,m)),!(m<255);)m-=255};c(e.data.length),c(a.data.length);let u=new Uint8Array(1+o.length+e.data.length+a.data.length+s.data.length);u[0]=2,u.set(o,1),u.set(e.data,1+o.length),u.set(a.data,1+o.length+e.data.length),u.set(s.data,1+o.length+e.data.length+a.data.length),r.codecInfo.codec="vorbis",r.description=u,r.lastMetadataPacket=s;let d=D(e.data);r.numberOfChannels=d.getUint8(11),r.sampleRate=d.getUint32(12,!0);let l=d.getUint8(28);r.codecInfo.vorbisInfo={blocksizes:[1<<(l&15),1<<(l>>4)],modeBlockflags:Tn(s.data).modeBlockflags},bi(a.data.subarray(7),this.metadataTags)}async readOpusMetadata(e,r){let n=await this.findNextPacketStart(e);if(!n)return;let a=await this.readPacket(n.startPage,n.startSegmentIndex);if(!a)return;r.codecInfo.codec="opus",r.description=e.data,r.lastMetadataPacket=a;let s=Mt(e.data);r.numberOfChannels=s.outputChannelCount,r.sampleRate=Le,r.codecInfo.opusInfo={preSkip:s.preSkip},bi(a.data.subarray(8),this.metadataTags)}async readPacket(e,r){p(r<e.lacingValues.length);let n=0;for(let m=0;m<r;m++)n+=e.lacingValues[m];let a=e,s=n,o=r,c=[];e:for(;;){let m=this.reader.requestSlice(a.dataStartPos,a.dataSize);m instanceof Promise&&(m=await m),p(m);let f=M(m,a.dataSize);for(;;){if(o===a.lacingValues.length){c.push(f.subarray(n,s));break}let g=a.lacingValues[o];if(s+=g,g<255){c.push(f.subarray(n,s));break e}o++}let h=a.headerStartPos+a.totalSize;for(;;){let g=this.reader.requestSliceRange(h,zt,sr);if(g instanceof Promise&&(g=await g),!g)return null;let b=jr(g);if(!b)return null;if(a=b,a.serialNumber===e.serialNumber)break;h=a.headerStartPos+a.totalSize}n=0,s=0,o=0}let u=c.reduce((m,f)=>m+f.length,0);if(u===0)return null;let d=new Uint8Array(u),l=0;for(let m=0;m<c.length;m++){let f=c[m];d.set(f,l),l+=f.length}return{data:d,endPage:a,endSegmentIndex:o}}async findNextPacketStart(e){if(e.endSegmentIndex<e.endPage.lacingValues.length-1)return{startPage:e.endPage,startSegmentIndex:e.endSegmentIndex+1};if(!!(e.endPage.headerType&4))return null;let n=e.endPage.headerStartPos+e.endPage.totalSize;for(;;){let a=this.reader.requestSliceRange(n,zt,sr);if(a instanceof Promise&&(a=await a),!a)return null;let s=jr(a);if(!s)return null;if(s.serialNumber===e.endPage.serialNumber)return{startPage:s,startSegmentIndex:0};n=s.headerStartPos+s.totalSize}}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(r=>r.getCodecParameterString()));return jn({codecStrings:e.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){let e=await this.getTracks(),r=await Promise.all(e.map(n=>n.computeDuration()));return Math.max(0,...r)}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}},Cs=class{constructor(t,e){this.bitstream=t;this.demuxer=e;this.encodedPacketToMetadata=new WeakMap;this.sequentialScanCache=[];this.sequentialScanMutex=new Te;this.internalSampleRate=t.codecInfo.codec==="opus"?Le:t.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}getInternalCodecId(){return null}async getDecoderConfig(){return p(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getName(){return null}getLanguageCode(){return ee}getDisposition(){return{...Se}}async getFirstTimestamp(){return 0}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}granulePositionToTimestampInSamples(t){return this.bitstream.codecInfo.codec==="opus"?(p(this.bitstream.codecInfo.opusInfo),t-this.bitstream.codecInfo.opusInfo.preSkip):t}createEncodedPacketFromOggPacket(t,e,r){if(!t)return null;let{durationInSamples:n,vorbisBlockSize:a}=qn(t.data,this.bitstream.codecInfo,e.vorbisLastBlocksize),s=new L(r.metadataOnly?oe:t.data,"key",Math.max(0,e.timestampInSamples)/this.internalSampleRate,n/this.internalSampleRate,t.endPage.headerStartPos+t.endSegmentIndex,t.data.byteLength);return this.encodedPacketToMetadata.set(s,{packet:t,timestampInSamples:e.timestampInSamples,durationInSamples:n,vorbisLastBlockSize:e.vorbisLastBlocksize,vorbisBlockSize:a}),s}async getFirstPacket(t){p(this.bitstream.lastMetadataPacket);let e=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!e)return null;let r=0;this.bitstream.codecInfo.codec==="opus"&&(p(this.bitstream.codecInfo.opusInfo),r-=this.bitstream.codecInfo.opusInfo.preSkip);let n=await this.demuxer.readPacket(e.startPage,e.startSegmentIndex);return this.createEncodedPacketFromOggPacket(n,{timestampInSamples:r,vorbisLastBlocksize:null},t)}async getNextPacket(t,e){let r=this.encodedPacketToMetadata.get(t);if(!r)throw new Error("Packet was not created from this track.");let n=await this.demuxer.findNextPacketStart(r.packet);if(!n)return null;let a=r.timestampInSamples+r.durationInSamples,s=await this.demuxer.readPacket(n.startPage,n.startSegmentIndex);return this.createEncodedPacketFromOggPacket(s,{timestampInSamples:a,vorbisLastBlocksize:r.vorbisBlockSize},e)}async getPacket(t,e){if(this.demuxer.reader.fileSize===null)return this.getPacketSequential(t,e);let r=lt(t*this.internalSampleRate);if(r===0)return this.getFirstPacket(e);if(r<0)return null;p(this.bitstream.lastMetadataPacket);let n=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!n)return null;let a=n.startPage,s=this.demuxer.reader.fileSize,o=[a];e:for(;a.headerStartPos+a.totalSize<s;){let k=a.headerStartPos,w=Math.floor((k+s)/2),S=w;for(;;){let T=Math.min(S+Kn,s-zt),x=this.demuxer.reader.requestSlice(S,T-S);if(x instanceof Promise&&(x=await x),p(x),!kc(x,T)){s=w+zt;continue e}let C=this.demuxer.reader.requestSliceRange(x.filePos,zt,sr);C instanceof Promise&&(C=await C),p(C);let _=jr(C);p(_);let U=!1;if(_.serialNumber===this.bitstream.serialNumber)U=!0;else{let R=this.demuxer.reader.requestSlice(_.headerStartPos,_.totalSize);R instanceof Promise&&(R=await R),p(R);let H=M(R,_.totalSize);U=Hn(H)===_.checksum}if(!U){S=_.headerStartPos+4;continue}if(U&&_.serialNumber!==this.bitstream.serialNumber){S=_.headerStartPos+_.totalSize;continue}if(_.granulePosition===-1){S=_.headerStartPos+_.totalSize;continue}this.granulePositionToTimestampInSamples(_.granulePosition)>r?s=_.headerStartPos:(a=_,o.push(_));continue e}}let c=n.startPage;for(let k of o){if(k.granulePosition===a.granulePosition)break;(!c||k.headerStartPos>c.headerStartPos)&&(c=k)}let u=c,d=[u];for(;!(u.serialNumber===this.bitstream.serialNumber&&u.granulePosition===a.granulePosition);){let k=u.headerStartPos+u.totalSize,w=this.demuxer.reader.requestSliceRange(k,zt,sr);w instanceof Promise&&(w=await w),p(w);let S=jr(w);p(S),u=S,u.serialNumber===this.bitstream.serialNumber&&d.push(u)}p(u.granulePosition!==-1);let l=null,m,f,h=u,g=0;if(u.headerStartPos===n.startPage.headerStartPos)m=this.granulePositionToTimestampInSamples(0),f=!0,l=0;else{m=0,f=!1;for(let S=u.lacingValues.length-1;S>=0;S--)if(u.lacingValues[S]<255){l=S+1;break}if(l===null)throw new Error("Invalid page with granule position: no packets end on this page.");g=l-1;let k={data:oe,endPage:h,endSegmentIndex:g};if(await this.demuxer.findNextPacketStart(k)){let S=Tc(d,u,l);p(S);let T=wc(d,S.page,S.segmentIndex);T&&(u=T.page,l=T.segmentIndex)}else for(;;){let S=Tc(d,u,l);if(!S)break;let T=wc(d,S.page,S.segmentIndex);if(!T)break;if(u=T.page,l=T.segmentIndex,S.page.headerStartPos!==h.headerStartPos){h=S.page,g=S.segmentIndex;break}}}let b=null,y=null;for(;u!==null;){p(l!==null);let k=await this.demuxer.readPacket(u,l);if(!k)break;if(!(u.headerStartPos===n.startPage.headerStartPos&&l<n.startSegmentIndex)){let T=this.createEncodedPacketFromOggPacket(k,{timestampInSamples:m,vorbisLastBlocksize:y?.vorbisBlockSize??null},e);p(T);let x=this.encodedPacketToMetadata.get(T);if(p(x),!f&&k.endPage.headerStartPos===h.headerStartPos&&k.endSegmentIndex===g?(m=this.granulePositionToTimestampInSamples(u.granulePosition),f=!0,T=this.createEncodedPacketFromOggPacket(k,{timestampInSamples:m-x.durationInSamples,vorbisLastBlocksize:y?.vorbisBlockSize??null},e),p(T),x=this.encodedPacketToMetadata.get(T),p(x)):m+=x.durationInSamples,b=T,y=x,f&&(Math.max(m,0)>r||Math.max(x.timestampInSamples,0)===r))break}let S=await this.demuxer.findNextPacketStart(k);if(!S)break;u=S.startPage,l=S.startSegmentIndex}return b}async getPacketSequential(t,e){let r=await this.sequentialScanMutex.acquire();try{let n=lt(t*this.internalSampleRate);t=n/this.internalSampleRate;let a=z(this.sequentialScanCache,n,c=>c.timestampInSamples),s;if(a!==-1){let c=this.sequentialScanCache[a];s=this.createEncodedPacketFromOggPacket(c.packet,{timestampInSamples:c.timestampInSamples,vorbisLastBlocksize:c.vorbisLastBlockSize},e)}else s=await this.getFirstPacket(e);let o=0;for(;s&&s.timestamp<t;){let c=await this.getNextPacket(s,e);if(!c||c.timestamp>t)break;if(s=c,o++,o===100){o=0;let u=this.encodedPacketToMetadata.get(s);p(u),this.sequentialScanCache.length>0&&p(j(this.sequentialScanCache).timestampInSamples<=u.timestampInSamples),this.sequentialScanCache.push(u)}}return s}finally{r()}}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}},wc=(i,t,e)=>{let r=t,n=e;e:for(;;){for(n--,n;n>=0;n--)if(r.lacingValues[n]<255){n++;break e}if(p(n===-1),!(r.headerType&1)){n=0;break}let s=Xa(i,o=>o.headerStartPos<r.headerStartPos);if(!s)return null;r=s,n=r.lacingValues.length}if(p(n!==-1),n===r.lacingValues.length){let a=i[i.indexOf(r)+1];p(a),r=a,n=0}return{page:r,segmentIndex:n}},Tc=(i,t,e)=>{if(e>0)return{page:t,segmentIndex:e-1};let r=Xa(i,n=>n.headerStartPos<t.headerStartPos);return r?{page:r,segmentIndex:r.lacingValues.length-1}:null};var Qn=class extends he{constructor(e){super(e);this.metadataPromise=null;this.dataStart=-1;this.dataSize=-1;this.audioInfo=null;this.tracks=[];this.lastKnownPacketIndex=0;this.metadataTags={};this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=this.reader.requestSlice(0,12);e instanceof Promise&&(e=await e),p(e);let r=re(e,4),n=r!=="RIFX",a=r==="RF64",s=St(e,n),o=a?this.reader.fileSize:Math.min(s+8,this.reader.fileSize??1/0);if(re(e,4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");let u=0,d=null,l=e.filePos;for(;o===null||l<o;){let f=this.reader.requestSlice(l,8);if(f instanceof Promise&&(f=await f),!f)break;let h=re(f,4),g=St(f,n),b=f.filePos;if(a&&u===0&&h!=="ds64")throw new Error('Invalid RF64 file: First chunk must be "ds64".');if(h==="fmt ")await this.parseFmtChunk(b,g,n);else if(h==="data"){if(d??=g,this.dataStart=f.filePos,this.dataSize=Math.min(d,(o??1/0)-this.dataStart),this.reader.fileSize===null)break}else if(h==="ds64"){let y=this.reader.requestSlice(b,g);if(y instanceof Promise&&(y=await y),!y)break;let k=vs(y,n);d=vs(y,n),o=Math.min(k+8,this.reader.fileSize??1/0)}else h==="LIST"?await this.parseListChunk(b,g,n):(h==="ID3 "||h==="id3 ")&&await this.parseId3Chunk(b,g);l=b+g+(g&1),u++}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');let m=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/m)*m,this.tracks.push(new te(this.input,new Ps(this)))})()}async parseFmtChunk(e,r,n){let a=this.reader.requestSlice(e,r);if(a instanceof Promise&&(a=await a),!a)return;let s=Gr(a,n),o=Gr(a,n),c=St(a,n);a.skip(4);let u=Gr(a,n),d;if(r===14?d=8:d=Gr(a,n),r>=18&&s!==357){let l=Gr(a,n),m=r-18;if(Math.min(m,l)>=22&&s===65534){a.skip(6);let h=M(a,16);s=h[0]|h[1]<<8}}(s===7||s===6)&&(d=8),this.audioInfo={format:s,numberOfChannels:o,sampleRate:c,sampleSizeInBytes:Math.ceil(d/8),blockSizeInBytes:u}}async parseListChunk(e,r,n){let a=this.reader.requestSlice(e,r);if(a instanceof Promise&&(a=await a),!a)return;let s=re(a,4);if(s!=="INFO"&&s!=="INF0")return;let o=a.filePos;for(;o<=e+r-8;){a.filePos=o;let c=re(a,4),u=St(a,n),d=M(a,u),l=0;for(let f=0;f<d.length&&d[f]!==0;f++)l++;let m=String.fromCharCode(...d.subarray(0,l));switch(this.metadataTags.raw??={},this.metadataTags.raw[c]=m,c){case"INAM":case"TITL":this.metadataTags.title??=m;break;case"TIT3":this.metadataTags.description??=m;break;case"IART":this.metadataTags.artist??=m;break;case"IPRD":this.metadataTags.album??=m;break;case"IPRT":case"ITRK":case"TRCK":{let f=m.split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(this.metadataTags.trackNumber??=h),g&&Number.isInteger(g)&&g>0&&(this.metadataTags.tracksTotal??=g)}break;case"ICRD":case"IDIT":{let f=new Date(m);Number.isNaN(f.getTime())||(this.metadataTags.date??=f)}break;case"YEAR":{let f=Number.parseInt(m,10);Number.isInteger(f)&&f>0&&(this.metadataTags.date??=new Date(f,0,1))}break;case"IGNR":case"GENR":this.metadataTags.genre??=m;break;case"ICMT":case"CMNT":case"COMM":this.metadataTags.comment??=m;break}o+=8+u+(u&1)}}async parseId3Chunk(e,r){let n=this.reader.requestSlice(e,r);if(n instanceof Promise&&(n=await n),!n)return;let a=nr(n);if(a){let s=n.slice(e+10,a.size);Ln(s,a,this.metadataTags)}}getCodec(){if(p(this.audioInfo),this.audioInfo.format===7)return"ulaw";if(this.audioInfo.format===6)return"alaw";if(this.audioInfo.format===1){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===3&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return p(e),e.computeDuration()}async getTracks(){return await this.readMetadata(),this.tracks}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}},Kr=2048,Ps=class{constructor(t){this.demuxer=t}getId(){return 1}getCodec(){return this.demuxer.getCodec()}getInternalCodecId(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.format}async getDecoderConfig(){let t=this.demuxer.getCodec();return t?(p(this.demuxer.audioInfo),{codec:t,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getNumberOfChannels(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return ee}getDisposition(){return{...Se}}async getFirstTimestamp(){return 0}async getPacketAtIndex(t,e){p(this.demuxer.audioInfo);let r=t*Kr*this.demuxer.audioInfo.blockSizeInBytes;if(r>=this.demuxer.dataSize)return null;let n=Math.min(Kr*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-r);if(this.demuxer.reader.fileSize===null){let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,n);if(c instanceof Promise&&(c=await c),!c)return null}let a;if(e.metadataOnly)a=oe;else{let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,n);c instanceof Promise&&(c=await c),p(c),a=M(c,n)}let s=t*Kr/this.demuxer.audioInfo.sampleRate,o=n/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return this.demuxer.lastKnownPacketIndex=Math.max(t,s),new L(a,"key",s,o,t,n)}getFirstPacket(t){return this.getPacketAtIndex(0,t)}async getPacket(t,e){p(this.demuxer.audioInfo);let r=Math.floor(Math.min(t*this.demuxer.audioInfo.sampleRate/Kr,(this.demuxer.dataSize-1)/(Kr*this.demuxer.audioInfo.blockSizeInBytes))),n=await this.getPacketAtIndex(r,e);if(n)return n;if(r===0)return null;p(this.demuxer.reader.fileSize===null);let a=await this.getPacketAtIndex(this.demuxer.lastKnownPacketIndex,e);for(;a;){let s=await this.getNextPacket(a,e);if(!s)break;a=s}return a}getNextPacket(t,e){p(this.demuxer.audioInfo);let r=Math.round(t.timestamp*this.demuxer.audioInfo.sampleRate/Kr);return this.getPacketAtIndex(r+1,e)}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}};var xt=7,Oe=9,Ee=i=>{let t=i.filePos,e=M(i,9),r=new V(e);if(r.readBits(12)!==4095||(r.skipBits(1),r.readBits(2)!==0))return null;let s=r.readBits(1),o=r.readBits(2)+1,c=r.readBits(4);if(c===15)return null;r.skipBits(1);let u=r.readBits(3);if(u===0)throw new Error("ADTS frames with channel configuration 0 are not supported.");r.skipBits(1),r.skipBits(1),r.skipBits(1),r.skipBits(1);let d=r.readBits(13);r.skipBits(11);let l=r.readBits(2)+1;if(l!==1)throw new Error("ADTS frames with more than one AAC frame are not supported.");let m=null;return s===1?i.filePos-=2:m=r.readBits(16),{objectType:o,samplingFrequencyIndex:c,channelConfiguration:u,frameLength:d,numberOfAacFrames:l,crcCheck:m,startPos:t}};var Di=1024,$n=class extends he{constructor(e){super(e);this.metadataPromise=null;this.firstFrameHeader=null;this.loadedSamples=[];this.tracks=[];this.readingMutex=new Te;this.lastSampleLoaded=!1;this.lastLoadedPos=0;this.nextTimestampInSamples=0;this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();p(this.firstFrameHeader),this.tracks=[new te(this.input,new Is(this))]})()}async advanceReader(){let e=this.reader.requestSliceRange(this.lastLoadedPos,xt,Oe);if(e instanceof Promise&&(e=await e),!e){this.lastSampleLoaded=!0;return}let r=Ee(e);if(!r){this.lastSampleLoaded=!0;return}if(this.reader.fileSize!==null&&r.startPos+r.frameLength>this.reader.fileSize){this.lastSampleLoaded=!0;return}this.firstFrameHeader||(this.firstFrameHeader=r);let n=Ue[r.samplingFrequencyIndex];p(n!==void 0);let a=Di/n,s={timestamp:this.nextTimestampInSamples/n,duration:a,dataStart:r.startPos,dataSize:r.frameLength};this.loadedSamples.push(s),this.nextTimestampInSamples+=Di,this.lastLoadedPos=r.startPos+r.frameLength}async getMimeType(){return"audio/aac"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return p(e),e.computeDuration()}async getMetadataTags(){return{}}},Is=class{constructor(t){this.demuxer=t}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return this.getSampleRate()/Di}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getName(){return null}getLanguageCode(){return ee}getCodec(){return"aac"}getInternalCodecId(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.objectType}getNumberOfChannels(){p(this.demuxer.firstFrameHeader);let t=et[this.demuxer.firstFrameHeader.channelConfiguration];return p(t!==void 0),t}getSampleRate(){p(this.demuxer.firstFrameHeader);let t=Ue[this.demuxer.firstFrameHeader.samplingFrequencyIndex];return p(t!==void 0),t}getDisposition(){return{...Se}}async getDecoderConfig(){return p(this.demuxer.firstFrameHeader),{codec:`mp4a.40.${this.demuxer.firstFrameHeader.objectType}`,numberOfChannels:this.getNumberOfChannels(),sampleRate:this.getSampleRate()}}async getPacketAtIndex(t,e){if(t===-1)return null;let r=this.demuxer.loadedSamples[t];if(!r)return null;let n;if(e.metadataOnly)n=oe;else{let a=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(a instanceof Promise&&(a=await a),!a)return null;n=M(a,r.dataSize)}return new L(n,"key",r.timestamp,r.duration,t,r.dataSize)}getFirstPacket(t){return this.getPacketAtIndex(0,t)}async getNextPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{let n=Kt(this.demuxer.loadedSamples,t.timestamp,s=>s.timestamp);if(n===-1)throw new Error("Packet was not created from this track.");let a=n+1;for(;a>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(a,e)}finally{r()}}async getPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let n=z(this.demuxer.loadedSamples,t,a=>a.timestamp);if(n===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(n,e);if(n>=0&&n+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(n,e);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}};var Xn=i=>i===0?null:i===1?192:i>=2&&i<=5?144*2**i:i===6?"uncommon-u8":i===7?"uncommon-u16":i>=8&&i<=15?2**i:null,Sc=(i,t)=>{switch(i){case 0:return t;case 1:return 88200;case 2:return 176400;case 3:return 192e3;case 4:return 8e3;case 5:return 16e3;case 6:return 22050;case 7:return 24e3;case 8:return 32e3;case 9:return 44100;case 10:return 48e3;case 11:return 96e3;case 12:return"uncommon-u8";case 13:return"uncommon-u16";case 14:return"uncommon-u16-10";default:return null}},Yn=i=>{let t=0,e=new V(M(i,1));for(;e.readBits(1)===1;)t++;if(t===0)return e.readBits(7);let r=[],n=t-1,a=new V(M(i,n)),s=8-t-1;for(let c=0;c<s;c++)r.unshift(e.readBits(1));for(let c=0;c<n;c++)for(let u=0;u<8;u++){let d=a.readBits(1);u<2||r.unshift(d)}return r.reduce((c,u,d)=>c|u<<d,0)},Zn=(i,t)=>{if(t==="uncommon-u16")return ce(i)+1;if(t==="uncommon-u8")return E(i)+1;if(typeof t=="number")return t;J(t),p(!1)},xc=(i,t)=>t==="uncommon-u16"?ce(i):t==="uncommon-u16-10"?ce(i)*10:t==="uncommon-u8"?E(i):typeof t=="number"?t:null,Cc=i=>{let e=0;for(let r of i){e^=r;for(let n=0;n<8;n++)(e&128)!==0?e=e<<1^7:e<<=1,e&=255}return e};var Jn=class extends he{constructor(e){super(e);this.loadedSamples=[];this.metadataPromise=null;this.track=null;this.metadataTags={};this.audioInfo=null;this.lastLoadedPos=null;this.blockingBit=null;this.readingMutex=new Te;this.lastSampleLoaded=!1;this.reader=e._reader}async computeDuration(){return await this.readMetadata(),p(this.track),this.track.computeDuration()}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}async getTracks(){return await this.readMetadata(),p(this.track),[this.track]}async getMimeType(){return"audio/flac"}async readMetadata(){let e=4;return this.metadataPromise??=(async()=>{for(;this.reader.fileSize===null||e<this.reader.fileSize;){let r=this.reader.requestSlice(e,4);if(r instanceof Promise&&(r=await r),e+=4,r===null)throw new Error(`Metadata block at position ${e} is too small! Corrupted file.`);p(r);let n=E(r),a=Ut(r),s=(n&128)!==0;switch(n&127){case 0:{let c=this.reader.requestSlice(e,a);if(c instanceof Promise&&(c=await c),p(c),c===null)throw new Error(`StreamInfo block at position ${e} is too small! Corrupted file.`);let u=M(c,34),d=new V(u),l=d.readBits(16),m=d.readBits(16),f=d.readBits(24),h=d.readBits(24),g=d.readBits(20),b=d.readBits(3)+1;d.readBits(5);let y=d.readBits(36);d.skipBits(16*8);let k=new Uint8Array(42);k.set(new Uint8Array([102,76,97,67]),0),k.set(new Uint8Array([128,0,0,34]),4),k.set(u,8),this.audioInfo={numberOfChannels:b,sampleRate:g,totalSamples:y,minimumBlockSize:l,maximumBlockSize:m,minimumFrameSize:f,maximumFrameSize:h,description:k},this.track=new te(this.input,new As(this));break}case 4:{let c=this.reader.requestSlice(e,a);c instanceof Promise&&(c=await c),p(c),bi(M(c,a),this.metadataTags);break}case 6:{let c=this.reader.requestSlice(e,a);c instanceof Promise&&(c=await c),p(c);let u=P(c),d=P(c),l=fe.decode(M(c,d)),m=P(c),f=fe.decode(M(c,m));c.skip(16);let h=P(c),g=M(c,h);this.metadataTags.images??=[],this.metadataTags.images.push({data:g,mimeType:l,kind:u===3?"coverFront":u===4?"coverBack":"unknown",description:f});break}default:break}if(e+=a,s){this.lastLoadedPos=e;break}}})()}async readNextFlacFrame({startPos:e,isFirstPacket:r}){p(this.audioInfo);let n=6,s=this.audioInfo.maximumFrameSize+16,o=await this.reader.requestSliceRange(e,this.audioInfo.minimumFrameSize,s);if(!o)return null;let c=this.readFlacFrameHeader({slice:o,isFirstPacket:r});if(!c)return null;for(o.filePos=e+this.audioInfo.minimumFrameSize;;){if(o.filePos>o.end-n)return{num:c.num,blockSize:c.blockSize,sampleRate:c.sampleRate,size:o.end-e,isLastFrame:!0};if(E(o)===255){let d=o.filePos,l=E(o),m=this.blockingBit===1?249:248;if(l!==m){o.filePos=d;continue}o.skip(-2);let f=o.filePos-e,h=this.readFlacFrameHeader({slice:o,isFirstPacket:!1});if(!h){o.filePos=d;continue}if(this.blockingBit===0){if(h.num-c.num!==1){o.filePos=d;continue}}else if(h.num-c.num!==c.blockSize){o.filePos=d;continue}return{num:c.num,blockSize:c.blockSize,sampleRate:c.sampleRate,size:f,isLastFrame:!1}}}}readFlacFrameHeader({slice:e,isFirstPacket:r}){let n=e.filePos,a=M(e,4),s=new V(a);if(s.readBits(15)!==32764)return null;if(this.blockingBit===null){p(r);let y=s.readBits(1);this.blockingBit=y}else if(this.blockingBit===1){if(p(!r),s.readBits(1)!==1)return null}else if(this.blockingBit===0){if(p(!r),s.readBits(1)!==0)return null}else throw new Error("Invalid blocking bit");let c=Xn(s.readBits(4));if(!c)return null;p(this.audioInfo);let u=Sc(s.readBits(4),this.audioInfo.sampleRate);if(!u||(s.readBits(4),s.readBits(3),s.readBits(1)!==0))return null;let l=Yn(e),m=Zn(e,c),f=xc(e,u);if(f===null||f!==this.audioInfo.sampleRate)return null;let h=e.filePos-n,g=E(e);e.skip(-h),e.skip(-1);let b=Cc(M(e,h));return g!==b?null:{num:l,blockSize:m,sampleRate:f}}async advanceReader(){await this.readMetadata(),p(this.lastLoadedPos!==null),p(this.audioInfo);let e=this.lastLoadedPos,r=await this.readNextFlacFrame({startPos:e,isFirstPacket:this.loadedSamples.length===0});if(!r){this.lastSampleLoaded=!0;return}let n=this.loadedSamples[this.loadedSamples.length-1],s={blockOffset:n?n.blockOffset+n.blockSize:0,blockSize:r.blockSize,byteOffset:e,byteSize:r.size};if(this.lastLoadedPos=this.lastLoadedPos+r.size,this.loadedSamples.push(s),r.isLastFrame){this.lastSampleLoaded=!0;return}}},As=class{constructor(t){this.demuxer=t}getId(){return 1}getCodec(){return"flac"}getInternalCodecId(){return null}getNumberOfChannels(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}getSampleRate(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return ee}getTimeResolution(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getDisposition(){return{...Se}}async getFirstTimestamp(){return 0}async getDecoderConfig(){return p(this.demuxer.audioInfo),{codec:"flac",numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate,description:this.demuxer.audioInfo.description}}async getPacket(t,e){if(p(this.demuxer.audioInfo),t<0)throw new Error("Timestamp cannot be negative");let r=await this.demuxer.readingMutex.acquire();try{for(;;){let n=z(this.demuxer.loadedSamples,t,c=>c.blockOffset/this.demuxer.audioInfo.sampleRate);if(n===-1){await this.demuxer.advanceReader();continue}let a=this.demuxer.loadedSamples[n],s=a.blockOffset/this.demuxer.audioInfo.sampleRate,o=a.blockSize/this.demuxer.audioInfo.sampleRate;if(s+o<=t){if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(this.demuxer.loadedSamples.length-1,e);await this.demuxer.advanceReader();continue}return this.getPacketAtIndex(n,e)}}finally{r()}}async getNextPacket(t,e){let r=await this.demuxer.readingMutex.acquire();try{let n=t.sequenceNumber+1;if(this.demuxer.lastSampleLoaded&&n>=this.demuxer.loadedSamples.length)return null;for(;n>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(n,e)}finally{r()}}getKeyPacket(t,e){return this.getPacket(t,e)}getNextKeyPacket(t,e){return this.getNextPacket(t,e)}async getPacketAtIndex(t,e){let r=this.demuxer.loadedSamples[t];if(!r)return null;let n;if(e.metadataOnly)n=oe;else{let o=this.demuxer.reader.requestSlice(r.byteOffset,r.byteSize);if(o instanceof Promise&&(o=await o),!o)return null;n=M(o,r.byteSize)}p(this.demuxer.audioInfo);let a=r.blockOffset/this.demuxer.audioInfo.sampleRate,s=r.blockSize/this.demuxer.audioInfo.sampleRate;return new L(n,"key",a,s,t,r.byteSize)}async getFirstPacket(t){for(;this.demuxer.loadedSamples.length===0&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(0,t)}};var ea=i=>{let t="video/MP2T",e=[...new Set(i.filter(Boolean))];return e.length>0&&(t+=`; codecs="${e.join(", ")}"`),t};var Qr="No PES packet found where one was expected.",ta=class extends he{constructor(e){super(e);this.metadataPromise=null;this.elementaryStreams=[];this.tracks=[];this.packetOffset=0;this.packetStride=-1;this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=205,r=this.reader.requestSlice(0,e);r instanceof Promise&&(r=await r),p(r);let n=M(r,e);if(n[0]===71&&n[188]===71)this.packetOffset=0,this.packetStride=188;else if(n[0]===71&&n[204]===71)this.packetOffset=0,this.packetStride=204;else if(n[4]===71&&n[192]===71)this.packetOffset=4,this.packetStride=188;else throw new Error("Unreachable.");let a=this.packetOffset,s=null,o=!1,c=!1;for(;;){let u=await this.readSection(a,!0);if(!u)break;let d=3,l=32;if(u.pid===0&&!o){let f=new V(u.payload),h=f.readAlignedByte();f.skipBits(8*h),f.skipBits(14);let g=f.readBits(10);for(f.skipBits(40);8*(g+d)-f.pos>l;){let b=f.readBits(16);if(f.skipBits(3),b!==0){if(s!==null)throw new Error("Only files with a single program are supported.");s=f.readBits(13)}}if(s===null)throw new Error("Program Association Table must link to a Program Map Table.");o=!0}else if(u.pid===s&&!c){let f=new V(u.payload),h=f.readAlignedByte();f.skipBits(8*h),f.skipBits(12);let g=f.readBits(12);f.skipBits(43);let b=f.readBits(13);f.skipBits(6);let y=f.readBits(10);for(f.skipBits(8*y);8*(g+d)-f.pos>l;){let k=f.readBits(8);f.skipBits(3);let w=f.readBits(13);f.skipBits(6);let S=f.readBits(10);f.skipBits(8*S);let T=null;switch(k){case 3:case 4:case 15:T={type:"audio",codec:k===15?"aac":"mp3",aacCodecInfo:null,numberOfChannels:-1,sampleRate:-1};break;case 27:case 36:T={type:"video",codec:k===27?"avc":"hevc",avcCodecInfo:null,hevcCodecInfo:null,colorSpace:{primaries:null,transfer:null,matrix:null,fullRange:null},width:-1,height:-1,reorderSize:-1};break;default:}T&&this.elementaryStreams.push({demuxer:this,pid:w,streamType:k,initialized:!1,firstSection:null,info:T})}c=!0}else{let f=this.elementaryStreams.find(h=>h.pid===u.pid);if(f&&!f.initialized){let h=Xr(u);if(!h)throw new Error(`Couldn't read first PES packet for Elementary Stream with PID ${f.pid}`);if(f.firstSection=u,f.info.type==="video")if(f.info.codec==="avc"){if(f.info.avcCodecInfo=Cr(h.data),!f.info.avcCodecInfo)throw new Error("Invalid AVC video stream; could not extract AVCDecoderConfigurationRecord from first packet.");let g=f.info.avcCodecInfo.sequenceParameterSets[0];p(g);let b=gi(g);f.info.width=b.displayWidth,f.info.height=b.displayHeight,f.info.colorSpace={primaries:Ht[b.colourPrimaries],transfer:qt[b.transferCharacteristics],matrix:jt[b.matrixCoefficients],fullRange:!!b.fullRangeFlag},f.info.reorderSize=b.maxDecFrameBuffering,f.initialized=!0}else if(f.info.codec==="hevc"){if(f.info.hevcCodecInfo=Pr(h.data),!f.info.hevcCodecInfo)throw new Error("Invalid HEVC video stream; could not extract HVCDecoderConfigurationRecord from first packet.");let b=f.info.hevcCodecInfo.arrays.find(k=>k.nalUnitType===33).nalUnits[0];p(b);let y=ns(b);f.info.width=y.displayWidth,f.info.height=y.displayHeight,f.info.colorSpace={primaries:Ht[y.colourPrimaries],transfer:qt[y.transferCharacteristics],matrix:jt[y.matrixCoefficients],fullRange:!!y.fullRangeFlag},f.info.reorderSize=y.maxDecFrameBuffering,f.initialized=!0}else throw new Error("Unhandled.");else if(f.info.codec==="aac"){let g=ge.tempFromBytes(h.data),b=Ee(g);if(!b)throw new Error("Invalid AAC audio stream; could not read ADTS frame header from first packet.");f.info.aacCodecInfo={isMpeg2:!1,objectType:b.objectType},f.info.numberOfChannels=et[b.channelConfiguration],f.info.sampleRate=Ue[b.samplingFrequencyIndex],f.initialized=!0}else if(f.info.codec==="mp3"){let g=P(ge.tempFromBytes(h.data)),b=ir(g,h.data.byteLength);if(!b.header)throw new Error("Invalid MP3 audio stream; could not read frame header from first packet.");f.info.numberOfChannels=b.header.channel===3?1:2,f.info.sampleRate=b.header.sampleRate,f.initialized=!0}else throw new Error("Unhandled.")}}if(c&&this.elementaryStreams.every(f=>f.initialized))break;p(u.endPos!==null),a=u.endPos}for(let u of this.elementaryStreams)u.info.type==="video"?this.tracks.push(new Ie(this.input,new Es(u))):this.tracks.push(new te(this.input,new _s(u)))})()}async getTracks(){return await this.readMetadata(),this.tracks}async getMetadataTags(){return{}}async computeDuration(){let e=await this.getTracks(),r=await Promise.all(e.map(n=>n.computeDuration()));return Math.max(0,...r)}async getMimeType(){await this.readMetadata();let e=await this.getTracks(),r=await Promise.all(e.map(n=>n.getCodecParameterString()));return ea(r)}async readSection(e,r){let n=e,a=e,s=[],o=0,c=null;for(;;){let d=await this.readPacket(a);if(a+=this.packetStride,!d)break;if(c){if(d.pid!==c.pid)continue;if(d.payloadUnitStartIndicator===1)break}else{if(d.payloadUnitStartIndicator===0)break;c=d}let l=!!(d.adaptationFieldControl&2),m=!!(d.adaptationFieldControl&1),f=0;if(l&&(f=1+d.body[0]),m&&(f===0?(s.push(d.body),o+=d.body.byteLength):(s.push(d.body.subarray(f)),o+=d.body.byteLength-f)),n=a,!r&&o>=64)break}if(!c)return null;let u;if(s.length===1)u=s[0];else{let d=s.reduce((m,f)=>m+f.length,0);u=new Uint8Array(d);let l=0;for(let m of s)u.set(m,l),l+=m.length}return{startPos:e,endPos:r?n:null,pid:c.pid,payload:u}}async readPacketHeader(e){let r=this.reader.requestSlice(e,4);if(r instanceof Promise&&(r=await r),!r)return null;if(E(r)!==71)throw new Error("Invalid TS packet sync byte. Likely an internal bug, please report this file.");let a=ce(r),s=a>>15,o=a>>14&1,c=a>>13&1,u=a&8191,d=E(r),l=d>>6,m=d>>4&3,f=d&15;return{payloadUnitStartIndicator:o,pid:u,adaptationFieldControl:m}}async readPacket(e){let r=this.reader.requestSlice(e,188);if(r instanceof Promise&&(r=await r),!r)return null;let n=M(r,188);if(n[0]!==71)throw new Error("Invalid TS packet sync byte. Likely an internal bug, please report this file.");let s=(n[1]<<8)+n[2],o=s>>15,c=s>>14&1,u=s>>13&1,d=s&8191,l=n[3],m=l>>6,f=l>>4&3,h=l&15;return{payloadUnitStartIndicator:c,pid:d,adaptationFieldControl:f,body:n.subarray(4)}}},$r=i=>{let t=new V(i.payload);if(t.readBits(24)!==1)return null;let r=t.readBits(8);if(t.skipBits(16),r===188||r===190||r===191||r===240||r===241||r===255||r===242||r===248)return null;t.skipBits(8);let n=t.readBits(2);t.skipBits(14);let a=0;if(n===2||n===3)t.skipBits(4),a+=t.readBits(3)*(1<<30),t.skipBits(1),a+=t.readBits(15)*32768,t.skipBits(1),a+=t.readBits(15);else throw new Error("PES packets without PTS are not currently supported. If you think this file should be supported, please report it.");return{sectionStartPos:i.startPos,sectionEndPos:i.endPos,pts:a}},Xr=i=>{p(i.endPos!==null);let t=$r(i);if(!t)return null;let e=new V(i.payload);e.skipBits(32);let r=e.readBits(16),n=6;e.skipBits(16);let a=e.readBits(8),s=e.pos+8*a;e.pos=s;let o=s/8;p(Number.isInteger(o));let c=i.payload.subarray(o,r>0?n+r:i.payload.byteLength);return{...t,data:c}},ra=class{constructor(t){this.elementaryStream=t;this.referencePesPackets=[];this.endReferencePesPacketAdded=!1;this.packetBuffers=new WeakMap;this.packetSectionStarts=new WeakMap;this.mutex=new Te}getId(){return this.elementaryStream.pid}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.elementaryStream.streamType}getName(){return null}getLanguageCode(){return ee}getDisposition(){return Se}getTimeResolution(){return 9e4}async computeDuration(){let t=await this.getPacket(1/0,{metadataOnly:!0});return(t?.timestamp??0)+(t?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}createEncodedPacket(t,e,r){return new L(r.metadataOnly?oe:t.data,this.getPacketType(t.data),t.pts/9e4,Math.max(e/9e4,0),t.sequenceNumber,t.data.byteLength)}maybeInsertReferencePacket(t,e,r){if(r&&this.mutex.pending>0)return;let n=z(this.referencePesPackets,t.pts,a=>a.pts);if(n>=0){let a=this.referencePesPackets[n];if(t.sectionStartPos<=a.sectionStartPos||!e&&t.pts-a.pts<9e4/2)return!1;if(n<this.referencePesPackets.length-1){let s=this.referencePesPackets[n+1];if(s.sectionStartPos<t.sectionStartPos||!e&&s.pts-t.pts<9e4/2)return!1}}return this.referencePesPackets.splice(n+1,0,t),!0}async getFirstPacket(t){let e=this.elementaryStream.firstSection;p(e);let r=Xr(e);p(r);let n=new Yr(this,r,!0),a=new Zr(this,n),s=await a.readNext();if(!s)return null;let o=this.createEncodedPacket(s.packet,s.duration,t);return this.packetBuffers.set(o,a),this.packetSectionStarts.set(o,s.packet.sectionStartPos),o}async getNextPacket(t,e){let r=this.packetBuffers.get(t);if(r){let d=await r.readNext();if(!d)return null;this.packetBuffers.delete(t);let l=this.createEncodedPacket(d.packet,d.duration,e);return this.packetBuffers.set(l,r),this.packetSectionStarts.set(l,d.packet.sectionStartPos),l}let n=this.packetSectionStarts.get(t);if(n===void 0)throw new Error("Packet was not created from this track.");let s=await this.elementaryStream.demuxer.readSection(n,!0);p(s);let o=Xr(s);p(o);let c=new Yr(this,o,!0);r=new Zr(this,c);let u=t.sequenceNumber;for(;;){let d=await r.readNext();if(!d)return null;if(d.packet.sequenceNumber>u){let l=this.createEncodedPacket(d.packet,d.duration,e);return this.packetBuffers.set(l,r),this.packetSectionStarts.set(l,d.packet.sectionStartPos),l}}}async getNextKeyPacket(t,e){let r=t;for(;;){if(r=await this.getNextPacket(r,e),!r)return null;if(r.type==="key")return r}}getPacket(t,e){return this.doPacketLookup(t,!1,e)}getKeyPacket(t,e){return this.doPacketLookup(t,!0,e)}async doPacketLookup(t,e,r){let n=lt(t*9e4),a=this.elementaryStream.demuxer,s=a.reader,o=await this.mutex.acquire(),c;try{if(this.referencePesPackets.length===0){let k=this.elementaryStream.firstSection;p(k);let w=$r(k);p(w),this.maybeInsertReferencePacket(w,!1,!1),p(this.referencePesPackets.length===1)}let b=z(this.referencePesPackets,n,k=>k.pts);if(b===-1)return null;if(s.fileSize!==null&&b===this.referencePesPackets.length-1&&!this.endReferencePesPacketAdded){let k=s.fileSize-a.packetStride+a.packetOffset,w=await a.readPacketHeader(k);if(!w)return null;for(;w.pid!==this.elementaryStream.pid||w.payloadUnitStartIndicator===0;){k-=a.packetStride;let x=await a.readPacketHeader(k);if(!x)return null;w=x}let S=await a.readSection(k,!1);p(S);let T=$r(S);if(!T)throw new Error(Qr);this.maybeInsertReferencePacket(T,!0,!1),this.endReferencePesPacketAdded=!0}for(b=z(this.referencePesPackets,n,k=>k.pts),p(b!==-1);s.fileSize!==null;){let k=this.referencePesPackets[b],w=this.referencePesPackets[b+1];if(n-k.pts<9e4||!w)break;let T=$t((k.sectionStartPos+w.sectionStartPos)/2,a.packetStride)+a.packetOffset,x=await a.readPacketHeader(T);for(p(x);T<w.sectionStartPos&&(x.pid!==this.elementaryStream.pid||x.payloadUnitStartIndicator===0);){T+=a.packetStride;let U=await a.readPacketHeader(T);if(!U)return null;x=U}if(T>=w.sectionStartPos)break;let A=await a.readSection(T,!1);p(A);let C=$r(A);if(!C)throw new Error(Qr);if(!this.maybeInsertReferencePacket(C,!1,!1))break;C.pts<=n&&b++}c=this.referencePesPackets[b],p(c.pts<=n)}finally{o()}o();e:for(;;){let b=c.sectionStartPos+a.packetStride;for(;;){let w=await a.readPacketHeader(b);if(!w)break e;if(w.pid===this.elementaryStream.pid&&w.payloadUnitStartIndicator===1)break;b+=a.packetStride}let y=await a.readSection(b,!1);if(!y)break;let k=$r(y);if(!k)throw new Error(Qr);if(k.pts>n)break;c=k,s.fileSize===null&&this.maybeInsertReferencePacket(k,!1,!0)}let u=this.getReorderSize();for(let b=0;b<u;b++){let y=c.sectionStartPos-a.packetStride;for(;;){let k=await a.readPacketHeader(y);if(!k)break;if(k.pid===this.elementaryStream.pid&&k.payloadUnitStartIndicator===1){let w=await a.readSection(y,!1);p(w);let S=$r(w);if(!S)throw new Error(Qr);c=S;break}y-=a.packetStride}}let d=await a.readSection(c.sectionStartPos,!0);p(d);let l=Xr(d);p(l);let m=new Yr(this,l,!0),f=new Zr(this,m);for(;!((j(f.presentationOrderPackets)?.pts??-1/0)>=n||!await f.readNextDecodeOrderPacket()););let h=yr(f.presentationOrderPackets,b=>b.pts<=n&&(!e||this.getPacketType(b.data)==="key"));if(h!==-1){let b=f.presentationOrderPackets[h],y=h===0?0:b.pts-f.presentationOrderPackets[h-1].pts;for(;f.decodeOrderPackets[0]!==b;)f.decodeOrderPackets.shift();f.lastDuration=y;let k=await f.readNext();p(k);let w=this.createEncodedPacket(k.packet,k.duration,r);return this.packetBuffers.set(w,f),this.packetSectionStarts.set(w,k.packet.sectionStartPos),w}if(!e)return null;let g=c.sectionStartPos;for(;;){g-=a.packetStride;let b=await a.readPacketHeader(g);if(!b)return null;if(b.pid!==this.elementaryStream.pid||b.payloadUnitStartIndicator!==1)continue;let y=await a.readSection(g,!0);p(y);let k=Xr(y);if(!k)throw new Error(Qr);let w=new Yr(this,k,!1);if(await this.markNextPacket(w),!w.suppliedPacket||this.getPacketType(w.suppliedPacket.data)!=="key")continue;w.uncapped=!0;let S=new Zr(this,w),T=await S.readNext();p(T);let x=this.createEncodedPacket(T.packet,T.duration,r);return this.packetBuffers.set(x,S),this.packetSectionStarts.set(x,T.packet.sectionStartPos),x}}},Es=class extends ra{constructor(t){super(t),this.elementaryStream=t,this.decoderConfig={codec:wr({width:this.elementaryStream.info.width,height:this.elementaryStream.info.height,codec:this.elementaryStream.info.codec,codecDescription:null,colorSpace:this.elementaryStream.info.colorSpace,avcType:1,avcCodecInfo:this.elementaryStream.info.avcCodecInfo,hevcCodecInfo:this.elementaryStream.info.hevcCodecInfo,vp9CodecInfo:null,av1CodecInfo:null}),codedWidth:this.elementaryStream.info.width,codedHeight:this.elementaryStream.info.height,colorSpace:this.elementaryStream.info.colorSpace}}getCodec(){return this.elementaryStream.info.codec}getCodedWidth(){return this.elementaryStream.info.width}getCodedHeight(){return this.elementaryStream.info.height}getRotation(){return 0}async getColorSpace(){return this.elementaryStream.info.colorSpace}async canBeTransparent(){return!1}async getDecoderConfig(){return this.decoderConfig}getPacketType(t){return vr(this.elementaryStream.info.codec,this.decoderConfig,t)??"key"}getReorderSize(){return this.elementaryStream.info.reorderSize}async markNextPacket(t){p(!t.suppliedPacket);let e=this.elementaryStream.info.codec,r=1024,n=null;for(;;){let a=t.ensureBuffered(r);if(a instanceof Promise&&(a=await a),a===0)break;let s=t.currentPos,o=t.readBytes(a),c=o.byteLength,u=0;for(;u<c;){let d=o.indexOf(0,u);if(d===-1||d>=c)break;u=d;let l=s+u;if(u+4>=c){t.seekTo(l);break}let m=o[u+1],f=o[u+2],h=o[u+3],g=0,b=null;if(m===0&&f===0&&h===1?(g=4,b=o[u+4]):m===0&&f===1&&(g=3,b=h),g===0){u++;continue}let y=l;if(n===null){n=y,u+=g;continue}if(b!==null){let k=e==="avc"?gt(b):tt(b);if(e==="avc"?k===9:k===35){let S=y-n;return t.seekTo(n),t.supplyPacket(S,0)}}u+=g}if(a<r)break}if(n!==null){let a=t.endPos-n;return t.seekTo(n),t.supplyPacket(a,0)}}},_s=class extends ra{constructor(t){super(t),this.elementaryStream=t}getCodec(){return this.elementaryStream.info.codec}getNumberOfChannels(){return this.elementaryStream.info.numberOfChannels}getSampleRate(){return this.elementaryStream.info.sampleRate}async getDecoderConfig(){return{codec:Tr({codec:this.elementaryStream.info.codec,codecDescription:null,aacCodecInfo:this.elementaryStream.info.aacCodecInfo}),numberOfChannels:this.elementaryStream.info.numberOfChannels,sampleRate:this.elementaryStream.info.sampleRate}}getPacketType(t){return"key"}getReorderSize(){return 1}async markNextPacket(t){p(!t.suppliedPacket);let e=this.elementaryStream.info.codec,r=128;for(;;){let n=t.ensureBuffered(r);n instanceof Promise&&(n=await n);let a=t.currentPos;for(;t.currentPos-a<n;){let s=t.readU8();if(e==="aac"){if(s!==255)continue;t.skip(-1);let o=t.currentPos,c=t.ensureBuffered(Oe);if(c instanceof Promise&&(c=await c),c<Oe)return;let u=t.readBytes(Oe),d=Ee(ge.tempFromBytes(u));if(d){t.seekTo(o);let l=t.ensureBuffered(d.frameLength);return l instanceof Promise&&(l=await l),t.supplyPacket(l,Math.round(Di*9e4/this.elementaryStream.info.sampleRate))}else t.seekTo(o+1)}else if(e==="mp3"){if(s!==255)continue;t.skip(-1);let o=t.currentPos,c=t.ensureBuffered(4);if(c instanceof Promise&&(c=await c),c<4)return;let u=t.readBytes(4),d=D(u).getUint32(0),l=ir(d,null);if(l.header){t.seekTo(o);let m=t.ensureBuffered(l.header.totalSize);m instanceof Promise&&(m=await m);let f=l.header.audioSamplesInFrame*9e4/this.elementaryStream.info.sampleRate;return t.supplyPacket(m,Math.round(f))}else t.seekTo(o+1)}else throw new Error("Unreachable")}if(n<r)break}}},Yr=class i{constructor(t,e,r){this.currentPos=0;this.pesPackets=[];this.currentPesPacketIndex=0;this.currentPesPacketPos=0;this.endPos=0;this.nextPts=0;this.suppliedPacket=null;this.backing=t,this.pid=t.elementaryStream.pid,this.demuxer=t.elementaryStream.demuxer,this.startingPesPacket=e,this.uncapped=r}clone(){let t=new i(this.backing,this.startingPesPacket,!0);return t.currentPos=this.currentPos,t.pesPackets=[...this.pesPackets],t.currentPesPacketIndex=this.currentPesPacketIndex,t.currentPesPacketPos=this.currentPesPacketPos,t.endPos=this.endPos,t.nextPts=this.nextPts,t}ensureBuffered(t){let e=this.endPos-this.currentPos;return e>=t?t:this.bufferData(t-e).then(()=>Math.min(this.endPos-this.currentPos,t))}getCurrentPesPacket(){let t=this.pesPackets[this.currentPesPacketIndex];return p(t),t}async bufferData(t){let e=this.endPos+t;for(;this.endPos<e;){let r;if(this.pesPackets.length===0)r=this.startingPesPacket;else{let n=j(this.pesPackets).sectionEndPos;for(p(n!==null);;){let o=await this.demuxer.readPacketHeader(n);if(!o)return;if(o.pid===this.pid)break;n+=this.demuxer.packetStride}let a=await this.demuxer.readSection(n,!0);if(!a)return;let s=Xr(a);if(!s)throw new Error(Qr);r=s}this.pesPackets.push(r),this.endPos+=r.data.byteLength,this.pesPackets.length===1&&(this.nextPts=r.pts)}}readBytes(t){let e=this.getCurrentPesPacket(),r=this.currentPos-this.currentPesPacketPos,n=r+t;if(this.currentPos+=t,n<=e.data.byteLength)return e.data.subarray(r,n);let a=new Uint8Array(t);a.set(e.data.subarray(r));let s=e.data.byteLength-r;for(;;){this.advanceCurrentPacket();let o=this.getCurrentPesPacket(),c=t-s;if(c<=o.data.byteLength){a.set(o.data.subarray(0,c),s);break}a.set(o.data,s),s+=o.data.byteLength}return a}readU8(){let t=this.getCurrentPesPacket(),e=this.currentPos-this.currentPesPacketPos;return this.currentPos++,e<t.data.byteLength?t.data[e]:(this.advanceCurrentPacket(),t=this.getCurrentPesPacket(),t.data[0])}seekTo(t){if(t!==this.currentPos){if(t<this.currentPos)for(;t<this.currentPesPacketPos;){this.currentPesPacketIndex--;let e=this.getCurrentPesPacket();this.currentPesPacketPos-=e.data.byteLength,this.nextPts=e.pts}else for(;;){let e=this.getCurrentPesPacket(),r=this.currentPesPacketPos+e.data.byteLength;if(t<r)break;this.currentPesPacketPos+=e.data.byteLength,this.currentPesPacketIndex++,this.nextPts=this.getCurrentPesPacket().pts}this.currentPos=t}}skip(t){this.seekTo(this.currentPos+t)}advanceCurrentPacket(){this.currentPesPacketPos+=this.getCurrentPesPacket().data.byteLength,this.currentPesPacketIndex++,this.nextPts=this.getCurrentPesPacket().pts}supplyPacket(t,e){let r=this.getCurrentPesPacket();if(!this.uncapped&&r!==this.startingPesPacket){this.suppliedPacket=null;return}this.backing.maybeInsertReferencePacket(r,!1,!0);let n=this.nextPts;this.nextPts+=e;let a=r.sectionStartPos,s=a+(this.currentPos-this.currentPesPacketPos),o=this.readBytes(t);this.suppliedPacket={pts:n,data:o,sequenceNumber:s,sectionStartPos:a},this.pesPackets.splice(0,this.currentPesPacketIndex),this.currentPesPacketIndex=0}},Zr=class{constructor(t,e){this.decodeOrderPackets=[];this.reorderBuffer=[];this.presentationOrderPackets=[];this.reachedEnd=!1;this.lastDuration=0;this.backing=t,this.context=e,this.reorderSize=t.getReorderSize(),p(this.reorderSize>=0)}async readNext(){if(this.decodeOrderPackets.length===0&&!await this.readNextDecodeOrderPacket())return null;await this.ensureCurrentPacketHasNext();let t=this.decodeOrderPackets[0],e=this.presentationOrderPackets.indexOf(t);p(e!==-1);let r;for(e===this.presentationOrderPackets.length-1?r=this.lastDuration:(r=this.presentationOrderPackets[e+1].pts-t.pts,this.lastDuration=r),this.decodeOrderPackets.shift();this.presentationOrderPackets.length>0;){let n=this.presentationOrderPackets[0];if(this.decodeOrderPackets.includes(n))break;this.presentationOrderPackets.shift()}return{packet:t,duration:r}}async readNextDecodeOrderPacket(){if(this.reachedEnd)return!1;let t;return this.context.suppliedPacket?t=this.context.suppliedPacket:(await this.backing.markNextPacket(this.context),t=this.context.suppliedPacket),this.context.suppliedPacket=null,t?(this.decodeOrderPackets.push(t),this.processPacketThroughReorderBuffer(t),!0):(this.reachedEnd=!0,this.flushReorderBuffer(),!1)}async ensureCurrentPacketHasNext(){let t=this.decodeOrderPackets[0];for(p(t);;){let e=this.presentationOrderPackets.indexOf(t);if(e!==-1&&e<=this.presentationOrderPackets.length-2||!await this.readNextDecodeOrderPacket())break}}processPacketThroughReorderBuffer(t){if(this.reorderBuffer.push(t),this.reorderBuffer.length>=this.reorderSize){let e=0;for(let n=1;n<this.reorderBuffer.length;n++)this.reorderBuffer[n].pts<this.reorderBuffer[e].pts&&(e=n);let r=this.reorderBuffer.splice(e,1)[0];this.presentationOrderPackets.push(r)}}flushReorderBuffer(){this.reorderBuffer.sort((t,e)=>t.pts-e.pts),this.presentationOrderPackets.push(...this.reorderBuffer),this.reorderBuffer.length=0}};var _e=class{},Jr=class extends _e{async _getMajorBrand(t){let e=t._reader.requestSlice(0,12);return e instanceof Promise&&(e=await e),!e||(e.skip(4),re(e,4)!=="ftyp")?null:re(e,4)}_createDemuxer(t){return new In(t)}},Bi=class extends Jr{async _canReadInput(t){let e=await this._getMajorBrand(t);return!!e&&e!=="qt  "}get name(){return"MP4"}get mimeType(){return"video/mp4"}},Oi=class extends Jr{async _canReadInput(t){return await this._getMajorBrand(t)==="qt  "}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}},ei=class extends _e{async isSupportedEBMLOfDocType(t,e){let r=t._reader.requestSlice(0,Ke);if(r instanceof Promise&&(r=await r),!r)return!1;let n=gs(r);if(n===null||n<1||n>8||N(r,n)!==440786851)return!1;let s=bs(r);if(typeof s!="number")return!1;let o=t._reader.requestSlice(r.filePos,s);if(o instanceof Promise&&(o=await o),!o)return!1;let c=r.filePos;for(;o.filePos<=c+s-Ae;){let u=Ge(o);if(!u)break;let{id:d,size:l}=u,m=o.filePos;if(l===void 0)return!1;switch(d){case 17030:if(N(o,l)!==1)return!1;break;case 17143:if(N(o,l)!==1)return!1;break;case 17026:if(Vt(o,l)!==e)return!1;break;case 17031:if(N(o,l)>4)return!1;break}o.filePos=m+l}return!0}_canReadInput(t){return this.isSupportedEBMLOfDocType(t,"matroska")}_createDemuxer(t){return new Bn(t)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}},Ui=class extends ei{_canReadInput(t){return this.isSupportedEBMLOfDocType(t,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}},Vi=class extends _e{async _canReadInput(t){let e=t._reader.requestSlice(0,10);if(e instanceof Promise&&(e=await e),!e)return!1;let r=0,n=!1;for(;;){let u=t._reader.requestSlice(r,Hr);if(u instanceof Promise&&(u=await u),!u)break;let d=nr(u);if(!d)break;n=!0,r=u.filePos+d.size}let a=await Mi(t._reader,r,r+4096);if(!a)return!1;if(n)return!0;r=a.startPos+a.header.totalSize;let s=await Mi(t._reader,r,r+4);if(!s)return!1;let o=a.header,c=s.header;return!(o.channel!==c.channel||o.sampleRate!==c.sampleRate)}_createDemuxer(t){return new Wn(t)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}},zi=class extends _e{async _canReadInput(t){let e=t._reader.requestSlice(0,12);if(e instanceof Promise&&(e=await e),!e)return!1;let r=re(e,4);return r!=="RIFF"&&r!=="RIFX"&&r!=="RF64"?!1:(e.skip(4),re(e,4)==="WAVE")}_createDemuxer(t){return new Qn(t)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}},Ni=class extends _e{async _canReadInput(t){let e=t._reader.requestSlice(0,4);return e instanceof Promise&&(e=await e),e?re(e,4)==="OggS":!1}_createDemuxer(t){return new Gn(t)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}},Li=class extends _e{async _canReadInput(t){let e=t._reader.requestSlice(0,4);return e instanceof Promise&&(e=await e),e?re(e,4)==="fLaC":!1}get name(){return"FLAC"}get mimeType(){return"audio/flac"}_createDemuxer(t){return new Jn(t)}},Wi=class extends _e{async _canReadInput(t){let e=t._reader.requestSliceRange(0,xt,Oe);if(e instanceof Promise&&(e=await e),!e)return!1;let r=Ee(e);if(!r||(e=t._reader.requestSliceRange(r.frameLength,xt,Oe),e instanceof Promise&&(e=await e),!e))return!1;let n=Ee(e);return n?r.objectType===n.objectType&&r.samplingFrequencyIndex===n.samplingFrequencyIndex&&r.channelConfiguration===n.channelConfiguration:!1}_createDemuxer(t){return new $n(t)}get name(){return"ADTS"}get mimeType(){return"audio/aac"}},Hi=class extends _e{async _canReadInput(t){let e=205,r=t._reader.requestSlice(0,e);if(r instanceof Promise&&(r=await r),!r)return!1;let n=M(r,e);return n[0]===71&&n[188]===71||n[0]===71&&n[204]===71?!0:n[4]===71&&n[192]===71}_createDemuxer(t){return new ta(t)}get name(){return"MPEG Transport Stream"}get mimeType(){return"video/MP2T"}},Fs=new Bi,Ms=new Oi,Rs=new ei,Ds=new Ui,Bs=new Vi,Os=new zi,Us=new Ni,Vs=new Wi,zs=new Li,Ns=new Hi,Pc=[Fs,Ms,Rs,Ds,Os,Us,zs,Bs,Vs,Ns];var vc=lo(Ls(),1);var td=typeof vc<"u"?vc:void 0,Ve=class{constructor(){this._disposed=!1;this._sizePromise=null;this.onread=null}async getSizeOrNull(){if(this._disposed)throw new de;return this._sizePromise??=Promise.resolve(this._retrieveSize())}async getSize(){if(this._disposed)throw new de;let t=await this.getSizeOrNull();if(t===null)throw new Error("Cannot determine the size of an unsized source.");return t}},ia=class extends Ve{constructor(e){if(!(e instanceof ArrayBuffer)&&!(typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer)&&!ArrayBuffer.isView(e))throw new TypeError("buffer must be an ArrayBuffer, SharedArrayBuffer, or ArrayBufferView.");super();this._onreadCalled=!1;this._bytes=W(e),this._view=D(e)}_retrieveSize(){return this._bytes.byteLength}_read(){return this._onreadCalled||(this.onread?.(0,this._bytes.byteLength),this._onreadCalled=!0),{bytes:this._bytes,view:this._view,offset:0}}_dispose(){}},na=class extends Ve{constructor(e,r={}){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.maxCacheSize!==void 0&&(!_t(r.maxCacheSize)||r.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super();this._readers=new WeakMap;this._blob=e,this._orchestrator=new ji({maxCacheSize:r.maxCacheSize??8*2**20,maxWorkerCount:4,runWorker:this._runWorker.bind(this),prefetchProfile:Ws.fileSystem})}_retrieveSize(){let e=this._blob.size;return this._orchestrator.fileSize=e,e}_read(e,r){return this._orchestrator.read(e,r)}async _runWorker(e){let r=this._readers.get(e);for(r===void 0&&("stream"in this._blob&&!Et()?r=this._blob.slice(e.currentPos).stream().getReader():r=null,this._readers.set(e,r));e.currentPos<e.targetPos&&!e.aborted;)if(r){let{done:n,value:a}=await r.read();if(n)throw this._orchestrator.forgetWorker(e),new Error("Blob reader stopped unexpectedly before all requested data was read.");if(e.aborted)break;this.onread?.(e.currentPos,e.currentPos+a.length),this._orchestrator.supplyWorkerData(e,a)}else{let n=await this._blob.slice(e.currentPos,e.targetPos).arrayBuffer();if(e.aborted)break;this.onread?.(e.currentPos,e.currentPos+n.byteLength),this._orchestrator.supplyWorkerData(e,new Uint8Array(n))}e.running=!1,e.aborted&&await r?.cancel()}_dispose(){this._orchestrator.dispose()}},Ic=.5*2**20,rd=(i,t,e)=>{if(t instanceof Error&&(t.message.includes("Failed to fetch")||t.message.includes("Load failed")||t.message.includes("NetworkError when attempting to fetch resource"))){let n=null;try{typeof window<"u"&&typeof window.location<"u"&&(n=new URL(e instanceof Request?e.url:e,window.location.href).origin)}catch{}if((typeof navigator<"u"&&typeof navigator.onLine=="boolean"?navigator.onLine:!0)&&n!==null&&n!==window.location.origin)return console.warn("Request will not be retried because a CORS error was suspected due to different origins. You can modify this behavior by providing your own function for the 'getRetryDelay' option."),null}return Math.min(2**(i-2),16)},aa=class extends Ve{constructor(e,r={}){if(typeof e!="string"&&!(e instanceof URL)&&!(typeof Request<"u"&&e instanceof Request))throw new TypeError("url must be a string, URL or Request.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.requestInit!==void 0&&(!r.requestInit||typeof r.requestInit!="object"))throw new TypeError("options.requestInit, when provided, must be an object.");if(r.getRetryDelay!==void 0&&typeof r.getRetryDelay!="function")throw new TypeError("options.getRetryDelay, when provided, must be a function.");if(r.maxCacheSize!==void 0&&(!_t(r.maxCacheSize)||r.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");if(r.fetchFn!==void 0&&typeof r.fetchFn!="function")throw new TypeError("options.fetchFn, when provided, must be a function.");super();this._existingResponses=new WeakMap;this._url=e,this._options=r,this._getRetryDelay=r.getRetryDelay??rd,this._orchestrator=new ji({maxCacheSize:r.maxCacheSize??64*2**20,maxWorkerCount:2,runWorker:this._runWorker.bind(this),prefetchProfile:Ws.network})}async _retrieveSize(){let e=new AbortController,r=await Za(this._options.fetchFn??fetch,this._url,Ya(this._options.requestInit??{},{headers:{Range:"bytes=0-"},signal:e.signal}),this._getRetryDelay,()=>this._disposed);if(!r.ok)throw new Error(`Error fetching ${String(this._url)}: ${r.status} ${r.statusText}`);let n,a;if(r.status===206)a=this._getTotalLengthFromRangeResponse(r),n=this._orchestrator.createWorker(0,Math.min(a,Ic));else{let s=r.headers.get("Content-Length");if(s)a=Number(s),n=this._orchestrator.createWorker(0,a),this._orchestrator.options.maxCacheSize=1/0,console.warn("HTTP server did not respond with 206 Partial Content, meaning the entire remote resource now has to be downloaded. For efficient media file streaming across a network, please make sure your server supports range requests.");else throw new Error(`HTTP response (status ${r.status}) must surface Content-Length header.`)}return this._orchestrator.fileSize=a,this._existingResponses.set(n,{response:r,abortController:e}),this._orchestrator.runWorker(n),a}_read(e,r){return this._orchestrator.read(e,r)}async _runWorker(e){for(;;){let r=this._existingResponses.get(e);this._existingResponses.delete(e);let n=r?.abortController,a=r?.response;if(n||(n=new AbortController,a=await Za(this._options.fetchFn??fetch,this._url,Ya(this._options.requestInit??{},{headers:{Range:`bytes=${e.currentPos}-`},signal:n.signal}),this._getRetryDelay,()=>this._disposed)),p(a),!a.ok)throw new Error(`Error fetching ${String(this._url)}: ${a.status} ${a.statusText}`);if(e.currentPos>0&&a.status!==206)throw new Error("HTTP server did not respond with 206 Partial Content to a range request. To enable efficient media file streaming across a network, please make sure your server supports range requests.");if(!a.body)throw new Error("Missing HTTP response body stream. The used fetch function must provide the response body as a ReadableStream.");let s=a.body.getReader();for(;;){if(e.currentPos>=e.targetPos||e.aborted){n.abort(),e.running=!1;return}let o;try{o=await s.read()}catch(d){if(this._disposed)throw d;let l=this._getRetryDelay(1,d,this._url);if(l!==null){console.error("Error while reading response stream. Attempting to resume.",d),await new Promise(m=>setTimeout(m,1e3*l));break}else throw d}if(e.aborted)continue;let{done:c,value:u}=o;if(c){if(e.currentPos>=e.targetPos){this._orchestrator.forgetWorker(e),e.running=!1;return}break}this.onread?.(e.currentPos,e.currentPos+u.length),this._orchestrator.supplyWorkerData(e,u)}}}_getTotalLengthFromRangeResponse(e){let r=e.headers.get("Content-Range");if(r){let a=/\/(\d+)/.exec(r);if(a)return Number(a[1])}let n=e.headers.get("Content-Length");if(n)return Number(n);throw new Error("Partial HTTP response (status 206) must surface either Content-Range or Content-Length header.")}_dispose(){this._orchestrator.dispose()}},sa=class extends Ve{constructor(e,r={}){if(typeof e!="string")throw new TypeError("filePath must be a string.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.maxCacheSize!==void 0&&(!_t(r.maxCacheSize)||r.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super();this._fileHandle=null;this._streamSource=new qi({getSize:async()=>(this._fileHandle=await td.fs.open(e,"r"),(await this._fileHandle.stat()).size),read:async(n,a)=>{p(this._fileHandle);let s=new Uint8Array(a-n);return await this._fileHandle.read(s,0,a-n,n),s},maxCacheSize:r.maxCacheSize,prefetchProfile:"fileSystem"})}_read(e,r){return this._streamSource._read(e,r)}_retrieveSize(){return this._streamSource._retrieveSize()}_dispose(){this._streamSource._dispose(),this._fileHandle?.close(),this._fileHandle=null}},qi=class extends Ve{constructor(t){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(typeof t.getSize!="function")throw new TypeError("options.getSize must be a function.");if(typeof t.read!="function")throw new TypeError("options.read must be a function.");if(t.dispose!==void 0&&typeof t.dispose!="function")throw new TypeError("options.dispose, when provided, must be a function.");if(t.maxCacheSize!==void 0&&(!_t(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");if(t.prefetchProfile&&!["none","fileSystem","network"].includes(t.prefetchProfile))throw new TypeError("options.prefetchProfile, when provided, must be one of 'none', 'fileSystem' or 'network'.");super(),this._options=t,this._orchestrator=new ji({maxCacheSize:t.maxCacheSize??8*2**20,maxWorkerCount:2,prefetchProfile:Ws[t.prefetchProfile??"none"],runWorker:this._runWorker.bind(this)})}_retrieveSize(){let t=this._options.getSize();if(t instanceof Promise)return t.then(e=>{if(!Number.isInteger(e)||e<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=e,e});if(!Number.isInteger(t)||t<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=t,t}_read(t,e){return this._orchestrator.read(t,e)}async _runWorker(t){for(;t.currentPos<t.targetPos&&!t.aborted;){let e=t.currentPos,r=t.targetPos,n=this._options.read(t.currentPos,r);if(n instanceof Promise&&(n=await n),t.aborted)break;if(n instanceof Uint8Array){if(n=W(n),n.length!==r-t.currentPos)throw new Error(`options.read returned a Uint8Array with unexpected length: Requested ${r-t.currentPos} bytes, but got ${n.length}.`);this.onread?.(t.currentPos,t.currentPos+n.length),this._orchestrator.supplyWorkerData(t,n)}else if(n instanceof ReadableStream){let a=n.getReader();for(;t.currentPos<r&&!t.aborted;){let{done:s,value:o}=await a.read();if(s){if(t.currentPos<r)throw new Error(`ReadableStream returned by options.read ended before supplying enough data. Requested ${r-e} bytes, but got ${t.currentPos-e}`);break}if(!(o instanceof Uint8Array))throw new TypeError("ReadableStream returned by options.read must yield Uint8Array chunks.");if(t.aborted)break;let c=W(o);this.onread?.(t.currentPos,t.currentPos+c.length),this._orchestrator.supplyWorkerData(t,c)}}else throw new TypeError("options.read must return or resolve to a Uint8Array or a ReadableStream.")}t.running=!1}_dispose(){this._orchestrator.dispose(),this._options.dispose?.()}},oa=class extends Ve{constructor(e,r={}){if(!(e instanceof ReadableStream))throw new TypeError("stream must be a ReadableStream.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.maxCacheSize!==void 0&&(!_t(r.maxCacheSize)||r.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super();this._reader=null;this._cache=[];this._pendingSlices=[];this._currentIndex=0;this._targetIndex=0;this._maxRequestedIndex=0;this._endIndex=null;this._pulling=!1;this._stream=e,this._maxCacheSize=r.maxCacheSize??16*2**20}_retrieveSize(){return this._endIndex}_read(e,r){if(this._endIndex!==null&&r>this._endIndex)return null;this._maxRequestedIndex=Math.max(this._maxRequestedIndex,r);let n=z(this._cache,e,l=>l.start),a=n!==-1?this._cache[n]:null;if(a&&a.start<=e&&r<=a.end)return{bytes:a.bytes,view:a.view,offset:a.start};let s=e,o=new Uint8Array(r-e);if(n!==-1)for(let l=n;l<this._cache.length;l++){let m=this._cache[l];if(m.start>=r)break;let f=Math.max(e,m.start);f>s&&this._throwDueToCacheMiss();let h=Math.min(r,m.end);f<h&&(o.set(m.bytes.subarray(f-m.start,h-m.start),f-e),s=h)}if(s===r)return{bytes:o,view:D(o),offset:e};this._currentIndex>s&&this._throwDueToCacheMiss();let{promise:c,resolve:u,reject:d}=Q();return this._pendingSlices.push({start:e,end:r,bytes:o,resolve:u,reject:d}),this._targetIndex=Math.max(this._targetIndex,r),this._pulling||(this._pulling=!0,this._pull().catch(l=>{if(this._pulling=!1,this._pendingSlices.length>0)this._pendingSlices.forEach(m=>m.reject(l)),this._pendingSlices.length=0;else throw l})),c}_throwDueToCacheMiss(){throw new Error("Read is before the cached region. With ReadableStreamSource, you must access the data more sequentially or increase the size of its cache.")}async _pull(){for(this._reader??=this._stream.getReader();this._currentIndex<this._targetIndex&&!this._disposed;){let{done:e,value:r}=await this._reader.read();if(e){for(let s of this._pendingSlices)s.resolve(null);this._pendingSlices.length=0,this._endIndex=this._currentIndex;break}let n=this._currentIndex,a=this._currentIndex+r.byteLength;for(let s=0;s<this._pendingSlices.length;s++){let o=this._pendingSlices[s],c=Math.max(n,o.start),u=Math.min(a,o.end);c<u&&(o.bytes.set(r.subarray(c-n,u-n),c-o.start),u===o.end&&(o.resolve({bytes:o.bytes,view:D(o.bytes),offset:o.start}),this._pendingSlices.splice(s,1),s--))}for(this._cache.push({start:n,end:a,bytes:r,view:D(r),age:0});this._cache.length>0;){let s=this._cache[0];if(this._maxRequestedIndex-s.end<=this._maxCacheSize)break;this._cache.shift()}this._currentIndex+=r.byteLength}this._pulling=!1}_dispose(){this._pendingSlices.length=0,this._cache.length=0}},Ws={none:(i,t)=>({start:i,end:t}),fileSystem:(i,t)=>(i=Math.floor((i-65536)/65536)*65536,t=Math.ceil((t+65536)/65536)*65536,{start:i,end:t}),network:(i,t,e)=>{i=Math.max(0,Math.floor((i-65536)/65536)*65536);for(let n of e){let s=Math.max((n.startPos+n.targetPos)/2,n.targetPos-8388608);if(cn(i,t,s,n.targetPos)){let o=n.targetPos-n.startPos,c=Math.ceil((o+1)/8388608)*8388608,u=2**Math.ceil(Math.log2(o+1)),d=Math.min(u,c);t=Math.max(t,n.startPos+d)}}return t=Math.max(t,i+Ic),{start:i,end:t}}},ji=class{constructor(t){this.options=t;this.fileSize=null;this.nextAge=0;this.workers=[];this.cache=[];this.currentCacheSize=0;this.disposed=!1}read(t,e){p(this.fileSize!==null);let r=this.options.prefetchProfile(t,e,this.workers),n=Math.max(r.start,0),a=Math.min(r.end,this.fileSize);p(n<=t&&e<=a);let s=null,o=z(this.cache,t,k=>k.start),c=o!==-1?this.cache[o]:null;c&&c.start<=t&&e<=c.end&&(c.age=this.nextAge++,s={bytes:c.bytes,view:c.view,offset:c.start});let u=z(this.cache,n,k=>k.start),d=s?null:new Uint8Array(e-t),l=0,m=n,f=[];if(u!==-1){for(let k=u;k<this.cache.length;k++){let w=this.cache[k];if(w.start>=a)break;if(w.end<=n)continue;let S=Math.max(n,w.start),T=Math.min(a,w.end);if(p(S<=T),m<S&&f.push({start:m,end:S}),m=T,d){let x=Math.max(t,w.start),A=Math.min(e,w.end);if(x<A){let C=x-t;d.set(w.bytes.subarray(x-w.start,A-w.start),C),C===l&&(l=A-t)}}w.age=this.nextAge++}m<a&&f.push({start:m,end:a})}else f.push({start:n,end:a});if(d&&l>=d.length&&(s={bytes:d,view:D(d),offset:t}),f.length===0)return p(s),s;let{promise:h,resolve:g,reject:b}=Q(),y=[];for(let k of f){let w=Math.max(t,k.start),S=Math.min(e,k.end);w===k.start&&S===k.end?y.push(k):w<S&&y.push({start:w,end:S})}for(let k of f){let w=d&&{start:t,bytes:d,holes:y,resolve:g,reject:b},S=!1;for(let T of this.workers)if(cn(k.start-131072,k.start,T.currentPos,T.targetPos)){T.targetPos=Math.max(T.targetPos,k.end),S=!0,w&&!T.pendingSlices.includes(w)&&T.pendingSlices.push(w),T.running||this.runWorker(T);break}if(!S){let T=this.createWorker(k.start,k.end);w&&(T.pendingSlices=[w]),this.runWorker(T)}}return s||(p(d),s=h.then(k=>({bytes:k,view:D(k),offset:t}))),s}createWorker(t,e){let r={startPos:t,currentPos:t,targetPos:e,running:!1,aborted:this.disposed,pendingSlices:[],age:this.nextAge++};for(this.workers.push(r);this.workers.length>this.options.maxWorkerCount;){let n=0,a=this.workers[0];for(let s=1;s<this.workers.length;s++){let o=this.workers[s];o.age<a.age&&(n=s,a=o)}if(a.running&&a.pendingSlices.length>0)break;a.aborted=!0,this.workers.splice(n,1)}return r}runWorker(t){p(!t.running),p(t.currentPos<t.targetPos),t.running=!0,t.age=this.nextAge++,this.options.runWorker(t).catch(e=>{if(t.running=!1,t.pendingSlices.length>0)t.pendingSlices.forEach(r=>r.reject(e)),t.pendingSlices.length=0;else throw e})}supplyWorkerData(t,e){p(!t.aborted);let r=t.currentPos,n=r+e.length;this.insertIntoCache({start:r,end:n,bytes:e,view:D(e),age:this.nextAge++}),t.currentPos+=e.length,t.targetPos=Math.max(t.targetPos,t.currentPos);for(let a=0;a<t.pendingSlices.length;a++){let s=t.pendingSlices[a],o=Math.max(r,s.start),c=Math.min(n,s.start+s.bytes.length);o<c&&s.bytes.set(e.subarray(o-r,c-r),o-s.start);for(let u=0;u<s.holes.length;u++){let d=s.holes[u];r<=d.start&&n>d.start&&(d.start=n),d.end<=d.start&&(s.holes.splice(u,1),u--)}s.holes.length===0&&(s.resolve(s.bytes),t.pendingSlices.splice(a,1),a--)}for(let a=0;a<this.workers.length;a++){let s=this.workers[a];t===s||s.running||cn(r,n,s.currentPos,s.targetPos)&&(this.workers.splice(a,1),a--)}}forgetWorker(t){let e=this.workers.indexOf(t);p(e!==-1),this.workers.splice(e,1)}insertIntoCache(t){if(this.options.maxCacheSize===0)return;let e=z(this.cache,t.start,r=>r.start)+1;if(e>0){let r=this.cache[e-1];if(r.end>=t.end)return;if(r.end>t.start){let n=new Uint8Array(t.end-r.start);n.set(r.bytes,0),n.set(t.bytes,t.start-r.start),this.currentCacheSize+=t.end-r.end,r.bytes=n,r.view=D(n),r.end=t.end,e--,t=r}else this.cache.splice(e,0,t),this.currentCacheSize+=t.bytes.length}else this.cache.splice(e,0,t),this.currentCacheSize+=t.bytes.length;for(let r=e+1;r<this.cache.length;r++){let n=this.cache[r];if(t.end<=n.start)break;if(t.end>=n.end){this.cache.splice(r,1),this.currentCacheSize-=n.bytes.length,r--;continue}let a=new Uint8Array(n.end-t.start);a.set(t.bytes,0),a.set(n.bytes,n.start-t.start),this.currentCacheSize-=t.end-n.start,t.bytes=a,t.view=D(a),t.end=n.end,this.cache.splice(r,1);break}for(;this.currentCacheSize>this.options.maxCacheSize;){let r=0,n=this.cache[0];for(let a=1;a<this.cache.length;a++){let s=this.cache[a];s.age<n.age&&(r=a,n=s)}if(this.currentCacheSize-n.bytes.length<=this.options.maxCacheSize)break;this.cache.splice(r,1),this.currentCacheSize-=n.bytes.length}}dispose(){for(let t of this.workers)t.aborted=!0;this.workers.length=0,this.cache.length=0,this.disposed=!0}};un();var ti=class{constructor(t){this._demuxerPromise=null;this._format=null;this._disposed=!1;if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Array.isArray(t.formats)||t.formats.some(e=>!(e instanceof _e)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(t.source instanceof Ve))throw new TypeError("options.source must be a Source.");if(t.source._disposed)throw new Error("options.source must not be disposed.");this._formats=t.formats,this._source=t.source,this._reader=new ca(t.source)}get disposed(){return this._disposed}_getDemuxer(){return this._demuxerPromise??=(async()=>{this._reader.fileSize=await this._source.getSizeOrNull();for(let t of this._formats)if(await t._canReadInput(this))return this._format=t,t._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})()}get source(){return this._source}async getFormat(){return await this._getDemuxer(),p(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getFirstTimestamp(){let t=await this.getTracks();if(t.length===0)return 0;let e=await Promise.all(t.map(r=>r.getFirstTimestamp()));return Math.min(...e)}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(e=>e.isVideoTrack())}async getAudioTracks(){return(await this.getTracks()).filter(e=>e.isAudioTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(e=>e.isVideoTrack())??null}async getPrimaryAudioTrack(){return(await this.getTracks()).find(e=>e.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}async getMetadataTags(){return(await this._getDemuxer()).getMetadataTags()}dispose(){this._disposed||(this._disposed=!0,this._source._disposed=!0,this._source._dispose())}[Symbol.dispose](){this.dispose()}},de=class extends Error{constructor(t="Input has been disposed."){super(t),this.name="InputDisposedError"}};var ca=class{constructor(t){this.source=t}requestSlice(t,e){if(this.source._disposed)throw new de;if(t<0||this.fileSize!==null&&t+e>this.fileSize)return null;let r=t+e,n=this.source._read(t,r);return n instanceof Promise?n.then(a=>a?new ge(a.bytes,a.view,a.offset,t,r):null):n?new ge(n.bytes,n.view,n.offset,t,r):null}requestSliceRange(t,e,r){if(this.source._disposed)throw new de;if(t<0)return null;if(this.fileSize!==null)return this.requestSlice(t,ae(this.fileSize-t,e,r));{let n=this.requestSlice(t,r),a=s=>{if(s)return s;let o=u=>(p(u!==null),this.requestSlice(t,ae(u-t,e,r))),c=this.source._retrieveSize();return c instanceof Promise?c.then(o):o(c)};return n instanceof Promise?n.then(a):a(n)}}},ge=class i{constructor(t,e,r,n,a){this.bytes=t;this.view=e;this.offset=r;this.start=n;this.end=a;this.bufferPos=n-r}static tempFromBytes(t){return new i(t,D(t),0,0,t.length)}get length(){return this.end-this.start}get filePos(){return this.offset+this.bufferPos}set filePos(t){this.bufferPos=t-this.offset}get remainingLength(){return Math.max(this.end-this.filePos,0)}skip(t){this.bufferPos+=t}slice(t,e=this.end-t){if(t<this.start||t+e>this.end)throw new RangeError("Slicing outside of original slice.");return new i(this.bytes,this.view,this.offset,t,t+e)}},Fe=(i,t)=>{if(i.filePos<i.start||i.filePos+t>i.end)throw new RangeError(`Tried reading [${i.filePos}, ${i.filePos+t}), but slice is [${i.start}, ${i.end}). This is likely an internal error, please report it alongside the file that caused it.`)},M=(i,t)=>{Fe(i,t);let e=i.bytes.subarray(i.bufferPos,i.bufferPos+t);return i.bufferPos+=t,e},E=i=>(Fe(i,1),i.view.getUint8(i.bufferPos++)),Gr=(i,t)=>{Fe(i,2);let e=i.view.getUint16(i.bufferPos,t);return i.bufferPos+=2,e},ce=i=>{Fe(i,2);let t=i.view.getUint16(i.bufferPos,!1);return i.bufferPos+=2,t},Ut=i=>{Fe(i,3);let t=Gt(i.view,i.bufferPos,!1);return i.bufferPos+=3,t},Ai=i=>{Fe(i,2);let t=i.view.getInt16(i.bufferPos,!1);return i.bufferPos+=2,t},St=(i,t)=>{Fe(i,4);let e=i.view.getUint32(i.bufferPos,t);return i.bufferPos+=4,e},P=i=>{Fe(i,4);let t=i.view.getUint32(i.bufferPos,!1);return i.bufferPos+=4,t},ar=i=>{Fe(i,4);let t=i.view.getUint32(i.bufferPos,!0);return i.bufferPos+=4,t},wt=i=>{Fe(i,4);let t=i.view.getInt32(i.bufferPos,!1);return i.bufferPos+=4,t},id=i=>{Fe(i,4);let t=i.view.getInt32(i.bufferPos,!0);return i.bufferPos+=4,t},vs=(i,t)=>{let e,r;return t?(e=St(i,!0),r=St(i,!0)):(r=St(i,!1),e=St(i,!1)),r*4294967296+e},De=i=>{let t=P(i),e=P(i);return t*4294967296+e},oc=i=>{let t=wt(i),e=P(i);return t*4294967296+e},yc=i=>{let t=ar(i);return id(i)*4294967296+t},mc=i=>{Fe(i,4);let t=i.view.getFloat32(i.bufferPos,!1);return i.bufferPos+=4,t},En=i=>{Fe(i,8);let t=i.view.getFloat64(i.bufferPos,!1);return i.bufferPos+=8,t},re=(i,t)=>{Fe(i,t);let e="";for(let r=0;r<t;r++)e+=String.fromCharCode(i.bytes[i.bufferPos++]);return e};var Ac=new Uint8Array([102,76,97,67]),nd=38,ad=34,ua=class extends pe{constructor(e,r){super(e);this.metadataWritten=!1;this.blockSizes=[];this.frameSizes=[];this.sampleRate=null;this.channels=null;this.bitsPerSample=null;this.writer=e._writer,this.format=r}async start(){this.writer.write(Ac)}writeHeader({bitsPerSample:e,minimumBlockSize:r,maximumBlockSize:n,minimumFrameSize:a,maximumFrameSize:s,sampleRate:o,channels:c,totalSamples:u}){p(this.writer.getPos()===4);let d=!Yt(this.output._metadataTags),l=new V(new Uint8Array(4));l.writeBits(1,+!d),l.writeBits(7,0),l.writeBits(24,ad),this.writer.write(l.bytes);let m=new V(new Uint8Array(18));if(m.writeBits(16,r),m.writeBits(16,n),m.writeBits(24,a),m.writeBits(24,s),m.writeBits(20,o),m.writeBits(3,c-1),m.writeBits(5,e-1),u>=2**32)throw new Error("This muxer only supports writing up to 2 ** 32 samples");m.writeBits(4,0),m.writeBits(32,u),this.writer.write(m.bytes),this.writer.write(new Uint8Array(16))}writePictureBlock(e){let r=32+e.mimeType.length+(e.description?.length??0)+e.data.length,n=new Uint8Array(r),a=0,s=D(n);s.setUint32(a,e.kind==="coverFront"?3:e.kind==="coverBack"?4:0),a+=4,s.setUint32(a,e.mimeType.length),a+=4,n.set(G.encode(e.mimeType),8),a+=e.mimeType.length,s.setUint32(a,e.description?.length??0),a+=4,n.set(G.encode(e.description??""),a),a+=e.description?.length??0,a+=16,s.setUint32(a,e.data.length),a+=4,n.set(e.data,a),a+=e.data.length,p(a===r);let o=new V(new Uint8Array(4));o.writeBits(1,0),o.writeBits(7,6),o.writeBits(24,r),this.writer.write(o.bytes),this.writer.write(n)}writeVorbisCommentAndPictureBlock(){if(this.writer.seek(nd+Ac.byteLength),Yt(this.output._metadataTags)){this.metadataWritten=!0;return}let e=this.output._metadataTags.images??[];for(let a of e)this.writePictureBlock(a);let r=ki(new Uint8Array(0),this.output._metadataTags,!1),n=new V(new Uint8Array(4));n.writeBits(1,1),n.writeBits(7,4),n.writeBits(24,r.length),this.writer.write(n.bytes),this.writer.write(r),this.metadataWritten=!0}async getMimeType(){return"audio/flac"}async addEncodedVideoPacket(){throw new Error("FLAC does not support video.")}async addEncodedAudioPacket(e,r,n){let a=await this.mutex.acquire();ve(n),p(n),p(n.decoderConfig),p(n.decoderConfig.description);try{if(this.validateAndNormalizeTimestamp(e,r.timestamp,r.type==="key"),this.sampleRate===null&&(this.sampleRate=n.decoderConfig.sampleRate),this.channels===null&&(this.channels=n.decoderConfig.numberOfChannels),this.bitsPerSample===null){let m=new V(W(n.decoderConfig.description));m.skipBits(167);let f=m.readBits(5)+1;this.bitsPerSample=f}this.metadataWritten||this.writeVorbisCommentAndPictureBlock();let s=ge.tempFromBytes(r.data);M(s,2);let o=M(s,2),c=new V(o),u=Xn(c.readBits(4));if(u===null)throw new Error("Invalid FLAC frame: Invalid block size.");Yn(s);let d=Zn(s,u);this.blockSizes.push(d),this.frameSizes.push(r.data.length);let l=this.writer.getPos();this.writer.write(r.data),this.format._options.onFrame&&this.format._options.onFrame(r.data,l),await this.writer.flush()}finally{a()}}addSubtitleCue(){throw new Error("FLAC does not support subtitles.")}async finalize(){let e=await this.mutex.acquire(),r=1/0,n=0,a=1/0,s=0,o=0;for(let c=0;c<this.blockSizes.length;c++)a=Math.min(a,this.frameSizes[c]),s=Math.max(s,this.frameSizes[c]),n=Math.max(n,this.blockSizes[c]),o+=this.blockSizes[c],c!==this.blockSizes.length-1&&(r=Math.min(r,this.blockSizes[c]));p(this.sampleRate!==null),p(this.channels!==null),p(this.bitsPerSample!==null),this.writer.seek(4),this.writeHeader({minimumBlockSize:r,maximumBlockSize:n,minimumFrameSize:a,maximumFrameSize:s,sampleRate:this.sampleRate,channels:this.channels,bitsPerSample:this.bitsPerSample,totalSamples:o}),e()}};var Ki=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,sd=/^WEBVTT(.|\n)*?\n{2}/,ri=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,da=class{constructor(t){this.preambleText=null;this.preambleEmitted=!1;this.options=t}parse(t){t=t.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),Ki.lastIndex=0;let e;if(!this.preambleText){if(!sd.test(t))throw new Error("WebVTT preamble incorrect.");e=Ki.exec(t);let r=t.slice(0,e?.index??t.length).trimEnd();if(!r)throw new Error("No WebVTT preamble provided.");this.preambleText=r,e&&(t=t.slice(e.index),Ki.lastIndex=0)}for(;e=Ki.exec(t);){let r=t.slice(0,e.index),n=e[1],a=e.index+e[0].length,s=t.indexOf(`
`,a)+1,o=t.slice(a,s).trim(),c=t.indexOf(`

`,a);c===-1&&(c=t.length);let u=la(e[2]),l=la(e[3])-u,m=t.slice(s,c).trim();t=t.slice(c).trimStart(),Ki.lastIndex=0;let f={timestamp:u/1e3,duration:l/1e3,text:m,identifier:n,settings:o,notes:r},h={};this.preambleEmitted||(h.config={description:this.preambleText},this.preambleEmitted=!0),this.options.output(f,h)}}},od=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,la=i=>{let t=od.exec(i);if(!t)throw new Error("Expected match.");return 60*60*1e3*Number(t[1]||"0")+60*1e3*Number(t[2])+1e3*Number(t[3])+Number(t[4])},ma=i=>{let t=Math.floor(i/36e5),e=Math.floor(i%(60*60*1e3)/(60*1e3)),r=Math.floor(i%(60*1e3)/1e3),n=i%1e3;return t.toString().padStart(2,"0")+":"+e.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+"."+n.toString().padStart(3,"0")};var Gi=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap}writeU32(t){this.helperView.setUint32(0,t,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(t){this.helperView.setUint32(0,Math.floor(t/2**32),!1),this.helperView.setUint32(4,t,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(t){for(let e=0;e<t.length;e++)this.helperView.setUint8(e%8,t.charCodeAt(e)),e%8===7&&this.writer.write(this.helper);t.length%8!==0&&this.writer.write(this.helper.subarray(0,t.length%8))}writeBox(t){if(this.offsets.set(t,this.writer.getPos()),t.contents&&!t.children)this.writeBoxHeader(t,t.size??t.contents.byteLength+8),this.writer.write(t.contents);else{let e=this.writer.getPos();if(this.writeBoxHeader(t,0),t.contents&&this.writer.write(t.contents),t.children)for(let a of t.children)a&&this.writeBox(a);let r=this.writer.getPos(),n=t.size??r-e;this.writer.seek(e),this.writeBoxHeader(t,n),this.writer.seek(r)}}writeBoxHeader(t,e){this.writeU32(t.largeSize?1:e),this.writeAscii(t.type),t.largeSize&&this.writeU64(e)}measureBoxHeader(t){return 8+(t.largeSize?8:0)}patchBox(t){let e=this.offsets.get(t);p(e!==void 0);let r=this.writer.getPos();this.writer.seek(e),this.writeBox(t),this.writer.seek(r)}measureBox(t){if(t.contents&&!t.children)return this.measureBoxHeader(t)+t.contents.byteLength;{let e=this.measureBoxHeader(t);if(t.contents&&(e+=t.contents.byteLength),t.children)for(let r of t.children)r&&(e+=this.measureBox(r));return e}}},q=new Uint8Array(8),nt=new DataView(q.buffer),ie=i=>[(i%256+256)%256],B=i=>(nt.setUint16(0,i,!1),[q[0],q[1]]),Fc=i=>(nt.setInt16(0,i,!1),[q[0],q[1]]),Mc=i=>(nt.setUint32(0,i,!1),[q[1],q[2],q[3]]),I=i=>(nt.setUint32(0,i,!1),[q[0],q[1],q[2],q[3]]),Lt=i=>(nt.setInt32(0,i,!1),[q[0],q[1],q[2],q[3]]),or=i=>(nt.setUint32(0,Math.floor(i/2**32),!1),nt.setUint32(4,i,!1),[q[0],q[1],q[2],q[3],q[4],q[5],q[6],q[7]]),Rc=i=>(nt.setInt16(0,2**8*i,!1),[q[0],q[1]]),Ct=i=>(nt.setInt32(0,2**16*i,!1),[q[0],q[1],q[2],q[3]]),Hs=i=>(nt.setInt32(0,2**30*i,!1),[q[0],q[1],q[2],q[3]]),qs=(i,t)=>{let e=[],r=i;do{let n=r&127;r>>=7,e.length>0&&(n|=128),e.push(n),t!==void 0&&t--}while(r>0||t);return e.reverse()},Ce=(i,t=!1)=>{let e=Array(i.length).fill(null).map((r,n)=>i.charCodeAt(n));return t&&e.push(0),e},Ks=i=>{let t=null;for(let e of i)(!t||e.timestamp>t.timestamp)&&(t=e);return t},Dc=i=>{let t=i*(Math.PI/180),e=Math.round(Math.cos(t)),r=Math.round(Math.sin(t));return[e,r,0,-r,e,0,0,0,1]},Bc=Dc(0),Oc=i=>[Ct(i[0]),Ct(i[1]),Hs(i[2]),Ct(i[3]),Ct(i[4]),Hs(i[5]),Ct(i[6]),Ct(i[7]),Hs(i[8])],O=(i,t,e)=>({type:i,contents:t&&new Uint8Array(t.flat(10)),children:e}),K=(i,t,e,r,n)=>O(i,[ie(t),Mc(e),r??[]],n),Uc=i=>i.isQuickTime?O("ftyp",[Ce("qt  "),I(512),Ce("qt  ")]):i.fragmented?O("ftyp",[Ce("iso5"),I(512),Ce("iso5"),Ce("iso6"),Ce("mp41")]):O("ftyp",[Ce("isom"),I(512),Ce("isom"),i.holdsAvc?Ce("avc1"):[],Ce("mp41")]),Qi=i=>({type:"mdat",largeSize:i}),Vc=i=>({type:"free",size:i}),ii=i=>O("moov",void 0,[cd(i.creationTime,i.trackDatas),...i.trackDatas.map(t=>ud(t,i.creationTime)),i.isFragmented?qd(i.trackDatas):null,Jd(i)]),cd=(i,t)=>{let e=me(Math.max(0,...t.filter(s=>s.samples.length>0).map(s=>{let o=Ks(s.samples);return o.timestamp+o.duration})),fa),r=Math.max(0,...t.map(s=>s.track.id))+1,n=!Wt(i)||!Wt(e),a=n?or:I;return K("mvhd",+n,0,[a(i),a(i),I(fa),a(e),Ct(1),Rc(1),Array(10).fill(0),Oc(Bc),Array(24).fill(0),I(r)])},ud=(i,t)=>{let e=Gc(i);return O("trak",void 0,[dd(i,t),ld(i,t),e.name!==void 0?O("udta",void 0,[O("name",[...G.encode(e.name)])]):null])},dd=(i,t)=>{let e=Ks(i.samples),r=me(e?e.timestamp+e.duration:0,fa),n=!Wt(t)||!Wt(r),a=n?or:I,s;if(i.type==="video"){let c=i.track.metadata.rotation;s=Dc(c??0)}else s=Bc;let o=2;return i.track.metadata.disposition?.default!==!1&&(o|=1),K("tkhd",+n,o,[a(t),a(t),I(i.track.id),I(0),a(r),Array(8).fill(0),B(0),B(i.track.id),Rc(i.type==="audio"?1:0),B(0),Oc(s),Ct(i.type==="video"?i.info.width:0),Ct(i.type==="video"?i.info.height:0)])},ld=(i,t)=>O("mdia",void 0,[md(i,t),Gs(!0,fd[i.type],pd[i.type]),hd(i)]),md=(i,t)=>{let e=Ks(i.samples),r=me(e?e.timestamp+e.duration:0,i.timescale),n=!Wt(t)||!Wt(r),a=n?or:I;return K("mdhd",+n,0,[a(t),a(t),I(i.timescale),a(r),B(Kc(i.track.metadata.languageCode??ee)),B(0)])},fd={video:"vide",audio:"soun",subtitle:"text"},pd={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},Gs=(i,t,e,r="\0\0\0\0")=>K("hdlr",0,0,[i?Ce("mhlr"):I(0),Ce(t),Ce(r),I(0),I(0),Ce(e,!0)]),hd=i=>O("minf",void 0,[yd[i.type](),wd(),xd(i)]),gd=()=>K("vmhd",0,1,[B(0),B(0),B(0),B(0)]),bd=()=>K("smhd",0,0,[B(0),B(0)]),kd=()=>K("nmhd",0,0),yd={video:gd,audio:bd,subtitle:kd},wd=()=>O("dinf",void 0,[Td()]),Td=()=>K("dref",0,0,[I(1)],[Sd()]),Sd=()=>K("url ",0,1),xd=i=>{let t=i.compositionTimeOffsetTable.length>1||i.compositionTimeOffsetTable.some(e=>e.sampleCompositionTimeOffset!==0);return O("stbl",void 0,[Cd(i),Ud(i),t?Wd(i):null,t?Hd(i):null,zd(i),Nd(i),Ld(i),Vd(i)])},Cd=i=>{let t;if(i.type==="video")t=Pd(il(i.track.source._codec,i.info.decoderConfig.codec),i);else if(i.type==="audio"){let e=jc(i.track.source._codec,i.muxer.isQuickTime);p(e),t=_d(e,i)}else i.type==="subtitle"&&(t=Bd(sl[i.track.source._codec],i));return p(t),K("stsd",0,0,[I(1)],[t])},Pd=(i,t)=>O(i,[Array(6).fill(0),B(1),B(0),B(0),Array(12).fill(0),B(t.info.width),B(t.info.height),I(4718592),I(4718592),I(0),B(1),Array(32).fill(0),B(24),Fc(65535)],[nl[t.track.source._codec](t),on(t.info.decoderConfig.colorSpace)?vd(t):null]),vd=i=>O("colr",[Ce("nclx"),B(ct[i.info.decoderConfig.colorSpace.primaries]),B(ut[i.info.decoderConfig.colorSpace.transfer]),B(dt[i.info.decoderConfig.colorSpace.matrix]),ie((i.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),Id=i=>i.info.decoderConfig&&O("avcC",[...W(i.info.decoderConfig.description)]),Ad=i=>i.info.decoderConfig&&O("hvcC",[...W(i.info.decoderConfig.description)]),Ec=i=>{if(!i.info.decoderConfig)return null;let t=i.info.decoderConfig,e=t.codec.split("."),r=Number(e[1]),n=Number(e[2]),a=Number(e[3]),s=e[4]?Number(e[4]):1,o=e[8]?Number(e[8]):Number(t.colorSpace?.fullRange??0),c=(a<<4)+(s<<1)+o,u=e[5]?Number(e[5]):t.colorSpace?.primaries?ct[t.colorSpace.primaries]:2,d=e[6]?Number(e[6]):t.colorSpace?.transfer?ut[t.colorSpace.transfer]:2,l=e[7]?Number(e[7]):t.colorSpace?.matrix?dt[t.colorSpace.matrix]:2;return K("vpcC",1,0,[ie(r),ie(n),ie(c),ie(u),ie(d),ie(l),B(0)])},Ed=i=>O("av1C",dn(i.info.decoderConfig.codec)),_d=(i,t)=>{let e=0,r,n=16;if(Y.includes(t.track.source._codec)){let a=t.track.source._codec,{sampleSize:s}=ke(a);n=8*s,n>16&&(e=1)}return e===0?r=[Array(6).fill(0),B(1),B(e),B(0),I(0),B(t.info.numberOfChannels),B(n),B(0),B(0),B(t.info.sampleRate<2**16?t.info.sampleRate:0),B(0)]:r=[Array(6).fill(0),B(1),B(e),B(0),I(0),B(t.info.numberOfChannels),B(Math.min(n,16)),B(0),B(0),B(t.info.sampleRate<2**16?t.info.sampleRate:0),B(0),I(1),I(n/8),I(t.info.numberOfChannels*n/8),I(2)],O(i,r,[al(t.track.source._codec,t.muxer.isQuickTime)?.(t)??null])},js=i=>{let t;switch(i.track.source._codec){case"aac":t=64;break;case"mp3":t=107;break;case"vorbis":t=221;break;default:throw new Error(`Unhandled audio codec: ${i.track.source._codec}`)}let e=[...ie(t),...ie(21),...Mc(0),...I(0),...I(0)];if(i.info.decoderConfig.description){let r=W(i.info.decoderConfig.description);e=[...e,...ie(5),...qs(r.byteLength),...r]}return e=[...B(1),...ie(0),...ie(4),...qs(e.length),...e,...ie(6),...ie(1),...ie(2)],e=[...ie(3),...qs(e.length),...e],K("esds",0,0,e)},Nt=i=>O("wave",void 0,[Fd(i),Md(i),O("\0\0\0\0")]),Fd=i=>O("frma",[Ce(jc(i.track.source._codec,i.muxer.isQuickTime))]),Md=i=>{let{littleEndian:t}=ke(i.track.source._codec);return O("enda",[B(+t)])},Rd=i=>{let t=i.info.numberOfChannels,e=3840,r=i.info.sampleRate,n=0,a=0,s=new Uint8Array(0),o=i.info.decoderConfig?.description;if(o){p(o.byteLength>=18);let c=W(o),u=Mt(c);t=u.outputChannelCount,e=u.preSkip,r=u.inputSampleRate,n=u.outputGain,a=u.channelMappingFamily,u.channelMappingTable&&(s=u.channelMappingTable)}return O("dOps",[ie(0),ie(t),B(e),I(r),Fc(n),ie(a),...s])},Dd=i=>{let t=i.info.decoderConfig?.description;p(t);let e=W(t);return K("dfLa",0,0,[...e.subarray(4)])},rt=i=>{let{littleEndian:t,sampleSize:e}=ke(i.track.source._codec),r=+t;return K("pcmC",0,0,[ie(r),ie(8*e)])},Bd=(i,t)=>O(i,[Array(6).fill(0),B(1)],[ol[t.track.source._codec](t)]),Od=i=>O("vttC",[...G.encode(i.info.config.description)]);var Ud=i=>K("stts",0,0,[I(i.timeToSampleTable.length),i.timeToSampleTable.map(t=>[I(t.sampleCount),I(t.sampleDelta)])]),Vd=i=>{if(i.samples.every(e=>e.type==="key"))return null;let t=[...i.samples.entries()].filter(([,e])=>e.type==="key");return K("stss",0,0,[I(t.length),t.map(([e])=>I(e+1))])},zd=i=>K("stsc",0,0,[I(i.compactlyCodedChunkTable.length),i.compactlyCodedChunkTable.map(t=>[I(t.firstChunk),I(t.samplesPerChunk),I(1)])]),Nd=i=>{if(i.type==="audio"&&i.info.requiresPcmTransformation){let{sampleSize:t}=ke(i.track.source._codec);return K("stsz",0,0,[I(t*i.info.numberOfChannels),I(i.samples.reduce((e,r)=>e+me(r.duration,i.timescale),0))])}return K("stsz",0,0,[I(0),I(i.samples.length),i.samples.map(t=>I(t.size))])},Ld=i=>i.finalizedChunks.length>0&&j(i.finalizedChunks).offset>=2**32?K("co64",0,0,[I(i.finalizedChunks.length),i.finalizedChunks.map(t=>or(t.offset))]):K("stco",0,0,[I(i.finalizedChunks.length),i.finalizedChunks.map(t=>I(t.offset))]),Wd=i=>K("ctts",1,0,[I(i.compositionTimeOffsetTable.length),i.compositionTimeOffsetTable.map(t=>[I(t.sampleCount),Lt(t.sampleCompositionTimeOffset)])]),Hd=i=>{let t=1/0,e=-1/0,r=1/0,n=-1/0;p(i.compositionTimeOffsetTable.length>0),p(i.samples.length>0);for(let s=0;s<i.compositionTimeOffsetTable.length;s++){let o=i.compositionTimeOffsetTable[s];t=Math.min(t,o.sampleCompositionTimeOffset),e=Math.max(e,o.sampleCompositionTimeOffset)}for(let s=0;s<i.samples.length;s++){let o=i.samples[s];r=Math.min(r,me(o.timestamp,i.timescale)),n=Math.max(n,me(o.timestamp+o.duration,i.timescale))}let a=Math.max(-t,0);return n>=2**31?null:K("cslg",0,0,[Lt(a),Lt(t),Lt(e),Lt(r),Lt(n)])},qd=i=>O("mvex",void 0,i.map(jd)),jd=i=>K("trex",0,0,[I(i.track.id),I(1),I(0),I(0),I(0)]),Qs=(i,t)=>O("moof",void 0,[Kd(i),...t.map(Gd)]),Kd=i=>K("mfhd",0,0,[I(i)]),zc=i=>{let t=0,e=0,r=0,n=0,a=i.type==="delta";return e|=+a,a?t|=1:t|=2,t<<24|e<<16|r<<8|n},Gd=i=>O("traf",void 0,[Qd(i),$d(i),Xd(i)]),Qd=i=>{p(i.currentChunk);let t=0;t|=8,t|=16,t|=32,t|=131072;let e=i.currentChunk.samples[1]??i.currentChunk.samples[0],r={duration:e.timescaleUnitsToNextSample,size:e.size,flags:zc(e)};return K("tfhd",0,t,[I(i.track.id),I(r.duration),I(r.size),I(r.flags)])},$d=i=>(p(i.currentChunk),K("tfdt",1,0,[or(me(i.currentChunk.startTimestamp,i.timescale))])),Xd=i=>{p(i.currentChunk);let t=i.currentChunk.samples.map(g=>g.timescaleUnitsToNextSample),e=i.currentChunk.samples.map(g=>g.size),r=i.currentChunk.samples.map(zc),n=i.currentChunk.samples.map(g=>me(g.timestamp-g.decodeTimestamp,i.timescale)),a=new Set(t),s=new Set(e),o=new Set(r),c=new Set(n),u=o.size===2&&r[0]!==r[1],d=a.size>1,l=s.size>1,m=!u&&o.size>1,f=c.size>1||[...c].some(g=>g!==0),h=0;return h|=1,h|=4*+u,h|=256*+d,h|=512*+l,h|=1024*+m,h|=2048*+f,K("trun",1,h,[I(i.currentChunk.samples.length),I(i.currentChunk.offset-i.currentChunk.moofOffset||0),u?I(r[0]):[],i.currentChunk.samples.map((g,b)=>[d?I(t[b]):[],l?I(e[b]):[],m?I(r[b]):[],f?Lt(n[b]):[]])])},Nc=i=>O("mfra",void 0,[...i.map(Yd),Zd()]),Yd=(i,t)=>K("tfra",1,0,[I(i.track.id),I(63),I(i.finalizedChunks.length),i.finalizedChunks.map(r=>[or(me(r.samples[0].timestamp,i.timescale)),or(r.moofOffset),I(t+1),I(1),I(1)])]),Zd=()=>K("mfro",0,0,[I(0)]),Lc=()=>O("vtte"),Wc=(i,t,e,r,n)=>O("vttc",void 0,[n!==null?O("vsid",[Lt(n)]):null,e!==null?O("iden",[...G.encode(e)]):null,t!==null?O("ctim",[...G.encode(ma(t))]):null,r!==null?O("sttg",[...G.encode(r)]):null,O("payl",[...G.encode(i)])]),Hc=i=>O("vtta",[...G.encode(i)]),Jd=i=>{let t=[],e=i.format._options.metadataFormat??"auto",r=i.output._metadataTags;if(e==="mdir"||e==="auto"&&!i.isQuickTime){let n=tl(r);n&&t.push(n)}else if(e==="mdta"){let n=rl(r);n&&t.push(n)}else(e==="udta"||e==="auto"&&i.isQuickTime)&&el(t,i.output._metadataTags);return t.length===0?null:O("udta",void 0,t)},el=(i,t)=>{for(let{key:e,value:r}of Ne(t))switch(e){case"title":i.push(it("\xA9nam",r));break;case"description":i.push(it("\xA9des",r));break;case"artist":i.push(it("\xA9ART",r));break;case"album":i.push(it("\xA9alb",r));break;case"albumArtist":i.push(it("albr",r));break;case"genre":i.push(it("\xA9gen",r));break;case"date":i.push(it("\xA9day",r.toISOString().slice(0,10)));break;case"comment":i.push(it("\xA9cmt",r));break;case"lyrics":i.push(it("\xA9lyr",r));break;case"raw":break;case"discNumber":case"discsTotal":case"trackNumber":case"tracksTotal":case"images":break;default:J(e)}if(t.raw)for(let e in t.raw){let r=t.raw[e];r==null||e.length!==4||i.some(n=>n.type===e)||(typeof r=="string"?i.push(it(e,r)):r instanceof Uint8Array&&i.push(O(e,Array.from(r))))}},it=(i,t)=>{let e=G.encode(t);return O(i,[B(e.length),B(Kc("und")),Array.from(e)])},_c={"image/jpeg":13,"image/png":14,"image/bmp":27},qc=(i,t)=>{let e=[];for(let{key:r,value:n}of Ne(i))switch(r){case"title":e.push({key:t?"title":"\xA9nam",value:$e(n)});break;case"description":e.push({key:t?"description":"\xA9des",value:$e(n)});break;case"artist":e.push({key:t?"artist":"\xA9ART",value:$e(n)});break;case"album":e.push({key:t?"album":"\xA9alb",value:$e(n)});break;case"albumArtist":e.push({key:t?"album_artist":"aART",value:$e(n)});break;case"comment":e.push({key:t?"comment":"\xA9cmt",value:$e(n)});break;case"genre":e.push({key:t?"genre":"\xA9gen",value:$e(n)});break;case"lyrics":e.push({key:t?"lyrics":"\xA9lyr",value:$e(n)});break;case"date":e.push({key:t?"date":"\xA9day",value:$e(n.toISOString().slice(0,10))});break;case"images":for(let a of n)a.kind==="coverFront"&&e.push({key:"covr",value:O("data",[I(_c[a.mimeType]??0),I(0),Array.from(a.data)])});break;case"trackNumber":if(t){let a=i.tracksTotal!==void 0?`${n}/${i.tracksTotal}`:n.toString();e.push({key:"track",value:$e(a)})}else e.push({key:"trkn",value:O("data",[I(0),I(0),B(0),B(n),B(i.tracksTotal??0),B(0)])});break;case"discNumber":t||e.push({key:"disc",value:O("data",[I(0),I(0),B(0),B(n),B(i.discsTotal??0),B(0)])});break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:J(r)}if(i.raw)for(let r in i.raw){let n=i.raw[r];n==null||!t&&r.length!==4||e.some(a=>a.key===r)||(typeof n=="string"?e.push({key:r,value:$e(n)}):n instanceof Uint8Array?e.push({key:r,value:O("data",[I(0),I(0),Array.from(n)])}):n instanceof Re&&e.push({key:r,value:O("data",[I(_c[n.mimeType]??0),I(0),Array.from(n.data)])}))}return e},tl=i=>{let t=qc(i,!1);return t.length===0?null:K("meta",0,0,void 0,[Gs(!1,"mdir","","appl"),O("ilst",void 0,t.map(e=>O(e.key,void 0,[e.value])))])},rl=i=>{let t=qc(i,!0);return t.length===0?null:O("meta",void 0,[Gs(!1,"mdta",""),K("keys",0,0,[I(t.length)],t.map(e=>O("mdta",[...G.encode(e.key)]))),O("ilst",void 0,t.map((e,r)=>{let n=String.fromCharCode(...I(r+1));return O(n,void 0,[e.value])}))])},$e=i=>O("data",[I(1),I(0),...G.encode(i)]),il=(i,t)=>{switch(i){case"avc":return t.startsWith("avc3")?"avc3":"avc1";case"hevc":return"hvc1";case"vp8":return"vp08";case"vp9":return"vp09";case"av1":return"av01"}},nl={avc:Id,hevc:Ad,vp8:Ec,vp9:Ec,av1:Ed},jc=(i,t)=>{switch(i){case"aac":return"mp4a";case"mp3":return"mp4a";case"opus":return"Opus";case"vorbis":return"mp4a";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(t)switch(i){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":return"in24";case"pcm-s24be":return"in24";case"pcm-s32":return"in32";case"pcm-s32be":return"in32";case"pcm-f32":return"fl32";case"pcm-f32be":return"fl32";case"pcm-f64":return"fl64";case"pcm-f64be":return"fl64"}else switch(i){case"pcm-s16":return"ipcm";case"pcm-s16be":return"ipcm";case"pcm-s24":return"ipcm";case"pcm-s24be":return"ipcm";case"pcm-s32":return"ipcm";case"pcm-s32be":return"ipcm";case"pcm-f32":return"fpcm";case"pcm-f32be":return"fpcm";case"pcm-f64":return"fpcm";case"pcm-f64be":return"fpcm"}},al=(i,t)=>{switch(i){case"aac":return js;case"mp3":return js;case"opus":return Rd;case"vorbis":return js;case"flac":return Dd}if(t)switch(i){case"pcm-s24":return Nt;case"pcm-s24be":return Nt;case"pcm-s32":return Nt;case"pcm-s32be":return Nt;case"pcm-f32":return Nt;case"pcm-f32be":return Nt;case"pcm-f64":return Nt;case"pcm-f64be":return Nt}else switch(i){case"pcm-s16":return rt;case"pcm-s16be":return rt;case"pcm-s24":return rt;case"pcm-s24be":return rt;case"pcm-s32":return rt;case"pcm-s32be":return rt;case"pcm-f32":return rt;case"pcm-f32be":return rt;case"pcm-f64":return rt;case"pcm-f64be":return rt}return null},sl={webvtt:"wvtt"},ol={webvtt:Od},Kc=i=>{p(i.length===3);let t=0;for(let e=0;e<3;e++)t<<=5,t+=i.charCodeAt(e)-96;return t};var $i=class{constructor(){this.ensureMonotonicity=!1;this.trackedWrites=null;this.trackedStart=-1;this.trackedEnd=-1}start(){}maybeTrackWrites(t){if(!this.trackedWrites)return;let e=this.getPos();if(e<this.trackedStart){if(e+t.byteLength<=this.trackedStart)return;t=t.subarray(this.trackedStart-e),e=0}let r=e+t.byteLength-this.trackedStart,n=this.trackedWrites.byteLength;for(;n<r;)n*=2;if(n!==this.trackedWrites.byteLength){let a=new Uint8Array(n);a.set(this.trackedWrites,0),this.trackedWrites=a}this.trackedWrites.set(t,e-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,e+t.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(2**10),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw new Error("Internal error: Can't get tracked writes since nothing was tracked.");let e={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,e}},$s=2**16,Xs=2**32,ni=class extends $i{constructor(e){super();this.pos=0;this.maxPos=0;if(this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer($s,{maxByteLength:Xs})}catch{this.buffer=new ArrayBuffer($s),this.supportsResize=!1}else this.buffer=new ArrayBuffer($s);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let r=this.buffer.byteLength;for(;r<e;)r*=2;if(r!==this.buffer.byteLength){if(r>Xs)throw new Error(`ArrayBuffer exceeded maximum size of ${Xs} bytes. Please consider using another target.`);if(this.supportsResize)this.buffer.resize(r);else{let n=new ArrayBuffer(r),a=new Uint8Array(n);a.set(this.bytes,0),this.buffer=n,this.bytes=a}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,r){return this.bytes.slice(e,r)}},cl=2**24,ul=2,pa=class extends $i{constructor(e){super();this.pos=0;this.sections=[];this.lastWriteEnd=0;this.lastFlushEnd=0;this.writer=null;this.chunks=[];this.target=e,this.chunked=e._options.chunked??!1,this.chunkSize=e._options.chunkSize??cl}start(){this.writer=this.target._writable.getWriter()}write(e){if(this.pos>this.lastWriteEnd){let r=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(r))}this.maybeTrackWrites(e),this.sections.push({data:e.slice(),start:this.pos}),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.lastWriteEnd=Math.max(this.lastWriteEnd,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){if(this.pos>this.lastWriteEnd){let n=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(n))}if(p(this.writer),this.sections.length===0)return;let e=[],r=[...this.sections].sort((n,a)=>n.start-a.start);e.push({start:r[0].start,size:r[0].data.byteLength});for(let n=1;n<r.length;n++){let a=e[e.length-1],s=r[n];s.start<=a.start+a.size?a.size=Math.max(a.size,s.start+s.data.byteLength-a.start):e.push({start:s.start,size:s.data.byteLength})}for(let n of e){n.data=new Uint8Array(n.size);for(let a of this.sections)n.start<=a.start&&a.start<n.start+n.size&&n.data.set(a.data,a.start-n.start);if(this.writer.desiredSize!==null&&this.writer.desiredSize<=0&&await this.writer.ready,this.chunked)this.writeDataIntoChunks(n.data,n.start),this.tryToFlushChunks();else{if(this.ensureMonotonicity&&n.start!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:n.data,position:n.start}),this.lastFlushEnd=n.start+n.data.byteLength}}this.sections.length=0}writeDataIntoChunks(e,r){let n=this.chunks.findIndex(u=>u.start<=r&&r<u.start+this.chunkSize);n===-1&&(n=this.createChunk(r));let a=this.chunks[n],s=r-a.start,o=e.subarray(0,Math.min(this.chunkSize-s,e.byteLength));a.data.set(o,s);let c={start:s,end:s+o.byteLength};if(this.insertSectionIntoChunk(a,c),a.written[0].start===0&&a.written[0].end===this.chunkSize&&(a.shouldFlush=!0),this.chunks.length>ul){for(let u=0;u<this.chunks.length-1;u++)this.chunks[u].shouldFlush=!0;this.tryToFlushChunks()}o.byteLength<e.byteLength&&this.writeDataIntoChunks(e.subarray(o.byteLength),r+o.byteLength)}insertSectionIntoChunk(e,r){let n=0,a=e.written.length-1,s=-1;for(;n<=a;){let o=Math.floor(n+(a-n+1)/2);e.written[o].start<=r.start?(n=o+1,s=o):a=o-1}for(e.written.splice(s+1,0,r),(s===-1||e.written[s].end<r.start)&&s++;s<e.written.length-1&&e.written[s].end>=e.written[s+1].start;)e.written[s].end=Math.max(e.written[s].end,e.written[s+1].end),e.written.splice(s+1,1)}createChunk(e){let n={start:Math.floor(e/this.chunkSize)*this.chunkSize,data:new Uint8Array(this.chunkSize),written:[],shouldFlush:!1};return this.chunks.push(n),this.chunks.sort((a,s)=>a.start-s.start),this.chunks.indexOf(n)}tryToFlushChunks(e=!1){p(this.writer);for(let r=0;r<this.chunks.length;r++){let n=this.chunks[r];if(!(!n.shouldFlush&&!e)){for(let a of n.written){let s=n.start+a.start;if(this.ensureMonotonicity&&s!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:n.data.subarray(a.start,a.end),position:s}),this.lastFlushEnd=n.start+a.end}this.chunks.splice(r--,1)}}}finalize(){return this.chunked&&this.tryToFlushChunks(!0),p(this.writer),this.writer.close()}async close(){return this.writer?.close()}},ha=class extends $i{constructor(e){super();this.target=e;this.pos=0}write(e){this.maybeTrackWrites(e),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength}getPos(){return this.pos}seek(e){this.pos=e}async flush(){}async finalize(){}async close(){}};var Qc=lo(Ls(),1);var dl=typeof Qc<"u"?Qc:void 0,at=class{constructor(){this._output=null;this.onwrite=null}},ai=class extends at{constructor(){super(...arguments);this.buffer=null}_createWriter(){return new ni(this)}},Xi=class extends at{constructor(t,e={}){if(super(),!(t instanceof WritableStream))throw new TypeError("StreamTarget requires a WritableStream instance.");if(e!=null&&typeof e!="object")throw new TypeError("StreamTarget options, when provided, must be an object.");if(e.chunked!==void 0&&typeof e.chunked!="boolean")throw new TypeError("options.chunked, when provided, must be a boolean.");if(e.chunkSize!==void 0&&(!Number.isInteger(e.chunkSize)||e.chunkSize<1024))throw new TypeError("options.chunkSize, when provided, must be an integer and not smaller than 1024.");this._writable=t,this._options=e}_createWriter(){return new pa(this)}},ga=class extends at{constructor(e,r={}){if(typeof e!="string")throw new TypeError("filePath must be a string.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");super();this._fileHandle=null;let n=new WritableStream({start:async()=>{this._fileHandle=await dl.fs.open(e,"w")},write:async a=>{p(this._fileHandle),await this._fileHandle.write(a.data,0,a.data.byteLength,a.position)},close:async()=>{this._fileHandle&&(await this._fileHandle.close(),this._fileHandle=null)}});this._streamTarget=new Xi(n,{chunked:!0,...r}),this._streamTarget._output=this._output}_createWriter(){return this._streamTarget._createWriter()}},si=class extends at{_createWriter(){return new ha(this)}};var fa=1e3,ll=2082844800,Gc=i=>{let t={},e=i.track;return e.metadata.name!==void 0&&(t.name=e.metadata.name),t},me=(i,t,e=!0)=>{let r=i*t;return e?Math.round(r):r},ba=class extends pe{constructor(e,r){super(e);this.auxTarget=new ai;this.auxWriter=this.auxTarget._createWriter();this.auxBoxWriter=new Gi(this.auxWriter);this.mdat=null;this.ftypSize=null;this.trackDatas=[];this.allTracksKnown=Q();this.creationTime=Math.floor(Date.now()/1e3)+ll;this.finalizedChunks=[];this.nextFragmentNumber=1;this.maxWrittenTimestamp=-1/0;this.format=r,this.writer=e._writer,this.boxWriter=new Gi(this.writer),this.isQuickTime=r instanceof cr;let n=this.writer instanceof ni?"in-memory":!1;this.fastStart=r._options.fastStart??n,this.isFragmented=this.fastStart==="fragmented",(this.fastStart==="in-memory"||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=r._options.minimumFragmentDuration??1}async start(){let e=await this.mutex.acquire(),r=this.output._tracks.some(n=>n.type==="video"&&n.source._codec==="avc");if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(Uc({isQuickTime:this.isQuickTime,holdsAvc:r,fragmented:this.isFragmented})),this.format._options.onFtyp){let{data:n,start:a}=this.writer.stopTrackingWrites();this.format._options.onFtyp(n,a)}if(this.ftypSize=this.writer.getPos(),this.fastStart!=="in-memory")if(this.fastStart==="reserve"){for(let n of this.output._tracks)if(n.metadata.maximumPacketCount===void 0)throw new Error("All tracks must specify maximumPacketCount in their metadata when using fastStart: 'reserve'.")}else this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=Qi(!0),this.boxWriter.writeBox(this.mdat));await this.writer.flush(),e()}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(r=>r.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(r=>r.type==="video"||r.type==="audio"?r.info.decoderConfig.codec:{webvtt:"wvtt"}[r.track.source._codec]);return Cn({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(r=>r.type==="video"),hasAudio:this.trackDatas.some(r=>r.type==="audio"),codecStrings:e})}getVideoTrackData(e,r,n){let a=this.trackDatas.find(d=>d.track===e);if(a)return a;xr(n),p(n),p(n.decoderConfig);let s={...n.decoderConfig};p(s.codedWidth!==void 0),p(s.codedHeight!==void 0);let o=!1;if(e.source._codec==="avc"&&!s.description){let d=Cr(r.data);if(!d)throw new Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");s.description=No(d),o=!0}else if(e.source._codec==="hevc"&&!s.description){let d=Pr(r.data);if(!d)throw new Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");s.description=Lo(d),o=!0}let c=wo(1/(e.metadata.frameRate??57600),1e6).denominator,u={muxer:this,track:e,type:"video",info:{width:s.codedWidth,height:s.codedHeight,decoderConfig:s,requiresAnnexBTransformation:o},timescale:c,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(u),this.trackDatas.sort((d,l)=>d.track.id-l.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),u}getAudioTrackData(e,r,n){let a=this.trackDatas.find(u=>u.track===e);if(a)return a;ve(n),p(n),p(n.decoderConfig);let s={...n.decoderConfig},o=!1;if(e.source._codec==="aac"&&!s.description){let u=Ee(ge.tempFromBytes(r.data));if(!u)throw new Error("Couldn't parse ADTS header from the AAC packet. Make sure the packets are in ADTS format (as specified in ISO 13818-7) when not providing a description, or provide a description (must be an AudioSpecificConfig as specified in ISO 14496-3) and ensure the packets are raw AAC data.");let d=Ue[u.samplingFrequencyIndex],l=et[u.channelConfiguration];if(d===void 0||l===void 0)throw new Error("Invalid ADTS frame header.");s.description=Sr({objectType:u.objectType,sampleRate:d,numberOfChannels:l}),o=!0}let c={muxer:this,track:e,type:"audio",info:{numberOfChannels:n.decoderConfig.numberOfChannels,sampleRate:n.decoderConfig.sampleRate,decoderConfig:s,requiresPcmTransformation:!this.isFragmented&&Y.includes(e.source._codec),requiresAdtsStripping:o},timescale:n.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(c),this.trackDatas.sort((u,d)=>u.track.id-d.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),c}getSubtitleTrackData(e,r){let n=this.trackDatas.find(s=>s.track===e);if(n)return n;ln(r),p(r),p(r.config);let a={muxer:this,track:e,type:"subtitle",info:{config:r.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(e,r,n){let a=await this.mutex.acquire();try{let s=this.getVideoTrackData(e,r,n),o=r.data;if(s.info.requiresAnnexBTransformation){let d=[...Ft(o)].map(l=>o.subarray(l.offset,l.offset+l.length));if(d.length===0)throw new Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");o=rs(d,4)}let c=this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key"),u=this.createSampleForTrack(s,o,c,r.duration,r.type);await this.registerSample(s,u)}finally{a()}}async addEncodedAudioPacket(e,r,n){let a=await this.mutex.acquire();try{let s=this.getAudioTrackData(e,r,n),o=r.data;if(s.info.requiresAdtsStripping){let d=Ee(ge.tempFromBytes(o));if(!d)throw new Error("Expected ADTS frame, didn't get one.");let l=d.crcCheck===null?xt:Oe;o=o.subarray(l)}let c=this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key"),u=this.createSampleForTrack(s,o,c,r.duration,r.type);s.info.requiresPcmTransformation&&await this.maybePadWithSilence(s,c),await this.registerSample(s,u)}finally{a()}}async maybePadWithSilence(e,r){let n=j(e.samples),a=n?n.timestamp+n.duration:0,s=r-a,o=me(s,e.timescale);if(o>0){let{sampleSize:c,silentValue:u}=ke(e.info.decoderConfig.codec),d=o*e.info.numberOfChannels,l=new Uint8Array(c*d).fill(u),m=this.createSampleForTrack(e,new Uint8Array(l.buffer),a,s,"key");await this.registerSample(e,m)}}async addSubtitleCue(e,r,n){let a=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(e,n);this.validateAndNormalizeTimestamp(s.track,r.timestamp,!0),e.source._codec==="webvtt"&&(s.cueQueue.push(r),await this.processWebVTTCues(s,r.timestamp))}finally{a()}}async processWebVTTCues(e,r){for(;e.cueQueue.length>0;){let n=new Set([]);for(let d of e.cueQueue)p(d.timestamp<=r),p(e.lastCueEndTimestamp<=d.timestamp+d.duration),n.add(Math.max(d.timestamp,e.lastCueEndTimestamp)),n.add(d.timestamp+d.duration);let a=[...n].sort((d,l)=>d-l),s=a[0],o=a[1]??s;if(r<o)break;if(e.lastCueEndTimestamp<s){this.auxWriter.seek(0);let d=Lc();this.auxBoxWriter.writeBox(d);let l=this.auxWriter.getSlice(0,this.auxWriter.getPos()),m=this.createSampleForTrack(e,l,e.lastCueEndTimestamp,s-e.lastCueEndTimestamp,"key");await this.registerSample(e,m),e.lastCueEndTimestamp=s}this.auxWriter.seek(0);for(let d=0;d<e.cueQueue.length;d++){let l=e.cueQueue[d];if(l.timestamp>=o)break;ri.lastIndex=0;let m=ri.test(l.text),f=l.timestamp+l.duration,h=e.cueToSourceId.get(l);if(h===void 0&&o<f&&(h=e.nextSourceId++,e.cueToSourceId.set(l,h)),l.notes){let b=Hc(l.notes);this.auxBoxWriter.writeBox(b)}let g=Wc(l.text,m?s:null,l.identifier??null,l.settings??null,h??null);this.auxBoxWriter.writeBox(g),f===o&&e.cueQueue.splice(d--,1)}let c=this.auxWriter.getSlice(0,this.auxWriter.getPos()),u=this.createSampleForTrack(e,c,s,o-s,"key");await this.registerSample(e,u),e.lastCueEndTimestamp=o}}createSampleForTrack(e,r,n,a,s){return{timestamp:n,decodeTimestamp:n,duration:a,data:r,size:r.byteLength,type:s,timescaleUnitsToNextSample:me(a,e.timescale)}}processTimestamps(e,r){if(e.timestampProcessingQueue.length===0)return;if(e.type==="audio"&&e.info.requiresPcmTransformation){let a=0;for(let s=0;s<e.timestampProcessingQueue.length;s++){let o=e.timestampProcessingQueue[s],c=me(o.duration,e.timescale);a+=c}if(e.timeToSampleTable.length===0)e.timeToSampleTable.push({sampleCount:a,sampleDelta:1});else{let s=j(e.timeToSampleTable);s.sampleCount+=a}e.timestampProcessingQueue.length=0;return}let n=e.timestampProcessingQueue.map(a=>a.timestamp).sort((a,s)=>a-s);for(let a=0;a<e.timestampProcessingQueue.length;a++){let s=e.timestampProcessingQueue[a];s.decodeTimestamp=n[a],!this.isFragmented&&e.lastTimescaleUnits===null&&(s.decodeTimestamp=0);let o=me(s.timestamp-s.decodeTimestamp,e.timescale),c=me(s.duration,e.timescale);if(e.lastTimescaleUnits!==null){p(e.lastSample);let u=me(s.decodeTimestamp,e.timescale,!1),d=Math.round(u-e.lastTimescaleUnits);if(p(d>=0),e.lastTimescaleUnits+=d,e.lastSample.timescaleUnitsToNextSample=d,!this.isFragmented){let l=j(e.timeToSampleTable);if(p(l),l.sampleCount===1){l.sampleDelta=d;let f=e.timeToSampleTable[e.timeToSampleTable.length-2];f&&f.sampleDelta===d&&(f.sampleCount++,e.timeToSampleTable.pop(),l=f)}else l.sampleDelta!==d&&(l.sampleCount--,e.timeToSampleTable.push(l={sampleCount:1,sampleDelta:d}));l.sampleDelta===c?l.sampleCount++:e.timeToSampleTable.push({sampleCount:1,sampleDelta:c});let m=j(e.compositionTimeOffsetTable);p(m),m.sampleCompositionTimeOffset===o?m.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:o})}}else e.lastTimescaleUnits=me(s.decodeTimestamp,e.timescale,!1),this.isFragmented||(e.timeToSampleTable.push({sampleCount:1,sampleDelta:c}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:o}));e.lastSample=s}if(e.timestampProcessingQueue.length=0,p(e.lastSample),p(e.lastTimescaleUnits!==null),r!==void 0&&e.lastSample.timescaleUnitsToNextSample===0){p(r.type==="key");let a=me(r.timestamp,e.timescale,!1),s=Math.round(a-e.lastTimescaleUnits);e.lastSample.timescaleUnitsToNextSample=s}}async registerSample(e,r){r.type==="key"&&this.processTimestamps(e,r),e.timestampProcessingQueue.push(r),this.isFragmented?(e.sampleQueue.push(r),await this.interleaveSamples()):this.fastStart==="reserve"?await this.registerSampleFastStartReserve(e,r):await this.addSampleToTrack(e,r)}async addSampleToTrack(e,r){if(!this.isFragmented&&(e.samples.push(r),this.fastStart==="reserve")){let a=e.track.metadata.maximumPacketCount;if(p(a!==void 0),e.samples.length>a)throw new Error(`Track #${e.track.id} has already reached the maximum packet count (${a}). Either add less packets or increase the maximum packet count.`)}let n=!1;if(!e.currentChunk)n=!0;else{e.currentChunk.startTimestamp=Math.min(e.currentChunk.startTimestamp,r.timestamp);let a=r.timestamp-e.currentChunk.startTimestamp;if(this.isFragmented){let s=this.trackDatas.every(o=>{if(e===o)return r.type==="key";let c=o.sampleQueue[0];return c?c.type==="key":o.track.source._closed});a>=this.minimumFragmentDuration&&s&&r.timestamp>this.maxWrittenTimestamp&&(n=!0,await this.finalizeFragment())}else n=a>=.5}n&&(e.currentChunk&&await this.finalizeCurrentChunk(e),e.currentChunk={startTimestamp:r.timestamp,samples:[],offset:null,moofOffset:null}),p(e.currentChunk),e.currentChunk.samples.push(r),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,r.timestamp))}async finalizeCurrentChunk(e){if(p(!this.isFragmented),!e.currentChunk)return;e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk);let r=e.currentChunk.samples.length;if(e.type==="audio"&&e.info.requiresPcmTransformation&&(r=e.currentChunk.samples.reduce((n,a)=>n+me(a.duration,e.timescale),0)),(e.compactlyCodedChunkTable.length===0||j(e.compactlyCodedChunkTable).samplesPerChunk!==r)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:r}),this.fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=this.writer.getPos();for(let n of e.currentChunk.samples)p(n.data),this.writer.write(n.data),n.data=null;await this.writer.flush()}async interleaveSamples(e=!1){if(p(this.isFragmented),!(!e&&!this.allTracksAreKnown()))e:for(;;){let r=null,n=1/0;for(let s of this.trackDatas){if(!e&&s.sampleQueue.length===0&&!s.track.source._closed)break e;s.sampleQueue.length>0&&s.sampleQueue[0].timestamp<n&&(r=s,n=s.sampleQueue[0].timestamp)}if(!r)break;let a=r.sampleQueue.shift();await this.addSampleToTrack(r,a)}}async finalizeFragment(e=!0){p(this.isFragmented);let r=this.nextFragmentNumber++;if(r===1){this.format._options.onMoov&&this.writer.startTrackingWrites();let h=ii(this);if(this.boxWriter.writeBox(h),this.format._options.onMoov){let{data:g,start:b}=this.writer.stopTrackingWrites();this.format._options.onMoov(g,b)}}let n=this.trackDatas.filter(h=>h.currentChunk),a=Qs(r,n),s=this.writer.getPos(),o=s+this.boxWriter.measureBox(a),c=o+He,u=1/0;for(let h of n){h.currentChunk.offset=c,h.currentChunk.moofOffset=s;for(let g of h.currentChunk.samples)c+=g.size;u=Math.min(u,h.currentChunk.startTimestamp)}let d=c-o,l=d>=2**32;if(l)for(let h of n)h.currentChunk.offset+=kt-He;this.format._options.onMoof&&this.writer.startTrackingWrites();let m=Qs(r,n);if(this.boxWriter.writeBox(m),this.format._options.onMoof){let{data:h,start:g}=this.writer.stopTrackingWrites();this.format._options.onMoof(h,g,u)}p(this.writer.getPos()===o),this.format._options.onMdat&&this.writer.startTrackingWrites();let f=Qi(l);f.size=d,this.boxWriter.writeBox(f),this.writer.seek(o+(l?kt:He));for(let h of n)for(let g of h.currentChunk.samples)this.writer.write(g.data),g.data=null;if(this.format._options.onMdat){let{data:h,start:g}=this.writer.stopTrackingWrites();this.format._options.onMdat(h,g)}for(let h of n)h.finalizedChunks.push(h.currentChunk),this.finalizedChunks.push(h.currentChunk),h.currentChunk=null;e&&await this.writer.flush()}async registerSampleFastStartReserve(e,r){if(this.allTracksAreKnown()){if(!this.mdat){let n=ii(this),s=this.boxWriter.measureBox(n)+this.computeSampleTableSizeUpperBound()+4096;p(this.ftypSize!==null),this.writer.seek(this.ftypSize+s),this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=Qi(!0),this.boxWriter.writeBox(this.mdat);for(let o of this.trackDatas){for(let c of o.sampleQueue)await this.addSampleToTrack(o,c);o.sampleQueue.length=0}}await this.addSampleToTrack(e,r)}else e.sampleQueue.push(r)}computeSampleTableSizeUpperBound(){p(this.fastStart==="reserve");let e=0;for(let r of this.trackDatas){let n=r.track.metadata.maximumPacketCount;p(n!==void 0),e+=8*Math.ceil(2/3*n),e+=4*n,e+=8*Math.ceil(2/3*n),e+=12*Math.ceil(2/3*n),e+=4*n,e+=8*n}return e}async onTrackClose(e){let r=await this.mutex.acquire();if(e.type==="subtitle"&&e.source._codec==="webvtt"){let n=this.trackDatas.find(a=>a.track===e);n&&await this.processWebVTTCues(n,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),r()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve();for(let r of this.trackDatas)r.type==="subtitle"&&r.track.source._codec==="webvtt"&&await this.processWebVTTCues(r,1/0);if(this.isFragmented){await this.interleaveSamples(!0);for(let r of this.trackDatas)this.processTimestamps(r);await this.finalizeFragment(!1)}else for(let r of this.trackDatas)this.processTimestamps(r),await this.finalizeCurrentChunk(r);if(this.fastStart==="in-memory"){this.mdat=Qi(!1);let r;for(let a=0;a<2;a++){let s=ii(this),o=this.boxWriter.measureBox(s);r=this.boxWriter.measureBox(this.mdat);let c=this.writer.getPos()+o+r;for(let u of this.finalizedChunks){u.offset=c;for(let{data:d}of u.samples)p(d),c+=d.byteLength,r+=d.byteLength}if(c<2**32)break;r>=2**32&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();let n=ii(this);if(this.boxWriter.writeBox(n),this.format._options.onMoov){let{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onMoov(a,s)}this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=r,this.boxWriter.writeBox(this.mdat);for(let a of this.finalizedChunks)for(let s of a.samples)p(s.data),this.writer.write(s.data),s.data=null;if(this.format._options.onMdat){let{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onMdat(a,s)}}else if(this.isFragmented){let r=this.writer.getPos(),n=Nc(this.trackDatas);this.boxWriter.writeBox(n);let a=this.writer.getPos()-r;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(a)}else{p(this.mdat);let r=this.boxWriter.offsets.get(this.mdat);p(r!==void 0);let n=this.writer.getPos()-r;if(this.mdat.size=n,this.mdat.largeSize=n>=2**32,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){let{data:s,start:o}=this.writer.stopTrackingWrites();this.format._options.onMdat(s,o)}let a=ii(this);if(this.fastStart==="reserve"){p(this.ftypSize!==null),this.writer.seek(this.ftypSize),this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(a);let s=this.boxWriter.offsets.get(this.mdat)-this.writer.getPos();this.boxWriter.writeBox(Vc(s))}else this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(a);if(this.format._options.onMoov){let{data:s,start:o}=this.writer.stopTrackingWrites();this.format._options.onMoov(s,o)}}e()}};var ml=-(2**15),fl=2**15-1,$c="Mediabunny",Xc=6,Yc=5,pl={video:1,audio:2,subtitle:17},ka=class extends pe{constructor(e,r){super(e);this.trackDatas=[];this.allTracksKnown=Q();this.segment=null;this.segmentInfo=null;this.seekHead=null;this.tracksElement=null;this.tagsElement=null;this.attachmentsElement=null;this.segmentDuration=null;this.cues=null;this.currentCluster=null;this.currentClusterStartMsTimestamp=null;this.currentClusterMaxMsTimestamp=null;this.trackDatasInCurrentCluster=new Map;this.duration=0;this.writer=e._writer,this.format=r,this.ebmlWriter=new _n(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){let e=await this.mutex.acquire();this.writeEBMLHeader(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:this.format instanceof ur?"webm":"matroska"},{id:17031,data:2},{id:17029,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){let{data:r,start:n}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(r,n)}}maybeCreateSeekHead(e){if(this.format._options.appendOnly)return;let r=new Uint8Array([28,83,187,107]),n=new Uint8Array([21,73,169,102]),a=new Uint8Array([22,84,174,107]),s=new Uint8Array([25,65,164,105]),o=new Uint8Array([18,84,195,103]),c={id:290298740,data:[{id:19899,data:[{id:21419,data:r},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset:0}]},{id:19899,data:[{id:21419,data:n},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset:0}]},{id:19899,data:[{id:21419,data:a},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset:0}]},this.attachmentsElement?{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.attachmentsElement)-this.segmentDataOffset:0}]}:null,this.tagsElement?{id:19899,data:[{id:21419,data:o},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.tagsElement)-this.segmentDataOffset:0}]}:null]};this.seekHead=c}createSegmentInfo(){let e={id:17545,data:new Dr(0)};this.segmentDuration=e;let r={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:$c},{id:22337,data:$c},this.format._options.appendOnly?null:e]};this.segmentInfo=r}createTracks(){let e={id:374648427,data:[]};this.tracksElement=e;for(let r of this.trackDatas){let n=Be[r.track.source._codec];p(n);let a=0;if(r.type==="audio"&&r.track.source._codec==="opus"){a=1e6*80;let s=r.info.decoderConfig.description;if(s){let o=W(s),c=Mt(o);a=Math.round(1e9*(c.preSkip/Le))}}e.data.push({id:174,data:[{id:215,data:r.track.id},{id:29637,data:r.track.id},{id:131,data:pl[r.type]},r.track.metadata.disposition?.default===!1?{id:136,data:0}:null,r.track.metadata.disposition?.forced?{id:21930,data:1}:null,r.track.metadata.disposition?.hearingImpaired?{id:21931,data:1}:null,r.track.metadata.disposition?.visuallyImpaired?{id:21932,data:1}:null,r.track.metadata.disposition?.original?{id:21934,data:1}:null,r.track.metadata.disposition?.commentary?{id:21935,data:1}:null,{id:156,data:0},{id:2274716,data:r.track.metadata.languageCode??ee},{id:134,data:n},{id:22186,data:0},{id:22203,data:a},r.track.metadata.name!==void 0?{id:21358,data:new je(r.track.metadata.name)}:null,r.type==="video"?this.videoSpecificTrackInfo(r):null,r.type==="audio"?this.audioSpecificTrackInfo(r):null,r.type==="subtitle"?this.subtitleSpecificTrackInfo(r):null]})}}videoSpecificTrackInfo(e){let{frameRate:r,rotation:n}=e.track.metadata,a=[e.info.decoderConfig.description?{id:25506,data:W(e.info.decoderConfig.description)}:null,r?{id:2352003,data:1e9/r}:null],s=n?It(-n):0,o=e.info.decoderConfig.colorSpace,c={id:224,data:[{id:176,data:e.info.width},{id:186,data:e.info.height},e.info.alphaMode?{id:21440,data:1}:null,on(o)?{id:21936,data:[{id:21937,data:dt[o.matrix]},{id:21946,data:ut[o.transfer]},{id:21947,data:ct[o.primaries]},{id:21945,data:o.fullRange?2:1}]}:null,s?{id:30320,data:[{id:30321,data:0},{id:30325,data:new Rr((s+180)%360-180)}]}:null]};return a.push(c),a}audioSpecificTrackInfo(e){let r=Y.includes(e.track.source._codec)?ke(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:25506,data:W(e.info.decoderConfig.description)}:null,{id:225,data:[{id:181,data:new Rr(e.info.sampleRate)},{id:159,data:e.info.numberOfChannels},r?{id:25188,data:8*r.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:25506,data:G.encode(e.info.config.description)}]}maybeCreateTags(){let e=[],r=(s,o)=>{e.push({id:26568,data:[{id:17827,data:new je(s)},typeof o=="string"?{id:17543,data:new je(o)}:{id:17541,data:o}]})},n=this.output._metadataTags,a=new Set;for(let{key:s,value:o}of Ne(n))switch(s){case"title":r("TITLE",o),a.add("TITLE");break;case"description":r("DESCRIPTION",o),a.add("DESCRIPTION");break;case"artist":r("ARTIST",o),a.add("ARTIST");break;case"album":r("ALBUM",o),a.add("ALBUM");break;case"albumArtist":r("ALBUM_ARTIST",o),a.add("ALBUM_ARTIST");break;case"genre":r("GENRE",o),a.add("GENRE");break;case"comment":r("COMMENT",o),a.add("COMMENT");break;case"lyrics":r("LYRICS",o),a.add("LYRICS");break;case"date":r("DATE",o.toISOString().slice(0,10)),a.add("DATE");break;case"trackNumber":{let c=n.tracksTotal!==void 0?`${o}/${n.tracksTotal}`:o.toString();r("PART_NUMBER",c),a.add("PART_NUMBER")}break;case"discNumber":{let c=n.discsTotal!==void 0?`${o}/${n.discsTotal}`:o.toString();r("DISC",c),a.add("DISC")}break;case"tracksTotal":case"discsTotal":break;case"images":case"raw":break;default:J(s)}if(n.raw)for(let s in n.raw){let o=n.raw[s];o==null||a.has(s)||(typeof o=="string"||o instanceof Uint8Array)&&r(s,o)}e.length!==0&&(this.tagsElement={id:307544935,data:[{id:29555,data:[{id:25536,data:[{id:26826,data:50},{id:25546,data:"MOVIE"}]},...e]}]})}maybeCreateAttachments(){let e=this.output._metadataTags,r=[],n=new Set,a=e.images??[];for(let s of a){let o=s.name;o===void 0&&(o=(s.kind==="coverFront"?"cover":s.kind==="coverBack"?"back":"image")+(So(s.mimeType)??""));let c;for(;;){c=0n;for(let u=0;u<8;u++)c<<=8n,c|=BigInt(Math.floor(Math.random()*256));if(c!==0n&&!n.has(c))break}n.add(c),r.push({id:24999,data:[s.description!==void 0?{id:18046,data:new je(s.description)}:null,{id:18030,data:new je(o)},{id:18016,data:s.mimeType},{id:18012,data:s.data},{id:18094,data:c}]})}for(let[s,o]of Object.entries(e.raw??{}))!(o instanceof ft)||!/^\d+$/.test(s)||a.find(u=>u.mimeType===o.mimeType&&Po(u.data,o.data))||r.push({id:24999,data:[o.description!==void 0?{id:18046,data:new je(o.description)}:null,{id:18030,data:new je(o.name??"")},{id:18016,data:o.mimeType??""},{id:18012,data:o.data},{id:18094,data:BigInt(s)}]});r.length!==0&&(this.attachmentsElement={id:423732329,data:r})}createSegment(){this.createTracks(),this.maybeCreateTags(),this.maybeCreateAttachments(),this.maybeCreateSeekHead(!1);let e={id:408125543,size:this.format._options.appendOnly?-1:Xc,data:[this.seekHead,this.segmentInfo,this.tracksElement,this.attachmentsElement,this.tagsElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){let{data:r,start:n}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(r,n)}}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return p(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(r=>r.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(r=>r.type==="video"||r.type==="audio"?r.info.decoderConfig.codec:{webvtt:"wvtt"}[r.track.source._codec]);return Dn({isWebM:this.format instanceof ur,hasVideo:this.trackDatas.some(r=>r.type==="video"),hasAudio:this.trackDatas.some(r=>r.type==="audio"),codecStrings:e})}getVideoTrackData(e,r,n){let a=this.trackDatas.find(o=>o.track===e);if(a)return a;xr(n),p(n),p(n.decoderConfig),p(n.decoderConfig.codedWidth!==void 0),p(n.decoderConfig.codedHeight!==void 0);let s={track:e,type:"video",info:{width:n.decoderConfig.codedWidth,height:n.decoderConfig.codedHeight,decoderConfig:n.decoderConfig,alphaMode:!!r.sideData.alpha},chunkQueue:[],lastWrittenMsTimestamp:null};return e.source._codec==="vp9"?s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array(Mo(s.info.decoderConfig.codec))}:e.source._codec==="av1"&&(s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array(dn(s.info.decoderConfig.codec))}),this.trackDatas.push(s),this.trackDatas.sort((o,c)=>o.track.id-c.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}getAudioTrackData(e,r,n){let a=this.trackDatas.find(u=>u.track===e);if(a)return a;ve(n),p(n),p(n.decoderConfig);let s={...n.decoderConfig},o=!1;if(e.source._codec==="aac"&&!s.description){let u=Ee(ge.tempFromBytes(r.data));if(!u)throw new Error("Couldn't parse ADTS header from the AAC packet. Make sure the packets are in ADTS format (as specified in ISO 13818-7) when not providing a description, or provide a description (must be an AudioSpecificConfig as specified in ISO 14496-3) and ensure the packets are raw AAC data.");let d=Ue[u.samplingFrequencyIndex],l=et[u.channelConfiguration];if(d===void 0||l===void 0)throw new Error("Invalid ADTS frame header.");s.description=Sr({objectType:u.objectType,sampleRate:d,numberOfChannels:l}),o=!0}let c={track:e,type:"audio",info:{numberOfChannels:n.decoderConfig.numberOfChannels,sampleRate:n.decoderConfig.sampleRate,decoderConfig:s,requiresAdtsStripping:o},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(c),this.trackDatas.sort((u,d)=>u.track.id-d.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),c}getSubtitleTrackData(e,r){let n=this.trackDatas.find(s=>s.track===e);if(n)return n;ln(r),p(r),p(r.config);let a={track:e,type:"subtitle",info:{config:r.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(e,r,n){let a=await this.mutex.acquire();try{let s=this.getVideoTrackData(e,r,n),o=r.type==="key",c=this.validateAndNormalizeTimestamp(s.track,r.timestamp,o),u=r.duration;e.metadata.frameRate!==void 0&&(c=$t(c,1/e.metadata.frameRate),u=$t(u,1/e.metadata.frameRate));let d=s.info.alphaMode?r.sideData.alpha??null:null,l=this.createInternalChunk(r.data,c,u,r.type,d);e.source._codec==="vp9"&&this.fixVP9ColorSpace(s,l),s.chunkQueue.push(l),await this.interleaveChunks()}finally{a()}}async addEncodedAudioPacket(e,r,n){let a=await this.mutex.acquire();try{let s=this.getAudioTrackData(e,r,n),o=r.data;if(s.info.requiresAdtsStripping){let l=Ee(ge.tempFromBytes(o));if(!l)throw new Error("Expected ADTS frame, didn't get one.");let m=l.crcCheck===null?xt:Oe;o=o.subarray(m)}let c=r.type==="key",u=this.validateAndNormalizeTimestamp(s.track,r.timestamp,c),d=this.createInternalChunk(o,u,r.duration,r.type);s.chunkQueue.push(d),await this.interleaveChunks()}finally{a()}}async addSubtitleCue(e,r,n){let a=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(e,n),o=this.validateAndNormalizeTimestamp(s.track,r.timestamp,!0),c=r.text,u=Math.round(o*1e3);ri.lastIndex=0,c=c.replace(ri,f=>{let g=la(f.slice(1,-1))-u;return`<${ma(g)}>`});let d=G.encode(c),l=`${r.settings??""}
${r.identifier??""}
${r.notes??""}`,m=this.createInternalChunk(d,o,r.duration,"key",l.trim()?G.encode(l):null);s.chunkQueue.push(m),await this.interleaveChunks()}finally{a()}}async interleaveChunks(e=!1){if(!(!e&&!this.allTracksAreKnown())){e:for(;;){let r=null,n=1/0;for(let s of this.trackDatas){if(!e&&s.chunkQueue.length===0&&!s.track.source._closed)break e;s.chunkQueue.length>0&&s.chunkQueue[0].timestamp<n&&(r=s,n=s.chunkQueue[0].timestamp)}if(!r)break;let a=r.chunkQueue.shift();this.writeBlock(r,a)}e||await this.writer.flush()}}fixVP9ColorSpace(e,r){if(r.type!=="key"||!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;let n=new V(r.data);n.skipBits(2);let a=n.readBits(1),o=(n.readBits(1)<<1)+a;if(o===3&&n.skipBits(1),n.readBits(1)||n.readBits(1)!==0||(n.skipBits(2),n.readBits(24)!==4817730))return;o>=2&&n.skipBits(1);let l={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];fo(r.data,n.pos,n.pos+3,l)}createInternalChunk(e,r,n,a,s=null){return{data:e,type:a,timestamp:r,duration:n,additions:s}}writeBlock(e,r){this.segment||this.createSegment();let n=Math.round(1e3*r.timestamp),a=this.trackDatas.every(l=>{if(e===l)return r.type==="key";let m=l.chunkQueue[0];return m?m.type==="key":l.track.source._closed}),s=!1;if(!this.currentCluster)s=!0;else{p(this.currentClusterStartMsTimestamp!==null),p(this.currentClusterMaxMsTimestamp!==null);let l=n-this.currentClusterStartMsTimestamp;s=a&&n>this.currentClusterMaxMsTimestamp&&l>=1e3*(this.format._options.minimumClusterDuration??1)||l>fl}s&&this.createNewCluster(n);let o=n-this.currentClusterStartMsTimestamp;if(o<ml)return;let c=new Uint8Array(4),u=new DataView(c.buffer);u.setUint8(0,128|e.track.id),u.setInt16(1,o,!1);let d=Math.round(1e3*r.duration);if(r.additions){let l={id:160,data:[{id:161,data:[c,r.data]},r.type==="delta"?{id:251,data:new Ei(e.lastWrittenMsTimestamp-n)}:null,r.additions?{id:30113,data:[{id:166,data:[{id:238,data:1},{id:165,data:r.additions}]}]}:null,d>0?{id:155,data:d}:null]};this.ebmlWriter.writeEBML(l)}else{u.setUint8(3,+(r.type==="key")<<7);let l={id:163,data:[c,r.data]};this.ebmlWriter.writeEBML(l)}this.duration=Math.max(this.duration,n+d),e.lastWrittenMsTimestamp=n,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:n}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,n)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:524531317,size:this.format._options.appendOnly?-1:Yc,data:[{id:231,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if(p(this.currentCluster),!this.format._options.appendOnly){let a=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),s=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(a,Yc),this.writer.seek(s)}if(this.format._options.onCluster){p(this.currentClusterStartMsTimestamp!==null);let{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onCluster(a,s,this.currentClusterStartMsTimestamp/1e3)}let e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,r=new Map;for(let[a,{firstMsTimestamp:s}]of this.trackDatasInCurrentCluster)r.has(s)||r.set(s,[]),r.get(s).push(a);let n=[...r.entries()].sort((a,s)=>a[0]-s[0]);for(let[a,s]of n)p(this.cues),this.cues.data.push({id:187,data:[{id:179,data:a},...s.map(o=>({id:183,data:[{id:247,data:o.track.id},{id:241,data:e}]}))]})}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){let e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||this.createSegment(),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),p(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){let r=this.writer.getPos(),n=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(n,Xc),this.segmentDuration.data=new Dr(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),p(this.seekHead),this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.maybeCreateSeekHead(!0),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(r)}e()}};var ya=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer)}writeU32(t){this.helperView.setUint32(0,t,!1),this.writer.write(this.helper.subarray(0,4))}writeXingFrame(t){let e=this.writer.getPos(),r=255,n=224|t.mpegVersionId<<3|t.layer<<1,a;t.mpegVersionId&2?a=t.mpegVersionId&1?0:1:a=1;let s=0,o=155,c=-1,u=a*16*4+t.layer*16;for(let b=0;b<16;b++){let y=Un[u+b];if(zn(a,t.layer,1e3*y,t.sampleRate,s)>=o){c=b;break}}if(c===-1)throw new Error("No suitable bitrate found.");let d=c<<4|t.frequencyIndex<<2|s<<1,l=t.channel<<6|t.modeExtension<<4|t.copyright<<3|t.original<<2|t.emphasis;this.helper[0]=r,this.helper[1]=n,this.helper[2]=d,this.helper[3]=l,this.writer.write(this.helper.subarray(0,4));let m=zr(t.mpegVersionId,t.channel);this.writer.seek(e+m),this.writeU32(Vr);let f=0;t.frameCount!==null&&(f|=1),t.fileSize!==null&&(f|=2),t.toc!==null&&(f|=4),this.writeU32(f),this.writeU32(t.frameCount??0),this.writeU32(t.fileSize??0),this.writer.write(t.toc??new Uint8Array(100));let h=Un[u+c],g=zn(a,t.layer,1e3*h,t.sampleRate,s);this.writer.seek(e+g)}};var wa=class extends pe{constructor(e,r){super(e);this.xingFrameData=null;this.frameCount=0;this.framePositions=[];this.xingFramePos=null;this.format=r,this.writer=e._writer,this.mp3Writer=new ya(e._writer)}async start(){Yt(this.output._metadataTags)||new Wr(this.writer).writeId3V2Tag(this.output._metadataTags)}async getMimeType(){return"audio/mpeg"}async addEncodedVideoPacket(){throw new Error("MP3 does not support video.")}async addEncodedAudioPacket(e,r){let n=await this.mutex.acquire();try{let a=this.format._options.xingHeader!==!1;if(!this.xingFrameData&&a){let s=D(r.data);if(s.byteLength<4)throw new Error("Invalid MP3 header in sample.");let o=s.getUint32(0,!1),c=ir(o,null).header;if(!c)throw new Error("Invalid MP3 header in sample.");let u=zr(c.mpegVersionId,c.channel);if(s.byteLength>=u+4){let d=s.getUint32(u,!1);if(d===Vr||d===Vn)return}this.xingFrameData={mpegVersionId:c.mpegVersionId,layer:c.layer,frequencyIndex:c.frequencyIndex,sampleRate:c.sampleRate,channel:c.channel,modeExtension:c.modeExtension,copyright:c.copyright,original:c.original,emphasis:c.emphasis,frameCount:null,fileSize:null,toc:null},this.xingFramePos=this.writer.getPos(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.frameCount++}this.validateAndNormalizeTimestamp(e,r.timestamp,r.type==="key"),this.writer.write(r.data),this.frameCount++,await this.writer.flush(),a&&this.framePositions.push(this.writer.getPos())}finally{n()}}async addSubtitleCue(){throw new Error("MP3 does not support subtitles.")}async finalize(){if(!this.xingFrameData||this.xingFramePos===null)return;let e=await this.mutex.acquire(),r=this.writer.getPos();this.writer.seek(this.xingFramePos);let n=new Uint8Array(100);for(let a=0;a<100;a++){let s=Math.floor(this.framePositions.length*(a/100));p(s!==-1&&s<this.framePositions.length);let o=this.framePositions[s];n[a]=256*(o/r)}if(this.xingFrameData.frameCount=this.frameCount,this.xingFrameData.fileSize=r,this.xingFrameData.toc=n,this.format._options.onXingFrame&&this.writer.startTrackingWrites(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.format._options.onXingFrame){let{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onXingFrame(a,s)}this.writer.seek(r),e()}};var hl=8192,Ta=class extends pe{constructor(e,r){super(e);this.trackDatas=[];this.bosPagesWritten=!1;this.allTracksKnown=Q();this.pageBytes=new Uint8Array(Kn);this.pageView=new DataView(this.pageBytes.buffer);this.format=r,this.writer=e._writer,this.writer.ensureMonotonicity=!0}async start(){}async getMimeType(){return await this.allTracksKnown.promise,jn({codecStrings:this.trackDatas.map(e=>e.codecInfo.codec)})}addEncodedVideoPacket(){throw new Error("Video tracks are not supported.")}getTrackData(e,r){let n=this.trackDatas.find(o=>o.track===e);if(n)return n;let a;do a=Math.floor(2**32*Math.random());while(this.trackDatas.some(o=>o.serialNumber===a));p(e.source._codec==="vorbis"||e.source._codec==="opus"),ve(r),p(r),p(r.decoderConfig);let s={track:e,serialNumber:a,internalSampleRate:e.source._codec==="opus"?Le:r.decoderConfig.sampleRate,codecInfo:{codec:e.source._codec,vorbisInfo:null,opusInfo:null},vorbisLastBlocksize:null,packetQueue:[],currentTimestampInSamples:0,pagesWritten:0,currentGranulePosition:0,currentLacingValues:[],currentPageData:[],currentPageSize:27,currentPageStartsWithFreshPacket:!0,currentPageStartTimestampInSamples:0};return this.queueHeaderPackets(s,r),this.trackDatas.push(s),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}queueHeaderPackets(e,r){if(p(r.decoderConfig),e.track.source._codec==="vorbis"){p(r.decoderConfig.description);let n=W(r.decoderConfig.description);if(n[0]!==2)throw new TypeError("First byte of Vorbis decoder description must be 2.");let a=1,s=()=>{let b=0;for(;;){let y=n[a++];if(y===void 0)throw new TypeError("Vorbis decoder description is too short.");if(b+=y,y<255)return b}},o=s(),c=s();if(n.length-a<=0)throw new TypeError("Vorbis decoder description is too short.");let d=n.subarray(a,a+=o);a+=c;let l=n.subarray(a),m=new Uint8Array(7);m[0]=3,m[1]=118,m[2]=111,m[3]=114,m[4]=98,m[5]=105,m[6]=115;let f=ki(m,this.output._metadataTags,!0);e.packetQueue.push({data:d,timestampInSamples:0,durationInSamples:0,forcePageFlush:!0},{data:f,timestampInSamples:0,durationInSamples:0,forcePageFlush:!1},{data:l,timestampInSamples:0,durationInSamples:0,forcePageFlush:!0});let g=D(d).getUint8(28);e.codecInfo.vorbisInfo={blocksizes:[1<<(g&15),1<<(g>>4)],modeBlockflags:Tn(l).modeBlockflags}}else if(e.track.source._codec==="opus"){if(!r.decoderConfig.description)throw new TypeError("For Ogg, Opus decoder description is required.");let n=W(r.decoderConfig.description),a=new Uint8Array(8),s=D(a);s.setUint32(0,1332770163,!1),s.setUint32(4,1415669619,!1);let o=ki(a,this.output._metadataTags,!0);e.packetQueue.push({data:n,timestampInSamples:0,durationInSamples:0,forcePageFlush:!0},{data:o,timestampInSamples:0,durationInSamples:0,forcePageFlush:!0}),e.codecInfo.opusInfo={preSkip:Mt(n).preSkip}}}async addEncodedAudioPacket(e,r,n){let a=await this.mutex.acquire();try{let s=this.getTrackData(e,n);this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key");let o=s.currentTimestampInSamples,{durationInSamples:c,vorbisBlockSize:u}=qn(r.data,s.codecInfo,s.vorbisLastBlocksize);s.currentTimestampInSamples+=c,s.vorbisLastBlocksize=u,s.packetQueue.push({data:r.data,timestampInSamples:o,durationInSamples:c,forcePageFlush:!1}),await this.interleavePages()}finally{a()}}addSubtitleCue(){throw new Error("Subtitle tracks are not supported.")}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(r=>r.track===e))return!1;return!0}async interleavePages(e=!1){if(!this.bosPagesWritten){if(!this.allTracksAreKnown()&&!e)return;for(let r of this.trackDatas)for(;r.packetQueue.length>0;){let n=r.packetQueue.shift();if(this.writePacket(r,n,!1),n.forcePageFlush)break}this.bosPagesWritten=!0}e:for(;;){let r=null,n=1/0;for(let o of this.trackDatas){if(!e&&o.packetQueue.length<=1&&!o.track.source._closed)break e;o.packetQueue.length>0&&o.packetQueue[0].timestampInSamples<n&&(r=o,n=o.packetQueue[0].timestampInSamples)}if(!r)break;let a=r.packetQueue.shift(),s=r.packetQueue.length===0;this.writePacket(r,a,s)}e||await this.writer.flush()}writePacket(e,r,n){let a=r.timestampInSamples+r.durationInSamples;if(this.format._options.maximumPageDuration!==void 0){let d=this.format._options.maximumPageDuration*e.internalSampleRate;e.currentLacingValues.length>0&&a-e.currentPageStartTimestampInSamples>d&&this.writePage(e,!1)}let s=r.data.length,o=0,c=0;for(;;){e.currentLacingValues.length===0&&o>0&&(e.currentPageStartsWithFreshPacket=!1);let d=Math.min(255,s);e.currentLacingValues.push(d),e.currentPageSize++,c+=d;let l=s<255;if(e.currentLacingValues.length===255){let m=r.data.subarray(o,c);if(o=c,e.currentPageData.push(m),e.currentPageSize+=m.length,this.writePage(e,n&&l),l)return}if(l)break;s-=255}let u=r.data.subarray(o);e.currentPageData.push(u),e.currentPageSize+=u.length,e.currentGranulePosition=a,(e.currentPageSize>=hl||r.forcePageFlush)&&this.writePage(e,n)}writePage(e,r){this.pageView.setUint32(0,Ri,!0),this.pageView.setUint8(4,0);let n=0;e.currentPageStartsWithFreshPacket||(n|=1),e.pagesWritten===0&&(n|=2),r&&(n|=4),this.pageView.setUint8(5,n);let a=e.currentLacingValues.every(u=>u===255)?-1:e.currentGranulePosition;ko(this.pageView,6,a,!0),this.pageView.setUint32(14,e.serialNumber,!0),this.pageView.setUint32(18,e.pagesWritten,!0),this.pageView.setUint32(22,0,!0),this.pageView.setUint8(26,e.currentLacingValues.length),this.pageBytes.set(e.currentLacingValues,27);let s=27+e.currentLacingValues.length;for(let u of e.currentPageData)this.pageBytes.set(u,s),s+=u.length;let o=this.pageBytes.subarray(0,s),c=Hn(o);if(this.pageView.setUint32(22,c,!0),e.pagesWritten++,e.currentLacingValues.length=0,e.currentPageData.length=0,e.currentPageSize=27,e.currentPageStartsWithFreshPacket=!0,e.currentPageStartTimestampInSamples=e.currentGranulePosition,this.format._options.onPage&&this.writer.startTrackingWrites(),this.writer.write(o),this.format._options.onPage){let{data:u,start:d}=this.writer.stopTrackingWrites();this.format._options.onPage(u,d,e.track.source)}}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleavePages(),e()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve(),await this.interleavePages(!0);for(let r of this.trackDatas)r.currentLacingValues.length>0&&this.writePage(r,!0);e()}};var gl=0,tu=4096,Zc=256,bl=224,kl=192,Jc=new Uint8Array([9,240]),eu=new Uint8Array([70,1]),Sa=class extends pe{constructor(e,r){super(e);this.trackDatas=[];this.tablesWritten=!1;this.continuityCounters=new Map;this.packetBuffer=new Uint8Array(188);this.packetView=D(this.packetBuffer);this.allTracksKnown=Q();this.videoTrackIndex=0;this.audioTrackIndex=0;this.pesHeaderBuffer=new Uint8Array(14);this.pesHeaderView=D(this.pesHeaderBuffer);this.ptsBitstream=new V(this.pesHeaderBuffer.subarray(9,14));this.adaptationFieldBuffer=new Uint8Array(184);this.payloadBuffer=new Uint8Array(184);this.format=r,this.writer=e._writer,this.writer.ensureMonotonicity=!0}async start(){}async getMimeType(){return await this.allTracksKnown.promise,ea(this.trackDatas.map(e=>e.codecString))}getVideoTrackData(e,r){let n=this.trackDatas.find(d=>d.track===e);if(n)return n;xr(r),p(r?.decoderConfig);let a=e.source._codec;p(a==="avc"||a==="hevc");let s=a==="avc"?27:36,o=Zc+this.trackDatas.length,c=bl+this.videoTrackIndex++,u={track:e,pid:o,streamType:s,streamId:c,codecString:r.decoderConfig.codec,packetQueue:[],inputIsAnnexB:null,inputIsAdts:null,avcDecoderConfig:null,hevcDecoderConfig:null,adtsHeader:null,adtsHeaderBitstream:null,firstPacketWritten:!1};return this.trackDatas.push(u),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),u}getAudioTrackData(e,r){let n=this.trackDatas.find(d=>d.track===e);if(n)return n;ve(r),p(r?.decoderConfig);let a=e.source._codec;p(a==="aac"||a==="mp3");let s=a==="aac"?15:3,o=Zc+this.trackDatas.length,c=kl+this.audioTrackIndex++,u={track:e,pid:o,streamType:s,streamId:c,codecString:r.decoderConfig.codec,packetQueue:[],inputIsAnnexB:null,inputIsAdts:null,avcDecoderConfig:null,hevcDecoderConfig:null,adtsHeader:null,adtsHeaderBitstream:null,firstPacketWritten:!1};return this.trackDatas.push(u),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),u}async addEncodedVideoPacket(e,r,n){let a=await this.mutex.acquire();try{let s=this.getVideoTrackData(e,n),o=this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key"),c=this.prepareVideoPacket(s,r,n);s.packetQueue.push({data:c,timestamp:o,isKeyframe:r.type==="key"}),await this.interleavePackets()}finally{a()}}async addEncodedAudioPacket(e,r,n){let a=await this.mutex.acquire();try{let s=this.getAudioTrackData(e,n),o=this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key"),c=this.prepareAudioPacket(s,r,n);s.packetQueue.push({data:c,timestamp:o,isKeyframe:r.type==="key"}),await this.interleavePackets()}finally{a()}}async addSubtitleCue(){throw new Error("MPEG-TS does not support subtitles.")}prepareVideoPacket(e,r,n){let a=e.track.source._codec;if(e.inputIsAnnexB===null){let s=n?.decoderConfig?.description;if(e.inputIsAnnexB=!s,!e.inputIsAnnexB){let o=W(s);a==="avc"?e.avcDecoderConfig=kn(o):e.hevcDecoderConfig=Wo(o)}}return e.inputIsAnnexB?this.prepareAnnexBVideoPacket(r.data,a):this.prepareLengthPrefixedVideoPacket(e,r,a)}prepareAnnexBVideoPacket(e,r){let n=[];for(let s of Ft(e)){let o=e.subarray(s.offset,s.offset+s.length);(r==="avc"?gt(o[0])===9:tt(o[0])===35)||n.push(o)}let a=r==="avc"?Jc:eu;return n.unshift(a),bn(n)}prepareLengthPrefixedVideoPacket(e,r,n){let a=r.data,s=n==="avc"?e.avcDecoderConfig.lengthSizeMinusOne+1:e.hevcDecoderConfig.lengthSizeMinusOne+1,o=[];for(let u of hn(a,s)){let d=a.subarray(u.offset,u.offset+u.length);(n==="avc"?gt(d[0])===9:tt(d[0])===35)||o.push(d)}if(r.type==="key")if(n==="avc"){let u=e.avcDecoderConfig;for(let d of u.pictureParameterSets)o.unshift(d);for(let d of u.sequenceParameterSets)o.unshift(d)}else{let u=e.hevcDecoderConfig;for(let d of u.arrays)if(d.nalUnitType===34)for(let l of d.nalUnits)o.unshift(l);for(let d of u.arrays)if(d.nalUnitType===33)for(let l of d.nalUnits)o.unshift(l);for(let d of u.arrays)if(d.nalUnitType===32)for(let l of d.nalUnits)o.unshift(l)}let c=n==="avc"?Jc:eu;return o.unshift(c),bn(o)}prepareAudioPacket(e,r,n){if(e.track.source._codec==="mp3")return r.data;if(e.inputIsAdts===null){let u=n?.decoderConfig?.description;if(e.inputIsAdts=!u,!e.inputIsAdts){let d=ht(W(u)),l=mn(d);e.adtsHeader=l.header,e.adtsHeaderBitstream=l.bitstream}}if(e.inputIsAdts)return r.data;p(e.adtsHeader),p(e.adtsHeaderBitstream);let s=e.adtsHeader,o=r.data.byteLength+s.byteLength;fn(e.adtsHeaderBitstream,o);let c=new Uint8Array(o);return c.set(s,0),c.set(r.data,s.byteLength),c}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(r=>r.track===e))return!1;return!0}async interleavePackets(e=!1){if(!this.tablesWritten){if(!this.allTracksAreKnown()&&!e)return;this.writeTables()}e:for(;;){let r=null,n=1/0;for(let s of this.trackDatas){if(!e&&s.packetQueue.length===0&&!s.track.source._closed)break e;s.packetQueue.length>0&&s.packetQueue[0].timestamp<n&&(r=s,n=s.packetQueue[0].timestamp)}if(!r)break;let a=r.packetQueue.shift();this.writePesPacket(r,a)}e||await this.writer.flush()}writeTables(){p(!this.tablesWritten),this.writePsiSection(gl,dr),this.writePsiSection(tu,wl(this.trackDatas)),this.tablesWritten=!0}writePsiSection(e,r){let n=0,a=!0;for(;n<r.length;){let o=184-(a?1:0),c=r.length-n,u=Math.min(o,c),d;a?(d=this.payloadBuffer.subarray(0,1+u),d[0]=0,d.set(r.subarray(n,n+u),1)):d=r.subarray(n,n+u),this.writeTsPacket(e,a,null,d),n+=u,a=!1}}writePesPacket(e,r){let n=this.pesHeaderView;Qt(n,0,1,!1),this.pesHeaderBuffer[3]=e.streamId;let a=e.track.type==="video"?0:Math.min(8+r.data.length,65535);n.setUint16(4,a,!1),n.setUint8(6,132),n.setUint8(7,128),n.setUint8(8,5);let s=Math.round(r.timestamp*9e4);this.ptsBitstream.pos=0,this.ptsBitstream.writeBits(4,2),this.ptsBitstream.writeBits(3,s>>>30&7),this.ptsBitstream.writeBits(1,1),this.ptsBitstream.writeBits(15,s>>>15&32767),this.ptsBitstream.writeBits(1,1),this.ptsBitstream.writeBits(15,s&32767),this.ptsBitstream.writeBits(1,1);let o=this.pesHeaderBuffer.length+r.data.length,c=0,u=!0;for(;c<o;){let d=u,l=o-c,m=u&&r.isKeyframe,f=u&&!e.firstPacketWritten,h=Math.max(0,184-l),g;m||f?g=Math.max(2,h):g=h;let b=null;if(g>0){let x=this.adaptationFieldBuffer;g===1?x[0]=0:(x[0]=g-1,x[1]=Number(f)<<7|Number(m)<<6,x.fill(255,2,g)),b=x.subarray(0,g)}let y=Math.min(184-g,l),k=this.payloadBuffer.subarray(0,y),w=0;if(c<this.pesHeaderBuffer.length){let x=Math.min(this.pesHeaderBuffer.length-c,y);k.set(this.pesHeaderBuffer.subarray(c,c+x),0),w=x}let S=Math.max(0,c-this.pesHeaderBuffer.length),T=S+(y-w);w<y&&k.set(r.data.subarray(S,T),w),this.writeTsPacket(e.pid,d,b,k),c+=y,u=!1}e.firstPacketWritten=!0}writeTsPacket(e,r,n,a){let s=this.continuityCounters.get(e)??0,o=a.length>0,c=n?o?3:2:o?1:0;this.packetBuffer[0]=71,this.packetView.setUint16(1,(r?16384:0)|e&8191,!1),this.packetBuffer[3]=c<<4|s&15,o&&this.continuityCounters.set(e,s+1&15);let u=4;n&&(this.packetBuffer.set(n,u),u+=n.length),this.packetBuffer.set(a,u),u+=a.length,u<188&&this.packetBuffer.fill(255,u);let d=this.writer.getPos();this.writer.write(this.packetBuffer),this.format._options.onPacket&&this.format._options.onPacket(this.packetBuffer.slice(),d)}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleavePackets(),e()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve(),await this.interleavePackets(!0),e()}},yl=79764919,ru=new Uint32Array(256);for(let i=0;i<256;i++){let t=i<<24;for(let e=0;e<8;e++)t=t&2147483648?t<<1^yl:t<<1;ru[i]=t>>>0&4294967295}var iu=i=>{let t=4294967295;for(let e=0;e<i.length;e++){let r=i[e];t=(t<<8^ru[t>>>24^r])>>>0}return t},dr=new Uint8Array(16);{let i=D(dr);dr[0]=0,i.setUint16(1,45069,!1),i.setUint16(3,1,!1),dr[5]=193,dr[6]=0,dr[7]=0,i.setUint16(8,1,!1),i.setUint16(10,57344|tu&8191,!1),i.setUint32(12,iu(dr.subarray(0,12)),!1)}var wl=i=>{let t=9+i.length*5+4,e=new Uint8Array(3+t-4),r=D(e);e[0]=2,r.setUint16(1,45056|t&4095,!1),r.setUint16(3,1,!1),e[5]=193,e[6]=0,e[7]=0,r.setUint16(8,65535,!1),r.setUint16(10,61440,!1);let n=12;for(let o of i)e[n++]=o.streamType,r.setUint16(n,57344|o.pid&8191,!1),n+=2,r.setUint16(n,61440,!1),n+=2;let a=iu(e),s=new Uint8Array(e.length+4);return s.set(e,0),D(s).setUint32(e.length,a,!1),s};var xa=class{constructor(t){this.writer=t;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer)}writeU16(t){this.helperView.setUint16(0,t,!0),this.writer.write(this.helper.subarray(0,2))}writeU32(t){this.helperView.setUint32(0,t,!0),this.writer.write(this.helper.subarray(0,4))}writeU64(t){this.helperView.setUint32(0,t,!0),this.helperView.setUint32(4,Math.floor(t/2**32),!0),this.writer.write(this.helper)}writeAscii(t){this.writer.write(new TextEncoder().encode(t))}};var Ca=class extends pe{constructor(e,r){super(e);this.headerWritten=!1;this.dataSize=0;this.sampleRate=null;this.sampleCount=0;this.riffSizePos=null;this.dataSizePos=null;this.ds64RiffSizePos=null;this.ds64DataSizePos=null;this.ds64SampleCountPos=null;this.format=r,this.writer=e._writer,this.riffWriter=new xa(e._writer),this.isRf64=!!r._options.large}async start(){}async getMimeType(){return"audio/wav"}async addEncodedVideoPacket(){throw new Error("WAVE does not support video.")}async addEncodedAudioPacket(e,r,n){let a=await this.mutex.acquire();try{if(this.headerWritten||(ve(n),p(n),p(n.decoderConfig),this.writeHeader(e,n.decoderConfig),this.sampleRate=n.decoderConfig.sampleRate,this.headerWritten=!0),this.validateAndNormalizeTimestamp(e,r.timestamp,r.type==="key"),!this.isRf64&&this.writer.getPos()+r.data.byteLength>=2**32)throw new Error("Adding more audio data would exceed the maximum RIFF size of 4 GiB. To write larger files, use RF64 by setting `large: true` in the WavOutputFormatOptions.");this.writer.write(r.data),this.dataSize+=r.data.byteLength,this.sampleCount+=Math.round(r.duration*this.sampleRate),await this.writer.flush()}finally{a()}}async addSubtitleCue(){throw new Error("WAVE does not support subtitles.")}writeHeader(e,r){this.format._options.onHeader&&this.writer.startTrackingWrites();let n,a=e.source._codec,s=ke(a);s.dataType==="ulaw"?n=7:s.dataType==="alaw"?n=6:s.dataType==="float"?n=3:n=1;let o=r.numberOfChannels,c=r.sampleRate,u=s.sampleSize*o;if(this.riffWriter.writeAscii(this.isRf64?"RF64":"RIFF"),this.isRf64?this.riffWriter.writeU32(4294967295):(this.riffSizePos=this.writer.getPos(),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("WAVE"),this.isRf64&&(this.riffWriter.writeAscii("ds64"),this.riffWriter.writeU32(28),this.ds64RiffSizePos=this.writer.getPos(),this.riffWriter.writeU64(0),this.ds64DataSizePos=this.writer.getPos(),this.riffWriter.writeU64(0),this.ds64SampleCountPos=this.writer.getPos(),this.riffWriter.writeU64(0),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("fmt "),this.riffWriter.writeU32(16),this.riffWriter.writeU16(n),this.riffWriter.writeU16(o),this.riffWriter.writeU32(c),this.riffWriter.writeU32(c*u),this.riffWriter.writeU16(u),this.riffWriter.writeU16(8*s.sampleSize),!Yt(this.output._metadataTags)){let d=this.format._options.metadataFormat??"info";d==="info"?this.writeInfoChunk(this.output._metadataTags):d==="id3"?this.writeId3Chunk(this.output._metadataTags):J(d)}if(this.riffWriter.writeAscii("data"),this.isRf64?this.riffWriter.writeU32(4294967295):(this.dataSizePos=this.writer.getPos(),this.riffWriter.writeU32(0)),this.format._options.onHeader){let{data:d,start:l}=this.writer.stopTrackingWrites();this.format._options.onHeader(d,l)}}writeInfoChunk(e){let r=this.writer.getPos();this.riffWriter.writeAscii("LIST"),this.riffWriter.writeU32(0),this.riffWriter.writeAscii("INFO");let n=new Set,a=(c,u)=>{if(!At(u)){console.warn(`Didn't write tag '${c}' because '${u}' is not ISO 8859-1-compatible.`);return}let d=u.length+1,l=new Uint8Array(d);for(let m=0;m<u.length;m++)l[m]=u.charCodeAt(m);this.riffWriter.writeAscii(c),this.riffWriter.writeU32(d),this.writer.write(l),d&1&&this.writer.write(new Uint8Array(1)),n.add(c)};for(let{key:c,value:u}of Ne(e))switch(c){case"title":a("INAM",u),n.add("INAM");break;case"artist":a("IART",u),n.add("IART");break;case"album":a("IPRD",u),n.add("IPRD");break;case"trackNumber":{let d=e.tracksTotal!==void 0?`${u}/${e.tracksTotal}`:u.toString();a("ITRK",d),n.add("ITRK")}break;case"genre":a("IGNR",u),n.add("IGNR");break;case"date":a("ICRD",u.toISOString().slice(0,10)),n.add("ICRD");break;case"comment":a("ICMT",u),n.add("ICMT");break;case"albumArtist":case"discNumber":case"tracksTotal":case"discsTotal":case"description":case"lyrics":case"images":break;case"raw":break;default:J(c)}if(e.raw)for(let c in e.raw){let u=e.raw[c];u==null||c.length!==4||n.has(c)||typeof u=="string"&&a(c,u)}let s=this.writer.getPos(),o=s-r-8;this.writer.seek(r+4),this.riffWriter.writeU32(o),this.writer.seek(s),o&1&&this.writer.write(new Uint8Array(1))}writeId3Chunk(e){let r=this.writer.getPos();this.riffWriter.writeAscii("ID3 "),this.riffWriter.writeU32(0);let a=new Wr(this.writer).writeId3V2Tag(e),s=this.writer.getPos();this.writer.seek(r+4),this.riffWriter.writeU32(a),this.writer.seek(s),a&1&&this.writer.write(new Uint8Array(1))}async finalize(){let e=await this.mutex.acquire(),r=this.writer.getPos();this.isRf64?(p(this.ds64RiffSizePos!==null),this.writer.seek(this.ds64RiffSizePos),this.riffWriter.writeU64(r-8),p(this.ds64DataSizePos!==null),this.writer.seek(this.ds64DataSizePos),this.riffWriter.writeU64(this.dataSize),p(this.ds64SampleCountPos!==null),this.writer.seek(this.ds64SampleCountPos),this.riffWriter.writeU64(this.sampleCount)):(p(this.riffSizePos!==null),this.writer.seek(this.riffSizePos),this.riffWriter.writeU32(r-8),p(this.dataSizePos!==null),this.writer.seek(this.dataSizePos),this.riffWriter.writeU32(this.dataSize)),this.writer.seek(r),e()}};var Me=class{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(t=>se.includes(t))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(t=>ue.includes(t))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(t=>Pe.includes(t))}_codecUnsupportedHint(t){return""}},oi=class extends Me{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.fastStart!==void 0&&![!1,"in-memory","reserve","fragmented"].includes(t.fastStart))throw new TypeError("options.fastStart, when provided, must be false, 'in-memory', 'reserve', or 'fragmented'.");if(t.minimumFragmentDuration!==void 0&&(!Number.isFinite(t.minimumFragmentDuration)||t.minimumFragmentDuration<0))throw new TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(t.onFtyp!==void 0&&typeof t.onFtyp!="function")throw new TypeError("options.onFtyp, when provided, must be a function.");if(t.onMoov!==void 0&&typeof t.onMoov!="function")throw new TypeError("options.onMoov, when provided, must be a function.");if(t.onMdat!==void 0&&typeof t.onMdat!="function")throw new TypeError("options.onMdat, when provided, must be a function.");if(t.onMoof!==void 0&&typeof t.onMoof!="function")throw new TypeError("options.onMoof, when provided, must be a function.");if(t.metadataFormat!==void 0&&!["mdir","mdta","udta","auto"].includes(t.metadataFormat))throw new TypeError("options.metadataFormat, when provided, must be either 'auto', 'mdir', 'mdta', or 'udta'.");super(),this._options=t}getSupportedTrackCounts(){return{video:{min:0,max:4294967295},audio:{min:0,max:4294967295},subtitle:{min:0,max:4294967295},total:{min:1,max:4294967295}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(t){return new ba(t,this)}},lr=class extends oi{constructor(t){super(t)}get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...se,...Je,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...Pe]}_codecUnsupportedHint(t){return new cr().getSupportedCodecs().includes(t)?" Switching to MOV will grant support for this codec.":""}},cr=class extends oi{constructor(t){super(t)}get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...se,...ue]}_codecUnsupportedHint(t){return new lr().getSupportedCodecs().includes(t)?" Switching to MP4 will grant support for this codec.":""}},ci=class extends Me{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.appendOnly!==void 0&&typeof t.appendOnly!="boolean")throw new TypeError("options.appendOnly, when provided, must be a boolean.");if(t.minimumClusterDuration!==void 0&&(!Number.isFinite(t.minimumClusterDuration)||t.minimumClusterDuration<0))throw new TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(t.onEbmlHeader!==void 0&&typeof t.onEbmlHeader!="function")throw new TypeError("options.onEbmlHeader, when provided, must be a function.");if(t.onSegmentHeader!==void 0&&typeof t.onSegmentHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");if(t.onCluster!==void 0&&typeof t.onCluster!="function")throw new TypeError("options.onCluster, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new ka(t,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:127},audio:{min:0,max:127},subtitle:{min:0,max:127},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...se,...Je,...Y.filter(t=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(t)),...Pe]}get supportsVideoRotationMetadata(){return!1}},ur=class extends ci{constructor(t){super(t)}getSupportedCodecs(){return[...se.filter(t=>["vp8","vp9","av1"].includes(t)),...ue.filter(t=>["opus","vorbis"].includes(t)),...Pe]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(t){return new ci().getSupportedCodecs().includes(t)?" Switching to MKV will grant support for this codec.":""}},Pa=class extends Me{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.xingHeader!==void 0&&typeof t.xingHeader!="boolean")throw new TypeError("options.xingHeader, when provided, must be a boolean.");if(t.onXingFrame!==void 0&&typeof t.onXingFrame!="function")throw new TypeError("options.onXingFrame, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new wa(t,this)}get _name(){return"MP3"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".mp3"}get mimeType(){return"audio/mpeg"}getSupportedCodecs(){return["mp3"]}get supportsVideoRotationMetadata(){return!1}},va=class extends Me{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.large!==void 0&&typeof t.large!="boolean")throw new TypeError("options.large, when provided, must be a boolean.");if(t.metadataFormat!==void 0&&!["info","id3"].includes(t.metadataFormat))throw new TypeError("options.metadataFormat, when provided, must be either 'info' or 'id3'.");if(t.onHeader!==void 0&&typeof t.onHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new Ca(t,this)}get _name(){return"WAVE"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".wav"}get mimeType(){return"audio/wav"}getSupportedCodecs(){return[...Y.filter(t=>["pcm-s16","pcm-s24","pcm-s32","pcm-f32","pcm-u8","ulaw","alaw"].includes(t))]}get supportsVideoRotationMetadata(){return!1}},Ia=class extends Me{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maximumPageDuration!==void 0&&(!Number.isFinite(t.maximumPageDuration)||t.maximumPageDuration<=0))throw new TypeError("options.maximumPageDuration, when provided, must be a positive number.");if(t.onPage!==void 0&&typeof t.onPage!="function")throw new TypeError("options.onPage, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new Ta(t,this)}get _name(){return"Ogg"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:0,max:4294967296},subtitle:{min:0,max:0},total:{min:1,max:4294967296}}}get fileExtension(){return".ogg"}get mimeType(){return"application/ogg"}getSupportedCodecs(){return[...ue.filter(t=>["vorbis","opus"].includes(t))]}get supportsVideoRotationMetadata(){return!1}},Aa=class extends Me{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.onFrame!==void 0&&typeof t.onFrame!="function")throw new TypeError("options.onFrame, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new pn(t,this)}get _name(){return"ADTS"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".aac"}get mimeType(){return"audio/aac"}getSupportedCodecs(){return["aac"]}get supportsVideoRotationMetadata(){return!1}},Ea=class extends Me{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");super(),this._options=t}_createMuxer(t){return new ua(t,this)}get _name(){return"FLAC"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".flac"}get mimeType(){return"audio/flac"}getSupportedCodecs(){return["flac"]}get supportsVideoRotationMetadata(){return!1}},_a=class extends Me{constructor(t={}){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.onPacket!==void 0&&typeof t.onPacket!="function")throw new TypeError("options.onPacket, when provided, must be a function.");super(),this._options=t}_createMuxer(t){return new Sa(t,this)}get _name(){return"MPEG-TS"}getSupportedTrackCounts(){return{video:{min:0,max:16},audio:{min:0,max:32},subtitle:{min:0,max:0},total:{min:1,max:48}}}get fileExtension(){return".ts"}get mimeType(){return"video/MP2T"}getSupportedCodecs(){return[...se.filter(t=>["avc","hevc"].includes(t)),...ue.filter(t=>["aac","mp3"].includes(t))]}get supportsVideoRotationMetadata(){return!1}};var Ra=i=>{if(!i||typeof i!="object")throw new TypeError("Encoding config must be an object.");if(!se.includes(i.codec))throw new TypeError(`Invalid video codec '${i.codec}'. Must be one of: ${se.join(", ")}.`);if(!(i.bitrate instanceof be)&&(!Number.isInteger(i.bitrate)||i.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(i.keyFrameInterval!==void 0&&(!Number.isFinite(i.keyFrameInterval)||i.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(i.sizeChangeBehavior!==void 0&&!["deny","passThrough","fill","contain","cover"].includes(i.sizeChangeBehavior))throw new TypeError("config.sizeChangeBehavior, when provided, must be 'deny', 'passThrough', 'fill', 'contain' or 'cover'.");if(i.onEncodedPacket!==void 0&&typeof i.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(i.onEncoderConfig!==void 0&&typeof i.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");nu(i.codec,i)},nu=(i,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.alpha!==void 0&&!["discard","keep"].includes(t.alpha))throw new TypeError("options.alpha, when provided, must be 'discard' or 'keep'.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.latencyMode!==void 0&&!["quality","realtime"].includes(t.latencyMode))throw new TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&Ja(t.fullCodecString)!==i)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${i}).`);if(t.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(t.hardwareAcceleration))throw new TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(t.scalabilityMode!==void 0&&typeof t.scalabilityMode!="string")throw new TypeError("scalabilityMode, when provided, must be a string.");if(t.contentHint!==void 0&&typeof t.contentHint!="string")throw new TypeError("contentHint, when provided, must be a string.")},Fa=i=>{let t=i.bitrate instanceof be?i.bitrate._toVideoBitrate(i.codec,i.width,i.height):i.bitrate;return{codec:i.fullCodecString??Fo(i.codec,i.width,i.height,t),width:i.width,height:i.height,bitrate:t,bitrateMode:i.bitrateMode,alpha:i.alpha??"discard",framerate:i.framerate,latencyMode:i.latencyMode,hardwareAcceleration:i.hardwareAcceleration,scalabilityMode:i.scalabilityMode,contentHint:i.contentHint,...Bo(i.codec)}},Da=i=>{if(!i||typeof i!="object")throw new TypeError("Encoding config must be an object.");if(!ue.includes(i.codec))throw new TypeError(`Invalid audio codec '${i.codec}'. Must be one of: ${ue.join(", ")}.`);if(i.bitrate===void 0&&(!Y.includes(i.codec)||i.codec==="flac"))throw new TypeError("config.bitrate must be provided for compressed audio codecs.");if(i.bitrate!==void 0&&!(i.bitrate instanceof be)&&(!Number.isInteger(i.bitrate)||i.bitrate<=0))throw new TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(i.onEncodedPacket!==void 0&&typeof i.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(i.onEncoderConfig!==void 0&&typeof i.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");au(i.codec,i)},au=(i,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&Ja(t.fullCodecString)!==i)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${i}).`)},Ma=i=>{let t=i.bitrate instanceof be?i.bitrate._toAudioBitrate(i.codec):i.bitrate;return{codec:i.fullCodecString??Ro(i.codec,i.numberOfChannels,i.sampleRate),numberOfChannels:i.numberOfChannels,sampleRate:i.sampleRate,bitrate:t,bitrateMode:i.bitrateMode,...Oo(i.codec)}},be=class{constructor(t){this._factor=t}_toVideoBitrate(t,e,r){let n=e*r,a={avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2},s=1920*1080,o=3e6,c=Math.pow(n/s,.95),l=o*c*a[t]*this._factor;return Math.ceil(l/1e3)*1e3}_toAudioBitrate(t){if(Y.includes(t)||t==="flac")return;let r={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[t];if(!r)throw new Error(`Unhandled codec: ${t}`);let n=r*this._factor;return t==="aac"?n=[96e3,128e3,16e4,192e3].reduce((s,o)=>Math.abs(o-n)<Math.abs(s-n)?o:s):t==="opus"||t==="vorbis"?n=Math.max(6e3,n):t==="mp3"&&(n=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((s,o)=>Math.abs(o-n)<Math.abs(s-n)?o:s)),Math.round(n/1e3)*1e3}},su=new be(.3),ou=new be(.6),cu=new be(1),Yi=new be(2),uu=new be(4),du=i=>{if(se.includes(i))return Zi(i);if(ue.includes(i))return Ji(i);if(Pe.includes(i))return en(i);throw new TypeError(`Unknown codec '${i}'.`)},Zi=async(i,t={})=>{let{width:e=1280,height:r=720,bitrate:n=1e6,...a}=t;if(!se.includes(i))return!1;if(!Number.isInteger(e)||e<=0)throw new TypeError("width must be a positive integer.");if(!Number.isInteger(r)||r<=0)throw new TypeError("height must be a positive integer.");if(!(n instanceof be)&&(!Number.isInteger(n)||n<=0))throw new TypeError("bitrate must be a positive integer or a quality.");nu(i,a);let s=null;return Zt.length>0&&(s??=Fa({codec:i,width:e,height:r,bitrate:n,framerate:void 0,...a}),Zt.some(u=>u.supports(i,s)))?!0:typeof VideoEncoder>"u"||(e%2===1||r%2===1)&&(i==="avc"||i==="hevc")||(s??=Fa({codec:i,width:e,height:r,bitrate:n,framerate:void 0,...a,alpha:"discard"}),!(await VideoEncoder.isConfigSupported(s)).supported)?!1:Ze()?new Promise(async u=>{try{let d=new VideoEncoder({output:()=>{},error:()=>u(!1)});d.configure(s);let l=new Uint8Array(e*r*4),m=new VideoFrame(l,{format:"RGBA",codedWidth:e,codedHeight:r,timestamp:0});d.encode(m),m.close(),await d.flush(),u(!0)}catch{u(!1)}}):!0},Ji=async(i,t={})=>{let{numberOfChannels:e=2,sampleRate:r=48e3,bitrate:n=128e3,...a}=t;if(!ue.includes(i))return!1;if(!Number.isInteger(e)||e<=0)throw new TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(r)||r<=0)throw new TypeError("sampleRate must be a positive integer.");if(!(n instanceof be)&&(!Number.isInteger(n)||n<=0))throw new TypeError("bitrate must be a positive integer.");au(i,a);let s=null;return Jt.length>0&&(s??=Ma({codec:i,numberOfChannels:e,sampleRate:r,bitrate:n,...a}),Jt.some(c=>c.supports(i,s)))||Y.includes(i)?!0:typeof AudioEncoder>"u"?!1:(s??=Ma({codec:i,numberOfChannels:e,sampleRate:r,bitrate:n,...a}),(await AudioEncoder.isConfigSupported(s)).supported===!0)},en=async i=>!!Pe.includes(i),lu=async()=>{let[i,t,e]=await Promise.all([Ys(),ui(),Zs()]);return[...i,...t,...e]},Ys=async(i=se,t)=>{let e=await Promise.all(i.map(r=>Zi(r,t)));return i.filter((r,n)=>e[n])},ui=async(i=ue,t)=>{let e=await Promise.all(i.map(r=>Ji(r,t)));return i.filter((r,n)=>e[n])},Zs=async(i=Pe)=>{let t=await Promise.all(i.map(en));return i.filter((e,r)=>t[r])},Ba=async(i,t)=>{for(let e of i)if(await Zi(e,t))return e;return null},mu=async(i,t)=>{for(let e of i)if(await Ji(e,t))return e;return null},fu=async i=>{for(let t of i)if(await en(t))return t;return null};var mr=class{constructor(){this._connectedTrack=null;this._closingPromise=null;this._closed=!1;this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if(this._connectedTrack.output.state==="canceled")throw new Error("Output has been canceled.");if(this._connectedTrack.output.state==="finalizing"||this._connectedTrack.output.state==="finalized")throw new Error("Output has been finalized.");if(this._connectedTrack.output.state==="pending")throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}async _start(){}async _flushAndClose(t){}close(){if(this._closingPromise)return;let t=this._connectedTrack;if(!t)throw new Error("Cannot call close without connecting the source to an output track.");if(t.output.state==="pending")throw new Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,!(t.output.state==="finalizing"||t.output.state==="finalized")&&t.output._muxer.onTrackClose(t)})()}async _flushOrWaitForOngoingClose(t){return this._closingPromise??=(async()=>{await this._flushAndClose(t),this._closed=!0})()}},st=class extends mr{constructor(e){super();this._connectedTrack=null;if(!se.includes(e))throw new TypeError(`Invalid video codec '${e}'. Must be one of: ${se.join(", ")}.`);this._codec=e}},di=class extends st{constructor(t){super(t)}add(t,e){if(!(t instanceof L))throw new TypeError("packet must be an EncodedPacket.");if(t.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedVideoPacket(this._connectedTrack,t,e)}},tn=class{constructor(t,e){this.source=t;this.encodingConfig=e;this.ensureEncoderPromise=null;this.encoderInitialized=!1;this.encoder=null;this.muxer=null;this.lastMultipleOfKeyFrameInterval=-1;this.codedWidth=null;this.codedHeight=null;this.resizeCanvas=null;this.customEncoder=null;this.customEncoderCallSerializer=new vt;this.customEncoderQueueSize=0;this.alphaEncoder=null;this.splitter=null;this.splitterCreationFailed=!1;this.alphaFrameQueue=[];this.error=null;this.errorNeedsNewStack=!0}async add(t,e,r){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.codedWidth!==null&&this.codedHeight!==null){if(t.codedWidth!==this.codedWidth||t.codedHeight!==this.codedHeight){let o=this.encodingConfig.sizeChangeBehavior??"deny";if(o!=="passThrough"){if(o==="deny")throw new Error(`Video sample size must remain constant. Expected ${this.codedWidth}x${this.codedHeight}, got ${t.codedWidth}x${t.codedHeight}. To allow the sample size to change over time, set \`sizeChangeBehavior\` to a value other than 'strict' in the encoding options.`);{let c=!1;this.resizeCanvas||(typeof document<"u"?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),c=!0);let u=this.resizeCanvas.getContext("2d",{alpha:Ze()});p(u),c||(Ze()?(u.fillStyle="black",u.fillRect(0,0,this.codedWidth,this.codedHeight)):u.clearRect(0,0,this.codedWidth,this.codedHeight)),t.drawWithFit(u,{fit:o}),e&&t.close(),t=new le(this.resizeCanvas,{timestamp:t.timestamp,duration:t.duration,rotation:t.rotation}),e=!0}}}}else this.codedWidth=t.codedWidth,this.codedHeight=t.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(t),this.encoderInitialized||await this.ensureEncoderPromise),p(this.encoderInitialized);let n=this.encodingConfig.keyFrameInterval??5,a=Math.floor(t.timestamp/n),s={...r,keyFrame:r?.keyFrame||n===0||a!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=a,this.customEncoder){this.customEncoderQueueSize++;let o=t.clone(),c=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(o,s)).then(()=>this.customEncoderQueueSize--).catch(u=>this.error??=u).finally(()=>{o.close()});this.customEncoderQueueSize>=4&&await c}else{p(this.encoder);let o=t.toVideoFrame();if(!this.alphaEncoder)this.encoder.encode(o,s),o.close();else if(!!o.format&&!o.format.includes("A")||this.splitterCreationFailed)this.alphaFrameQueue.push(null),this.encoder.encode(o,s),o.close();else{let u=o.displayWidth,d=o.displayHeight;if(!this.splitter)try{this.splitter=new to(u,d)}catch(l){console.error("Due to an error, only color data will be encoded.",l),this.splitterCreationFailed=!0,this.alphaFrameQueue.push(null),this.encoder.encode(o,s),o.close()}if(this.splitter){let l=this.splitter.extractColor(o),m=this.splitter.extractAlpha(o);this.alphaFrameQueue.push(m),this.encoder.encode(l,s),l.close(),o.close()}}e&&t.close(),this.encoder.encodeQueueSize>=4&&await new Promise(c=>this.encoder.addEventListener("dequeue",c,{once:!0}))}await this.muxer.mutex.currentPromise}finally{e&&t.close()}}ensureEncoder(t){let e=new Error;this.ensureEncoderPromise=(async()=>{let r=Fa({width:t.codedWidth,height:t.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(r);let n=Zt.find(a=>a.supports(this.encodingConfig.codec,r));if(n)this.customEncoder=new n,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=r,this.customEncoder.onPacket=(a,s)=>{if(!(a instanceof L))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(s!==void 0&&(!s||typeof s!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(a,s),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,a,s).catch(o=>{this.error??=o,this.errorNeedsNewStack=!1})},await this.customEncoder.init();else{if(typeof VideoEncoder>"u")throw new Error("VideoEncoder is not supported by this browser.");if(r.alpha="discard",this.encodingConfig.alpha==="keep"&&(r.latencyMode="quality"),(r.width%2===1||r.height%2===1)&&(this.encodingConfig.codec==="avc"||this.encodingConfig.codec==="hevc"))throw new Error(`The dimensions ${r.width}x${r.height} are not supported for codec '${this.encodingConfig.codec}'; both width and height must be even numbers. Make sure to round your dimensions to the nearest even number.`);if(!(await VideoEncoder.isConfigSupported(r)).supported)throw new Error(`This specific encoder configuration (${r.codec}, ${r.bitrate} bps, ${r.width}x${r.height}, hardware acceleration: ${r.hardwareAcceleration??"no-preference"}) is not supported by this browser. Consider using another codec or changing your video parameters.`);let o=[],c=[],u=0,d=0,l=(m,f,h)=>{let g={};if(f){let y=new Uint8Array(f.byteLength);f.copyTo(y),g.alpha=y}let b=L.fromEncodedChunk(m,g);this.encodingConfig.onEncodedPacket?.(b,h),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,b,h).catch(y=>{this.error??=y,this.errorNeedsNewStack=!1})};this.encoder=new VideoEncoder({output:(m,f)=>{if(!this.alphaEncoder){l(m,null,f);return}let h=this.alphaFrameQueue.shift();p(h!==void 0),h?(this.alphaEncoder.encode(h,{keyFrame:m.type==="key"}),d++,h.close(),o.push({chunk:m,meta:f})):d===0?l(m,null,f):(c.push(u+d),o.push({chunk:m,meta:f}))},error:m=>{m.stack=e.stack,this.error??=m}}),this.encoder.configure(r),this.encodingConfig.alpha==="keep"&&(this.alphaEncoder=new VideoEncoder({output:(m,f)=>{d--;let h=o.shift();for(p(h!==void 0),l(h.chunk,m,h.meta),u++;c.length>0&&c[0]===u;){c.shift();let g=o.shift();p(g!==void 0),l(g.chunk,null,g.meta)}},error:m=>{m.stack=e.stack,this.error??=m}}),this.alphaEncoder.configure(r))}p(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(t){t||this.checkForEncoderError(),this.customEncoder?(t||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(t||(await this.encoder.flush(),await this.alphaEncoder?.flush()),this.encoder.state!=="closed"&&this.encoder.close(),this.alphaEncoder&&this.alphaEncoder.state!=="closed"&&this.alphaEncoder.close(),this.alphaFrameQueue.forEach(e=>e?.close()),this.splitter?.close()),t||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}},to=class{constructor(t,e){this.lastFrame=null;typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(t,e):(this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e);let r=this.canvas.getContext("webgl2",{alpha:!0});if(!r)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=r,this.colorProgram=this.createColorProgram(),this.alphaProgram=this.createAlphaProgram(),this.vao=this.createVAO(),this.sourceTexture=this.createTexture(),this.alphaResolutionLocation=this.gl.getUniformLocation(this.alphaProgram,"u_resolution"),this.gl.useProgram(this.colorProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.colorProgram,"u_sourceTexture"),0),this.gl.useProgram(this.alphaProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.alphaProgram,"u_sourceTexture"),0)}createVertexShader(){return this.createShader(this.gl.VERTEX_SHADER,`#version 300 es
			in vec2 a_position;
			in vec2 a_texCoord;
			out vec2 v_texCoord;
			
			void main() {
				gl_Position = vec4(a_position, 0.0, 1.0);
				v_texCoord = a_texCoord;
			}
		`)}createColorProgram(){let t=this.createVertexShader(),e=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_sourceTexture;
			in vec2 v_texCoord;
			out vec4 fragColor;
			
			void main() {
				vec4 source = texture(u_sourceTexture, v_texCoord);
				fragColor = vec4(source.rgb, 1.0);
			}
		`),r=this.gl.createProgram();return this.gl.attachShader(r,t),this.gl.attachShader(r,e),this.gl.linkProgram(r),r}createAlphaProgram(){let t=this.createVertexShader(),e=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_sourceTexture;
			uniform vec2 u_resolution; // The width and height of the canvas
			in vec2 v_texCoord;
			out vec4 fragColor;

			// This function determines the value for a single byte in the YUV stream
			float getByteValue(float byteOffset) {
				float width = u_resolution.x;
				float height = u_resolution.y;

				float yPlaneSize = width * height;

				if (byteOffset < yPlaneSize) {
					// This byte is in the luma plane. Find the corresponding pixel coordinates to sample from
					float y = floor(byteOffset / width);
					float x = mod(byteOffset, width);
					
					// Add 0.5 to sample the center of the texel
					vec2 sampleCoord = (vec2(x, y) + 0.5) / u_resolution;
					
					// The luma value is the alpha from the source texture
					return texture(u_sourceTexture, sampleCoord).a;
				} else {
					// Write a fixed value for chroma and beyond
					return 128.0 / 255.0;
				}
			}
			
			void main() {
				// Each fragment writes 4 bytes (R, G, B, A)
				float pixelIndex = floor(gl_FragCoord.y) * u_resolution.x + floor(gl_FragCoord.x);
				float baseByteOffset = pixelIndex * 4.0;

				vec4 result;
				for (int i = 0; i < 4; i++) {
					float currentByteOffset = baseByteOffset + float(i);
					result[i] = getByteValue(currentByteOffset);
				}
				
				fragColor = result;
			}
		`),r=this.gl.createProgram();return this.gl.attachShader(r,t),this.gl.attachShader(r,e),this.gl.linkProgram(r),r}createShader(t,e){let r=this.gl.createShader(t);return this.gl.shaderSource(r,e),this.gl.compileShader(r),this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)||console.error("Shader compile error:",this.gl.getShaderInfoLog(r)),r}createVAO(){let t=this.gl.createVertexArray();this.gl.bindVertexArray(t);let e=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW);let n=this.gl.getAttribLocation(this.colorProgram,"a_position"),a=this.gl.getAttribLocation(this.colorProgram,"a_texCoord");return this.gl.enableVertexAttribArray(n),this.gl.vertexAttribPointer(n,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(a),this.gl.vertexAttribPointer(a,2,this.gl.FLOAT,!1,16,8),t}createTexture(){let t=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),t}updateTexture(t){this.lastFrame!==t&&((t.displayWidth!==this.canvas.width||t.displayHeight!==this.canvas.height)&&(this.canvas.width=t.displayWidth,this.canvas.height=t.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.lastFrame=t)}extractColor(t){return this.updateTexture(t),this.gl.useProgram(this.colorProgram),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),new VideoFrame(this.canvas,{timestamp:t.timestamp,duration:t.duration??void 0,alpha:"discard"})}extractAlpha(t){this.updateTexture(t),this.gl.useProgram(this.alphaProgram),this.gl.uniform2f(this.alphaResolutionLocation,this.canvas.width,this.canvas.height),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4);let{width:e,height:r}=this.canvas,n=Math.ceil(e/2)*Math.ceil(r/2),a=e*r+n*2,s=Math.ceil(a/(e*4)),o=new Uint8Array(4*e*s);this.gl.readPixels(0,0,e,s,this.gl.RGBA,this.gl.UNSIGNED_BYTE,o),o=o.subarray(0,a),p(o[e*r]===128),p(o[o.length-1]===128);let c={format:"I420",codedWidth:e,codedHeight:r,timestamp:t.timestamp,duration:t.duration??void 0,transfer:[o.buffer]};return new VideoFrame(o,c)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}},fr=class extends st{constructor(t){Ra(t),super(t.codec),this._encoder=new tn(this,t)}add(t,e){if(!(t instanceof le))throw new TypeError("videoSample must be a VideoSample.");return this._encoder.add(t,!1,e)}_flushAndClose(t){return this._encoder.flushAndClose(t)}},Oa=class extends st{constructor(t,e){if(!(typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement)&&!(typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas))throw new TypeError("canvas must be an HTMLCanvasElement or OffscreenCanvas.");Ra(e),super(e.codec),this._encoder=new tn(this,e),this._canvas=t}add(t,e=0,r){if(!Number.isFinite(t)||t<0)throw new TypeError("timestamp must be a non-negative number.");if(!Number.isFinite(e)||e<0)throw new TypeError("duration must be a non-negative number.");let n=new le(this._canvas,{timestamp:t,duration:e});return this._encoder.add(n,!0,r)}_flushAndClose(t){return this._encoder.flushAndClose(t)}},Ua=class extends st{constructor(e,r){if(!(e instanceof MediaStreamTrack)||e.kind!=="video")throw new TypeError("track must be a video MediaStreamTrack.");Ra(r),r={...r,latencyMode:"realtime"};super(r.codec);this._abortController=null;this._workerTrackId=null;this._workerListener=null;this._promiseWithResolvers=Q();this._errorPromiseAccessed=!1;this._paused=!1;this._lastSampleTimestamp=null;this._pauseOffset=0;this._encoder=new tn(this,r),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}get paused(){return this._paused}async _start(){this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController;let e=null,r=!1,n=a=>{if(r){a.close();return}let s=a.timestamp/1e6;if(this._paused){if(e!==null){if(this._lastSampleTimestamp!==null){let u=s-this._lastSampleTimestamp;this._pauseOffset-=u}this._lastSampleTimestamp=s}a.close();return}if(e===null){e=s;let c=this._connectedTrack.output._muxer;c.firstMediaStreamTimestamp===null?(c.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-c.firstMediaStreamTimestamp-e}if(this._lastSampleTimestamp=s,this._encoder.getQueueSize()>=4){a.close();return}let o=new le(a,{timestamp:s+this._pauseOffset});this._encoder.add(o,!0).catch(c=>{r=!0,this._abortController?.abort(),this._promiseWithResolvers.reject(c),this._workerTrackId!==null&&eo({type:"stopTrack",trackId:this._workerTrackId})})};if(typeof MediaStreamTrackProcessor<"u"){let a=new MediaStreamTrackProcessor({track:this._track}),s=new WritableStream({write:n});a.readable.pipeTo(s,{signal:this._abortController.signal}).catch(o=>{o instanceof DOMException&&o.name==="AbortError"||this._promiseWithResolvers.reject(o)})}else if(await Cl())this._workerTrackId=Sl++,eo({type:"videoTrack",trackId:this._workerTrackId,track:this._track}),this._workerListener=s=>{let o=s.data;o.type==="videoFrame"&&o.trackId===this._workerTrackId?n(o.videoFrame):o.type==="error"&&o.trackId===this._workerTrackId&&this._promiseWithResolvers.reject(o.error)},ze.addEventListener("message",this._workerListener);else throw new Error("MediaStreamTrackProcessor is required but not supported by this browser.")}pause(){this._paused=!0}resume(){this._paused=!1}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._workerTrackId!==null&&(p(this._workerListener),eo({type:"stopTrack",trackId:this._workerTrackId}),await new Promise(r=>{let n=a=>{let s=a.data;s.type==="trackStopped"&&s.trackId===this._workerTrackId&&(p(this._workerListener),ze.removeEventListener("message",this._workerListener),ze.removeEventListener("message",n),r())};ze.addEventListener("message",n)})),await this._encoder.flushAndClose(e)}},ot=class extends mr{constructor(e){super();this._connectedTrack=null;if(!ue.includes(e))throw new TypeError(`Invalid audio codec '${e}'. Must be one of: ${ue.join(", ")}.`);this._codec=e}},li=class extends ot{constructor(t){super(t)}add(t,e){if(!(t instanceof L))throw new TypeError("packet must be an EncodedPacket.");if(t.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedAudioPacket(this._connectedTrack,t,e)}},rn=class{constructor(t,e){this.source=t;this.encodingConfig=e;this.ensureEncoderPromise=null;this.encoderInitialized=!1;this.encoder=null;this.muxer=null;this.lastNumberOfChannels=null;this.lastSampleRate=null;this.isPcmEncoder=!1;this.outputSampleSize=null;this.writeOutputValue=null;this.customEncoder=null;this.customEncoderCallSerializer=new vt;this.customEncoderQueueSize=0;this.lastEndSampleIndex=null;this.error=null;this.errorNeedsNewStack=!0}async add(t,e){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.lastNumberOfChannels!==null&&this.lastSampleRate!==null){if(t.numberOfChannels!==this.lastNumberOfChannels||t.sampleRate!==this.lastSampleRate)throw new Error(`Audio parameters must remain constant. Expected ${this.lastNumberOfChannels} channels at ${this.lastSampleRate} Hz, got ${t.numberOfChannels} channels at ${t.sampleRate} Hz.`)}else this.lastNumberOfChannels=t.numberOfChannels,this.lastSampleRate=t.sampleRate;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(t),this.encoderInitialized||await this.ensureEncoderPromise),p(this.encoderInitialized);{let r=Math.round(t.timestamp*t.sampleRate),n=Math.round((t.timestamp+t.duration)*t.sampleRate);if(this.lastEndSampleIndex===null)this.lastEndSampleIndex=n;else{let a=r-this.lastEndSampleIndex;if(a>=64){let s=new ye({data:new Float32Array(a*t.numberOfChannels),format:"f32-planar",sampleRate:t.sampleRate,numberOfChannels:t.numberOfChannels,numberOfFrames:a,timestamp:this.lastEndSampleIndex/t.sampleRate});await this.add(s,!0)}this.lastEndSampleIndex+=t.numberOfFrames}}if(this.customEncoder){this.customEncoderQueueSize++;let r=t.clone(),n=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(r)).then(()=>this.customEncoderQueueSize--).catch(a=>this.error??=a).finally(()=>{r.close()});this.customEncoderQueueSize>=4&&await n,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(t,e);else{p(this.encoder);let r=t.toAudioData();this.encoder.encode(r),r.close(),e&&t.close(),this.encoder.encodeQueueSize>=4&&await new Promise(n=>this.encoder.addEventListener("dequeue",n,{once:!0})),await this.muxer.mutex.currentPromise}}finally{e&&t.close()}}async doPcmEncoding(t,e){p(this.outputSampleSize),p(this.writeOutputValue);let{numberOfChannels:r,numberOfFrames:n,sampleRate:a,timestamp:s}=t,o=2048,c=[];for(let m=0;m<n;m+=o){let f=Math.min(o,t.numberOfFrames-m),h=f*r*this.outputSampleSize,g=new ArrayBuffer(h),b=new DataView(g);c.push({frameCount:f,view:b})}let u=t.allocationSize({planeIndex:0,format:"f32-planar"}),d=new Float32Array(u/Float32Array.BYTES_PER_ELEMENT);for(let m=0;m<r;m++){t.copyTo(d,{planeIndex:m,format:"f32-planar"});for(let f=0;f<c.length;f++){let{frameCount:h,view:g}=c[f];for(let b=0;b<h;b++)this.writeOutputValue(g,(b*r+m)*this.outputSampleSize,d[f*o+b])}}e&&t.close();let l={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:r,sampleRate:a}};for(let m=0;m<c.length;m++){let{frameCount:f,view:h}=c[m],g=h.buffer,b=m*o,y=new L(new Uint8Array(g),"key",s+b/a,f/a);this.encodingConfig.onEncodedPacket?.(y,l),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,y,l)}}ensureEncoder(t){let e=new Error;this.ensureEncoderPromise=(async()=>{let{numberOfChannels:r,sampleRate:n}=t,a=Ma({numberOfChannels:r,sampleRate:n,...this.encodingConfig});this.encodingConfig.onEncoderConfig?.(a);let s=Jt.find(o=>o.supports(this.encodingConfig.codec,a));if(s)this.customEncoder=new s,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=a,this.customEncoder.onPacket=(o,c)=>{if(!(o instanceof L))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(c!==void 0&&(!c||typeof c!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(o,c),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,o,c).catch(u=>{this.error??=u,this.errorNeedsNewStack=!1})},await this.customEncoder.init();else if(Y.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if(typeof AudioEncoder>"u")throw new Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(a)).supported)throw new Error(`This specific encoder configuration (${a.codec}, ${a.bitrate} bps, ${a.numberOfChannels} channels, ${a.sampleRate} Hz) is not supported by this browser. Consider using another codec or changing your audio parameters.`);this.encoder=new AudioEncoder({output:(c,u)=>{if(this.encodingConfig.codec==="aac"&&u?.decoderConfig){let l=!1;if(!u.decoderConfig.description||u.decoderConfig.description.byteLength<2?l=!0:l=ht(W(u.decoderConfig.description)).objectType===0,l){let m=Number(j(a.codec.split(".")));u.decoderConfig.description=Sr({objectType:m,numberOfChannels:u.decoderConfig.numberOfChannels,sampleRate:u.decoderConfig.sampleRate})}}let d=L.fromEncodedChunk(c);this.encodingConfig.onEncodedPacket?.(d,u),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,d,u).catch(l=>{this.error??=l,this.errorNeedsNewStack=!1})},error:c=>{c.stack=e.stack,this.error??=c}}),this.encoder.configure(a)}p(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;let t=this.encodingConfig.codec,{dataType:e,sampleSize:r,littleEndian:n}=ke(t);switch(this.outputSampleSize=r,r){case 1:e==="unsigned"?this.writeOutputValue=(a,s,o)=>a.setUint8(s,ae((o+1)*127.5,0,255)):e==="signed"?this.writeOutputValue=(a,s,o)=>{a.setInt8(s,ae(Math.round(o*128),-128,127))}:e==="ulaw"?this.writeOutputValue=(a,s,o)=>{let c=ae(Math.floor(o*32767),-32768,32767);a.setUint8(s,Go(c))}:e==="alaw"?this.writeOutputValue=(a,s,o)=>{let c=ae(Math.floor(o*32767),-32768,32767);a.setUint8(s,$o(c))}:p(!1);break;case 2:e==="unsigned"?this.writeOutputValue=(a,s,o)=>a.setUint16(s,ae((o+1)*32767.5,0,65535),n):e==="signed"?this.writeOutputValue=(a,s,o)=>a.setInt16(s,ae(Math.round(o*32767),-32768,32767),n):p(!1);break;case 3:e==="unsigned"?this.writeOutputValue=(a,s,o)=>Qt(a,s,ae((o+1)*83886075e-1,0,16777215),n):e==="signed"?this.writeOutputValue=(a,s,o)=>bo(a,s,ae(Math.round(o*8388607),-8388608,8388607),n):p(!1);break;case 4:e==="unsigned"?this.writeOutputValue=(a,s,o)=>a.setUint32(s,ae((o+1)*21474836475e-1,0,4294967295),n):e==="signed"?this.writeOutputValue=(a,s,o)=>a.setInt32(s,ae(Math.round(o*2147483647),-2147483648,2147483647),n):e==="float"?this.writeOutputValue=(a,s,o)=>a.setFloat32(s,o,n):p(!1);break;case 8:e==="float"?this.writeOutputValue=(a,s,o)=>a.setFloat64(s,o,n):p(!1);break;default:J(r),p(!1)}}async flushAndClose(t){t||this.checkForEncoderError(),this.customEncoder?(t||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(t||await this.encoder.flush(),this.encoder.state!=="closed"&&this.encoder.close()),t||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}},pr=class extends ot{constructor(t){Da(t),super(t.codec),this._encoder=new rn(this,t)}add(t){if(!(t instanceof ye))throw new TypeError("audioSample must be an AudioSample.");return this._encoder.add(t,!1)}_flushAndClose(t){return this._encoder.flushAndClose(t)}},Va=class extends ot{constructor(e){Da(e);super(e.codec);this._accumulatedTime=0;this._encoder=new rn(this,e)}async add(e){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=ye._fromAudioBuffer(e,this._accumulatedTime);this._accumulatedTime+=e.duration;for(let n of r)await this._encoder.add(n,!0)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},za=class extends ot{constructor(e,r){if(!(e instanceof MediaStreamTrack)||e.kind!=="audio")throw new TypeError("track must be an audio MediaStreamTrack.");Da(r);super(r.codec);this._abortController=null;this._audioContext=null;this._scriptProcessorNode=null;this._promiseWithResolvers=Q();this._errorPromiseAccessed=!1;this._paused=!1;this._lastSampleTimestamp=null;this._pauseOffset=0;this._encoder=new rn(this,r),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}get paused(){return this._paused}async _start(){this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController;let e=null,r=!1,n=a=>{if(r){a.close();return}let s=a.timestamp;if(this._paused){if(e!==null){if(this._lastSampleTimestamp!==null){let c=s-this._lastSampleTimestamp;this._pauseOffset-=c}this._lastSampleTimestamp=s}a.close();return}if(e===null){e=a.timestamp;let o=this._connectedTrack.output._muxer;o.firstMediaStreamTimestamp===null?(o.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-o.firstMediaStreamTimestamp-e}if(this._lastSampleTimestamp=s,this._encoder.getQueueSize()>=4){a.close();return}a.setTimestamp(s+this._pauseOffset),this._encoder.add(a,!0).catch(o=>{r=!0,this._abortController?.abort(),this._promiseWithResolvers.reject(o),this._audioContext?.suspend()})};if(typeof MediaStreamTrackProcessor<"u"){let a=new MediaStreamTrackProcessor({track:this._track}),s=new WritableStream({write:o=>n(new ye(o))});a.readable.pipeTo(s,{signal:this._abortController.signal}).catch(o=>{o instanceof DOMException&&o.name==="AbortError"||this._promiseWithResolvers.reject(o)})}else{let a=window.AudioContext||window.webkitAudioContext;this._audioContext=new a({sampleRate:this._track.getSettings().sampleRate});let s=this._audioContext.createMediaStreamSource(new MediaStream([this._track]));this._scriptProcessorNode=this._audioContext.createScriptProcessor(4096),this._audioContext.state==="suspended"&&await this._audioContext.resume(),s.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._audioContext.destination);let o=0;this._scriptProcessorNode.onaudioprocess=c=>{let u=ye._fromAudioBuffer(c.inputBuffer,o);o+=c.inputBuffer.duration;for(let d of u)n(d)}}}pause(){this._paused=!0}resume(){this._paused=!1}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._audioContext&&(p(this._scriptProcessorNode),this._scriptProcessorNode.disconnect(),await this._audioContext.suspend()),await this._encoder.flushAndClose(e)}},Tl=()=>{let i=(r,n)=>{n?self.postMessage(r,{transfer:n}):self.postMessage(r)};i({type:"support",supported:typeof MediaStreamTrackProcessor<"u"});let t=new Map,e=new Map;self.addEventListener("message",r=>{let n=r.data;switch(n.type){case"videoTrack":{e.set(n.trackId,n.track);let a=new MediaStreamTrackProcessor({track:n.track}),s=new WritableStream({write:c=>{if(!e.has(n.trackId)){c.close();return}i({type:"videoFrame",trackId:n.trackId,videoFrame:c},[c])}}),o=new AbortController;t.set(n.trackId,o),a.readable.pipeTo(s,{signal:o.signal}).catch(c=>{c instanceof DOMException&&c.name==="AbortError"||i({type:"error",trackId:n.trackId,error:c})})}break;case"stopTrack":{let a=t.get(n.trackId);a&&(a.abort(),t.delete(n.trackId)),e.get(n.trackId)?.stop(),e.delete(n.trackId),i({type:"trackStopped",trackId:n.trackId})}break;default:J(n)}})},Sl=0,ze=null,xl=()=>{let i=new Blob([`(${Tl.toString()})()`],{type:"application/javascript"}),t=URL.createObjectURL(i);ze=new Worker(t)},Js=null,Cl=async()=>Js!==null?Js:(ze||xl(),new Promise(i=>{p(ze);let t=e=>{let r=e.data;r.type==="support"&&(Js=r.supported,ze.removeEventListener("message",t),i(r.supported))};ze.addEventListener("message",t)})),eo=(i,t)=>{p(ze),t?ze.postMessage(i,t):ze.postMessage(i)},hr=class extends mr{constructor(e){super();this._connectedTrack=null;if(!Pe.includes(e))throw new TypeError(`Invalid subtitle codec '${e}'. Must be one of: ${Pe.join(", ")}.`);this._codec=e}},Na=class extends hr{constructor(e){super(e);this._error=null;this._parser=new da({codec:e,output:(r,n)=>{this._connectedTrack?.output._muxer.addSubtitleCue(this._connectedTrack,r,n).catch(a=>{this._error??=a})}})}add(e){if(typeof e!="string")throw new TypeError("text must be a string.");return this._checkForError(),this._ensureValidAdd(),this._parser.parse(e),this._connectedTrack.output._muxer.mutex.currentPromise}_checkForError(){if(this._error)throw this._error}async _flushAndClose(e){e||this._checkForError()}};var io=["video","audio","subtitle"],ro=i=>{if(!i||typeof i!="object")throw new TypeError("metadata must be an object.");if(i.languageCode!==void 0&&!mt(i.languageCode))throw new TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");if(i.name!==void 0&&typeof i.name!="string")throw new TypeError("metadata.name, when provided, must be a string.");if(i.disposition!==void 0&&vo(i.disposition),i.maximumPacketCount!==void 0&&(!Number.isInteger(i.maximumPacketCount)||i.maximumPacketCount<0))throw new TypeError("metadata.maximumPacketCount, when provided, must be a non-negative integer.")},gr=class{constructor(t){this.state="pending";this._tracks=[];this._startPromise=null;this._cancelPromise=null;this._finalizePromise=null;this._mutex=new Te;this._metadataTags={};if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!(t.format instanceof Me))throw new TypeError("options.format must be an OutputFormat.");if(!(t.target instanceof at))throw new TypeError("options.target must be a Target.");if(t.target._output)throw new Error("Target is already used for another output.");t.target._output=this,this.format=t.format,this.target=t.target,this._writer=t.target._createWriter(),this._muxer=t.format._createMuxer(this)}addVideoTrack(t,e={}){if(!(t instanceof st))throw new TypeError("source must be a VideoSource.");if(ro(e),e.rotation!==void 0&&![0,90,180,270].includes(e.rotation))throw new TypeError(`Invalid video rotation: ${e.rotation}. Has to be 0, 90, 180 or 270.`);if(!this.format.supportsVideoRotationMetadata&&e.rotation)throw new Error(`${this.format._name} does not support video rotation metadata.`);if(e.frameRate!==void 0&&(!Number.isFinite(e.frameRate)||e.frameRate<=0))throw new TypeError(`Invalid video frame rate: ${e.frameRate}. Must be a positive number.`);this._addTrack("video",t,e)}addAudioTrack(t,e={}){if(!(t instanceof ot))throw new TypeError("source must be an AudioSource.");ro(e),this._addTrack("audio",t,e)}addSubtitleTrack(t,e={}){if(!(t instanceof hr))throw new TypeError("source must be a SubtitleSource.");ro(e),this._addTrack("subtitle",t,e)}setMetadataTags(t){if(pi(t),this.state!=="pending")throw new Error("Cannot set metadata tags after output has been started or canceled.");this._metadataTags=t}_addTrack(t,e,r){if(this.state!=="pending")throw new Error("Cannot add track after output has been started or canceled.");if(e._connectedTrack)throw new Error("Source is already used for a track.");let n=this.format.getSupportedTrackCounts(),a=this._tracks.reduce((u,d)=>u+(d.type===t?1:0),0),s=n[t].max;if(a===s)throw new Error(s===0?`${this.format._name} does not support ${t} tracks.`:`${this.format._name} does not support more than ${s} ${t} track${s===1?"":"s"}.`);let o=n.total.max;if(this._tracks.length===o)throw new Error(`${this.format._name} does not support more than ${o} tracks${o===1?"":"s"} in total.`);let c={id:this._tracks.length+1,output:this,type:t,source:e,metadata:r};if(c.type==="video"){let u=this.format.getSupportedVideoCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support video tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported video codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="audio"){let u=this.format.getSupportedAudioCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support audio tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported audio codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="subtitle"){let u=this.format.getSupportedSubtitleCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support subtitle tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported subtitle codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}this._tracks.push(c),e._connectedTrack=c}async start(){let t=this.format.getSupportedTrackCounts();for(let r of io){let n=this._tracks.reduce((s,o)=>s+(o.type===r?1:0),0),a=t[r].min;if(n<a)throw new Error(a===t[r].max?`${this.format._name} requires exactly ${a} ${r} track${a===1?"":"s"}.`:`${this.format._name} requires at least ${a} ${r} track${a===1?"":"s"}.`)}let e=t.total.min;if(this._tracks.length<e)throw new Error(e===t.total.max?`${this.format._name} requires exactly ${e} track${e===1?"":"s"}.`:`${this.format._name} requires at least ${e} track${e===1?"":"s"}.`);if(this.state==="canceled")throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();let r=await this._mutex.acquire();await this._muxer.start();let n=this._tracks.map(a=>a.source._start());await Promise.all(n),r()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if(this.state==="finalizing"||this.state==="finalized"){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";let t=await this._mutex.acquire(),e=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!0));await Promise.all(e),await this._writer.close(),t()})()}async finalize(){if(this.state==="pending")throw new Error("Cannot finalize before starting.");if(this.state==="canceled")throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";let t=await this._mutex.acquire(),e=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!1));await Promise.all(e),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",t()})()}};var pu=i=>{if(i!==void 0&&(!i||typeof i!="object"))throw new TypeError("options.video, when provided, must be an object.");if(i?.discard!==void 0&&typeof i.discard!="boolean")throw new TypeError("options.video.discard, when provided, must be a boolean.");if(i?.forceTranscode!==void 0&&typeof i.forceTranscode!="boolean")throw new TypeError("options.video.forceTranscode, when provided, must be a boolean.");if(i?.codec!==void 0&&!se.includes(i.codec))throw new TypeError(`options.video.codec, when provided, must be one of: ${se.join(", ")}.`);if(i?.bitrate!==void 0&&!(i.bitrate instanceof be)&&(!Number.isInteger(i.bitrate)||i.bitrate<=0))throw new TypeError("options.video.bitrate, when provided, must be a positive integer or a quality.");if(i?.width!==void 0&&(!Number.isInteger(i.width)||i.width<=0))throw new TypeError("options.video.width, when provided, must be a positive integer.");if(i?.height!==void 0&&(!Number.isInteger(i.height)||i.height<=0))throw new TypeError("options.video.height, when provided, must be a positive integer.");if(i?.fit!==void 0&&!["fill","contain","cover"].includes(i.fit))throw new TypeError("options.video.fit, when provided, must be one of 'fill', 'contain', or 'cover'.");if(i?.width!==void 0&&i.height!==void 0&&i.fit===void 0)throw new TypeError("When both options.video.width and options.video.height are provided, options.video.fit must also be provided.");if(i?.rotate!==void 0&&![0,90,180,270].includes(i.rotate))throw new TypeError("options.video.rotate, when provided, must be 0, 90, 180 or 270.");if(i?.allowRotationMetadata!==void 0&&typeof i.allowRotationMetadata!="boolean")throw new TypeError("options.video.allowRotationMetadata, when provided, must be a boolean.");if(i?.crop!==void 0&&vi(i.crop,"options.video."),i?.frameRate!==void 0&&(!Number.isFinite(i.frameRate)||i.frameRate<=0))throw new TypeError("options.video.frameRate, when provided, must be a finite positive number.");if(i?.alpha!==void 0&&!["discard","keep"].includes(i.alpha))throw new TypeError("options.video.alpha, when provided, must be either 'discard' or 'keep'.");if(i?.keyFrameInterval!==void 0&&(!Number.isFinite(i.keyFrameInterval)||i.keyFrameInterval<0))throw new TypeError("options.video.keyFrameInterval, when provided, must be a non-negative number.");if(i?.process!==void 0&&typeof i.process!="function")throw new TypeError("options.video.process, when provided, must be a function.");if(i?.processedWidth!==void 0&&(!Number.isInteger(i.processedWidth)||i.processedWidth<=0))throw new TypeError("options.video.processedWidth, when provided, must be a positive integer.");if(i?.processedHeight!==void 0&&(!Number.isInteger(i.processedHeight)||i.processedHeight<=0))throw new TypeError("options.video.processedHeight, when provided, must be a positive integer.");if(i?.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(i.hardwareAcceleration))throw new TypeError("options.video.hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.")},hu=i=>{if(i!==void 0&&(!i||typeof i!="object"))throw new TypeError("options.audio, when provided, must be an object.");if(i?.discard!==void 0&&typeof i.discard!="boolean")throw new TypeError("options.audio.discard, when provided, must be a boolean.");if(i?.forceTranscode!==void 0&&typeof i.forceTranscode!="boolean")throw new TypeError("options.audio.forceTranscode, when provided, must be a boolean.");if(i?.codec!==void 0&&!ue.includes(i.codec))throw new TypeError(`options.audio.codec, when provided, must be one of: ${ue.join(", ")}.`);if(i?.bitrate!==void 0&&!(i.bitrate instanceof be)&&(!Number.isInteger(i.bitrate)||i.bitrate<=0))throw new TypeError("options.audio.bitrate, when provided, must be a positive integer or a quality.");if(i?.numberOfChannels!==void 0&&(!Number.isInteger(i.numberOfChannels)||i.numberOfChannels<=0))throw new TypeError("options.audio.numberOfChannels, when provided, must be a positive integer.");if(i?.sampleRate!==void 0&&(!Number.isInteger(i.sampleRate)||i.sampleRate<=0))throw new TypeError("options.audio.sampleRate, when provided, must be a positive integer.");if(i?.process!==void 0&&typeof i.process!="function")throw new TypeError("options.audio.process, when provided, must be a function.");if(i?.processedNumberOfChannels!==void 0&&(!Number.isInteger(i.processedNumberOfChannels)||i.processedNumberOfChannels<=0))throw new TypeError("options.audio.processedNumberOfChannels, when provided, must be a positive integer.");if(i?.processedSampleRate!==void 0&&(!Number.isInteger(i.processedSampleRate)||i.processedSampleRate<=0))throw new TypeError("options.audio.processedSampleRate, when provided, must be a positive integer.")},no=2,ao=48e3,La=class i{constructor(t){this._addedCounts={video:0,audio:0,subtitle:0};this._totalTrackCount=0;this._trackPromises=[];this._executed=!1;this._synchronizer=new so;this._totalDuration=null;this._maxTimestamps=new Map;this._canceled=!1;this.onProgress=void 0;this._computeProgress=!1;this._lastProgress=0;this.isValid=!1;this.utilizedTracks=[];this.discardedTracks=[];if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!(t.input instanceof ti))throw new TypeError("options.input must be an Input.");if(!(t.output instanceof gr))throw new TypeError("options.output must be an Output.");if(t.output._tracks.length>0||Object.keys(t.output._metadataTags).length>0||t.output.state!=="pending")throw new TypeError("options.output must be fresh: no tracks or metadata tags added and not started.");if(typeof t.video!="function"&&pu(t.video),typeof t.audio!="function"&&hu(t.audio),t.trim!==void 0&&(!t.trim||typeof t.trim!="object"))throw new TypeError("options.trim, when provided, must be an object.");if(t.trim?.start!==void 0&&(!Number.isFinite(t.trim.start)||t.trim.start<0))throw new TypeError("options.trim.start, when provided, must be a non-negative number.");if(t.trim?.end!==void 0&&(!Number.isFinite(t.trim.end)||t.trim.end<0))throw new TypeError("options.trim.end, when provided, must be a non-negative number.");if(t.trim?.start!==void 0&&t.trim.end!==void 0&&t.trim.start>=t.trim.end)throw new TypeError("options.trim.start must be less than options.trim.end.");if(t.tags!==void 0&&(typeof t.tags!="object"||!t.tags)&&typeof t.tags!="function")throw new TypeError("options.tags, when provided, must be an object or a function.");if(typeof t.tags=="object"&&pi(t.tags),t.showWarnings!==void 0&&typeof t.showWarnings!="boolean")throw new TypeError("options.showWarnings, when provided, must be a boolean.");this._options=t,this.input=t.input,this.output=t.output;let{promise:e,resolve:r}=Q();this._started=e,this._start=r}static async init(t){let e=new i(t);return await e._init(),e}async _init(){this._startTimestamp=this._options.trim?.start??Math.max(await this.input.getFirstTimestamp(),0),this._endTimestamp=this._options.trim?.end??1/0;let t=await this.input.getTracks(),e=this.output.format.getSupportedTrackCounts(),r=1,n=1;for(let u of t){let d;if(u.isVideoTrack()?this._options.video&&(typeof this._options.video=="function"?(d=await this._options.video(u,r),pu(d),r++):d=this._options.video):u.isAudioTrack()?this._options.audio&&(typeof this._options.audio=="function"?(d=await this._options.audio(u,n),hu(d),n++):d=this._options.audio):p(!1),d?.discard){this.discardedTracks.push({track:u,reason:"discarded_by_user"});continue}if(this._totalTrackCount===e.total.max){this.discardedTracks.push({track:u,reason:"max_track_count_reached"});continue}if(this._addedCounts[u.type]===e[u.type].max){this.discardedTracks.push({track:u,reason:"max_track_count_of_type_reached"});continue}u.isVideoTrack()?await this._processVideoTrack(u,d??{}):u.isAudioTrack()&&await this._processAudioTrack(u,d??{})}let a=await this.input.getMetadataTags(),s;if(this._options.tags){let u=typeof this._options.tags=="function"?await this._options.tags(a):this._options.tags;pi(u),s=u}else s=a;let o=(await this.input.getFormat()).mimeType===this.output.format.mimeType,c=a.raw===s.raw;if(a.raw&&c&&!o&&delete s.raw,this.output.setMetadataTags(s),this.isValid=this._totalTrackCount>=e.total.min&&this._addedCounts.video>=e.video.min&&this._addedCounts.audio>=e.audio.min&&this._addedCounts.subtitle>=e.subtitle.min,this._options.showWarnings??!0){let u=[],d=this.discardedTracks.filter(l=>l.reason!=="discarded_by_user");d.length>0&&u.push("Some tracks had to be discarded from the conversion:",d),this.isValid||u.push(`

`+this._getInvalidityExplanation().join("")),u.length>0&&console.warn(...u)}}_getInvalidityExplanation(){let t=[];if(this.discardedTracks.length===0)t.push("Due to missing tracks, this conversion cannot be executed.");else{let e=this.discardedTracks.every(r=>r.reason==="discarded_by_user"||r.reason==="no_encodable_target_codec");if(t.push("Due to discarded tracks, this conversion cannot be executed."),e){let r=this.discardedTracks.flatMap(n=>n.reason==="discarded_by_user"?[]:n.track.type==="video"?this.output.format.getSupportedVideoCodecs():n.track.type==="audio"?this.output.format.getSupportedAudioCodecs():this.output.format.getSupportedSubtitleCodecs());r.length===1?t.push(`
Tracks were discarded because your environment is not able to encode '${r[0]}'.`):t.push(`
Tracks were discarded because your environment is not able to encode any of the following codecs: ${r.map(n=>`'${n}'`).join(", ")}.`),r.includes("mp3")&&t.push(`
The @mediabunny/mp3-encoder extension package provides support for encoding MP3.`)}else t.push(`
Check the discardedTracks field for more info.`)}return t}async execute(){if(!this.isValid)throw new Error(`Cannot execute this conversion because its output configuration is invalid. Make sure to always check the isValid field before executing a conversion.
`+this._getInvalidityExplanation().join(""));if(this._executed)throw new Error("Conversion cannot be executed twice.");if(this._executed=!0,this.onProgress){this._computeProgress=!0,this._totalDuration=Math.min(await this.input.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp);for(let t of this.utilizedTracks)this._maxTimestamps.set(t.id,0);this.onProgress?.(0)}await this.output.start(),this._start();try{await Promise.all(this._trackPromises)}catch(t){throw this._canceled||this.cancel(),t}if(this._canceled)throw new nn;await this.output.finalize(),this._computeProgress&&this.onProgress?.(1)}async cancel(){if(!(this.output.state==="finalizing"||this.output.state==="finalized")){if(this._canceled){console.warn("Conversion already canceled.");return}this._canceled=!0,await this.output.cancel()}}async _processVideoTrack(t,e){let r=t.codec;if(!r){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let n,a=It(t.rotation+(e.rotate??0)),s=this.output.format.supportsVideoRotationMetadata&&(e.allowRotationMetadata??!0),[o,c]=a%180===0?[t.codedWidth,t.codedHeight]:[t.codedHeight,t.codedWidth],u=e.crop;u&&Pi(u,o,c);let[d,l]=u?[u.width,u.height]:[o,c],m=d,f=l,h=m/f,g=T=>Math.ceil(T/2)*2;e.width!==void 0&&e.height===void 0?(m=g(e.width),f=g(Math.round(m/h))):e.width===void 0&&e.height!==void 0?(f=g(e.height),m=g(Math.round(f*h))):e.width!==void 0&&e.height!==void 0&&(m=g(e.width),f=g(e.height));let b=await t.getFirstTimestamp(),y=!!e.forceTranscode||b<this._startTimestamp||!!e.frameRate||e.keyFrameInterval!==void 0||e.process!==void 0,k=m!==d||f!==l||a!==0&&(!s||e.process!==void 0)||!!u,w=e.alpha??"discard",S=this.output.format.getSupportedVideoCodecs();if(!y&&!e.bitrate&&!k&&S.includes(r)&&(!e.codec||e.codec===r)){let T=new di(r);n=T,this._trackPromises.push((async()=>{await this._started;let x=new We(t),C={decoderConfig:await t.getDecoderConfig()??void 0},_=Number.isFinite(this._endTimestamp)?await x.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let U of x.packets(void 0,_,{verifyKeyPackets:!0})){if(this._canceled)return;let F=U.clone({timestamp:U.timestamp-this._startTimestamp,sideData:w==="discard"?{}:U.sideData});p(F.timestamp>=0),this._reportProgress(t.id,F.timestamp),await T.add(F,C),this._synchronizer.shouldWait(t.id,F.timestamp)&&await this._synchronizer.wait(F.timestamp)}T.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}e.codec&&(S=S.filter(U=>U===e.codec));let x=e.bitrate??Yi,A=await Ba(S,{width:e.process&&e.processedWidth?e.processedWidth:m,height:e.process&&e.processedHeight?e.processedHeight:f,bitrate:x});if(!A){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}let C={codec:A,bitrate:x,keyFrameInterval:e.keyFrameInterval,sizeChangeBehavior:e.fit??"passThrough",alpha:w,hardwareAcceleration:e.hardwareAcceleration},_=new fr(C);if(n=_,!k){let U=new gr({format:new lr,target:new si}),F=new fr(C);U.addVideoTrack(F),await U.start();let H=await new Rt(t).getSample(b);if(H)try{await F.add(H),H.close(),await U.finalize()}catch($){console.info("Error when probing encoder support. Falling back to rerender path.",$),k=!0,U.cancel()}else await U.cancel()}k?this._trackPromises.push((async()=>{await this._started;let F=new Mr(t,{width:m,height:f,fit:e.fit??"fill",rotation:a,crop:e.crop,poolSize:1,alpha:w==="keep"}).canvases(this._startTimestamp,this._endTimestamp),R=e.frameRate,H=null,$=null,X=null,Z=async ne=>{p(H),p(R!==void 0);let we=Math.round((ne-$)*R);for(let br=1;br<we;br++){let Pt=new le(H,{timestamp:$+br/R,duration:1/R});await this._registerVideoSample(t,e,_,Pt),Pt.close()}};for await(let{canvas:ne,timestamp:we,duration:br}of F){if(this._canceled)return;let Pt=Math.max(we-this._startTimestamp,0);if(X=Pt+br,R!==void 0){let an=Math.floor(Pt*R)/R;if(H!==null)if(an<=$){H=ne,$=an;continue}else await Z(an);Pt=an}let co=new le(ne,{timestamp:Pt,duration:R!==void 0?1/R:br});await this._registerVideoSample(t,e,_,co),co.close(),R!==void 0&&(H=ne,$=Pt)}H&&(p(X!==null),p(R!==void 0),await Z(Math.floor(X*R)/R)),_.close(),this._synchronizer.closeTrack(t.id)})()):this._trackPromises.push((async()=>{await this._started;let U=new Rt(t),F=e.frameRate,R=null,H=null,$=null,X=async Z=>{p(R),p(F!==void 0);let ne=Math.round((Z-H)*F);for(let we=1;we<ne;we++)R.setTimestamp(H+we/F),R.setDuration(1/F),await this._registerVideoSample(t,e,_,R);R.close()};for await(let Z of U.samples(this._startTimestamp,this._endTimestamp)){if(this._canceled){Z.close(),R?.close();return}let ne=Math.max(Z.timestamp-this._startTimestamp,0);if($=ne+Z.duration,F!==void 0){let we=Math.floor(ne*F)/F;if(R!==null)if(we<=H){R.close(),R=Z,H=we;continue}else await X(we);ne=we,Z.setDuration(1/F)}Z.setTimestamp(ne),await this._registerVideoSample(t,e,_,Z),F!==void 0?(R=Z,H=ne):Z.close()}R&&(p($!==null),p(F!==void 0),await X(Math.floor($*F)/F)),_.close(),this._synchronizer.closeTrack(t.id)})())}this.output.addVideoTrack(n,{frameRate:e.frameRate,languageCode:mt(t.languageCode)?t.languageCode:void 0,name:t.name??void 0,disposition:t.disposition,rotation:k?0:a}),this._addedCounts.video++,this._totalTrackCount++,this.utilizedTracks.push(t)}async _registerVideoSample(t,e,r,n){if(this._canceled)return;this._reportProgress(t.id,n.timestamp);let a;if(!e.process)a=[n];else{let s=e.process(n);s instanceof Promise&&(s=await s),Array.isArray(s)||(s=s===null?[]:[s]),a=s.map(o=>o instanceof le?o:typeof VideoFrame<"u"&&o instanceof VideoFrame?new le(o):new le(o,{timestamp:n.timestamp,duration:n.duration}))}for(let s of a){if(this._canceled)break;await r.add(s),this._synchronizer.shouldWait(t.id,s.timestamp)&&await this._synchronizer.wait(s.timestamp)}for(let s of a)s!==n&&s.close()}async _processAudioTrack(t,e){let r=t.codec;if(!r){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let n,a=t.numberOfChannels,s=t.sampleRate,o=await t.getFirstTimestamp(),c=e.numberOfChannels??a,u=e.sampleRate??s,d=c!==a||u!==s||o<this._startTimestamp,l=this.output.format.getSupportedAudioCodecs();if(!e.forceTranscode&&!e.bitrate&&!d&&l.includes(r)&&(!e.codec||e.codec===r)&&!e.process){let m=new li(r);n=m,this._trackPromises.push((async()=>{await this._started;let f=new We(t),g={decoderConfig:await t.getDecoderConfig()??void 0},b=Number.isFinite(this._endTimestamp)?await f.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let y of f.packets(void 0,b)){if(this._canceled)return;let k=y.clone({timestamp:y.timestamp-this._startTimestamp});p(k.timestamp>=0),this._reportProgress(t.id,k.timestamp),await m.add(k,g),this._synchronizer.shouldWait(t.id,k.timestamp)&&await this._synchronizer.wait(k.timestamp)}m.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}let f=null;e.codec&&(l=l.filter(b=>b===e.codec));let h=e.bitrate??Yi,g=await ui(l,{numberOfChannels:e.process&&e.processedNumberOfChannels?e.processedNumberOfChannels:c,sampleRate:e.process&&e.processedSampleRate?e.processedSampleRate:u,bitrate:h});if(!g.some(b=>Je.includes(b))&&l.some(b=>Je.includes(b))&&(c!==no||u!==ao)){let y=(await ui(l,{numberOfChannels:no,sampleRate:ao,bitrate:h})).find(k=>Je.includes(k));y&&(d=!0,f=y,c=no,u=ao)}else f=g[0]??null;if(f===null){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}if(d)n=this._resampleAudio(t,e,f,c,u,h);else{let b=new pr({codec:f,bitrate:h});n=b,this._trackPromises.push((async()=>{await this._started;let y=new Dt(t);for await(let k of y.samples(void 0,this._endTimestamp)){if(this._canceled){k.close();return}k.setTimestamp(k.timestamp-this._startTimestamp),await this._registerAudioSample(t,e,b,k),k.close()}b.close(),this._synchronizer.closeTrack(t.id)})())}}this.output.addAudioTrack(n,{languageCode:mt(t.languageCode)?t.languageCode:void 0,name:t.name??void 0,disposition:t.disposition}),this._addedCounts.audio++,this._totalTrackCount++,this.utilizedTracks.push(t)}async _registerAudioSample(t,e,r,n){if(this._canceled)return;this._reportProgress(t.id,n.timestamp);let a;if(!e.process)a=[n];else{let s=e.process(n);if(s instanceof Promise&&(s=await s),Array.isArray(s)||(s=s===null?[]:[s]),!s.every(o=>o instanceof ye))throw new TypeError("The audio process function must return an AudioSample, null, or an array of AudioSamples.");a=s}for(let s of a){if(this._canceled)break;await r.add(s),this._synchronizer.shouldWait(t.id,s.timestamp)&&await this._synchronizer.wait(s.timestamp)}for(let s of a)s!==n&&s.close()}_resampleAudio(t,e,r,n,a,s){let o=new pr({codec:r,bitrate:s});return this._trackPromises.push((async()=>{await this._started;let c=new oo({targetNumberOfChannels:n,targetSampleRate:a,startTime:this._startTimestamp,endTime:this._endTimestamp,onSample:async l=>{await this._registerAudioSample(t,e,o,l),l.close()}}),d=new Dt(t).samples(this._startTimestamp,this._endTimestamp);for await(let l of d){if(this._canceled){l.close();return}await c.add(l),l.close()}await c.finalize(),o.close(),this._synchronizer.closeTrack(t.id)})()),o}_reportProgress(t,e){if(!this._computeProgress)return;p(this._totalDuration!==null),this._maxTimestamps.set(t,Math.max(e,this._maxTimestamps.get(t)));let r=Math.min(...this._maxTimestamps.values()),n=ae(r/this._totalDuration,0,1);n!==this._lastProgress&&(this._lastProgress=n,this.onProgress?.(n))}},nn=class extends Error{constructor(t="Conversion has been canceled."){super(t),this.name="ConversionCanceledError"}},gu=5,so=class{constructor(){this.maxTimestamps=new Map;this.resolvers=[]}computeMinAndMaybeResolve(){let t=1/0;for(let[,e]of this.maxTimestamps)t=Math.min(t,e);for(let e=0;e<this.resolvers.length;e++){let r=this.resolvers[e];r.timestamp-t<gu&&(r.resolve(),this.resolvers.splice(e,1),e--)}return t}shouldWait(t,e){this.maxTimestamps.set(t,Math.max(e,this.maxTimestamps.get(t)??-1/0));let r=this.computeMinAndMaybeResolve();return e-r>=gu}wait(t){let{promise:e,resolve:r}=Q();return this.resolvers.push({timestamp:t,resolve:r}),e}closeTrack(t){this.maxTimestamps.delete(t),this.computeMinAndMaybeResolve()}},oo=class{constructor(t){this.sourceSampleRate=null;this.sourceNumberOfChannels=null;this.targetSampleRate=t.targetSampleRate,this.targetNumberOfChannels=t.targetNumberOfChannels,this.startTime=t.startTime,this.endTime=t.endTime,this.onSample=t.onSample,this.bufferSizeInFrames=Math.floor(this.targetSampleRate*5),this.bufferSizeInSamples=this.bufferSizeInFrames*this.targetNumberOfChannels,this.outputBuffer=new Float32Array(this.bufferSizeInSamples),this.bufferStartFrame=0,this.maxWrittenFrame=-1}doChannelMixerSetup(){p(this.sourceNumberOfChannels!==null);let t=this.sourceNumberOfChannels,e=this.targetNumberOfChannels;t===1&&e===2?this.channelMixer=(r,n)=>r[n*t]:t===1&&e===4?this.channelMixer=(r,n,a)=>r[n*t]*+(a<2):t===1&&e===6?this.channelMixer=(r,n,a)=>r[n*t]*+(a===2):t===2&&e===1?this.channelMixer=(r,n)=>{let a=n*t;return .5*(r[a]+r[a+1])}:t===2&&e===4?this.channelMixer=(r,n,a)=>r[n*t+a]*+(a<2):t===2&&e===6?this.channelMixer=(r,n,a)=>r[n*t+a]*+(a<2):t===4&&e===1?this.channelMixer=(r,n)=>{let a=n*t;return .25*(r[a]+r[a+1]+r[a+2]+r[a+3])}:t===4&&e===2?this.channelMixer=(r,n,a)=>{let s=n*t;return .5*(r[s+a]+r[s+a+2])}:t===4&&e===6?this.channelMixer=(r,n,a)=>{let s=n*t;return a<2?r[s+a]:a===2||a===3?0:r[s+a-2]}:t===6&&e===1?this.channelMixer=(r,n)=>{let a=n*t;return Math.SQRT1_2*(r[a]+r[a+1])+r[a+2]+.5*(r[a+4]+r[a+5])}:t===6&&e===2?this.channelMixer=(r,n,a)=>{let s=n*t;return r[s+a]+Math.SQRT1_2*(r[s+2]+r[s+a+4])}:t===6&&e===4?this.channelMixer=(r,n,a)=>{let s=n*t;return a<2?r[s+a]+Math.SQRT1_2*r[s+2]:r[s+a+2]}:this.channelMixer=(r,n,a)=>a<t?r[n*t+a]:0}ensureTempBufferSize(t){let e=this.tempSourceBuffer.length;for(;e<t;)e*=2;if(e!==this.tempSourceBuffer.length){let r=new Float32Array(e);r.set(this.tempSourceBuffer),this.tempSourceBuffer=r}}async add(t){this.sourceSampleRate===null&&(this.sourceSampleRate=t.sampleRate,this.sourceNumberOfChannels=t.numberOfChannels,this.tempSourceBuffer=new Float32Array(this.sourceSampleRate*this.sourceNumberOfChannels),this.doChannelMixerSetup());let e=t.numberOfFrames*t.numberOfChannels;this.ensureTempBufferSize(e);let r=t.allocationSize({planeIndex:0,format:"f32"}),n=new Float32Array(this.tempSourceBuffer.buffer,0,r/4);t.copyTo(n,{planeIndex:0,format:"f32"});let a=t.timestamp-this.startTime,s=t.numberOfFrames/this.sourceSampleRate,o=Math.min(a+s,this.endTime-this.startTime),c=Math.floor(a*this.targetSampleRate),u=Math.ceil(o*this.targetSampleRate);for(let d=c;d<u;d++){if(d<this.bufferStartFrame)continue;for(;d>=this.bufferStartFrame+this.bufferSizeInFrames;)await this.finalizeCurrentBuffer(),this.bufferStartFrame+=this.bufferSizeInFrames;let l=d-this.bufferStartFrame;p(l<this.bufferSizeInFrames);let h=(d/this.targetSampleRate-a)*this.sourceSampleRate,g=Math.floor(h),b=Math.ceil(h),y=h-g;for(let k=0;k<this.targetNumberOfChannels;k++){let w=0,S=0;g>=0&&g<t.numberOfFrames&&(w=this.channelMixer(n,g,k)),b>=0&&b<t.numberOfFrames&&(S=this.channelMixer(n,b,k));let T=w+y*(S-w),x=l*this.targetNumberOfChannels+k;this.outputBuffer[x]+=T}this.maxWrittenFrame=Math.max(this.maxWrittenFrame,l)}}async finalizeCurrentBuffer(){if(this.maxWrittenFrame<0)return;let t=(this.maxWrittenFrame+1)*this.targetNumberOfChannels,e=new Float32Array(t);e.set(this.outputBuffer.subarray(0,t));let r=this.bufferStartFrame/this.targetSampleRate,n=new ye({format:"f32",sampleRate:this.targetSampleRate,numberOfChannels:this.targetNumberOfChannels,timestamp:r,data:e});await this.onSample(n),this.outputBuffer.fill(0),this.maxWrittenFrame=-1}finalize(){return this.finalizeCurrentBuffer()}};return Cu(Pl);})();
if (typeof module === "object" && typeof module.exports === "object") Object.assign(module.exports, Mediabunny)
