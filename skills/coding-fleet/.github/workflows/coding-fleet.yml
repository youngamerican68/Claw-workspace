name: ğŸ¤– Coding Agent Fleet

on:
  # Trigger on PR creation/update
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'specs/**'
      - '.openclaw/coding-fleet.yaml'
  
  # Trigger on push to feature branches with specs
  push:
    branches:
      - 'ghost/**'
    paths:
      - 'specs/**'
  
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      spec:
        description: 'Feature specification or path to spec file'
        required: true
        default: 'specs/feature.md'
      agents:
        description: 'Agents to run (comma-separated)'
        required: true
        default: 'coder,reviewer,tester'
      ghost_branch:
        description: 'Ghost branch name (optional)'
        required: false
      auto_merge:
        description: 'Auto-merge if all agents pass'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  GHOST_BRANCH_PREFIX: 'ghost/'

jobs:
  # Detect if this is a spec-driven PR
  detect-spec:
    runs-on: ubuntu-latest
    outputs:
      has_spec: ${{ steps.check.outputs.has_spec }}
      spec_content: ${{ steps.check.outputs.spec_content }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for spec
        id: check
        run: |
          SPEC_FILE="${{ github.event.inputs.spec || 'specs/feature.md' }}"
          
          if [ -f "$SPEC_FILE" ]; then
            echo "has_spec=true" >> $GITHUB_OUTPUT
            # Read spec content, escaping for GitHub Actions
            SPEC_CONTENT=$(cat "$SPEC_FILE" | sed 's/"/\\"/g' | tr '\n' ' ')
            echo "spec_content=$SPEC_CONTENT" >> $GITHUB_OUTPUT
            echo "Found spec: $SPEC_FILE"
          else
            echo "has_spec=false" >> $GITHUB_OUTPUT
            echo "No spec file found at $SPEC_FILE"
          fi

  # Run the Coder Agent
  coder:
    needs: detect-spec
    if: needs.detect-spec.outputs.has_spec == 'true'
    runs-on: ubuntu-latest
    outputs:
      files_created: ${{ steps.run.outputs.files_created }}
      branch: ${{ steps.branch.outputs.name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Git
        run: |
          git config user.name "ğŸ¤– Coding Agent"
          git config user.email "agent@openclaw.local"
      
      - name: Create Ghost Branch
        id: branch
        run: |
          BRANCH="${{ env.GHOST_BRANCH_PREFIX }}$(date +%s)"
          if [ -n "${{ github.event.inputs.ghost_branch }}" ]; then
            BRANCH="${{ github.event.inputs.ghost_branch }}"
          fi
          git checkout -b "$BRANCH"
          echo "name=$BRANCH" >> $GITHUB_OUTPUT
      
      - name: Run Coder Agent
        id: run
        env:
          OPENCLAW_TOKEN: ${{ secrets.OPENCLAW_TOKEN }}
          OPENCLAW_HOST: ${{ secrets.OPENCLAW_HOST }}
        run: |
          echo "Running Coder Agent..."
          
          # This would call OpenClaw to spawn the coder agent
          # For now, simulate with placeholder
          
          cat > src/generated-feature.ts << 'EOF'
          // Generated by Coder Agent
          // TODO: Implement based on spec
          export function generatedFeature() {
            return "Implementation goes here";
          }
          EOF
          
          FILES_CREATED='["src/generated-feature.ts"]'
          echo "files_created=$FILES_CREATED" >> $GITHUB_OUTPUT
          
          # Commit the changes
          git add .
          git commit -m "[ghost] coder: implement from spec" || echo "No changes to commit"
      
      - name: Push Ghost Branch
        run: |
          git push -u origin ${{ steps.branch.outputs.name }}

  # Run the Reviewer Agent
  reviewer:
    needs: [detect-spec, coder]
    if: needs.detect-spec.outputs.has_spec == 'true' && contains(github.event.inputs.agents || 'coder,reviewer,tester', 'reviewer')
    runs-on: ubuntu-latest
    outputs:
      approval_status: ${{ steps.review.outputs.status }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.coder.outputs.branch }}
          fetch-depth: 0
      
      - name: Run Reviewer Agent
        id: review
        env:
          OPENCLAW_TOKEN: ${{ secrets.OPENCLAW_TOKEN }}
          OPENCLAW_HOST: ${{ secrets.OPENCLAW_HOST }}
        run: |
          echo "Running Reviewer Agent..."
          
          # Simulate review
          # In production, this would spawn the reviewer agent
          
          sleep 2
          
          # Output review results
          echo 'status=approved' >> $GITHUB_OUTPUT
          echo "### ğŸ¤– Reviewer Agent Results" >> $GITHUB_STEP_SUMMARY
          echo "- Approval Status: âœ… Approved" >> $GITHUB_STEP_SUMMARY
          echo "- Issues Found: 0" >> $GITHUB_STEP_SUMMARY
          echo "- Suggestions: 1" >> $GITHUB_STEP_SUMMARY
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '### ğŸ¤– Reviewer Agent\n\nâœ… **Approved**\n\n_Code review completed with no blocking issues._'
            });

  # Run the Tester Agent
  tester:
    needs: [detect-spec, coder, reviewer]
    if: |
      needs.detect-spec.outputs.has_spec == 'true' && 
      needs.reviewer.outputs.approval_status == 'approved' &&
      contains(github.event.inputs.agents || 'coder,reviewer,tester', 'tester')
    runs-on: ubuntu-latest
    outputs:
      tests_passed: ${{ steps.test.outputs.passed }}
      coverage: ${{ steps.test.outputs.coverage }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.coder.outputs.branch }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install Dependencies
        run: npm ci || npm install
      
      - name: Run Tests
        id: test
        run: |
          echo "Running Tester Agent..."
          
          # Generate and run tests
          # This would spawn the tester agent
          
          npm test 2>/dev/null || echo "No tests yet"
          
          # Output results
